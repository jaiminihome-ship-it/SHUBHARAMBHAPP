<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
<meta name="theme-color" content="#FF6F00">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>‡§∂‡•Å‡§≠‡§æ‡§∞‡§Ç‡§≠ - Pooja Samagri Manager</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800;900&family=Noto+Sans+Devanagari:wght@400;500;600;700&family=Noto+Serif+Devanagari:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
--bhagwa:#FF6F00;--bhagwa-dark:#E65100;--bhagwa-light:#FFB74D;--bhagwa-pale:#FFF3E0;
--gold:#DAA520;--deep-black:#1A1A2E;--dark-bg:#0F0F23;
--card-bg:rgba(255,255,255,0.04);--card-border:rgba(255,255,255,0.08);
--white:#fff;--g100:#F5F5F5;--g300:#E0E0E0;--g400:#BDBDBD;--g500:#9E9E9E;--g600:#757575;
--ok:#00C853;--err:#FF1744;--warn:#FFD600;--info:#2979FF;
--grad-b:linear-gradient(135deg,#FF6F00,#FF8F00,#FFA726);
--grad-d:linear-gradient(160deg,#0F0F23,#1A1A2E,#16213E);
--shadow-glow:0 0 30px rgba(255,111,0,0.15);
--r-sm:8px;--r-md:12px;--r-lg:16px;--r-xl:24px;--r-full:9999px;
--ease:cubic-bezier(0.4,0,0.2,1);
--f-ui:'Poppins',sans-serif;--f-hi:'Noto Sans Devanagari',sans-serif;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth;-webkit-text-size-adjust:100%}
body{font-family:var(--f-ui);background:var(--grad-d);color:var(--white);
overflow-x:hidden;min-height:100vh;line-height:1.6;-webkit-font-smoothing:antialiased}
body::before{content:'';position:fixed;inset:0;
background:radial-gradient(ellipse at 15% 50%,rgba(255,111,0,0.08),transparent 60%),
radial-gradient(ellipse at 85% 20%,rgba(218,165,32,0.05),transparent 50%);
pointer-events:none;z-index:0}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-thumb{background:var(--grad-b);border-radius:3px}
::selection{background:rgba(255,111,0,0.3);color:#fff}
.hide{display:none!important}
.shell{position:relative;z-index:1;max-width:1400px;margin:0 auto;min-height:100vh}
.topbar{position:sticky;top:0;z-index:900;padding:10px 12px}
.topbar-in{background:rgba(15,15,35,0.92);backdrop-filter:blur(24px) saturate(1.8);
border-radius:var(--r-xl);padding:10px 16px;display:flex;align-items:center;
justify-content:space-between;border:1px solid rgba(255,111,0,0.15);
box-shadow:0 4px 20px rgba(0,0,0,0.15),var(--shadow-glow)}
.brand{display:flex;align-items:center;gap:10px}
.brand-icon{width:42px;height:42px;background:var(--grad-b);border-radius:var(--r-md);
display:grid;place-items:center;font-size:1.35rem;box-shadow:0 4px 16px rgba(255,111,0,0.35);
animation:bFloat 4s ease-in-out infinite}
@keyframes bFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-3px)}}
.brand h1{font-size:1.15rem;font-weight:800;background:var(--grad-b);
-webkit-background-clip:text;-webkit-text-fill-color:transparent;line-height:1.2}
.brand small{font-size:0.65rem;color:var(--g600);display:block}
.top-right{display:flex;align-items:center;gap:6px}
.ibtn{width:36px;height:36px;border-radius:var(--r-md);border:1px solid var(--card-border);
background:var(--card-bg);color:var(--g400);cursor:pointer;display:grid;place-items:center;
font-size:1.1rem;transition:all .25s var(--ease)}
.ibtn:hover{background:rgba(255,111,0,0.15);color:#fff;transform:translateY(-1px)}
.ibtn:active{transform:scale(.94)}
.upill{display:flex;align-items:center;gap:6px;background:rgba(255,111,0,0.08);
border:1px solid rgba(255,111,0,0.15);padding:3px 10px 3px 3px;border-radius:var(--r-full);
cursor:pointer;transition:all .25s var(--ease)}
.upill:hover{background:rgba(255,111,0,0.15)}
.upill .ua{width:28px;height:28px;border-radius:50%;background:var(--grad-b);
display:grid;place-items:center;font-size:.8rem}
.upill .un{font-size:.75rem;font-weight:600;color:var(--bhagwa-light);max-width:80px;
overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.tabbar{position:fixed;bottom:0;left:0;right:0;z-index:900;padding:6px 10px;
padding-bottom:max(6px,env(safe-area-inset-bottom))}
.tabbar-in{background:rgba(7,7,15,0.96);backdrop-filter:blur(24px);
border-radius:var(--r-xl);padding:5px;display:grid;grid-template-columns:repeat(7,1fr);
gap:2px;border:1px solid rgba(255,111,0,0.12);box-shadow:0 -4px 30px rgba(0,0,0,0.4);
max-width:660px;margin:0 auto}
.tab{background:none;border:none;color:var(--g600);cursor:pointer;padding:6px 2px;
border-radius:var(--r-md);display:flex;flex-direction:column;align-items:center;gap:1px;
font-size:.58rem;font-weight:600;font-family:var(--f-ui);transition:all .25s var(--ease);
position:relative;user-select:none;-webkit-tap-highlight-color:transparent}
.tab .ti{font-size:1.15rem;transition:transform .3s var(--ease)}
.tab.on{color:#fff}
.tab.on::before{content:'';position:absolute;inset:0;background:var(--grad-b);
border-radius:var(--r-md);z-index:-1}
.tab:not(.on):hover{color:var(--bhagwa-light)}
.tab:not(.on):hover .ti{transform:translateY(-2px)}
.main{padding:0 12px 80px}
.page{display:none;animation:pgIn .35s var(--ease);max-width:900px;margin:0 auto}
.page.on{display:block}
@keyframes pgIn{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
.pg-head{text-align:center;padding:6px 0 18px}
.pg-title{font-size:1.6rem;font-weight:800;background:var(--grad-b);
-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.pg-sub{color:var(--g500);font-size:.85rem;margin-top:2px}
.card{background:var(--card-bg);backdrop-filter:blur(16px);border:1px solid var(--card-border);
border-radius:var(--r-lg);padding:18px;margin-bottom:14px;
transition:border-color .3s var(--ease),box-shadow .3s var(--ease)}
.card:hover{border-color:rgba(255,111,0,0.15)}
.card-h{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;
flex-wrap:wrap;gap:6px}
.card-t{font-size:1rem;font-weight:700;color:#fff;display:flex;align-items:center;gap:6px}
.fg{margin-bottom:14px}.fg:last-child{margin-bottom:0}
.fl{display:block;margin-bottom:4px;font-weight:600;color:var(--g300);font-size:.75rem;
text-transform:uppercase;letter-spacing:.6px}
.fi,.fsel,.ftx{width:100%;padding:10px 14px;background:rgba(255,255,255,0.04);
border:1.5px solid var(--card-border);border-radius:var(--r-md);color:#fff;
font-family:var(--f-ui);font-size:.9rem;transition:all .25s var(--ease);outline:none}
.fi:focus,.fsel:focus,.ftx:focus{border-color:var(--bhagwa);background:rgba(255,111,0,0.04);
box-shadow:0 0 0 3px rgba(255,111,0,0.1)}
.fi::placeholder,.ftx::placeholder{color:var(--g600)}
.ftx{min-height:90px;resize:vertical;font-family:var(--f-hi)}
.fsel option{background:var(--deep-black);color:#fff}
.fi-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.btn{padding:10px 16px;border:none;border-radius:var(--r-md);font-family:var(--f-ui);
font-size:.85rem;font-weight:600;cursor:pointer;transition:all .25s var(--ease);
display:inline-flex;align-items:center;justify-content:center;gap:5px;
user-select:none;-webkit-tap-highlight-color:transparent}
.btn:active{transform:scale(.96)}.btn:disabled{opacity:.4;pointer-events:none}
.btn-p{background:var(--grad-b);color:#fff;box-shadow:0 4px 14px rgba(255,111,0,0.3)}
.btn-p:hover:not(:disabled){box-shadow:0 6px 22px rgba(255,111,0,0.45);transform:translateY(-1px)}
.btn-s{background:rgba(255,255,255,0.06);color:#fff;border:1.5px solid rgba(255,255,255,0.1)}
.btn-s:hover:not(:disabled){background:rgba(255,255,255,0.1)}
.btn-g{background:linear-gradient(135deg,#00C853,#00E676);color:#fff}
.btn-d{background:linear-gradient(135deg,#FF1744,#FF5252);color:#fff}
.btn-w{width:100%}
.btn-sm{padding:6px 10px;font-size:.78rem}
.btn-xs{padding:4px 8px;font-size:.7rem;border-radius:6px}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px;margin-bottom:16px}
.stat{background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--r-lg);
padding:14px;text-align:center;cursor:pointer;transition:all .3s var(--ease)}
.stat:hover{border-color:rgba(255,111,0,0.2);transform:translateY(-2px)}
.stat-i{width:38px;height:38px;margin:0 auto 6px;background:var(--grad-b);border-radius:50%;
display:grid;place-items:center;font-size:1.1rem}
.stat-v{font-size:1.4rem;font-weight:800;color:#fff}
.stat-l{font-size:.65rem;color:var(--g500);text-transform:uppercase;letter-spacing:.4px}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);
backdrop-filter:blur(8px);z-index:9999;padding:14px;overflow-y:auto}
.modal.on{display:flex;align-items:center;justify-content:center}
.modal-box{background:var(--deep-black);border-radius:var(--r-xl);max-width:540px;width:100%;
max-height:90vh;overflow-y:auto;border:1px solid rgba(255,111,0,0.2);
animation:mPop .3s var(--ease)}
@keyframes mPop{from{opacity:0;transform:scale(.94) translateY(16px)}to{opacity:1;transform:scale(1) translateY(0)}}
.modal-h{padding:16px 18px;border-bottom:1px solid var(--card-border);display:flex;
align-items:center;justify-content:space-between}
.modal-t{font-size:1.1rem;font-weight:700;color:#fff}
.modal-x{width:32px;height:32px;border-radius:50%;border:none;background:rgba(255,255,255,0.08);
color:#fff;cursor:pointer;display:grid;place-items:center;font-size:1.2rem;transition:all .25s var(--ease)}
.modal-x:hover{background:var(--err);transform:rotate(90deg)}
.modal-b{padding:18px}
.modal-f{padding:14px 18px;border-top:1px solid var(--card-border);display:flex;gap:8px;justify-content:flex-end}
.toast-box{position:fixed;top:12px;right:12px;z-index:99999;display:flex;flex-direction:column;
gap:6px;max-width:360px;pointer-events:none}
.tst{background:rgba(15,15,35,0.95);backdrop-filter:blur(20px);border-radius:var(--r-md);
padding:10px 14px;display:flex;align-items:center;gap:8px;box-shadow:0 8px 40px rgba(0,0,0,0.3);
border-left:4px solid var(--bhagwa);animation:tIn .35s var(--ease);pointer-events:all}
.tst.ok{border-left-color:var(--ok)}.tst.err{border-left-color:var(--err)}.tst.warn{border-left-color:var(--warn)}
@keyframes tIn{from{opacity:0;transform:translateX(100%)}to{opacity:1;transform:translateX(0)}}
.tst-i{font-size:1.1rem;flex-shrink:0}
.tst-t{font-weight:600;color:#fff;font-size:.8rem}
.tst-m{font-size:.7rem;color:var(--g500);margin-top:1px}
.loader{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);backdrop-filter:blur(8px);z-index:99999}
.loader.on{display:flex;align-items:center;justify-content:center;flex-direction:column;gap:14px}
.lspin{width:40px;height:40px;border:3px solid rgba(255,255,255,0.08);
border-top-color:var(--bhagwa);border-radius:50%;animation:spin .75s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.ltxt{color:#fff;font-weight:600;font-size:.95rem}
.auth{position:fixed;inset:0;background:var(--grad-d);z-index:10000;
display:flex;align-items:center;justify-content:center;padding:16px;overflow-y:auto}
.auth::before{content:'';position:absolute;inset:0;
background:radial-gradient(ellipse at 20% 30%,rgba(255,111,0,0.08),transparent),
radial-gradient(ellipse at 80% 70%,rgba(218,165,32,0.05),transparent);pointer-events:none}
.auth.hide{display:none}
.auth-w{position:relative;max-width:420px;width:100%;z-index:1}
.auth-logo{text-align:center;margin-bottom:28px}
.auth-li{width:68px;height:68px;background:var(--grad-b);border-radius:var(--r-xl);
display:grid;place-items:center;font-size:2rem;margin:0 auto 14px;
box-shadow:0 8px 36px rgba(255,111,0,0.35);animation:bFloat 4s ease-in-out infinite}
.auth-logo h1{font-size:2rem;font-weight:900;background:var(--grad-b);
-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.auth-logo p{color:var(--g600);font-size:.82rem}
.auth-card{background:var(--card-bg);backdrop-filter:blur(16px);border:1px solid var(--card-border);
border-radius:var(--r-xl);padding:24px}
.auth-card h3{text-align:center;color:#fff;font-size:1.1rem;margin-bottom:20px}
.auth-sw{text-align:center;margin-top:14px;color:var(--g600);font-size:.82rem}
.auth-sw a{color:var(--bhagwa);text-decoration:none;font-weight:700;cursor:pointer}
.auth-ft{margin-top:24px;padding:14px;background:rgba(255,111,0,0.04);
border-radius:var(--r-lg);border:1px solid rgba(255,111,0,0.1)}
.auth-ft h4{color:var(--bhagwa);text-align:center;margin-bottom:8px;font-size:.82rem}
.auth-ft-g{display:grid;grid-template-columns:1fr 1fr;gap:3px 10px;font-size:.72rem;color:var(--g400)}
.otp-wrap{display:flex;gap:8px;justify-content:center;margin:16px 0}
.otp-inp{width:44px;height:52px;text-align:center;font-size:1.4rem;font-weight:800;
background:rgba(255,255,255,0.04);border:2px solid var(--card-border);border-radius:var(--r-md);
color:var(--bhagwa-light);font-family:var(--f-ui);outline:none;transition:all .25s var(--ease)}
.otp-inp:focus{border-color:var(--bhagwa);background:rgba(255,111,0,0.06);
box-shadow:0 0 0 3px rgba(255,111,0,0.15)}
.h-summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-bottom:16px}
.h-card{padding:14px;border-radius:var(--r-lg);text-align:center;cursor:pointer;transition:all .3s var(--ease)}
.h-card:hover{transform:translateY(-2px)}
.h-card.inc{background:rgba(0,200,83,0.06);border:1px solid rgba(0,200,83,0.15)}
.h-card.exp{background:rgba(255,23,68,0.06);border:1px solid rgba(255,23,68,0.15)}
.h-card.pend{background:rgba(255,214,0,0.06);border:1px solid rgba(255,214,0,0.15)}
.h-card.prof{background:rgba(255,111,0,0.06);border:1px solid rgba(255,111,0,0.15)}
.h-val{font-size:1.3rem;font-weight:800}
.h-val.green{color:#00E676}.h-val.red{color:#FF5252}
.h-val.yellow{color:#FFD740}.h-val.orange{color:var(--bhagwa-light)}
.h-lbl{font-size:.68rem;color:var(--g500);text-transform:uppercase;margin-top:2px}
.lrow{display:flex;align-items:center;gap:10px;padding:12px 0;
border-bottom:1px solid rgba(255,255,255,0.04);transition:background .2s var(--ease)}
.lrow:hover{background:rgba(255,255,255,0.02)}.lrow:last-child{border-bottom:none}
.lrow-i{width:38px;height:38px;border-radius:50%;display:grid;place-items:center;font-size:1rem;flex-shrink:0}
.lrow-b{flex:1;min-width:0}
.lrow-n{font-weight:600;color:#fff;font-size:.88rem}
.lrow-m{font-size:.7rem;color:var(--g500)}
.lrow-r{text-align:right;flex-shrink:0}
.lrow-a{display:flex;gap:4px;flex-shrink:0}
.badge{display:inline-block;padding:1px 7px;border-radius:var(--r-full);font-size:.6rem;font-weight:700}
.badge-ok{background:rgba(0,200,83,0.15);color:var(--ok)}
.badge-err{background:rgba(255,23,68,0.15);color:var(--err)}
.badge-warn{background:rgba(255,214,0,0.15);color:var(--warn)}
.sec-h{background:rgba(255,111,0,0.08);border-left:3px solid var(--bhagwa);
padding:8px 12px;border-radius:var(--r-sm);margin-bottom:6px;
font-weight:700;color:#fff;font-size:.88rem;display:flex;align-items:center;
justify-content:space-between;cursor:pointer}
.sec-h:hover{background:rgba(255,111,0,0.12)}
.sec-cnt{font-size:.68rem;color:var(--bhagwa-light);font-weight:400}
@media(max-width:768px){
.pg-title{font-size:1.3rem}.fi-row{grid-template-columns:1fr}
.stats{grid-template-columns:repeat(2,1fr)}.h-summary{grid-template-columns:repeat(2,1fr)}
.upill .un{display:none}.topbar{padding:6px 8px}.main{padding:0 8px 76px}
.tab .ti{font-size:1.05rem}.tab{font-size:.52rem}}
@media(min-width:1025px){.main{padding:0 20px 80px}.card{padding:22px}}
</style>
</head>
<body>

<div class="toast-box" id="toastBox"></div>
<div class="loader" id="loader"><div class="lspin"></div><div class="ltxt" id="loaderMsg">Loading...</div></div>

<!-- AUTH SCREEN -->
<div class="auth" id="authScreen">
<div class="auth-w">
  <div class="auth-logo">
    <div class="auth-li">üïâÔ∏è</div>
    <h1>‡§∂‡•Å‡§≠‡§æ‡§∞‡§Ç‡§≠</h1>
    <p>Professional Pooja Samagri Manager</p>
  </div>
  <div id="frmLogin" class="auth-card">
    <h3>üîê Login</h3>
    <div class="fg"><label class="fl">Email</label>
      <div style="position:relative"><input class="fi" id="aEmail" type="email" placeholder="your@email.com" autocomplete="email"></div></div>
    <div class="fg"><label class="fl">Password</label>
      <div style="position:relative"><input class="fi" id="aPass" type="password" placeholder="Password" autocomplete="current-password" style="padding-right:44px">
      <button type="button" class="ptg" onclick="togglePV('aPass',this)" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--g400);cursor:pointer;font-size:1.1rem;padding:4px">üëÅÔ∏è</button></div></div>
    <button class="btn btn-p btn-w" onclick="Auth.login()" style="margin-top:6px">Login ‚Üí</button>
    <div class="auth-sw">New here? <a onclick="Auth.showStep('signup')">Create Free Account</a></div>
  </div>
  <div id="frmSignup" class="auth-card hide">
    <h3>üÜï Create Account</h3>
    <div class="fg"><label class="fl">Full Name *</label>
      <input class="fi" id="rName" placeholder="‡§Ü‡§™‡§ï‡§æ ‡§®‡§æ‡§Æ" autocomplete="name"></div>
    <div class="fg"><label class="fl">Email *</label>
      <input class="fi" id="rEmail" type="email" placeholder="your@email.com" autocomplete="email"></div>
    <div class="fi-row">
      <div class="fg"><label class="fl">Phone</label>
        <input class="fi" id="rPhone" type="tel" placeholder="+91" autocomplete="tel"></div>
      <div class="fg"><label class="fl">City</label>
        <input class="fi" id="rCity" placeholder="‡§∂‡§π‡§∞"></div>
    </div>
    <div class="fg"><label class="fl">Password * (min 6)</label>
      <div style="position:relative"><input class="fi" id="rPass" type="password" placeholder="Password" autocomplete="new-password" style="padding-right:44px">
      <button type="button" class="ptg" onclick="togglePV('rPass',this)" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--g400);cursor:pointer;font-size:1.1rem;padding:4px">üëÅÔ∏è</button></div></div>
    <div class="fg"><label class="fl">Confirm Password *</label>
      <div style="position:relative"><input class="fi" id="rPass2" type="password" placeholder="Repeat" autocomplete="new-password" style="padding-right:44px">
      <button type="button" class="ptg" onclick="togglePV('rPass2',this)" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--g400);cursor:pointer;font-size:1.1rem;padding:4px">üëÅÔ∏è</button></div></div>
    <button class="btn btn-p btn-w" onclick="Auth.sendOTP()" style="margin-top:6px">Send OTP ‚Üí</button>
    <div class="auth-sw">Have account? <a onclick="Auth.showStep('login')">Login</a></div>
  </div>
  <div id="frmOTP" class="auth-card hide">
    <h3>üì© Verify Email</h3>
    <p style="text-align:center;color:var(--g400);font-size:.85rem;margin-bottom:14px">
      OTP sent to <strong id="otpEmail" style="color:var(--bhagwa-light)">-</strong></p>
    <div class="otp-wrap" id="otpWrap">
      <input class="otp-inp" maxlength="1" data-idx="0" oninput="Auth.otpNext(this,0)" onkeydown="Auth.otpKey(event,0)">
      <input class="otp-inp" maxlength="1" data-idx="1" oninput="Auth.otpNext(this,1)" onkeydown="Auth.otpKey(event,1)">
      <input class="otp-inp" maxlength="1" data-idx="2" oninput="Auth.otpNext(this,2)" onkeydown="Auth.otpKey(event,2)">
      <input class="otp-inp" maxlength="1" data-idx="3" oninput="Auth.otpNext(this,3)" onkeydown="Auth.otpKey(event,3)">
      <input class="otp-inp" maxlength="1" data-idx="4" oninput="Auth.otpNext(this,4)" onkeydown="Auth.otpKey(event,4)">
      <input class="otp-inp" maxlength="1" data-idx="5" oninput="Auth.otpNext(this,5)" onkeydown="Auth.otpKey(event,5)">
    </div>
    <button class="btn btn-p btn-w" onclick="Auth.verifyOTP()">Verify & Create Account ‚Üí</button>
    <div style="text-align:center;margin-top:10px">
      <button class="btn btn-xs btn-s" onclick="Auth.resendOTP()" id="btnResend">Resend OTP</button>
      <button class="btn btn-xs btn-s" onclick="Auth.showStep('signup')" style="margin-left:6px">‚Üê Back</button>
    </div>
  </div>
  <div class="auth-ft">
    <h4>üéâ Free Forever</h4>
    <div class="auth-ft-g">
      <span>‚úÖ Unlimited PDFs</span><span>‚úÖ 19 Themes</span>
      <span>‚úÖ Yajman Manager</span><span>‚úÖ Hisab Book</span>
      <span>‚úÖ WhatsApp Share</span><span>‚úÖ Cloud Backup</span>
    </div>
  </div>
</div>
</div>

<!-- APP SHELL -->
<div class="shell" id="appShell" style="display:none">
  <div class="topbar"><div class="topbar-in">
    <div class="brand">
      <div class="brand-icon">üïâÔ∏è</div>
      <div><h1>‡§∂‡•Å‡§≠‡§æ‡§∞‡§Ç‡§≠</h1><small id="topSub">Welcome</small></div>
    </div>
    <div class="top-right">
      <div class="upill" onclick="Nav.go('pgProfile')">
        <div class="ua">üë§</div>
        <span class="un" id="topUser">User</span>
      </div>
    </div>
  </div></div>
  <div class="main">
    <section id="pgHome" class="page on"></section>
    <section id="pgNew" class="page"></section>
    <section id="pgYaj" class="page"></section>
    <section id="pgHisab" class="page"></section>
    <section id="pgLib" class="page"></section>
    <section id="pgDB" class="page"></section>
    <section id="pgProfile" class="page"></section>
  </div>
  <div class="tabbar"><div class="tabbar-in">
    <button class="tab on" data-pg="pgHome" onclick="Nav.go('pgHome')"><span class="ti">üè†</span><span>Home</span></button>
    <button class="tab" data-pg="pgNew" onclick="Nav.go('pgNew')"><span class="ti">‚ûï</span><span>New</span></button>
    <button class="tab" data-pg="pgYaj" onclick="Nav.go('pgYaj')"><span class="ti">üë•</span><span>Yajman</span></button>
    <button class="tab" data-pg="pgHisab" onclick="Nav.go('pgHisab')"><span class="ti">üí∞</span><span>Hisab</span></button>
    <button class="tab" data-pg="pgLib" onclick="Nav.go('pgLib')"><span class="ti">üìö</span><span>Library</span></button>
    <button class="tab" data-pg="pgDB" onclick="Nav.go('pgDB')"><span class="ti">üóÑÔ∏è</span><span>Data</span></button>
    <button class="tab" data-pg="pgProfile" onclick="Nav.go('pgProfile')"><span class="ti">üë§</span><span>Profile</span></button>
  </div></div>
</div>

<div id="renderZone" style="position:absolute;left:-9999px;top:0;z-index:-1"></div>

<!-- ========== BLOCK 1: Password Toggle Global ========== -->
<script>
function togglePV(id,btn){
  var inp=document.getElementById(id);if(!inp)return;
  if(inp.type==='password'){inp.type='text';if(btn){btn.innerHTML='üôà';btn.style.color='var(--bhagwa-light)'}}
  else{inp.type='password';if(btn){btn.innerHTML='üëÅÔ∏è';btn.style.color='var(--g400)'}}
}
</script>

<!-- ========== BLOCK 2: Config ========== -->
<script>
var CFG={
  API:'https://script.google.com/macros/s/AKfycbyuINXuIq-r6wtQ98BoRkFI6SynSSxsNBNXBf8vcYdXDd4SGPSxmjKKYg361SrxPSfo/exec',
  VER:'3.0'
};
</script>

<!-- ========== BLOCK 3: UI Helpers ========== -->
<script>
var UI={
  toast:function(t,m,type){
    var b=document.getElementById('toastBox');
    var ic={ok:'‚úÖ',err:'‚ùå',warn:'‚ö†Ô∏è',info:'‚ÑπÔ∏è'};
    var d=document.createElement('div');d.className='tst '+(type||'info');
    d.innerHTML='<div class="tst-i">'+(ic[type]||'‚ÑπÔ∏è')+'</div><div><div class="tst-t">'+t+'</div>'+(m?'<div class="tst-m">'+m+'</div>':'')+'</div>';
    b.appendChild(d);setTimeout(function(){if(d.parentNode)d.remove()},4500);
  },
  load:function(m){document.getElementById('loaderMsg').textContent=m||'Loading...';document.getElementById('loader').classList.add('on')},
  unload:function(){document.getElementById('loader').classList.remove('on')},
  modal:function(id,s){var e=document.getElementById(id);if(e)e.classList.toggle('on',!!s)},
  $:function(id){return document.getElementById(id)},
  val:function(id){var e=document.getElementById(id);return e?e.value.trim():''},
  setVal:function(id,v){var e=document.getElementById(id);if(e)e.value=v||''},
  html:function(id,h){var e=document.getElementById(id);if(e)e.innerHTML=h}
};
</script>

<!-- ========== BLOCK 4: API Helper ========== -->
<script>
var API={
  user:null,
  get:function(action,params){
    var url=CFG.API+'?action='+action;
    if(this.user)url+='&userId='+this.user.userId;
    if(params){var keys=Object.keys(params);for(var i=0;i<keys.length;i++){if(params[keys[i]]!=null)url+='&'+keys[i]+'='+encodeURIComponent(params[keys[i]])}}
    return fetch(url).then(function(r){if(!r.ok)throw new Error('Network '+r.status);return r.json()});
  },
  post:function(payload){
    if(this.user&&!payload.userId)payload.userId=this.user.userId;
    return fetch(CFG.API,{method:'POST',redirect:'follow',
      headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(payload)
    }).then(function(r){return r.text()}).then(function(t){try{return JSON.parse(t)}catch(e){return{status:t}}})
    .catch(function(e){
      return fetch(CFG.API,{method:'POST',mode:'no-cors',
        headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(payload)
      }).then(function(){return{status:'sent'}});
    });
  }
};
</script>

<!-- ========== BLOCK 5: Auth ========== -->
<script>
var Auth={
  _signupData:{},
  showStep:function(s){
    ['frmLogin','frmSignup','frmOTP'].forEach(function(id){UI.$(id).classList.add('hide')});
    if(s==='login')UI.$('frmLogin').classList.remove('hide');
    else if(s==='signup')UI.$('frmSignup').classList.remove('hide');
    else if(s==='otp')UI.$('frmOTP').classList.remove('hide');
  },
  login:function(){
    var email=UI.val('aEmail'),pass=UI.val('aPass');
    if(!email){UI.toast('Required','Enter email','warn');return}
    if(!pass){UI.toast('Required','Enter password','warn');return}
    UI.load('Logging in...');
    API.post({action:'login',email:email,password:pass}).then(function(r){
      if(r.error){UI.unload();UI.toast('Failed',r.error,'err');return}
      API.user=r;localStorage.setItem('shubh_s',JSON.stringify(r));
      UI.unload();App.enter();UI.toast('Welcome!','‡§®‡§Æ‡§∏‡•ç‡§§‡•á '+r.name,'ok');
    }).catch(function(e){UI.unload();UI.toast('Error','Connection failed','err')});
  },
  sendOTP:function(){
    var name=UI.val('rName'),email=UI.val('rEmail'),pass=UI.val('rPass'),pass2=UI.val('rPass2');
    if(!name){UI.toast('Required','Enter name','warn');return}
    if(!email){UI.toast('Required','Enter email','warn');return}
    if(!pass||pass.length<6){UI.toast('Weak','Min 6 chars','warn');return}
    if(pass!==pass2){UI.toast('Mismatch','Passwords dont match','warn');return}
    this._signupData={name:name,email:email,phone:UI.val('rPhone'),password:pass};
    UI.load('Sending OTP...');
    var self=this;
    API.post({action:'sendOTP',name:name,email:email,phone:UI.val('rPhone'),password:pass}).then(function(r){
      UI.unload();if(r.error){UI.toast('Failed',r.error,'err');return}
      UI.toast('OTP Sent!','Check email','ok');UI.html('otpEmail',email);self.showStep('otp');
      setTimeout(function(){var f=document.querySelector('.otp-inp');if(f)f.focus()},300);
    }).catch(function(e){UI.unload();UI.toast('Error',e.message,'err')});
  },
  resendOTP:function(){
    if(!this._signupData.email){UI.toast('Error','Go back','err');return}
    UI.load('Resending...');
    API.post({action:'sendOTP',name:this._signupData.name,email:this._signupData.email,
      phone:this._signupData.phone,password:this._signupData.password}).then(function(r){
      UI.unload();if(r.error){UI.toast('Failed',r.error,'err');return}UI.toast('Resent!','','ok');
    }).catch(function(e){UI.unload();UI.toast('Error',e.message,'err')});
  },
  otpNext:function(inp,idx){if(inp.value.length===1&&idx<5){var n=document.querySelectorAll('.otp-inp')[idx+1];if(n)n.focus()}},
  otpKey:function(e,idx){
    if(e.key==='Backspace'&&!e.target.value&&idx>0){var p=document.querySelectorAll('.otp-inp')[idx-1];if(p){p.focus();p.value=''}}
    if(e.key==='Enter')this.verifyOTP();
  },
  _getOTP:function(){var inputs=document.querySelectorAll('.otp-inp');var otp='';inputs.forEach(function(i){otp+=i.value});return otp},
  verifyOTP:function(){
    var otp=this._getOTP();if(otp.length!==6){UI.toast('Required','Enter 6 digits','warn');return}
    UI.load('Verifying...');var self=this;
    API.post({action:'verifyOTP',email:self._signupData.email,otp:otp}).then(function(r){
      if(r.error){UI.unload();UI.toast('Failed',r.error,'err');
        document.querySelectorAll('.otp-inp').forEach(function(i){i.value=''});
        var f=document.querySelector('.otp-inp');if(f)f.focus();return}
      API.user=r;localStorage.setItem('shubh_s',JSON.stringify(r));
      UI.unload();App.enter();UI.toast('üéâ Welcome!','Account created','ok');
    }).catch(function(e){UI.unload();UI.toast('Error',e.message,'err')});
  },
  checkSession:function(){try{var d=JSON.parse(localStorage.getItem('shubh_s'));if(d&&d.userId){API.user=d;return true}}catch(e){}return false},
  logout:function(){localStorage.removeItem('shubh_s');API.user=null;
    UI.$('appShell').style.display='none';UI.$('authScreen').classList.remove('hide');UI.toast('Logged Out','üôè','ok')}
};
</script>

<!-- ========== BLOCK 6: Navigation ========== -->
<script>
var Nav={
  cur:'pgHome',
  go:function(pg){
    document.querySelectorAll('.page').forEach(function(p){p.classList.remove('on')});
    var el=UI.$(pg);if(el)el.classList.add('on');
    document.querySelectorAll('.tab').forEach(function(t){t.classList.toggle('on',t.dataset.pg===pg)});
    window.scrollTo({top:0,behavior:'smooth'});
    this.cur=pg;
    if(PG[pg])PG[pg]();
  }
};
</script>

<!-- ========== BLOCK 7: App Core ========== -->
<script>
var App={
  D:{master:[],templates:[],yajmans:[],hisab:[],stats:{},pending:[]},
  init:function(){if(Auth.checkSession())this.enter()},
  enter:function(){
    UI.$('authScreen').classList.add('hide');UI.$('appShell').style.display='block';
    var u=API.user;UI.html('topUser',u.name||'User');
    UI.html('topSub',(u.pandit&&u.pandit.name)||u.name||'Welcome');
    this.loadAll();
  },
  loadAll:function(){
    var self=this;UI.load('Loading data...');
    Promise.allSettled([
      API.get('getMaster'),API.get('getTemplates'),API.get('getYajmans'),API.get('getStats')
    ]).then(function(r){
      if(r[0].status==='fulfilled'&&Array.isArray(r[0].value))self.D.master=r[0].value;
      if(r[1].status==='fulfilled'&&Array.isArray(r[1].value))self.D.templates=r[1].value;
      if(r[2].status==='fulfilled'&&Array.isArray(r[2].value))self.D.yajmans=r[2].value;
      if(r[3].status==='fulfilled'&&r[3].value)self.D.stats=r[3].value;
      UI.unload();self.buildAndRender();
    }).catch(function(e){console.error(e);UI.unload();self.buildAndRender()});
  },
  buildAndRender:function(){
    var keys=Object.keys(PG_BUILD);
    for(var i=0;i<keys.length;i++){try{PG_BUILD[keys[i]]()}catch(e){console.error('Build '+keys[i],e)}}
    Nav.go(Nav.cur);
  },
  refresh:function(){
    var self=this;UI.load('Refreshing...');
    return Promise.allSettled([
      API.get('getMaster'),API.get('getTemplates'),API.get('getYajmans'),API.get('getStats')
    ]).then(function(r){
      if(r[0].status==='fulfilled'&&Array.isArray(r[0].value))self.D.master=r[0].value;
      if(r[1].status==='fulfilled'&&Array.isArray(r[1].value))self.D.templates=r[1].value;
      if(r[2].status==='fulfilled'&&Array.isArray(r[2].value))self.D.yajmans=r[2].value;
      if(r[3].status==='fulfilled'&&r[3].value)self.D.stats=r[3].value;
      UI.unload();self.buildAndRender();UI.toast('Done','Refreshed ‚úÖ','ok');
    }).catch(function(e){UI.unload();console.error(e)});
  },
  esc:function(s){return(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')},
  fmt$:function(n){n=parseFloat(n)||0;if(n>=100000)return'‚Çπ'+(n/100000).toFixed(1)+'L';if(n>=1000)return'‚Çπ'+(n/1000).toFixed(1)+'K';return'‚Çπ'+n.toLocaleString('en-IN')},
  fmtD:function(d){if(!d)return'-';try{var dt=new Date(d);if(isNaN(dt))return d;return dt.getDate().toString().padStart(2,'0')+'/'+(dt.getMonth()+1).toString().padStart(2,'0')+'/'+dt.getFullYear()}catch(e){return d}},
  uPoojas:function(){var s={};for(var i=0;i<this.D.master.length;i++){var p=this.D.master[i].pooja;if(p)s[p.trim()]=1}return Object.keys(s).sort()}
};
document.addEventListener('DOMContentLoaded',function(){App.init()});
document.addEventListener('keydown',function(e){
  if(e.key==='Enter'&&UI.$('authScreen')&&!UI.$('authScreen').classList.contains('hide')){
    if(!UI.$('frmLogin').classList.contains('hide'))Auth.login();}
});
</script>

<!-- ========== BLOCK 8: Utilities + Categories + PDF ========== -->
<script>
var HISAB_CATEGORIES={
  income:[{id:'dakshina',label:'‡§¶‡§ï‡•ç‡§∑‡§ø‡§£‡§æ',icon:'üôè'},{id:'chadawa',label:'‡§ö‡§¢‡§º‡§æ‡§µ‡§æ',icon:'ü™∑'},{id:'donation',label:'‡§¶‡§æ‡§®',icon:'üíù'},{id:'other_income',label:'‡§Ö‡§®‡•ç‡§Ø ‡§Ü‡§Ø',icon:'üí∞'}],
  expense:[{id:'saman',label:'‡§∏‡§æ‡§Æ‡§æ‡§® ‡§ñ‡§∞‡•ç‡§ö',icon:'üì¶'},{id:'other_panji',label:'‡§Ö‡§®‡•ç‡§Ø ‡§™‡§Ç‡§ú‡•Ä ‡§ï‡•ã ‡§¶‡§ø‡§Ø‡•á',icon:'üë®‚Äçüè´'},{id:'temple',label:'‡§Æ‡§Ç‡§¶‡§ø‡§∞ ‡§Æ‡•á‡§Ç ‡§¶‡§ø‡§Ø‡•á',icon:'üõï'},{id:'travel',label:'‡§Ø‡§æ‡§§‡•ç‡§∞‡§æ ‡§ñ‡§∞‡•ç‡§ö',icon:'üöó'},{id:'prasad',label:'‡§™‡•ç‡§∞‡§∏‡§æ‡§¶',icon:'üç≤'},{id:'other_expense',label:'‡§Ö‡§®‡•ç‡§Ø ‡§ñ‡§∞‡•ç‡§ö',icon:'üì§'}]
};
var PDFWatermark={
  shouldAdd:function(){return!(API.user&&(API.user.plan==='paid'||API.user.plan==='premium'||API.user.plan==='pro'))},
  addToCanvas:function(ctx,w,h){if(!this.shouldAdd())return;ctx.save();ctx.globalAlpha=0.08;ctx.font='bold 48px Arial';ctx.fillStyle='#FF6F00';ctx.translate(w/2,h/2);ctx.rotate(-45*Math.PI/180);ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('‡§∂‡•Å‡§≠‡§æ‡§∞‡§Ç‡§≠ FREE',0,-40);ctx.fillText('SHUBHARAMBH',0,40);ctx.restore()}
};
var PDFGen={
  getPanditInfo:function(){var u=API.user||{};var p=(u.pandit)||{};return{name:p.name||u.name||'',title:p.title||'',phone:p.phone||u.phone||'',address:p.address||'',website:p.website||'',tagline:p.tagline||'',email:u.email||''}},
  _e:function(s){return(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')},
  buildHeader:function(){var p=this.getPanditInfo();var h='<div style="text-align:center;border-bottom:3px solid #FF6F00;padding-bottom:10px;margin-bottom:12px">';h+='<div style="font-size:12px;color:#FF6F00;letter-spacing:4px;margin-bottom:4px">‡•• ‡§∂‡•ç‡§∞‡•Ä ‡§ó‡§£‡•á‡§∂‡§æ‡§Ø ‡§®‡§Æ‡§É ‡••</div>';if(p.name)h+='<div style="font-size:20px;font-weight:800;color:#FF6F00">'+this._e(p.name)+'</div>';if(p.title)h+='<div style="font-size:11px;color:#666">'+this._e(p.title)+'</div>';if(p.tagline)h+='<div style="font-size:10px;color:#999;font-style:italic">„Äå'+this._e(p.tagline)+'„Äç</div>';var c=[];if(p.phone)c.push('üìû '+p.phone);if(p.website)c.push('üåê '+p.website);if(c.length)h+='<div style="font-size:9px;color:#888">'+c.join(' | ')+'</div>';h+='</div>';return h},
  buildFooter:function(pg,tot){var p=this.getPanditInfo();var ip=!PDFWatermark.shouldAdd();var f='<div style="border-top:2px solid #FF6F00;padding-top:8px;margin-top:12px;text-align:center">';if(p.name)f+='<div style="font-size:10px;font-weight:600;color:#FF6F00">'+this._e(p.name)+'</div>';if(p.address)f+='<div style="font-size:8px;color:#888">üìç '+this._e(p.address)+'</div>';var c=[];if(p.phone)c.push('üìû '+p.phone);if(p.website)c.push('üåê '+p.website);if(c.length)f+='<div style="font-size:8px;color:#888">'+c.join(' | ')+'</div>';if(pg)f+='<div style="font-size:8px;color:#999;margin-top:4px">Page '+pg+(tot?'/'+tot:'')+'</div>';if(!ip)f+='<div style="font-size:7px;color:#FF6F00;margin-top:4px;background:rgba(255,111,0,0.08);padding:2px 6px;border-radius:3px;display:inline-block">Generated by ‡§∂‡•Å‡§≠‡§æ‡§∞‡§Ç‡§≠ Free</div>';f+='</div>';return f}
};
/* Pull to refresh */
(function(){var sy=0,pl=false,th=80;
document.addEventListener('touchstart',function(e){if(window.scrollY===0){sy=e.touches[0].clientY;pl=true}},{passive:true});
document.addEventListener('touchmove',function(e){if(!pl)return;var d=e.touches[0].clientY-sy;if(d>0&&d<150){var i=UI.$('pullInd');if(i){i.style.maxHeight=Math.min(d,60)+'px';i.style.padding=d>20?'8px 0':'0';var t=UI.$('pullTxt');if(t)t.textContent=d>th?'Release...':'Pull down...'}}},{passive:true});
document.addEventListener('touchend',function(){if(!pl)return;pl=false;var i=UI.$('pullInd');if(i){var h=parseInt(i.style.maxHeight)||0;if(h>=th){App.refresh().then(function(){setTimeout(function(){if(i){i.style.maxHeight='0';i.style.padding='0'}},600)})}else{i.style.maxHeight='0';i.style.padding='0'}}},{passive:true});
})();
document.addEventListener('visibilitychange',function(){if(!document.hidden&&API.user)App.refresh()});
</script>

<!-- ========== BLOCK 9: Page Builders (HTML Structure) ========== -->
<script>
var PG_BUILD={
  pgHome:function(){
    UI.html('pgHome',
      '<div class="pg-head"><h2 class="pg-title">üè† Dashboard</h2><p class="pg-sub" id="hGreet">Welcome!</p></div>'
      +'<div id="pullInd" style="text-align:center;padding:0;overflow:hidden;max-height:0;transition:max-height .3s ease,padding .3s ease"><div style="display:inline-flex;align-items:center;gap:6px;color:var(--bhagwa-light);font-size:.8rem"><span style="display:inline-block;width:18px;height:18px;border:2px solid rgba(255,111,0,0.2);border-top-color:var(--bhagwa);border-radius:50%;animation:spin .6s linear infinite"></span><span id="pullTxt">Refreshing...</span></div></div>'
      +'<div class="stats"><div class="stat" onclick="Nav.go(\'pgYaj\')"><div class="stat-i">üë•</div><div class="stat-v" id="sY">0</div><div class="stat-l">Yajmans</div></div><div class="stat" onclick="Nav.go(\'pgDB\')"><div class="stat-i">üïâÔ∏è</div><div class="stat-v" id="sP">0</div><div class="stat-l">Poojas</div></div><div class="stat" onclick="Nav.go(\'pgLib\')"><div class="stat-i">üìÑ</div><div class="stat-v" id="sT">0</div><div class="stat-l">Templates</div></div><div class="stat" onclick="Nav.go(\'pgHisab\')"><div class="stat-i">üí∞</div><div class="stat-v" id="sM">‚Çπ0</div><div class="stat-l">This Month</div></div></div>'
      +'<div class="card"><div class="card-h"><h3 class="card-t">‚ö° Quick Actions</h3></div><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px"><button class="btn btn-p" onclick="Nav.go(\'pgNew\')">‚ûï New Pooja</button><button class="btn btn-s" onclick="Nav.go(\'pgYaj\')">üë• Yajmans</button><button class="btn btn-s" onclick="Nav.go(\'pgHisab\')">üí∞ Hisab</button><button class="btn btn-s" onclick="Nav.go(\'pgDB\')">üóÑÔ∏è Database</button></div></div>'
      +'<div class="card"><div class="card-h"><h3 class="card-t">üìä Monthly Overview</h3></div><div class="h-summary" style="margin-bottom:0"><div class="h-card inc"><div class="h-val green" id="hMI">‚Çπ0</div><div class="h-lbl">Income</div></div><div class="h-card exp"><div class="h-val red" id="hME">‚Çπ0</div><div class="h-lbl">Expense</div></div><div class="h-card pend"><div class="h-val yellow" id="hMP">‚Çπ0</div><div class="h-lbl">Pending</div></div><div class="h-card prof"><div class="h-val orange" id="hMPr">‚Çπ0</div><div class="h-lbl">Profit</div></div></div></div>'
      +'<div class="card" id="hPendCard" style="display:none"><div class="card-h"><h3 class="card-t">‚ö†Ô∏è Pending Dues</h3><button class="btn btn-xs btn-s" onclick="Nav.go(\'pgHisab\')">View All</button></div><div id="hPendList"></div></div>'
      +'<div class="card"><div class="card-h"><h3 class="card-t">üë• Recent Yajmans</h3><button class="btn btn-xs btn-s" onclick="Nav.go(\'pgYaj\')">View All</button></div><div id="hRecent"></div></div>'
    );
  },
  pgYaj:function(){
    UI.html('pgYaj','<div class="pg-head"><h2 class="pg-title">üë• Yajman Management</h2><p class="pg-sub">Manage clients</p></div><div class="card"><div class="card-h"><h3 class="card-t">üìã All Yajmans</h3><button class="btn btn-sm btn-p" onclick="YajPage.showAdd()">‚ûï Add</button></div><input class="fi" id="yajSrch" placeholder="üîç Search..." oninput="YajPage.render()" style="margin-bottom:10px"><div id="yajList"></div></div>');
  },
  pgHisab:function(){
    UI.html('pgHisab',
      '<div class="pg-head"><h2 class="pg-title">üí∞ Hisab Book</h2><p class="pg-sub">Per-pooja accounting</p></div><div id="hSummary"></div>'
      +'<div class="card"><div class="card-h"><h3 class="card-t">üïâÔ∏è Pooja-wise Hisab</h3><div style="display:flex;gap:4px;flex-wrap:wrap"><button class="btn btn-xs btn-p" onclick="HisabPage.showAddPooja()">‚ûï Pooja Entry</button><button class="btn btn-xs btn-s" onclick="HisabPage.downloadHisabPDF()">üìÑ PDF</button></div></div>'
      +'<div style="padding:6px 10px;background:rgba(255,111,0,0.06);border-radius:var(--r-sm);margin-bottom:10px;border-left:3px solid var(--bhagwa);font-size:.68rem;color:var(--bhagwa-light)">üìå Each pooja: Income (‡§¶‡§ï‡•ç‡§∑‡§ø‡§£‡§æ,‡§ö‡§¢‡§º‡§æ‡§µ‡§æ) + Expenses (‡§∏‡§æ‡§Æ‡§æ‡§®,‡§Ö‡§®‡•ç‡§Ø ‡§™‡§Ç‡§ú‡•Ä,‡§Æ‡§Ç‡§¶‡§ø‡§∞)</div>'
      +'<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px"><input class="fi" id="hPoojaSearch" placeholder="üîç Search..." oninput="HisabPage.renderByPooja()" style="flex:1;min-width:120px"><select class="fsel" id="hPoojaMonth" onchange="HisabPage.renderByPooja()" style="width:auto;min-width:90px"><option value="all">All Time</option><option value="thisMonth">This Month</option><option value="lastMonth">Last Month</option><option value="thisYear">This Year</option></select></div>'
      +'<div id="hByPooja"></div></div>'
      +'<div class="card"><div class="card-h"><h3 class="card-t">üìã All Transactions</h3><div style="display:flex;gap:4px"><button class="btn btn-xs btn-g" onclick="HisabPage.showAddSingle(\'income\')">‚ûï Income</button><button class="btn btn-xs btn-d" onclick="HisabPage.showAddSingle(\'expense\')">‚ûï Expense</button></div></div>'
      +'<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px"><select class="fsel" id="hFType" onchange="HisabPage.renderList()" style="width:auto;min-width:80px"><option value="all">All</option><option value="income">Income</option><option value="expense">Expense</option></select><select class="fsel" id="hFStatus" onchange="HisabPage.renderList()" style="width:auto;min-width:80px"><option value="all">All</option><option value="paid">Paid</option><option value="pending">Pending</option></select><select class="fsel" id="hFCat" onchange="HisabPage.renderList()" style="width:auto;min-width:80px"><option value="all">All Cat</option><option value="dakshina">‡§¶‡§ï‡•ç‡§∑‡§ø‡§£‡§æ</option><option value="chadawa">‡§ö‡§¢‡§º‡§æ‡§µ‡§æ</option><option value="saman">‡§∏‡§æ‡§Æ‡§æ‡§®</option><option value="other_panji">‡§Ö‡§®‡•ç‡§Ø ‡§™‡§Ç‡§ú‡•Ä</option><option value="temple">‡§Æ‡§Ç‡§¶‡§ø‡§∞</option></select><input class="fi" id="hFSearch" placeholder="üîç" oninput="HisabPage.renderList()" style="flex:1;min-width:80px"></div><div id="hList"></div></div>'
    );
  },
  pgDB:function(){
    UI.html('pgDB','<div class="pg-head"><h2 class="pg-title">üóÑÔ∏è Database</h2><p class="pg-sub">Pooja & samagri data</p></div><div class="card"><div class="card-h"><h3 class="card-t">üìä Stats</h3><button class="btn btn-sm btn-p" onclick="DBPage.showAdd()">‚ûï Add</button></div><div class="stats" style="margin-bottom:10px"><div class="stat"><div class="stat-v" id="dbP">0</div><div class="stat-l">Poojas</div></div><div class="stat"><div class="stat-v" id="dbI">0</div><div class="stat-l">Items</div></div><div class="stat"><div class="stat-v" id="dbC">0</div><div class="stat-l">Custom</div></div></div><input class="fi" id="dbSrch" placeholder="üîç Search..." oninput="DBPage.render()" style="margin-bottom:10px"><div id="dbList" style="max-height:55vh;overflow:auto"></div></div>');
  },
  pgLib:function(){
    UI.html('pgLib','<div class="pg-head"><h2 class="pg-title">üìö Saved Templates</h2><p class="pg-sub">Cloud-saved lists</p></div><div class="card"><input class="fi" id="libSrch" placeholder="üîç Search..." oninput="LibPage.render()"></div><div id="libGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(270px,1fr));gap:12px"></div>');
  },
  pgNew:function(){
    var pn='';try{pn=App.esc((API.user.pandit&&API.user.pandit.name)||API.user.name||'')}catch(e){}
    var td='';try{td=new Date().toISOString().split('T')[0]}catch(e){}
    UI.html('pgNew',
      '<div class="pg-head"><h2 class="pg-title">‚ûï New Pooja Setup</h2><p class="pg-sub">'+App.uPoojas().length+' poojas available</p></div>'
      +'<div class="card"><div class="card-h"><h3 class="card-t">üë§ Yajman</h3><button class="btn btn-xs btn-s" onclick="NewPooja.pickYajman()">üìã Saved</button></div><div class="fi-row"><div class="fg"><label class="fl">Name *</label><input class="fi" id="npYajman" placeholder="‡§Ø‡§ú‡§Æ‡§æ‡§®"></div><div class="fg"><label class="fl">Phone</label><input class="fi" id="npPhone" type="tel" placeholder="Phone"></div></div><div class="fg"><label class="fl">Address</label><input class="fi" id="npAddr" placeholder="‡§™‡§§‡§æ"></div><div class="fi-row"><div class="fg"><label class="fl">Date</label><input class="fi" id="npDate" type="date" value="'+td+'"></div><div class="fg"><label class="fl">Pandit</label><input class="fi" id="npPandit" value="'+pn+'" readonly style="opacity:.7"></div></div></div>'
      +'<div class="card"><div class="card-h"><h3 class="card-t">üïâÔ∏è Select Poojas</h3><div style="display:flex;gap:4px"><button class="btn btn-xs btn-s" onclick="NewPooja.selAll()">All</button><button class="btn btn-xs btn-s" onclick="NewPooja.selNone()">Clear</button><span style="font-size:.78rem;color:var(--bhagwa-light);padding:4px 8px" id="npSelCount">0</span></div></div><input class="fi" id="npPSearch" placeholder="üîç Search..." oninput="NewPooja.drawPoojas()" style="margin-bottom:10px"><div id="npPoojaList" style="max-height:40vh;overflow-y:auto"></div></div>'
      +'<button class="btn btn-p btn-w" onclick="NewPooja.goToMaterials()" id="npNextBtn">Next: Materials ‚Üí</button>'
      +'<div id="npMatsWrap" class="hide" style="margin-top:14px"><div class="card"><div class="card-h"><h3 class="card-t">üì¶ Materials</h3><input class="fi" id="npMatSearch" placeholder="üîç" oninput="NewPooja.drawMats()" style="width:140px;padding:6px 10px;font-size:.8rem"></div><div id="npMatSections"></div></div><div class="card"><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px"><button class="btn btn-g btn-w" onclick="NewPooja.saveCloud()">üíæ Save</button><button class="btn btn-p btn-w" onclick="NewPooja.goToPreview()">üìÑ Preview ‚Üí</button></div></div></div>'
      +'<div id="npPreviewWrap" class="hide" style="margin-top:14px"><div class="card"><div class="card-h"><h3 class="card-t">üìÑ Preview</h3><button class="btn btn-xs btn-s" onclick="NewPooja.buildPreview()">üîÑ</button></div><div id="npPreview" style="background:#d0d0d0;border-radius:var(--r-md);padding:12px;max-height:60vh;overflow:auto"><p style="color:#666;text-align:center;padding:20px">Click üîÑ</p></div></div><div class="card"><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px"><button class="btn btn-p btn-w" onclick="NewPooja.dlPDF()">üìÑ PDF</button><button class="btn btn-g btn-w" onclick="NewPooja.dlImages()">üñºÔ∏è Images</button><button class="btn btn-s btn-w" onclick="NewPooja.share()">üì§ Share</button><button class="btn btn-s btn-w" onclick="NewPooja.addToHisab()">üí∞ Hisab</button></div></div></div>'
    );
  },
  pgProfile:function(){
    var u=API.user||{};var p=(u.pandit)||{};var ip=u.plan==='paid'||u.plan==='premium'||u.plan==='pro';
    UI.html('pgProfile',
      '<div class="pg-head"><h2 class="pg-title">üë§ Profile</h2><p class="pg-sub">Settings</p></div>'
      +'<div class="card" style="text-align:center"><div style="width:70px;height:70px;border-radius:50%;background:var(--grad-b);display:grid;place-items:center;font-size:2.2rem;margin:0 auto 10px">üôè</div><h3 style="color:#fff">'+App.esc(u.name||'')+'</h3><p style="color:var(--g500);font-size:.8rem">'+App.esc(u.email||'')+'</p><span class="badge '+(ip?'badge-ok':'badge-warn')+'" style="margin-top:6px">'+String(u.plan||'free').toUpperCase()+'</span></div>'
      +'<div class="card"><div class="card-h"><h3 class="card-t">üôè Pandit Profile (PDF)</h3></div><div style="padding:6px 10px;background:rgba(255,111,0,0.06);border-radius:var(--r-sm);margin-bottom:10px;border-left:3px solid var(--bhagwa);font-size:.68rem;color:var(--bhagwa-light)">üìå Appears on PDF header & footer</div><div class="fg"><label class="fl">Name</label><input class="fi" id="prN" value="'+App.esc(p.name||u.name||'')+'"></div><div class="fg"><label class="fl">Title</label><input class="fi" id="prT" value="'+App.esc(p.title||'')+'"></div><div class="fi-row"><div class="fg"><label class="fl">Phone</label><input class="fi" id="prP" value="'+App.esc(p.phone||u.phone||'')+'"></div><div class="fg"><label class="fl">Website</label><input class="fi" id="prW" value="'+App.esc(p.website||'')+'"></div></div><div class="fg"><label class="fl">Address</label><input class="fi" id="prA" value="'+App.esc(p.address||'')+'"></div><div class="fg"><label class="fl">Tagline</label><input class="fi" id="prTag" value="'+App.esc(p.tagline||'')+'"></div><button class="btn btn-p btn-w" onclick="ProfilePage.save()">üíæ Save</button></div>'
      +'<div class="card"><div class="card-h"><h3 class="card-t">üìÑ PDF Preview</h3><button class="btn btn-xs btn-s" onclick="ProfilePage.previewPDF()">üëÅÔ∏è</button></div><div id="prPDFPreview" style="background:rgba(255,255,255,0.03);border-radius:var(--r-sm);padding:14px;min-height:60px"><p style="color:var(--g500);font-size:.8rem;text-align:center">Click üëÅÔ∏è</p></div></div>'
      +'<div class="card"><div class="card-h"><h3 class="card-t">üîê Change Password</h3></div><div class="fg"><label class="fl">Current</label><div style="position:relative"><input class="fi" id="prCurPass" type="password" placeholder="Current" style="padding-right:44px"><button type="button" onclick="togglePV(\'prCurPass\',this)" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--g400);cursor:pointer;font-size:1.1rem;padding:4px">üëÅÔ∏è</button></div></div><div class="fg"><label class="fl">New (min 6)</label><div style="position:relative"><input class="fi" id="prNewPass" type="password" placeholder="New" style="padding-right:44px"><button type="button" onclick="togglePV(\'prNewPass\',this)" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--g400);cursor:pointer;font-size:1.1rem;padding:4px">üëÅÔ∏è</button></div></div><div class="fg"><label class="fl">Confirm</label><div style="position:relative"><input class="fi" id="prNewPass2" type="password" placeholder="Confirm" style="padding-right:44px"><button type="button" onclick="togglePV(\'prNewPass2\',this)" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--g400);cursor:pointer;font-size:1.1rem;padding:4px">üëÅÔ∏è</button></div></div><button class="btn btn-p btn-w" onclick="ProfilePage.changePassword()">üîë Change</button></div>'
      +'<div class="card"><button class="btn btn-s btn-w" onclick="ProfilePage.backup()" style="margin-bottom:8px">üíæ Backup</button><button class="btn btn-d btn-w" onclick="Auth.logout()">üö™ Logout</button></div>'
      +'<div style="text-align:center;padding:14px;color:var(--g600);font-size:.7rem">‡§∂‡•Å‡§≠‡§æ‡§∞‡§Ç‡§≠ v'+CFG.VER+'</div>'
    );
  }
};
</script>

<!-- BLOCK 10: Yajman System (COMPLETE REWRITE - ALL BUTTONS FIXED) -->
<script>
window.YajPage={

  render:function(){
    var list=App.D.yajmans||[];

    /* Update stats */
    var active=0;var inactive=0;var revenue=0;
    for(var i=0;i<list.length;i++){
      if(list[i].status==='inactive')inactive++;else active++;
      revenue+=parseFloat(list[i].totalAmount)||0;
    }
    var totalEl=document.getElementById('yajTotal');if(totalEl)totalEl.textContent=list.length;
    var activeEl=document.getElementById('yajActive');if(activeEl)activeEl.textContent=active;
    var inactiveEl=document.getElementById('yajInactive');if(inactiveEl)inactiveEl.textContent=inactive;
    var revEl=document.getElementById('yajRevenue');if(revEl)revEl.textContent=App.fmt$(revenue);

    var el=document.getElementById('yajList');if(!el)return;

    /* Filters */
    var q='';try{q=(UI.val('yajSrch')||'').toLowerCase()}catch(e){}
    var fStatus='all';try{fStatus=UI.val('yajFStatus')||'all'}catch(e){}

    var filtered=list.slice();

    if(fStatus!=='all'){
      filtered=filtered.filter(function(y){
        if(fStatus==='active')return y.status!=='inactive';
        return y.status==='inactive';
      });
    }

    if(q){
      filtered=filtered.filter(function(y){
        return String(y.name||'').toLowerCase().indexOf(q)!==-1||
          String(y.phone||'').indexOf(q)!==-1||
          String(y.city||'').toLowerCase().indexOf(q)!==-1||
          String(y.gotra||'').toLowerCase().indexOf(q)!==-1;
      });
    }

    if(!filtered.length){
      el.innerHTML='<div style="text-align:center;padding:30px">'
        +'<div style="font-size:2.5rem;margin-bottom:10px">üë•</div>'
        +'<p style="color:var(--g500);margin-bottom:12px">'+(q||fStatus!=='all'?'No matches found':'No yajmans yet')+'</p>'
        +(!q?'<button class="btn btn-sm btn-p" onclick="window.YajPage.showAdd()">‚ûï Add First Yajman</button>':'')
        +'</div>';
      return;
    }

    var html='';
    for(var i=0;i<filtered.length;i++){
      var y=filtered[i];
      var ph=String(y.phone||'').replace(/[^0-9]/g,'');
      var wa=String(y.whatsapp||y.phone||'').replace(/[^0-9]/g,'');
      var stClass=y.status==='inactive'?'badge-err':'badge-ok';
      var yid=y.id;

      html+='<div class="lrow" style="cursor:pointer" onclick="window.YajPage.showDetail(\''+yid+'\')">'
        +'<div class="lrow-i" style="background:var(--grad-b)">üë§</div>'
        +'<div class="lrow-b">'
        +'<div class="lrow-n">'+App.esc(y.name)+' <span class="badge '+stClass+'">'+(y.status||'active')+'</span></div>'
        +'<div class="lrow-m">'
        +(y.phone?'üìû '+String(y.phone):'')
        +(y.city?' ‚Ä¢ üìç '+App.esc(y.city):'')
        +(y.gotra?' ‚Ä¢ üî± '+App.esc(y.gotra):'')
        +'</div></div>'
        +'<div class="lrow-r">'
        +'<div style="font-weight:800;color:var(--bhagwa-light)">'+App.fmt$(y.totalAmount)+'</div>'
        +'<div style="font-size:.65rem;color:var(--g500)">'+(y.totalPoojas||0)+' poojas</div>'
        +'</div>'
        +'<div class="lrow-a" onclick="event.stopPropagation()">';
      if(ph)html+='<button class="btn btn-xs btn-s" onclick="window.YajPage.callNum(\''+ph+'\')" title="Call">üìû</button>';
      if(wa)html+='<button class="btn btn-xs btn-g" onclick="window.YajPage.waNum(\''+wa+'\')" title="WhatsApp">üí¨</button>';
      html+='<button class="btn btn-xs btn-s" onclick="window.YajPage.showDetail(\''+yid+'\')" title="View">üëÅÔ∏è</button>';
      html+='</div></div>';
    }
    el.innerHTML=html;
  },

  callNum:function(ph){
    if(!ph)return;
    try{window.location.href='tel:+91'+ph}catch(e){window.open('tel:+91'+ph)}
  },

  waNum:function(ph,msg){
    if(!ph)return;
    var url='https://wa.me/91'+ph;
    if(msg)url+='?text='+encodeURIComponent(msg);
    window.open(url,'_blank');
  },

  sendReminder:function(yajId){
    var y=this._find(yajId);if(!y)return;
    var wa=String(y.whatsapp||y.phone||'').replace(/[^0-9]/g,'');
    if(!wa){UI.toast('Error','No phone number','err');return}
    var pandit=(API.user&&API.user.pandit&&API.user.pandit.name)||(API.user&&API.user.name)||'';
    var msg='üôè ‡§®‡§Æ‡§∏‡•ç‡§§‡•á '+String(y.name)+' ‡§ú‡•Ä,\n\n'
      +'‡§Ü‡§™‡§ï‡•Ä ‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§∞‡§æ‡§∂‡§ø ‚Çπ'+(y.totalAmount||0)+' ‡§π‡•à‡•§\n'
      +'‡§ï‡•É‡§™‡§Ø‡§æ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡§∞‡•á‡§Ç‡•§\n\n'
      +'‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶ üôè\n'+pandit;
    this.waNum(wa,msg);
  },

  _find:function(id){
    for(var i=0;i<App.D.yajmans.length;i++){
      if(App.D.yajmans[i].id===id)return App.D.yajmans[i];
    }
    return null;
  },

  showAdd:function(editData){
    var old=document.getElementById('mYaj');if(old)old.remove();
    var m=document.createElement('div');m.id='mYaj';m.className='modal';document.body.appendChild(m);

    var d=editData||{};
    var isEdit=!!(d.id);

    var rashis=['‡§Æ‡•á‡§∑','‡§µ‡•É‡§∑‡§≠','‡§Æ‡§ø‡§•‡•Å‡§®','‡§ï‡§∞‡•ç‡§ï','‡§∏‡§ø‡§Ç‡§π','‡§ï‡§®‡•ç‡§Ø‡§æ','‡§§‡•Å‡§≤‡§æ','‡§µ‡•É‡§∂‡•ç‡§ö‡§ø‡§ï','‡§ß‡§®‡•Å','‡§Æ‡§ï‡§∞','‡§ï‡•Å‡§Ç‡§≠','‡§Æ‡•Ä‡§®'];
    var rashiOpts='<option value="">‚Äî Select ‚Äî</option>';
    for(var i=0;i<rashis.length;i++){
      rashiOpts+='<option'+(d.rashi===rashis[i]?' selected':'')+'>'+rashis[i]+'</option>';
    }

    m.innerHTML='<div class="modal-box">'
      +'<div class="modal-h"><h3 class="modal-t">'+(isEdit?'‚úèÔ∏è Edit':'‚ûï Add')+' Yajman</h3>'
      +'<button class="modal-x" onclick="document.getElementById(\'mYaj\').classList.remove(\'on\')">√ó</button></div>'
      +'<div class="modal-b">'
      +'<input type="hidden" id="yId" value="'+(d.id||'')+'">'

      +'<div class="fg"><label class="fl">Name *</label>'
      +'<input class="fi" id="yN" value="'+App.esc(d.name||'')+'" placeholder="‡§Ø‡§ú‡§Æ‡§æ‡§® ‡§ï‡§æ ‡§®‡§æ‡§Æ"></div>'

      +'<div class="fi-row">'
      +'<div class="fg"><label class="fl">Phone</label>'
      +'<input class="fi" id="yP" value="'+App.esc(String(d.phone||''))+'" type="tel" placeholder="9876543210"></div>'
      +'<div class="fg"><label class="fl">WhatsApp</label>'
      +'<input class="fi" id="yW" value="'+App.esc(String(d.whatsapp||''))+'" type="tel" placeholder="Same or different"></div>'
      +'</div>'

      +'<div class="fg"><label class="fl">Address</label>'
      +'<input class="fi" id="yAddr" value="'+App.esc(d.address||'')+'" placeholder="‡§™‡•Ç‡§∞‡§æ ‡§™‡§§‡§æ"></div>'

      +'<div class="fi-row">'
      +'<div class="fg"><label class="fl">City</label>'
      +'<input class="fi" id="yCity" value="'+App.esc(d.city||'')+'" placeholder="‡§∂‡§π‡§∞"></div>'
      +'<div class="fg"><label class="fl">Gotra</label>'
      +'<input class="fi" id="yG" value="'+App.esc(d.gotra||'')+'" placeholder="‡§ó‡•ã‡§§‡•ç‡§∞"></div>'
      +'</div>'

      +'<div class="fi-row">'
      +'<div class="fg"><label class="fl">Rashi</label><select class="fsel" id="yR">'+rashiOpts+'</select></div>'
      +'<div class="fg"><label class="fl">Status</label><select class="fsel" id="ySt">'
      +'<option value="active"'+((d.status||'active')==='active'?' selected':'')+'>Active</option>'
      +'<option value="inactive"'+(d.status==='inactive'?' selected':'')+'>Inactive</option>'
      +'</select></div>'
      +'</div>'

      +'<div class="fg"><label class="fl">Notes</label>'
      +'<textarea class="ftx" id="yNt" placeholder="‡§µ‡§ø‡§∂‡•á‡§∑ ‡§ü‡§ø‡§™‡•ç‡§™‡§£‡•Ä">'+App.esc(d.notes||'')+'</textarea></div>'

      +'</div>'
      +'<div class="modal-f">'
      +'<button class="btn btn-s" onclick="document.getElementById(\'mYaj\').classList.remove(\'on\')">Cancel</button>'
      +'<button class="btn btn-p" onclick="window.YajPage.save()">üíæ '+(isEdit?'Update':'Save')+'</button>'
      +'</div></div>';

    m.classList.add('on');
  },

  save:function(){
    var nameEl=document.getElementById('yN');
    var name=nameEl?nameEl.value.trim():'';
    if(!name){UI.toast('Required','Enter name','warn');return}

    var idEl=document.getElementById('yId');
    var id=idEl?idEl.value.trim():'';

    document.getElementById('mYaj').classList.remove('on');
    UI.load(id?'Updating...':'Saving...');

    var self=this;
    var payload={
      action:id?'updateYajman':'addYajman',
      name:name,
      phone:UI.val('yP'),
      whatsapp:UI.val('yW')||UI.val('yP'),
      address:UI.val('yAddr'),
      city:UI.val('yCity'),
      gotra:UI.val('yG'),
      rashi:UI.val('yR'),
      notes:UI.val('yNt'),
      status:UI.val('ySt')
    };
    if(id)payload.id=id;

    API.post(payload).then(function(r){
      UI.unload();
      if(r.error){UI.toast('Error',r.error,'err');return}
      UI.toast('Saved!',name,'ok');
      return API.get('getYajmans');
    }).then(function(yaj){
      if(Array.isArray(yaj))App.D.yajmans=yaj;
      self.render();
    }).catch(function(e){UI.unload();UI.toast('Error',String(e.message||e),'err')});
  },

  showDetail:function(id){
    var y=this._find(id);
    if(!y){UI.toast('Error','Not found','err');return}

    var old=document.getElementById('mYD');if(old)old.remove();
    var m=document.createElement('div');m.id='mYD';m.className='modal';document.body.appendChild(m);

    var ph=String(y.phone||'').replace(/[^0-9]/g,'');
    var wa=String(y.whatsapp||y.phone||'').replace(/[^0-9]/g,'');
    var yid=y.id;

    var html='<div class="modal-box" style="max-width:640px">'
      +'<div class="modal-h"><h3 class="modal-t">üë§ '+App.esc(y.name)+'</h3>'
      +'<button class="modal-x" onclick="document.getElementById(\'mYD\').classList.remove(\'on\')">√ó</button></div>'
      +'<div class="modal-b">';

    /* Profile header */
    html+='<div style="text-align:center;padding:16px;background:rgba(255,111,0,0.05);border-radius:16px;margin-bottom:14px">'
      +'<div style="width:56px;height:56px;border-radius:50%;background:var(--grad-b);display:grid;place-items:center;font-size:1.6rem;margin:0 auto 8px">üë§</div>'
      +'<h3 style="color:#fff;font-size:1.05rem">'+App.esc(y.name)+'</h3>'
      +'<span class="badge '+(y.status==='inactive'?'badge-err':'badge-ok')+'">'+(y.status||'active')+'</span>'
      +'</div>';

    /* Stats */
    html+='<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:14px">'
      +'<div class="stat" style="padding:10px"><div class="stat-v" style="font-size:1.1rem">'+(y.totalPoojas||0)+'</div><div class="stat-l">Poojas</div></div>'
      +'<div class="stat" style="padding:10px"><div class="stat-v" style="font-size:1.1rem">'+App.fmt$(y.totalAmount)+'</div><div class="stat-l">Total</div></div>'
      +'<div class="stat" style="padding:10px"><div class="stat-v" style="font-size:1.1rem">'+App.fmtD(y.lastPoojaDate)+'</div><div class="stat-l">Last</div></div>'
      +'</div>';

    /* Contact */
    html+='<div class="card" style="padding:12px;margin-bottom:10px">'
      +'<h4 style="color:var(--bhagwa);font-size:.78rem;margin-bottom:8px">üìã CONTACT DETAILS</h4>';
    if(y.phone)html+='<div style="font-size:.85rem;color:var(--g300);margin-bottom:4px">üìû '+String(y.phone)+'</div>';
    if(y.whatsapp&&String(y.whatsapp)!==String(y.phone))html+='<div style="font-size:.85rem;color:var(--g300);margin-bottom:4px">üí¨ '+String(y.whatsapp)+' (WhatsApp)</div>';
    if(y.address)html+='<div style="font-size:.85rem;color:var(--g300);margin-bottom:4px">üìç '+App.esc(y.address)+(y.city?', '+App.esc(y.city):'')+'</div>';
    if(y.gotra)html+='<div style="font-size:.85rem;color:var(--g300);margin-bottom:4px">üî± ‡§ó‡•ã‡§§‡•ç‡§∞: '+App.esc(y.gotra)+'</div>';
    if(y.rashi)html+='<div style="font-size:.85rem;color:var(--g300);margin-bottom:4px">‚≠ê ‡§∞‡§æ‡§∂‡§ø: '+App.esc(y.rashi)+'</div>';
    if(y.notes)html+='<div style="margin-top:6px;padding:8px;background:rgba(255,255,255,0.03);border-radius:8px;font-size:.8rem;color:var(--g400)">üìù '+App.esc(y.notes)+'</div>';
    html+='</div>';

    /* Action buttons */
    html+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px">'
      +'<button class="btn btn-p btn-w" onclick="document.getElementById(\'mYD\').classList.remove(\'on\');window.YajPage.createPoojaFor(\''+yid+'\')">üïâÔ∏è Create Pooja</button>'
      +'<button class="btn btn-g btn-w" onclick="document.getElementById(\'mYD\').classList.remove(\'on\');window.HisabPage.addForYajman(\''+yid+'\')">üí∞ Add Hisab</button>'
      +'</div>';

    html+='<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:12px">';
    if(ph)html+='<button class="btn btn-sm btn-s btn-w" onclick="window.YajPage.callNum(\''+ph+'\')">üìû Call</button>';else html+='<div></div>';
    if(wa)html+='<button class="btn btn-sm btn-g btn-w" onclick="window.YajPage.waNum(\''+wa+'\')">üí¨ WhatsApp</button>';else html+='<div></div>';
    if(wa)html+='<button class="btn btn-sm btn-s btn-w" onclick="window.YajPage.sendReminder(\''+yid+'\')">‚ö†Ô∏è Reminder</button>';else html+='<div></div>';
    html+='</div>';

    /* Hisab History */
    html+='<div class="card" style="padding:12px;margin-bottom:10px">'
      +'<div class="card-h" style="margin-bottom:6px"><h4 style="color:var(--bhagwa);font-size:.78rem">üí∞ PAYMENT HISTORY</h4>'
      +'<button class="btn btn-xs btn-s" onclick="document.getElementById(\'mYD\').classList.remove(\'on\');window.HisabPage.filterYajman(\''+yid+'\')">View All ‚Üí</button></div>'
      +'<div id="ydH_'+yid+'"><div style="text-align:center;padding:10px;color:var(--g500);font-size:.8rem">Loading...</div></div>'
      +'</div>';

    /* Pooja History */
    html+='<div class="card" style="padding:12px">'
      +'<h4 style="color:var(--bhagwa);font-size:.78rem;margin-bottom:6px">üïâÔ∏è POOJA HISTORY</h4>'
      +'<div id="ydP_'+yid+'"><div style="text-align:center;padding:10px;color:var(--g500);font-size:.8rem">Loading...</div></div>'
      +'</div>';

    html+='</div>';

    /* Footer */
    html+='<div class="modal-f">'
      +'<button class="btn btn-s" onclick="document.getElementById(\'mYD\').classList.remove(\'on\');var yd=window.YajPage._find(\''+yid+'\');if(yd)window.YajPage.showAdd(yd)">‚úèÔ∏è Edit</button>'
      +'<button class="btn btn-d" onclick="window.YajPage.delYaj(\''+yid+'\')">üóëÔ∏è Delete</button>'
      +'<button class="btn btn-s" onclick="document.getElementById(\'mYD\').classList.remove(\'on\')">Close</button>'
      +'</div></div>';

    m.innerHTML=html;
    m.classList.add('on');
    this._loadDetail(yid);
  },

  _loadDetail:function(yajId){
    API.get('getYajmanDetail',{yajmanId:yajId}).then(function(r){
      if(r.error)return;

      var hEl=document.getElementById('ydH_'+yajId);
      if(hEl){
        if(!r.hisab||!r.hisab.length){
          hEl.innerHTML='<p style="color:var(--g500);font-size:.8rem;text-align:center">No records yet</p>';
        }else{
          var hh='';
          var entries=r.hisab.slice(-8).reverse();
          for(var i=0;i<entries.length;i++){
            var h=entries[i];var isI=h.type==='income';
            var stB=h.paymentStatus==='paid'?'badge-ok':h.paymentStatus==='partial'?'badge-warn':'badge-err';
            hh+='<div class="lrow" style="padding:6px 0">'
              +'<div class="lrow-i" style="width:28px;height:28px;font-size:.75rem;background:'+(isI?'rgba(0,200,83,0.1)':'rgba(255,23,68,0.1)')+'">'+(isI?'üí∞':'üì§')+'</div>'
              +'<div class="lrow-b"><div class="lrow-n" style="font-size:.8rem">'+App.esc(h.poojaName||'Payment')+'</div>'
              +'<div class="lrow-m">'+App.fmtD(h.date)+' ‚Ä¢ <span class="badge '+stB+'">'+(h.paymentStatus||'pending')+'</span></div></div>'
              +'<div style="font-weight:700;color:'+(isI?'#00E676':'#FF5252')+';font-size:.85rem">'+App.fmt$(h.amount)+'</div></div>';
          }
          hEl.innerHTML=hh;
        }
      }

      var pEl=document.getElementById('ydP_'+yajId);
      if(pEl){
        var hist=(r.yajman&&Array.isArray(r.yajman.poojaHistory))?r.yajman.poojaHistory:[];
        if(!hist.length){
          pEl.innerHTML='<p style="color:var(--g500);font-size:.8rem;text-align:center">No pooja records</p>';
        }else{
          var ph2='';var recent=hist.slice(-8).reverse();
          for(var j=0;j<recent.length;j++){
            var p=recent[j];
            ph2+='<div class="lrow" style="padding:5px 0">'
              +'<div class="lrow-i" style="width:26px;height:26px;font-size:.7rem;background:rgba(255,111,0,0.1)">üïâÔ∏è</div>'
              +'<div class="lrow-b"><div class="lrow-n" style="font-size:.8rem">'+App.esc(p.pooja||'Pooja')+'</div>'
              +'<div class="lrow-m">'+App.fmtD(p.date)+'</div></div>'
              +'<div style="font-weight:600;color:var(--bhagwa-light);font-size:.8rem">'+App.fmt$(p.amount)+'</div></div>';
          }
          pEl.innerHTML=ph2;
        }
      }
    }).catch(function(e){console.error('Detail:',e)});
  },

  createPoojaFor:function(yajId){
    var y=this._find(yajId);if(!y)return;
    App._selectedYajman=y;
    Nav.go('pgNew');
    setTimeout(function(){
      var n=document.getElementById('npYajman');if(n)n.value=y.name||'';
      var p=document.getElementById('npPhone');if(p)p.value=String(y.phone||'');
      var a=document.getElementById('npAddr');if(a)a.value=(y.address||'')+(y.city?', '+y.city:'');
    },400);
    UI.toast('Selected',String(y.name),'ok');
  },

  delYaj:function(id){
    if(!confirm('Delete this yajman permanently?'))return;
    var modal=document.getElementById('mYD');if(modal)modal.classList.remove('on');
    UI.load('Deleting...');
    var self=this;
    API.post({action:'deleteYajman',id:id}).then(function(){
      UI.unload();UI.toast('Deleted','','ok');
      return API.get('getYajmans');
    }).then(function(yaj){
      if(Array.isArray(yaj))App.D.yajmans=yaj;
      self.render();
    }).catch(function(e){UI.unload();UI.toast('Error',String(e.message||e),'err')});
  },

  exportList:function(){
    var list=App.D.yajmans||[];
    if(!list.length){UI.toast('Empty','No yajmans','warn');return}
    var csv='Name,Phone,WhatsApp,City,Address,Gotra,Rashi,Status,Amount,Poojas\n';
    for(var i=0;i<list.length;i++){
      var y=list[i];
      csv+='"'+(y.name||'')+'","'+(y.phone||'')+'","'+(y.whatsapp||'')+'","'+(y.city||'')+'","'
        +(y.address||'')+'","'+(y.gotra||'')+'","'+(y.rashi||'')+'","'+(y.status||'active')+'","'
        +(y.totalAmount||0)+'","'+(y.totalPoojas||0)+'"\n';
    }
    var blob=new Blob([csv],{type:'text/csv'});
    var a=document.createElement('a');a.href=URL.createObjectURL(blob);
    a.download='Yajmans_'+new Date().toISOString().split('T')[0]+'.csv';
    a.click();URL.revokeObjectURL(a.href);
    UI.toast('Exported!','CSV downloaded','ok');
  }
};
</script>
<!-- BLOCK 11: Hisab Book System (FIXED - ALL BUTTONS WORKING) -->
<script>
/* Remove any previous HisabPage definition conflicts */
window.HisabPage={
  _data:[],

  render:function(){
    var self=this;
    this.loadData().then(function(){
      self.renderSummary();
      self.renderByPooja();
      self.renderList();
    }).catch(function(e){
      console.error('Hisab render error:',e);
      self.renderSummary();
      self.renderByPooja();
      self.renderList();
    });
  },

  loadData:function(){
    var self=this;
    return new Promise(function(resolve,reject){
      API.get('getHisab').then(function(d){
        if(Array.isArray(d)){self._data=d;App.D.hisab=d}
        resolve();
      }).catch(function(e){
        console.error('Hisab load:',e);
        resolve();
      });
    });
  },

  /* ============================================================
     SUMMARY CARDS
     ============================================================ */
  renderSummary:function(){
    var el=UI.$('hSummary');if(!el)return;
    var inc=0,exp=0,pend=0,mI=0,mE=0;
    var now=new Date();
    var thisM=now.getMonth();
    var thisY=now.getFullYear();

    for(var i=0;i<this._data.length;i++){
      var h=this._data[i];
      var amt=parseFloat(h.amount)||0;
      if(h.type==='income'){
        inc+=amt;
        pend+=parseFloat(h.pendingAmount)||0;
      }else{
        exp+=amt;
      }
      try{
        var dt=new Date(h.date);
        if(!isNaN(dt.getTime())&&dt.getMonth()===thisM&&dt.getFullYear()===thisY){
          if(h.type==='income')mI+=amt;else mE+=amt;
        }
      }catch(e){}
    }

    el.innerHTML='<div class="h-summary">'
      +'<div class="h-card inc"><div class="h-val green">'+App.fmt$(inc)+'</div><div class="h-lbl">Total Income</div></div>'
      +'<div class="h-card exp"><div class="h-val red">'+App.fmt$(exp)+'</div><div class="h-lbl">Total Expense</div></div>'
      +'<div class="h-card pend"><div class="h-val yellow">'+App.fmt$(pend)+'</div><div class="h-lbl">Pending</div></div>'
      +'<div class="h-card prof"><div class="h-val orange">'+App.fmt$(inc-exp)+'</div><div class="h-lbl">Net Profit</div></div>'
      +'</div>'
      +'<div class="stats" style="margin-bottom:14px">'
      +'<div class="stat" style="padding:10px"><div class="stat-v" style="font-size:1.1rem;color:#00E676">'+App.fmt$(mI)+'</div><div class="stat-l">Month In</div></div>'
      +'<div class="stat" style="padding:10px"><div class="stat-v" style="font-size:1.1rem;color:#FF5252">'+App.fmt$(mE)+'</div><div class="stat-l">Month Out</div></div>'
      +'<div class="stat" style="padding:10px"><div class="stat-v" style="font-size:1.1rem;color:var(--bhagwa-light)">'+App.fmt$(mI-mE)+'</div><div class="stat-l">Month Profit</div></div>'
      +'<div class="stat" style="padding:10px"><div class="stat-v" style="font-size:1.1rem">'+this._data.length+'</div><div class="stat-l">Entries</div></div>'
      +'</div>';
  },

  /* ============================================================
     HELPER: Filter by time
     ============================================================ */
  _filterByTime:function(data){
    var p='all';
    try{p=UI.val('hPoojaMonth')||'all'}catch(e){}
    if(p==='all')return data;
    var now=new Date();
    var out=[];
    for(var i=0;i<data.length;i++){
      try{
        var dt=new Date(data[i].date);
        if(isNaN(dt.getTime()))continue;
        var ok=false;
        if(p==='thisMonth')ok=(dt.getMonth()===now.getMonth()&&dt.getFullYear()===now.getFullYear());
        else if(p==='lastMonth'){
          var lm=now.getMonth()-1;var ly=now.getFullYear();
          if(lm<0){lm=11;ly--}
          ok=(dt.getMonth()===lm&&dt.getFullYear()===ly);
        }
        else if(p==='thisYear')ok=(dt.getFullYear()===now.getFullYear());
        if(ok)out.push(data[i]);
      }catch(e){}
    }
    return out;
  },

  /* ============================================================
     HELPER: Get category info
     ============================================================ */
  _getCatInfo:function(type,catId){
    var cats=(type==='income')?HISAB_CATEGORIES.income:HISAB_CATEGORIES.expense;
    for(var i=0;i<cats.length;i++){
      if(cats[i].id===catId)return cats[i];
    }
    return{id:catId||'other',label:catId||'‡§Ö‡§®‡•ç‡§Ø',icon:(type==='income')?'üí∞':'üì§'};
  },

  /* ============================================================
     POOJA-WISE BREAKDOWN
     ============================================================ */
  renderByPooja:function(){
    var el=UI.$('hByPooja');if(!el)return;
    var data=this._filterByTime(this._data);

    var sq='';
    try{sq=(UI.val('hPoojaSearch')||'').toLowerCase()}catch(e){}
    if(sq){
      data=data.filter(function(h){
        return String(h.poojaName||'').toLowerCase().indexOf(sq)!==-1||
          String(h.yajmanName||'').toLowerCase().indexOf(sq)!==-1;
      });
    }

    var groups={};
    for(var i=0;i<data.length;i++){
      var h=data[i];
      var key=h.poojaName||'‡§Ö‡§®‡•ç‡§Ø (Other)';
      if(!groups[key]){
        groups[key]={pooja:key,count:0,income:0,expense:0,pending:0,incByCat:{},expByCat:{},entries:[]};
      }
      var g=groups[key];
      g.count++;
      var amt=parseFloat(h.amount)||0;
      if(h.type==='income'){
        g.income+=amt;
        var ic=h.category||'other_income';
        g.incByCat[ic]=(g.incByCat[ic]||0)+amt;
      }else{
        g.expense+=amt;
        var ec=h.category||'other_expense';
        g.expByCat[ec]=(g.expByCat[ec]||0)+amt;
      }
      g.pending+=parseFloat(h.pendingAmount)||0;
      g.entries.push(h);
    }

    var arr=[];
    for(var k in groups){
      if(groups.hasOwnProperty(k))arr.push(groups[k]);
    }
    arr.sort(function(a,b){return b.income-a.income});

    if(!arr.length){
      el.innerHTML='<div style="text-align:center;padding:20px">'
        +'<div style="font-size:2rem;margin-bottom:8px">üïâÔ∏è</div>'
        +'<p style="color:var(--g500);margin-bottom:10px">No hisab data yet</p>'
        +'<button class="btn btn-sm btn-p" onclick="window.HisabPage.showAddPooja()">‚ûï Add First Pooja Entry</button>'
        +'</div>';
      return;
    }

    var html='';
    for(var j=0;j<arr.length;j++){
      var grp=arr[j];
      var profit=grp.income-grp.expense;
      var sid='hpS_'+j;

      html+='<div style="margin-bottom:10px">'
        +'<div class="sec-h" onclick="var e=document.getElementById(\''+sid+'\');if(e)e.style.display=e.style.display===\'none\'?\'block\':\'none\'">'
        +'<span>üïâÔ∏è '+App.esc(grp.pooja)+' <span style="font-size:.65rem;color:var(--g400)">('+grp.count+'x)</span></span>'
        +'<span style="font-size:.75rem;color:'+(profit>=0?'#00E676':'#FF5252')+'">'+App.fmt$(profit)+'</span>'
        +'</div>';

      html+='<div id="'+sid+'" style="display:none;padding:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.04);border-top:none;border-radius:0 0 8px 8px">';

      /* Summary grid */
      html+='<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:10px">'
        +'<div style="text-align:center;padding:8px;background:rgba(0,200,83,0.06);border-radius:8px"><div style="font-weight:700;color:#00E676;font-size:.9rem">'+App.fmt$(grp.income)+'</div><div style="font-size:.6rem;color:var(--g500)">INCOME</div></div>'
        +'<div style="text-align:center;padding:8px;background:rgba(255,23,68,0.06);border-radius:8px"><div style="font-weight:700;color:#FF5252;font-size:.9rem">'+App.fmt$(grp.expense)+'</div><div style="font-size:.6rem;color:var(--g500)">EXPENSE</div></div>'
        +'<div style="text-align:center;padding:8px;background:rgba(255,111,0,0.06);border-radius:8px"><div style="font-weight:700;color:'+(profit>=0?'#00E676':'#FF5252')+';font-size:.9rem">'+App.fmt$(profit)+'</div><div style="font-size:.6rem;color:var(--g500)">PROFIT</div></div>'
        +'</div>';

      /* Income breakdown */
      var incKeys=Object.keys(grp.incByCat);
      if(incKeys.length){
        html+='<div style="margin-bottom:8px"><div style="font-size:.7rem;font-weight:600;color:#00E676;margin-bottom:4px">üí∞ Income Breakdown:</div>';
        for(var a=0;a<incKeys.length;a++){
          var ci=this._getCatInfo('income',incKeys[a]);
          html+='<div style="display:flex;justify-content:space-between;padding:2px 8px;font-size:.75rem;border-bottom:1px solid rgba(255,255,255,0.03)">'
            +'<span style="color:var(--g300)">'+ci.icon+' '+ci.label+'</span>'
            +'<span style="color:#00E676;font-weight:600">'+App.fmt$(grp.incByCat[incKeys[a]])+'</span></div>';
        }
        html+='</div>';
      }

      /* Expense breakdown */
      var expKeys=Object.keys(grp.expByCat);
      if(expKeys.length){
        html+='<div style="margin-bottom:8px"><div style="font-size:.7rem;font-weight:600;color:#FF5252;margin-bottom:4px">üì§ Expense Breakdown:</div>';
        for(var b=0;b<expKeys.length;b++){
          var ce=this._getCatInfo('expense',expKeys[b]);
          html+='<div style="display:flex;justify-content:space-between;padding:2px 8px;font-size:.75rem;border-bottom:1px solid rgba(255,255,255,0.03)">'
            +'<span style="color:var(--g300)">'+ce.icon+' '+ce.label+'</span>'
            +'<span style="color:#FF5252;font-weight:600">'+App.fmt$(grp.expByCat[expKeys[b]])+'</span></div>';
        }
        html+='</div>';
      }

      if(grp.pending>0){
        html+='<div style="padding:4px 8px;background:rgba(255,214,0,0.06);border-radius:8px;margin-bottom:6px;font-size:.75rem;color:#FFD740">‚ö†Ô∏è Pending: '+App.fmt$(grp.pending)+'</div>';
      }

      /* Recent entries */
      var ents=grp.entries.slice().reverse();
      for(var e=0;e<Math.min(ents.length,5);e++){
        var en=ents[e];
        var isI=en.type==='income';
        var ec2=this._getCatInfo(en.type,en.category);
        html+='<div style="display:flex;align-items:center;gap:6px;padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.03);font-size:.78rem">'
          +'<span style="color:'+(isI?'#00E676':'#FF5252')+'">'+ec2.icon+'</span>'
          +'<span style="flex:1;color:var(--g300)">'+App.esc(en.yajmanName||en.description||ec2.label)+' ‚Ä¢ '+App.fmtD(en.date)+'</span>'
          +'<span style="font-weight:700;color:'+(isI?'#00E676':'#FF5252')+'">'+(isI?'+':'-')+App.fmt$(en.amount)+'</span>'
          +'</div>';
      }
      if(ents.length>5){
        html+='<div style="text-align:center;padding:4px;font-size:.7rem;color:var(--g500)">+'+(ents.length-5)+' more</div>';
      }
      html+='</div></div>';
    }
    el.innerHTML=html;
  },

  /* ============================================================
     ALL TRANSACTIONS LIST
     ============================================================ */
  renderList:function(){
    var el=UI.$('hList');if(!el)return;
    var list=this._data.slice();

    var ft='all',fs='all',fc='all',fq='';
    try{ft=UI.val('hFType')||'all'}catch(e){}
    try{fs=UI.val('hFStatus')||'all'}catch(e){}
    try{fc=UI.val('hFCat')||'all'}catch(e){}
    try{fq=(UI.val('hFSearch')||'').toLowerCase()}catch(e){}

    if(ft!=='all')list=list.filter(function(h){return h.type===ft});
    if(fs!=='all')list=list.filter(function(h){return h.paymentStatus===fs});
    if(fc!=='all')list=list.filter(function(h){return h.category===fc});
    if(fq)list=list.filter(function(h){
      return String(h.yajmanName||'').toLowerCase().indexOf(fq)!==-1||
        String(h.poojaName||'').toLowerCase().indexOf(fq)!==-1||
        String(h.description||'').toLowerCase().indexOf(fq)!==-1;
    });

    list=list.reverse();

    if(!list.length){
      el.innerHTML='<div style="text-align:center;padding:24px">'
        +'<div style="font-size:2rem;margin-bottom:8px">üí∞</div>'
        +'<p style="color:var(--g500);margin-bottom:10px">No entries found</p>'
        +'<div style="display:flex;gap:6px;justify-content:center">'
        +'<button class="btn btn-sm btn-g" onclick="window.HisabPage.showAddSingle(\'income\')">‚ûï Income</button>'
        +'<button class="btn btn-sm btn-d" onclick="window.HisabPage.showAddSingle(\'expense\')">‚ûï Expense</button>'
        +'</div></div>';
      return;
    }

    var html='';
    for(var i=0;i<list.length;i++){
      var h=list[i];
      var isI=h.type==='income';
      var ci=this._getCatInfo(h.type,h.category);
      var sb=h.paymentStatus==='paid'?'badge-ok':h.paymentStatus==='partial'?'badge-warn':'badge-err';

      html+='<div class="lrow">'
        +'<div class="lrow-i" style="background:'+(isI?'rgba(0,200,83,0.1)':'rgba(255,23,68,0.1)')+'">'+ci.icon+'</div>'
        +'<div class="lrow-b">'
        +'<div class="lrow-n">'+App.esc(h.yajmanName||h.description||ci.label)
        +' <span style="font-size:.6rem;color:var(--g500);background:rgba(255,255,255,0.05);padding:1px 5px;border-radius:8px">'+ci.label+'</span></div>'
        +'<div class="lrow-m">'+App.fmtD(h.date)
        +(h.poojaName?' ‚Ä¢ üïâÔ∏è '+App.esc(h.poojaName):'')
        +' ‚Ä¢ <span class="badge '+sb+'">'+(h.paymentStatus||'pending')+'</span></div>'
        +'</div>'
        +'<div class="lrow-r">'
        +'<div style="font-weight:800;font-size:.95rem;color:'+(isI?'#00E676':'#FF5252')+'">'+(isI?'+':'-')+App.fmt$(h.amount)+'</div>'
        +(h.pendingAmount>0?'<div style="font-size:.62rem;color:#FFD740">‚Çπ'+h.pendingAmount+' due</div>':'')
        +'</div>'
        +'<div class="lrow-a" style="flex-direction:column;gap:2px">'
        +(h.pendingAmount>0?'<button class="btn btn-xs btn-g" onclick="window.HisabPage.markPaid(\''+h.id+'\')">‚úÖ</button>':'')
        +'<button class="btn btn-xs btn-s" onclick="window.HisabPage.showEditEntry(\''+h.id+'\')">‚úèÔ∏è</button>'
        +'<button class="btn btn-xs btn-d" onclick="window.HisabPage.del(\''+h.id+'\')">üóëÔ∏è</button>'
        +'</div></div>';
    }
    el.innerHTML=html;
  },

  /* ============================================================
     ADD COMPLETE POOJA ENTRY (Multi Income + Multi Expense)
     ============================================================ */
  showAddPooja:function(){
    console.log('showAddPooja called');

    /* Remove old modal if exists */
    var old=document.getElementById('mHP');
    if(old)old.remove();

    /* Create fresh modal */
    var m=document.createElement('div');
    m.id='mHP';
    m.className='modal';
    document.body.appendChild(m);

    /* Build yajman options */
    var yO='<option value="">‚Äî Select Yajman ‚Äî</option>';
    var yajmans=App.D.yajmans||[];
    for(var i=0;i<yajmans.length;i++){
      var y=yajmans[i];
      yO+='<option value="'+y.id+'">'+App.esc(y.name)+'</option>';
    }

    /* Build pooja options */
    var pList=App.uPoojas();
    var pO='<option value="">‚Äî Select Pooja ‚Äî</option>';
    for(var j=0;j<pList.length;j++){
      pO+='<option value="'+App.esc(pList[j])+'">'+App.esc(pList[j])+'</option>';
    }

    var today=new Date().toISOString().split('T')[0];

    var modalHTML='<div class="modal-box" style="max-width:600px">'
      +'<div class="modal-h"><h3 class="modal-t">üïâÔ∏è Complete Pooja Hisab</h3>'
      +'<button class="modal-x" onclick="document.getElementById(\'mHP\').classList.remove(\'on\')">√ó</button></div>'
      +'<div class="modal-b">'

      /* Info banner */
      +'<div style="padding:8px;background:rgba(255,111,0,0.06);border-radius:8px;margin-bottom:12px;border-left:3px solid var(--bhagwa);font-size:.7rem;color:var(--bhagwa-light)">'
      +'üìå ‡§¶‡§ï‡•ç‡§∑‡§ø‡§£‡§æ, ‡§ö‡§¢‡§º‡§æ‡§µ‡§æ (income) + ‡§∏‡§æ‡§Æ‡§æ‡§®, ‡§Ö‡§®‡•ç‡§Ø ‡§™‡§Ç‡§ú‡•Ä, ‡§Æ‡§Ç‡§¶‡§ø‡§∞ (expenses) ‡§è‡§ï ‡§∏‡§æ‡§• add ‡§ï‡§∞‡•á‡§Ç</div>'

      /* Date + Pooja */
      +'<div class="fi-row">'
      +'<div class="fg"><label class="fl">Date *</label>'
      +'<input class="fi" id="hpDate" type="date" value="'+today+'"></div>'
      +'<div class="fg"><label class="fl">Pooja *</label>'
      +'<select class="fsel" id="hpPooja">'+pO+'</select></div>'
      +'</div>'

      /* Yajman */
      +'<div class="fg"><label class="fl">Yajman</label>'
      +'<select class="fsel" id="hpYaj">'+yO+'</select></div>'

      /* ---- INCOME SECTION ---- */
      +'<div style="margin-top:14px;margin-bottom:6px;padding:6px 10px;background:rgba(0,200,83,0.08);border-radius:8px;border-left:3px solid #00E676;font-weight:700;color:#00E676;font-size:.82rem">'
      +'üí∞ Income (‡§Ü‡§Ø)</div>'

      +'<div class="fi-row" style="margin-bottom:6px">'
      +'<div class="fg"><label class="fl">üôè ‡§¶‡§ï‡•ç‡§∑‡§ø‡§£‡§æ ‚Çπ</label>'
      +'<input class="fi" id="hpDakshina" type="number" placeholder="‚Çπ" inputmode="numeric" oninput="window.HisabPage._calcPoojaTotals()"></div>'
      +'<div class="fg"><label class="fl">ü™∑ ‡§ö‡§¢‡§º‡§æ‡§µ‡§æ ‚Çπ</label>'
      +'<input class="fi" id="hpChadawa" type="number" placeholder="‚Çπ" inputmode="numeric" oninput="window.HisabPage._calcPoojaTotals()"></div>'
      +'</div>'

      +'<div class="fi-row" style="margin-bottom:6px">'
      +'<div class="fg"><label class="fl">üíù ‡§¶‡§æ‡§® ‚Çπ</label>'
      +'<input class="fi" id="hpDonation" type="number" placeholder="‚Çπ" inputmode="numeric" oninput="window.HisabPage._calcPoojaTotals()"></div>'
      +'<div class="fg"><label class="fl">üí∞ ‡§Ö‡§®‡•ç‡§Ø ‡§Ü‡§Ø ‚Çπ</label>'
      +'<input class="fi" id="hpOtherInc" type="number" placeholder="‚Çπ" inputmode="numeric" oninput="window.HisabPage._calcPoojaTotals()"></div>'
      +'</div>'

      +'<div style="text-align:right;font-size:.8rem;color:#00E676;font-weight:700;padding:4px 8px;background:rgba(0,200,83,0.04);border-radius:8px;margin-bottom:10px">'
      +'Total Income: <span id="hpTI">‚Çπ0</span></div>'

      /* ---- EXPENSE SECTION ---- */
      +'<div style="margin-bottom:6px;padding:6px 10px;background:rgba(255,23,68,0.08);border-radius:8px;border-left:3px solid #FF5252;font-weight:700;color:#FF5252;font-size:.82rem">'
      +'üì§ Expense (‡§ñ‡§∞‡•ç‡§ö)</div>'

      +'<div class="fi-row" style="margin-bottom:6px">'
      +'<div class="fg"><label class="fl">üì¶ ‡§∏‡§æ‡§Æ‡§æ‡§® ‚Çπ</label>'
      +'<input class="fi" id="hpSaman" type="number" placeholder="‚Çπ" inputmode="numeric" oninput="window.HisabPage._calcPoojaTotals()"></div>'
      +'<div class="fg"><label class="fl">üë®‚Äçüè´ ‡§Ö‡§®‡•ç‡§Ø ‡§™‡§Ç‡§ú‡•Ä ‚Çπ</label>'
      +'<input class="fi" id="hpOtherPanji" type="number" placeholder="‚Çπ" inputmode="numeric" oninput="window.HisabPage._calcPoojaTotals()"></div>'
      +'</div>'

      +'<div class="fi-row" style="margin-bottom:6px">'
      +'<div class="fg"><label class="fl">üõï ‡§Æ‡§Ç‡§¶‡§ø‡§∞ ‚Çπ</label>'
      +'<input class="fi" id="hpTemple" type="number" placeholder="‚Çπ" inputmode="numeric" oninput="window.HisabPage._calcPoojaTotals()"></div>'
      +'<div class="fg"><label class="fl">üöó ‡§Ø‡§æ‡§§‡•ç‡§∞‡§æ ‚Çπ</label>'
      +'<input class="fi" id="hpTravel" type="number" placeholder="‚Çπ" inputmode="numeric" oninput="window.HisabPage._calcPoojaTotals()"></div>'
      +'</div>'

      +'<div class="fi-row" style="margin-bottom:6px">'
      +'<div class="fg"><label class="fl">üç≤ ‡§™‡•ç‡§∞‡§∏‡§æ‡§¶ ‚Çπ</label>'
      +'<input class="fi" id="hpPrasad" type="number" placeholder="‚Çπ" inputmode="numeric" oninput="window.HisabPage._calcPoojaTotals()"></div>'
      +'<div class="fg"><label class="fl">üì§ ‡§Ö‡§®‡•ç‡§Ø ‡§ñ‡§∞‡•ç‡§ö ‚Çπ</label>'
      +'<input class="fi" id="hpOtherExp" type="number" placeholder="‚Çπ" inputmode="numeric" oninput="window.HisabPage._calcPoojaTotals()"></div>'
      +'</div>'

      +'<div style="text-align:right;font-size:.8rem;color:#FF5252;font-weight:700;padding:4px 8px;background:rgba(255,23,68,0.04);border-radius:8px;margin-bottom:10px">'
      +'Total Expense: <span id="hpTE">‚Çπ0</span></div>'

      /* ---- PROFIT ---- */
      +'<div style="text-align:center;padding:12px;background:rgba(255,111,0,0.06);border-radius:16px;border:1px solid rgba(255,111,0,0.15);margin-bottom:10px">'
      +'<div style="font-size:.7rem;color:var(--g500)">NET PROFIT (‡§∂‡•Å‡§¶‡•ç‡§ß ‡§≤‡§æ‡§≠)</div>'
      +'<div style="font-size:1.3rem;font-weight:800;color:#00E676" id="hpPr">‚Çπ0</div>'
      +'</div>'

      /* Status + Mode */
      +'<div class="fi-row">'
      +'<div class="fg"><label class="fl">Payment Status</label>'
      +'<select class="fsel" id="hpPS">'
      +'<option value="paid">‚úÖ Paid (‡§™‡•Ç‡§∞‡§æ ‡§Æ‡§ø‡§≤‡§æ)</option>'
      +'<option value="partial">‚è≥ Partial (‡§ï‡•Å‡§õ ‡§¨‡§æ‡§ï‡•Ä)</option>'
      +'<option value="pending">‚ùå Pending (‡§¨‡§æ‡§ï‡•Ä ‡§π‡•à)</option>'
      +'</select></div>'
      +'<div class="fg"><label class="fl">Payment Mode</label>'
      +'<select class="fsel" id="hpPM">'
      +'<option value="cash">üíµ Cash</option>'
      +'<option value="upi">üì± UPI</option>'
      +'<option value="bank">üè¶ Bank</option>'
      +'<option value="mixed">üîÑ Mixed</option>'
      +'</select></div>'
      +'</div>'

      /* Notes */
      +'<div class="fg"><label class="fl">Notes</label>'
      +'<input class="fi" id="hpNotes" placeholder="‡§Ö‡§§‡§ø‡§∞‡§ø‡§ï‡•ç‡§§ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä"></div>'

      +'</div>'

      /* Footer buttons */
      +'<div class="modal-f">'
      +'<button class="btn btn-s" onclick="document.getElementById(\'mHP\').classList.remove(\'on\')">Cancel</button>'
      +'<button class="btn btn-p" onclick="window.HisabPage.savePooja()">üíæ Save Pooja Hisab</button>'
      +'</div></div>';

    m.innerHTML=modalHTML;
    m.classList.add('on');
  },

  /* Auto-calculate totals */
  _calcPoojaTotals:function(){
    var iIds=['hpDakshina','hpChadawa','hpDonation','hpOtherInc'];
    var eIds=['hpSaman','hpOtherPanji','hpTemple','hpTravel','hpPrasad','hpOtherExp'];
    var ti=0,te=0;
    for(var a=0;a<iIds.length;a++){
      var v=document.getElementById(iIds[a]);
      if(v)ti+=parseFloat(v.value)||0;
    }
    for(var b=0;b<eIds.length;b++){
      var v2=document.getElementById(eIds[b]);
      if(v2)te+=parseFloat(v2.value)||0;
    }
    var tiEl=document.getElementById('hpTI');
    var teEl=document.getElementById('hpTE');
    var prEl=document.getElementById('hpPr');
    if(tiEl)tiEl.textContent='‚Çπ'+ti.toLocaleString('en-IN');
    if(teEl)teEl.textContent='‚Çπ'+te.toLocaleString('en-IN');
    if(prEl){
      var profit=ti-te;
      prEl.textContent='‚Çπ'+profit.toLocaleString('en-IN');
      prEl.style.color=profit>=0?'#00E676':'#FF5252';
    }
  },

  /* ============================================================
     SAVE COMPLETE POOJA (Multiple entries)
     ============================================================ */
  savePooja:function(){
    var poojaEl=document.getElementById('hpPooja');
    var pooja=poojaEl?poojaEl.value:'';
    if(!pooja){UI.toast('Required','Select a pooja','warn');return}

    var dateEl=document.getElementById('hpDate');
    var date=dateEl?dateEl.value:'';

    var ySelEl=document.getElementById('hpYaj');
    var yId='';var yN='';
    if(ySelEl&&ySelEl.value){
      yId=ySelEl.value;
      yN=ySelEl.options[ySelEl.selectedIndex].text;
    }

    var notesEl=document.getElementById('hpNotes');
    var notes=notesEl?notesEl.value.trim():'';

    var psEl=document.getElementById('hpPS');
    var ps=psEl?psEl.value:'paid';

    var pmEl=document.getElementById('hpPM');
    var pm=pmEl?pmEl.value:'cash';

    var entries=[];

    /* Income entries */
    var incFields=[
      {id:'hpDakshina',cat:'dakshina',l:'‡§¶‡§ï‡•ç‡§∑‡§ø‡§£‡§æ'},
      {id:'hpChadawa',cat:'chadawa',l:'‡§ö‡§¢‡§º‡§æ‡§µ‡§æ'},
      {id:'hpDonation',cat:'donation',l:'‡§¶‡§æ‡§®'},
      {id:'hpOtherInc',cat:'other_income',l:'‡§Ö‡§®‡•ç‡§Ø ‡§Ü‡§Ø'}
    ];

    for(var i=0;i<incFields.length;i++){
      var el=document.getElementById(incFields[i].id);
      var amt=el?parseFloat(el.value)||0:0;
      if(amt>0){
        entries.push({
          date:date,type:'income',category:incFields[i].cat,
          amount:amt,
          receivedAmount:ps==='paid'?amt:0,
          pendingAmount:ps==='paid'?0:amt,
          yajmanId:yId,yajmanName:yN,
          poojaName:pooja,description:incFields[i].l,
          paymentMode:pm,paymentStatus:ps,notes:notes
        });
      }
    }

    /* Expense entries */
    var expFields=[
      {id:'hpSaman',cat:'saman',l:'‡§∏‡§æ‡§Æ‡§æ‡§® ‡§ñ‡§∞‡•ç‡§ö'},
      {id:'hpOtherPanji',cat:'other_panji',l:'‡§Ö‡§®‡•ç‡§Ø ‡§™‡§Ç‡§ú‡•Ä ‡§ï‡•ã ‡§¶‡§ø‡§Ø‡•á'},
      {id:'hpTemple',cat:'temple',l:'‡§Æ‡§Ç‡§¶‡§ø‡§∞ ‡§Æ‡•á‡§Ç ‡§¶‡§ø‡§Ø‡•á'},
      {id:'hpTravel',cat:'travel',l:'‡§Ø‡§æ‡§§‡•ç‡§∞‡§æ ‡§ñ‡§∞‡•ç‡§ö'},
      {id:'hpPrasad',cat:'prasad',l:'‡§™‡•ç‡§∞‡§∏‡§æ‡§¶'},
      {id:'hpOtherExp',cat:'other_expense',l:'‡§Ö‡§®‡•ç‡§Ø ‡§ñ‡§∞‡•ç‡§ö'}
    ];

    for(var j=0;j<expFields.length;j++){
      var el2=document.getElementById(expFields[j].id);
      var eAmt=el2?parseFloat(el2.value)||0:0;
      if(eAmt>0){
        entries.push({
          date:date,type:'expense',category:expFields[j].cat,
          amount:eAmt,
          receivedAmount:0,pendingAmount:0,
          yajmanId:yId,yajmanName:yN,
          poojaName:pooja,description:expFields[j].l,
          paymentMode:pm,paymentStatus:'paid',notes:notes
        });
      }
    }

    if(!entries.length){UI.toast('Empty','Enter at least one amount','warn');return}

    /* Close modal */
    var modal=document.getElementById('mHP');
    if(modal)modal.classList.remove('on');

    UI.load('Saving '+entries.length+' entries...');

    var self=this;

    /* Try bulk first, fallback to one-by-one */
    API.post({action:'addBulkHisab',entries:entries}).then(function(r){
      if(r.error){
        /* Fallback: save one by one */
        return self._saveOneByOne(entries);
      }
      return 'done';
    }).catch(function(){
      return self._saveOneByOne(entries);
    }).then(function(){
      UI.unload();
      UI.toast('Saved!',entries.length+' entries for '+pooja,'ok');
      self.render();
    }).catch(function(e){
      UI.unload();
      UI.toast('Error',String(e.message||e),'err');
    });
  },

  _saveOneByOne:function(entries){
    var chain=Promise.resolve();
    for(var i=0;i<entries.length;i++){
      (function(entry){
        chain=chain.then(function(){
          entry.action='addHisab';
          return API.post(entry);
        });
      })(entries[i]);
    }
    return chain;
  },

  /* ============================================================
     ADD SINGLE ENTRY (Income or Expense)
     ============================================================ */
  showAddSingle:function(type,preYajId){
    console.log('showAddSingle called:',type);

    var old=document.getElementById('mH');
    if(old)old.remove();

    var m=document.createElement('div');
    m.id='mH';
    m.className='modal';
    document.body.appendChild(m);

    var isIncome=(type==='income');

    /* Yajman options */
    var yO='<option value="">‚Äî Select Yajman ‚Äî</option>';
    var yajmans=App.D.yajmans||[];
    for(var i=0;i<yajmans.length;i++){
      var y=yajmans[i];
      yO+='<option value="'+y.id+'"'+(preYajId===y.id?' selected':'')+'>'+App.esc(y.name)+'</option>';
    }

    /* Pooja options for datalist */
    var pList=App.uPoojas();
    var pO='';
    for(var j=0;j<pList.length;j++){
      pO+='<option value="'+App.esc(pList[j])+'">'+App.esc(pList[j])+'</option>';
    }

    /* Category options */
    var cats=isIncome?HISAB_CATEGORIES.income:HISAB_CATEGORIES.expense;
    var cO='';
    for(var c=0;c<cats.length;c++){
      cO+='<option value="'+cats[c].id+'">'+cats[c].icon+' '+cats[c].label+'</option>';
    }

    var today=new Date().toISOString().split('T')[0];

    var html='<div class="modal-box">'
      +'<div class="modal-h"><h3 class="modal-t">'+(isIncome?'üí∞ Add Income':'üì§ Add Expense')+'</h3>'
      +'<button class="modal-x" onclick="document.getElementById(\'mH\').classList.remove(\'on\')">√ó</button></div>'
      +'<div class="modal-b">'

      +'<input type="hidden" id="hType" value="'+type+'">'
      +'<input type="hidden" id="hEditId" value="">'

      /* Type indicator */
      +'<div style="padding:8px 12px;background:'+(isIncome?'rgba(0,200,83,0.08)':'rgba(255,23,68,0.08)')
      +';border-radius:8px;margin-bottom:12px;border-left:3px solid '+(isIncome?'#00E676':'#FF5252')+'">'
      +'<div style="font-weight:700;color:'+(isIncome?'#00E676':'#FF5252')+';font-size:.85rem">'+(isIncome?'üí∞ Income Entry':'üì§ Expense Entry')+'</div>'
      +'<div style="font-size:.65rem;color:var(--g400)">'+(isIncome?'‡§¶‡§ï‡•ç‡§∑‡§ø‡§£‡§æ, ‡§ö‡§¢‡§º‡§æ‡§µ‡§æ, ‡§¶‡§æ‡§® ‡§Ü‡§¶‡§ø':'‡§∏‡§æ‡§Æ‡§æ‡§®, ‡§Ö‡§®‡•ç‡§Ø ‡§™‡§Ç‡§ú‡•Ä, ‡§Æ‡§Ç‡§¶‡§ø‡§∞ ‡§Ü‡§¶‡§ø')+'</div>'
      +'</div>'

      /* Date + Amount */
      +'<div class="fi-row">'
      +'<div class="fg"><label class="fl">Date *</label>'
      +'<input class="fi" id="hDate" type="date" value="'+today+'"></div>'
      +'<div class="fg"><label class="fl">Amount ‚Çπ *</label>'
      +'<input class="fi" id="hAmt" type="number" placeholder="‚Çπ ‡§∞‡§æ‡§∂‡§ø" inputmode="numeric"></div>'
      +'</div>'

      /* Category */
      +'<div class="fg"><label class="fl">Category *</label>'
      +'<select class="fsel" id="hCat">'+cO+'</select></div>'

      /* Yajman */
      +'<div class="fg"><label class="fl">Yajman</label>'
      +'<select class="fsel" id="hYaj">'+yO+'</select></div>'

      /* Pooja */
      +'<div class="fg"><label class="fl">Pooja</label>'
      +'<input class="fi" id="hPj" placeholder="Type or select pooja" list="hPjDL">'
      +'<datalist id="hPjDL">'+pO+'</datalist></div>'

      /* Description */
      +'<div class="fg"><label class="fl">Description</label>'
      +'<input class="fi" id="hDesc" placeholder="‡§µ‡§ø‡§µ‡§∞‡§£"></div>'

      /* Received/PaidTo + Mode */
      +'<div class="fi-row">';

    if(isIncome){
      html+='<div class="fg"><label class="fl">Received ‚Çπ</label>'
        +'<input class="fi" id="hRec" type="number" placeholder="‚Çπ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§" inputmode="numeric"></div>';
    }else{
      html+='<div class="fg"><label class="fl">Paid To (‡§ï‡§ø‡§∏‡§ï‡•ã)</label>'
        +'<input class="fi" id="hPaidTo" placeholder="‡§ï‡§ø‡§∏‡§ï‡•ã ‡§¶‡§ø‡§Ø‡§æ">'
        +'<input type="hidden" id="hRec" value="0"></div>';
    }

    html+='<div class="fg"><label class="fl">Payment Mode</label>'
      +'<select class="fsel" id="hMode">'
      +'<option value="cash">üíµ Cash</option>'
      +'<option value="upi">üì± UPI</option>'
      +'<option value="bank">üè¶ Bank</option>'
      +'<option value="other">Other</option>'
      +'</select></div></div>'

      /* Notes */
      +'<div class="fg"><label class="fl">Notes</label>'
      +'<input class="fi" id="hNotes" placeholder="‡§Ö‡§§‡§ø‡§∞‡§ø‡§ï‡•ç‡§§ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä"></div>'

      +'</div>'
      +'<div class="modal-f">'
      +'<button class="btn btn-s" onclick="document.getElementById(\'mH\').classList.remove(\'on\')">Cancel</button>'
      +'<button class="btn btn-p" onclick="window.HisabPage.saveSingle()">üíæ Save</button>'
      +'</div></div>';

    m.innerHTML=html;
    m.classList.add('on');
  },

  /* ============================================================
     SAVE SINGLE ENTRY
     ============================================================ */
  saveSingle:function(){
    var amtEl=document.getElementById('hAmt');
    var amt=amtEl?amtEl.value.trim():'';
    if(!amt){UI.toast('Required','Enter amount','warn');return}

    var ySelEl=document.getElementById('hYaj');
    var yId='';var yN='';
    if(ySelEl&&ySelEl.value){
      yId=ySelEl.value;
      yN=ySelEl.options[ySelEl.selectedIndex].text;
    }

    var editIdEl=document.getElementById('hEditId');
    var editId=editIdEl?editIdEl.value.trim():'';

    var recEl=document.getElementById('hRec');
    var received=recEl?parseFloat(recEl.value)||0:0;
    var amount=parseFloat(amt)||0;

    var typeEl=document.getElementById('hType');
    var type=typeEl?typeEl.value:'income';

    var catEl=document.getElementById('hCat');
    var cat=catEl?catEl.value:'';

    var dateEl=document.getElementById('hDate');
    var date=dateEl?dateEl.value:'';

    var pjEl=document.getElementById('hPj');
    var pj=pjEl?pjEl.value.trim():'';

    var descEl=document.getElementById('hDesc');
    var desc=descEl?descEl.value.trim():'';

    var paidToEl=document.getElementById('hPaidTo');
    if(paidToEl&&paidToEl.value.trim()&&!desc){
      desc='Paid to: '+paidToEl.value.trim();
    }

    var modeEl=document.getElementById('hMode');
    var mode=modeEl?modeEl.value:'cash';

    var notesEl=document.getElementById('hNotes');
    var notes=notesEl?notesEl.value.trim():'';

    /* Close modal */
    var modal=document.getElementById('mH');
    if(modal)modal.classList.remove('on');

    UI.load(editId?'Updating...':'Saving...');

    var self=this;
    var payload={
      action:editId?'updateHisab':'addHisab',
      date:date,type:type,category:cat,
      amount:amount,
      receivedAmount:received,
      pendingAmount:Math.max(0,amount-received),
      yajmanId:yId,yajmanName:yN,
      poojaName:pj,description:desc,
      paymentMode:mode,
      paymentStatus:received>=amount?'paid':received>0?'partial':'pending',
      notes:notes
    };
    if(editId)payload.id=editId;

    API.post(payload).then(function(r){
      UI.unload();
      if(r.error){UI.toast('Error',r.error,'err');return}
      UI.toast('Saved!','Entry '+(editId?'updated':'added'),'ok');
      self.render();
    }).catch(function(e){
      UI.unload();
      UI.toast('Error',String(e.message||e),'err');
    });
  },

  /* ============================================================
     EDIT ENTRY
     ============================================================ */
  showEditEntry:function(entryId){
    var h=null;
    for(var i=0;i<this._data.length;i++){
      if(this._data[i].id===entryId){h=this._data[i];break}
    }
    if(!h){UI.toast('Error','Entry not found','err');return}

    this.showAddSingle(h.type,h.yajmanId);

    var self=this;
    setTimeout(function(){
      var editIdEl=document.getElementById('hEditId');
      if(editIdEl)editIdEl.value=h.id;

      var dateEl=document.getElementById('hDate');
      if(dateEl&&h.date)dateEl.value=h.date;

      var amtEl=document.getElementById('hAmt');
      if(amtEl)amtEl.value=h.amount||'';

      var catEl=document.getElementById('hCat');
      if(catEl&&h.category)catEl.value=h.category;

      var pjEl=document.getElementById('hPj');
      if(pjEl)pjEl.value=h.poojaName||'';

      var descEl=document.getElementById('hDesc');
      if(descEl)descEl.value=h.description||'';

      var recEl=document.getElementById('hRec');
      if(recEl)recEl.value=h.receivedAmount||'';

      var modeEl=document.getElementById('hMode');
      if(modeEl&&h.paymentMode)modeEl.value=h.paymentMode;

      var notesEl=document.getElementById('hNotes');
      if(notesEl)notesEl.value=h.notes||'';

      var title=document.querySelector('#mH .modal-t');
      if(title)title.textContent='‚úèÔ∏è Edit Entry';
    },200);
  },

  /* ============================================================
     MARK PAID
     ============================================================ */
  markPaid:function(id){
    if(!confirm('Mark as fully paid?'))return;
    UI.load('Updating...');
    var self=this;
    API.post({action:'markPaid',id:id}).then(function(r){
      UI.unload();
      if(r&&r.error){UI.toast('Error',r.error,'err');return}
      UI.toast('Done','Paid ‚úÖ','ok');
      self.render();
    }).catch(function(e){
      UI.unload();
      UI.toast('Error',String(e.message||e),'err');
    });
  },

  /* ============================================================
     DELETE
     ============================================================ */
  del:function(id){
    if(!confirm('Delete this entry permanently?'))return;
    UI.load('Deleting...');
    var self=this;
    API.post({action:'deleteHisab',id:id}).then(function(r){
      UI.unload();
      if(r&&r.error){UI.toast('Error',r.error,'err');return}
      UI.toast('Deleted','Entry removed','ok');
      self.render();
    }).catch(function(e){
      UI.unload();
      UI.toast('Error',String(e.message||e),'err');
    });
  },

  /* ============================================================
     FILTERS (called from other pages)
     ============================================================ */
  filterType:function(t){
    Nav.go('pgHisab');
    var self=this;
    setTimeout(function(){
      try{
        if(t==='pending'){
          UI.setVal('hFType','all');
          UI.setVal('hFStatus','pending');
        }else{
          UI.setVal('hFType',t);
          UI.setVal('hFStatus','all');
        }
        UI.setVal('hFSearch','');
        UI.setVal('hFCat','all');
        self.renderList();
      }catch(e){console.error(e)}
    },500);
  },

  filterYajman:function(yajId){
    Nav.go('pgHisab');
    var self=this;
    setTimeout(function(){
      var y=null;
      for(var i=0;i<App.D.yajmans.length;i++){
        if(App.D.yajmans[i].id===yajId){y=App.D.yajmans[i];break}
      }
      if(y){
        try{
          UI.setVal('hFType','all');
          UI.setVal('hFStatus','all');
          UI.setVal('hFCat','all');
          UI.setVal('hFSearch',y.name);
          self.renderList();
        }catch(e){console.error(e)}
      }
    },500);
  },

  addForYajman:function(yajId){
    Nav.go('pgHisab');
    var self=this;
    setTimeout(function(){self.showAddSingle('income',yajId)},500);
  },

  /* Backward compatibility aliases */
  showAdd:function(t,y){this.showAddSingle(t,y)},
  save:function(){this.saveSingle()},
  showEdit:function(id){this.showEditEntry(id)},
  setFilter:function(id,val){try{UI.setVal(id,val);this.renderList()}catch(e){}},

  /* ============================================================
     DOWNLOAD HISAB PDF
     ============================================================ */
  downloadHisabPDF:function(){
    if(!this._data||!this._data.length){UI.toast('Empty','No data to export','warn');return}
    var pi=PDFGen.getPanditInfo();
    var isPaid=!PDFWatermark.shouldAdd();

    var groups={};
    for(var i=0;i<this._data.length;i++){
      var h=this._data[i];
      var k=h.poojaName||'‡§Ö‡§®‡•ç‡§Ø';
      if(!groups[k])groups[k]={p:k,inc:0,exp:0,ent:[]};
      if(h.type==='income')groups[k].inc+=parseFloat(h.amount)||0;
      else groups[k].exp+=parseFloat(h.amount)||0;
      groups[k].ent.push(h);
    }

    var ht='<div id="hPdfR" style="width:700px;font-family:Noto Sans Devanagari,sans-serif;padding:20px;background:#fff;color:#000">';
    ht+=PDFGen.buildHeader();
    ht+='<h3 style="text-align:center;color:#FF6F00;margin-bottom:16px">‡§π‡§ø‡§∏‡§æ‡§¨ ‡§ï‡§ø‡§§‡§æ‡§¨</h3>';

    var ar=[];for(var k2 in groups){if(groups.hasOwnProperty(k2))ar.push(groups[k2])}
    ar.sort(function(a,b){return b.inc-a.inc});
    var gI=0,gE=0;

    for(var g=0;g<ar.length;g++){
      var gr=ar[g];gI+=gr.inc;gE+=gr.exp;
      ht+='<div style="margin-bottom:12px"><div style="background:#FFF3E0;padding:6px 10px;border-left:3px solid #FF6F00;font-weight:700;font-size:13px">üïâÔ∏è '+PDFGen._esc(gr.p)
        +' <span style="float:right;color:'+(gr.inc-gr.exp>=0?'green':'red')+'">‚Çπ'+(gr.inc-gr.exp)+'</span></div>'
        +'<table style="width:100%;border-collapse:collapse;font-size:10px"><tr style="background:#f5f5f5"><th style="border:1px solid #ddd;padding:3px">Date</th><th style="border:1px solid #ddd;padding:3px">Type</th><th style="border:1px solid #ddd;padding:3px">Details</th><th style="border:1px solid #ddd;padding:3px;text-align:right">‚Çπ</th></tr>';
      for(var e=0;e<gr.ent.length;e++){
        var en=gr.ent[e];var isI2=en.type==='income';
        ht+='<tr><td style="border:1px solid #eee;padding:2px">'+App.fmtD(en.date)+'</td><td style="border:1px solid #eee;padding:2px;color:'+(isI2?'green':'red')+'">'+(isI2?'‡§Ü‡§Ø':'‡§ñ‡§∞‡•ç‡§ö')+'</td><td style="border:1px solid #eee;padding:2px">'+PDFGen._esc(en.description||en.yajmanName||'')+'</td><td style="border:1px solid #eee;padding:2px;text-align:right;color:'+(isI2?'green':'red')+'">‚Çπ'+en.amount+'</td></tr>';
      }
      ht+='</table></div>';
    }
    ht+='<div style="padding:12px;background:#FFF3E0;border:2px solid #FF6F00;border-radius:8px;text-align:center;margin-top:10px"><div style="font-weight:700;color:#FF6F00">Grand Total</div><div style="font-size:12px"><span style="color:green">Income: ‚Çπ'+gI+'</span> | <span style="color:red">Expense: ‚Çπ'+gE+'</span> | <span style="color:#FF6F00;font-weight:800">Profit: ‚Çπ'+(gI-gE)+'</span></div></div>';
    ht+=PDFGen.buildFooter(1,1);
    ht+='</div>';

    var zone=document.getElementById('renderZone');
    if(!zone)return;
    zone.innerHTML=ht;
    var node=document.getElementById('hPdfR');
    if(!node)return;

    UI.load('Generating PDF...');
    html2canvas(node,{scale:2,useCORS:true,backgroundColor:'#ffffff'}).then(function(c){
      if(!isPaid)PDFWatermark.addToCanvas(c.getContext('2d'),c.width,c.height);
      var img=c.toDataURL('image/jpeg',0.92);
      var pdf=new jspdf.jsPDF('p','mm','a4');
      var pW=pdf.internal.pageSize.getWidth();
      var iW=pW-20;var iH=(c.height*iW)/c.width;
      pdf.addImage(img,'JPEG',10,10,iW,iH);
      pdf.save('Hisab_'+(pi.name||'ShubhArambh')+'_'+new Date().toISOString().split('T')[0]+'.pdf');
      zone.innerHTML='';
      UI.unload();
      UI.toast('Downloaded!','PDF saved','ok');
    }).catch(function(e){
      zone.innerHTML='';
      UI.unload();
      UI.toast('Error',String(e.message||e),'err');
    });
  }
};
</script>

<!-- BLOCK 12: Database Page Logic (COMPLETE) -->
<script>
var DBPage={
  render:function(){
    var data=App.D.master||[];
    var poojas=App.uPoojas();
    var custom=0;
    for(var i=0;i<data.length;i++){if(data[i].source==='user')custom++}
    UI.html('dbP',poojas.length);
    UI.html('dbI',data.length);
    UI.html('dbC',custom);

    var el=UI.$('dbList');if(!el)return;
    var q=(UI.val('dbSrch')||'').toLowerCase();
    var filtered=data;
    if(q)filtered=data.filter(function(d){
      return(d.pooja||'').toLowerCase().includes(q)||(d.samagri||'').toLowerCase().includes(q);
    });

    if(!filtered.length){
      el.innerHTML='<div style="text-align:center;padding:24px">'
        +'<div style="font-size:2.5rem;margin-bottom:8px">üóÑÔ∏è</div>'
        +'<p style="color:var(--g500);margin-bottom:10px">'+(q?'No matches found':'No data in database')+'</p>'
        +(!q?'<button class="btn btn-sm btn-p" onclick="DBPage.showAdd()">‚ûï Add First Items</button>':'')
        +'</div>';
      return;
    }

    /* Group by pooja */
    var groups={};
    for(var j=0;j<filtered.length;j++){
      var d=filtered[j];
      var p=d.pooja||'Unknown';
      if(!groups[p])groups[p]=[];
      groups[p].push(d);
    }

    var keys=Object.keys(groups).sort();
    var html='';
    for(var k=0;k<keys.length;k++){
      var pooja=keys[k];
      var items=groups[pooja];
      var secId='dbSec_'+k;

      html+='<div class="sec-h" onclick="var e=UI.$(\''+secId+'\');if(e)e.classList.toggle(\'hide\')">'
        +'üïâÔ∏è '+App.esc(pooja)+' <span class="sec-cnt">'+items.length+' items</span>'
        +'</div>';
      html+='<div id="'+secId+'" class="hide">';

      for(var m=0;m<items.length;m++){
        var item=items[m];
        var isCustom=item.source==='user';
        html+='<div style="display:flex;align-items:center;gap:6px;padding:5px 10px;border-bottom:1px solid rgba(255,255,255,0.03);font-size:.82rem">'
          +'<span style="flex:1;color:var(--g300)">'+App.esc(item.samagri)+'</span>'
          +'<span style="font-size:.6rem;color:'+(isCustom?'var(--bhagwa)':'var(--g600)')+'">'+(isCustom?'‚≠ê Custom':'Master')+'</span>'
          +'<button class="btn btn-xs btn-s" onclick="DBPage.editItem(\''+App.esc(item.pooja).replace(/'/g,"\\'")+'\',\''+App.esc(item.samagri).replace(/'/g,"\\'")+'\')">‚úèÔ∏è</button>'
          +'<button class="btn btn-xs btn-d" onclick="DBPage.del(\''+App.esc(item.pooja).replace(/'/g,"\\'")+'\',\''+App.esc(item.samagri).replace(/'/g,"\\'")+'\')">üóëÔ∏è</button>'
          +'</div>';
      }

      /* Add item inline */
      html+='<div style="display:flex;gap:4px;padding:6px 10px">'
        +'<input class="fi" id="dbInline_'+k+'" placeholder="‚ûï Add item to '+App.esc(pooja)+'..." '
        +'style="flex:1;padding:6px 8px;font-size:.8rem;border-style:dashed;border-color:rgba(255,111,0,0.3)" '
        +'onkeydown="if(event.key===\'Enter\')DBPage.addInline(\''+App.esc(pooja).replace(/'/g,"\\'")+'\','+k+')">'
        +'<button class="btn btn-xs btn-p" onclick="DBPage.addInline(\''+App.esc(pooja).replace(/'/g,"\\'")+'\','+k+')">Add</button>'
        +'</div>';

      html+='</div>';
    }
    el.innerHTML=html;
  },

  showAdd:function(){
    var m=UI.$('mDB');
    if(!m){m=document.createElement('div');m.id='mDB';m.className='modal';document.body.appendChild(m)}

    var poojas=App.uPoojas();
    var opts='<option value="">‚Äî Select Existing ‚Äî</option>';
    for(var i=0;i<poojas.length;i++){
      opts+='<option value="'+App.esc(poojas[i])+'">'+App.esc(poojas[i])+'</option>';
    }

    m.innerHTML='<div class="modal-box">'
      +'<div class="modal-h"><h3 class="modal-t">‚ûï Add Items to Database</h3>'
      +'<button class="modal-x" onclick="UI.modal(\'mDB\',0)">√ó</button></div>'
      +'<div class="modal-b">'
      +'<div style="padding:6px 10px;background:rgba(255,111,0,0.06);border-radius:var(--r-sm);margin-bottom:10px;border-left:3px solid var(--bhagwa);font-size:.68rem;color:var(--bhagwa-light)">'
      +'üìå Type pooja name or select existing. Add items one per line.</div>'
      +'<div class="fg"><label class="fl">Pooja Name *</label>'
      +'<input class="fi" id="dbPj" placeholder="Enter new or select below">'
      +'<select class="fsel" id="dbPjSel" onchange="UI.setVal(\'dbPj\',this.value)" style="margin-top:6px">'+opts+'</select></div>'
      +'<div class="fg"><label class="fl">Samagri Items (one per line) *</label>'
      +'<textarea class="ftx" id="dbItms" placeholder="‡§∞‡•ã‡§≤‡•Ä\n‡§Æ‡•å‡§≤‡•Ä\n‡§ö‡§æ‡§µ‡§≤\n‡§ï‡§™‡•Ç‡§∞\n‡§ß‡•Ç‡§™‡§¨‡§§‡•ç‡§§‡•Ä" style="min-height:120px"></textarea></div>'
      +'</div>'
      +'<div class="modal-f">'
      +'<button class="btn btn-s" onclick="UI.modal(\'mDB\',0)">Cancel</button>'
      +'<button class="btn btn-p" onclick="DBPage.addBulk()">‚ûï Add Items</button>'
      +'</div></div>';
    UI.modal('mDB',1);
  },

  addBulk:async function(){
    var pooja=UI.val('dbPj');
    var txt=UI.val('dbItms');
    if(!pooja){UI.toast('Required','Enter pooja name','warn');return}
    if(!txt){UI.toast('Required','Enter items','warn');return}
    var lines=txt.split('\n');
    var items=[];
    for(var i=0;i<lines.length;i++){
      var s=lines[i].trim();
      if(s)items.push(s);
    }
    if(!items.length){UI.toast('Empty','No valid items','warn');return}

    UI.modal('mDB',0);
    UI.load('Adding '+items.length+' items...');
    try{
      var payload={action:'addBulkItems',items:[]};
      for(var j=0;j<items.length;j++){
        payload.items.push({pooja:pooja,samagri:items[j]});
      }
      var r=await API.post(payload);
      UI.unload();
      UI.toast('Added!',(r.added||items.length)+' items to '+pooja,'ok');
      /* Refresh master data */
      var master=await API.get('getMaster');
      if(Array.isArray(master))App.D.master=master;
      this.render();
    }catch(e){UI.unload();UI.toast('Error',String(e.message||e),'err')}
  },

  addInline:async function(pooja,secIdx){
    var inp=UI.$('dbInline_'+secIdx);
    if(!inp)return;
    var val=inp.value.trim();
    if(!val){UI.toast('Empty','Type item name','warn');return}

    /* Check duplicate */
    for(var i=0;i<App.D.master.length;i++){
      if(App.D.master[i].pooja===pooja&&App.D.master[i].samagri===val){
        UI.toast('Exists','Already in database','warn');return;
      }
    }

    inp.value='';
    UI.load('Adding...');
    try{
      await API.post({action:'addItem',pooja:pooja,samagri:val});
      UI.unload();
      UI.toast('Added',val+' ‚Üí '+pooja,'ok');
      var master=await API.get('getMaster');
      if(Array.isArray(master))App.D.master=master;
      this.render();
    }catch(e){UI.unload();UI.toast('Error',String(e.message||e),'err')}
  },

  editItem:function(pooja,samagri){
    var newName=prompt('Edit item name:',samagri);
    if(!newName||newName.trim()===samagri)return;
    newName=newName.trim();
    UI.load('Updating...');
    API.post({action:'updateItem',pooja:pooja,oldSamagri:samagri,newSamagri:newName}).then(function(r){
      UI.unload();
      if(r.error){UI.toast('Error',r.error,'err');return}
      UI.toast('Updated',samagri+' ‚Üí '+newName,'ok');
      return API.get('getMaster');
    }).then(function(master){
      if(Array.isArray(master))App.D.master=master;
      DBPage.render();
    }).catch(function(e){UI.unload();UI.toast('Error',String(e.message||e),'err')});
  },

  del:async function(pooja,samagri){
    if(!confirm('Remove "'+samagri+'" from '+pooja+'?'))return;
    UI.load('Removing...');
    try{
      await API.post({action:'deleteItem',pooja:pooja,samagri:samagri});
      UI.unload();
      UI.toast('Removed',samagri,'ok');
      var master=await API.get('getMaster');
      if(Array.isArray(master))App.D.master=master;
      this.render();
    }catch(e){UI.unload();UI.toast('Error',String(e.message||e),'err')}
  }
};
</script>

<!-- BLOCK 13: Library Page Logic (COMPLETE) -->
<script>
var LibPage={
  render:function(){
    var el=UI.$('libGrid');if(!el)return;
    var list=App.D.templates||[];
    var q=(UI.val('libSrch')||'').toLowerCase();
    if(q)list=list.filter(function(t){
      return(t.name||'').toLowerCase().includes(q)||(t.poojas||'').toLowerCase().includes(q);
    });

    if(!list.length){
      el.innerHTML='<div class="card" style="text-align:center;padding:24px;grid-column:1/-1">'
        +'<div style="font-size:2.5rem;margin-bottom:8px">üìö</div>'
        +'<p style="color:var(--g500);margin-bottom:10px">'+(q?'No matches':'No templates saved yet')+'</p>'
        +'<p style="color:var(--g600);font-size:.75rem">Create a pooja from ‚ûï New tab and save to cloud</p>'
        +'</div>';
      return;
    }

    /* Sort newest first */
    var sorted=list.slice().reverse();

    var html='';
    for(var i=0;i<sorted.length;i++){
      var t=sorted[i];
      var poojaList=(t.poojas||'').split(',');
      var poojaCount=0;
      for(var p=0;p<poojaList.length;p++){if(poojaList[p].trim())poojaCount++}
      var itemCount=0;
      try{if(t.samagri&&Array.isArray(t.samagri))itemCount=t.samagri.length}catch(e){}

      html+='<div class="card" style="margin:0">'
        +'<div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:6px">'
        +'<div>'
        +'<div style="font-weight:700;color:#fff;font-size:.9rem">'+App.esc(t.name)+'</div>'
        +'<div style="font-size:.7rem;color:var(--g500);margin-top:2px">'
        +'üìÖ '+App.fmtD(t.date)
        +' ‚Ä¢ üïâÔ∏è '+poojaCount+' pooja'+(poojaCount!==1?'s':'')
        +(itemCount?' ‚Ä¢ üì¶ '+itemCount+' items':'')
        +'</div>'
        +'</div>'
        +'</div>';

      /* Pooja tags */
      if(t.poojas){
        html+='<div style="display:flex;flex-wrap:wrap;gap:3px;margin-bottom:8px">';
        for(var j=0;j<poojaList.length;j++){
          var pn=poojaList[j].trim();
          if(pn){
            html+='<span style="font-size:.6rem;color:var(--bhagwa-light);background:rgba(255,111,0,0.1);padding:1px 6px;border-radius:8px">'+App.esc(pn)+'</span>';
          }
        }
        html+='</div>';
      }

      /* Details row */
      if(t.phone||t.address){
        html+='<div style="font-size:.7rem;color:var(--g400);margin-bottom:6px">';
        if(t.phone)html+='üìû '+App.esc(String(t.phone))+' ';
        if(t.address)html+='üìç '+App.esc(t.address);
        html+='</div>';
      }

      /* Action buttons */
      html+='<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px">'
        +'<button class="btn btn-xs btn-p" onclick="LibPage.load(\''+t.id+'\')">üìÇ Open</button>'
        +'<button class="btn btn-xs btn-s" onclick="LibPage.duplicate(\''+t.id+'\')">üìã Copy</button>'
        +'<button class="btn btn-xs btn-d" onclick="LibPage.del(\''+t.id+'\')">üóëÔ∏è Delete</button>'
        +'</div>'
        +'</div>';
    }
    el.innerHTML=html;
  },

  load:function(id){
    var t=null;
    for(var i=0;i<App.D.templates.length;i++){
      if(App.D.templates[i].id===id){t=App.D.templates[i];break}
    }
    if(!t){UI.toast('Error','Template not found','err');return}

    /* Navigate to New Pooja page and pre-fill */
    Nav.go('pgNew');

    setTimeout(function(){
      /* Set yajman details */
      UI.setVal('npYajman',t.name||'');
      UI.setVal('npPhone',String(t.phone||''));
      UI.setVal('npAddr',t.address||'');
      if(t.date)UI.setVal('npDate',t.date);

      /* Set poojas */
      if(typeof NewPooja!=='undefined'){
        NewPooja._sel=[];
        if(t.poojas){
          var pList=t.poojas.split(',');
          for(var j=0;j<pList.length;j++){
            var pn=pList[j].trim();
            if(pn)NewPooja._sel.push({name:pn,order:j});
          }
        }
        NewPooja.drawPoojas();

        /* Set materials if available */
        if(t.samagri&&Array.isArray(t.samagri)){
          NewPooja._mats=[];
          for(var k=0;k<t.samagri.length;k++){
            var s=t.samagri[k];
            NewPooja._mats.push({
              pooja:s.pooja||'',name:s.name||s.samagri||'',
              qty:s.qty||'',unit:s.unit||'',on:s.on!==false,custom:!!s.custom
            });
          }
        }

        /* Auto go to materials if we have selections */
        if(NewPooja._sel.length){
          setTimeout(function(){
            NewPooja.goToMaterials();
          },300);
        }
      }
      UI.toast('Loaded',t.name,'ok');
    },400);
  },

  duplicate:function(id){
    var t=null;
    for(var i=0;i<App.D.templates.length;i++){
      if(App.D.templates[i].id===id){t=App.D.templates[i];break}
    }
    if(!t){UI.toast('Error','Not found','err');return}

    var newName=prompt('New name for copy:',t.name+' (Copy)');
    if(!newName)return;

    UI.load('Duplicating...');
    API.post({
      action:'saveTemplate',
      name:newName,date:new Date().toISOString().split('T')[0],
      poojas:t.poojas,samagri:t.samagri,phone:t.phone,address:t.address
    }).then(function(r){
      UI.unload();
      if(r.error){UI.toast('Error',r.error,'err');return}
      UI.toast('Duplicated!',newName,'ok');
      return API.get('getTemplates');
    }).then(function(templates){
      if(Array.isArray(templates))App.D.templates=templates;
      LibPage.render();
    }).catch(function(e){UI.unload();UI.toast('Error',String(e.message||e),'err')});
  },

  del:async function(id){
    if(!confirm('Delete this template permanently?'))return;
    UI.load('Deleting...');
    try{
      await API.post({action:'deleteTemplate',id:id});
      UI.unload();
      UI.toast('Deleted','Template removed','ok');
      var t=await API.get('getTemplates');
      if(Array.isArray(t))App.D.templates=t;
      this.render();
    }catch(e){UI.unload();UI.toast('Error',String(e.message||e),'err')}
  }
};
</script>

<!-- BLOCK 14: Profile Page Logic with UPI Details (COMPLETE) -->
<script>
window.ProfilePage={
  save:function(){
    UI.load('Saving profile...');
    API.post({
      action:'updateProfile',
      panditName:UI.val('prN'),panditTitle:UI.val('prT'),
      panditPhone:UI.val('prP'),panditWebsite:UI.val('prW'),
      panditAddress:UI.val('prA'),panditTagline:UI.val('prTag'),
      upiId:UI.val('prUPI'),upiName:UI.val('prUPIName')
    }).then(function(r){
      if(API.user){
        API.user.pandit={
          name:UI.val('prN'),title:UI.val('prT'),phone:UI.val('prP'),
          website:UI.val('prW'),address:UI.val('prA'),tagline:UI.val('prTag'),
          upiId:UI.val('prUPI'),upiName:UI.val('prUPIName')
        };
        localStorage.setItem('shubh_s',JSON.stringify(API.user));
        UI.html('topSub',API.user.pandit.name||API.user.name||'');
      }
      UI.unload();UI.toast('Saved!','Profile updated','ok');
    }).catch(function(e){UI.unload();UI.toast('Error',String(e.message||e),'err')});
  },

  togglePass:function(id,btn){
    var inp=document.getElementById(id);if(!inp)return;
    if(inp.type==='password'){inp.type='text';if(btn){btn.innerHTML='üôà';btn.style.color='var(--bhagwa-light)'}}
    else{inp.type='password';if(btn){btn.innerHTML='üëÅÔ∏è';btn.style.color='var(--g400)'}}
  },

  changePassword:function(){
    var cur=UI.val('prCurPass'),np=UI.val('prNewPass'),np2=UI.val('prNewPass2');
    if(!cur){UI.toast('Required','Enter current password','warn');return}
    if(!np||np.length<6){UI.toast('Weak','Min 6 characters','warn');return}
    if(np!==np2){UI.toast('Mismatch','Passwords do not match','warn');return}
    UI.load('Changing...');
    API.post({action:'changePassword',currentPassword:cur,newPassword:np}).then(function(r){
      UI.unload();if(r.error){UI.toast('Error',r.error,'err');return}
      UI.toast('Done!','Password changed','ok');
      UI.setVal('prCurPass','');UI.setVal('prNewPass','');UI.setVal('prNewPass2','');
    }).catch(function(e){UI.unload();UI.toast('Error',String(e.message||e),'err')});
  },

  previewPDF:function(){
    var el=document.getElementById('prPDFPreview');if(!el)return;
    var pi=PDFGen.getPanditInfo();
    var isPaid=!PDFWatermark.shouldAdd();
    el.innerHTML=
      '<div style="background:#FFF3E0;border-radius:8px;padding:12px;margin-bottom:8px;border:2px solid #FF6F00;text-align:center">'
      +'<div style="font-size:.55rem;color:#888;text-align:left">üìÑ HEADER</div>'
      +'<div style="border-bottom:3px double #FF6F00;padding-bottom:8px">'
      +'<div style="font-size:10px;color:#FF6F00;letter-spacing:3px">‡•• ‡§∂‡•ç‡§∞‡•Ä ‡§ó‡§£‡•á‡§∂‡§æ‡§Ø ‡§®‡§Æ‡§É ‡••</div>'
      +'<div style="font-size:1.2rem;font-weight:800;color:#E65100">'+(pi.name||'Your Name')+'</div>'
      +(pi.title?'<div style="font-size:.75rem;color:#666">'+App.esc(pi.title)+'</div>':'')
      +(pi.tagline?'<div style="font-size:.65rem;color:#999;font-style:italic">'+App.esc(pi.tagline)+'</div>':'')
      +'</div>'
      +'<div style="font-size:.6rem;color:#888;margin-top:4px">'
      +(pi.phone?'üìû '+pi.phone:'')+(pi.website?' ‚Ä¢ üåê '+pi.website:'')+'</div></div>'

      +'<div style="background:#FFF3E0;border-radius:8px;padding:10px;border:2px solid #FF6F00;text-align:center">'
      +'<div style="font-size:.55rem;color:#888;text-align:left">üìÑ FOOTER</div>'
      +'<div style="border-top:2px solid #FF6F00;padding-top:6px">'
      +'<div style="font-size:.7rem;color:#555;font-weight:600">'+(pi.name||'Name')+'</div>'
      +(pi.address?'<div style="font-size:.55rem;color:#888">üìç '+App.esc(pi.address)+'</div>':'')
      +'</div>'
      +(!isPaid?'<div style="margin-top:6px;padding:3px;background:rgba(255,111,0,0.1);border-radius:4px;font-size:.55rem;color:#FF6F00;font-weight:600">‚ö†Ô∏è FREE: Watermark on PDF</div>'
        :'<div style="margin-top:6px;font-size:.55rem;color:#00C853">‚úÖ Premium: No Watermark</div>')
      +'</div>';
  },

  backup:function(){
    try{
      var d={exportDate:new Date().toISOString(),version:CFG.VER,app:'ShubhArambh',
        user:{name:(API.user&&API.user.name)||'',email:(API.user&&API.user.email)||''},
        data:{master:App.D.master||[],templates:App.D.templates||[],yajmans:App.D.yajmans||[],hisab:App.D.hisab||[]}};
      var blob=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});
      var a=document.createElement('a');a.href=URL.createObjectURL(blob);
      a.download='ShubhArambh_Backup_'+new Date().toISOString().split('T')[0]+'.json';
      document.body.appendChild(a);a.click();document.body.removeChild(a);
      URL.revokeObjectURL(a.href);UI.toast('Exported!','Backup downloaded','ok');
    }catch(e){UI.toast('Error',String(e.message||e),'err')}
  }
};
</script>


<!-- BLOCK 15: New Pooja + PROFESSIONAL PDF ENGINE (COMPLETE) -->
<script>
window.NewPooja={
  _sel:[],
  _mats:[],

  pickYajman:function(){
    var old=document.getElementById('mPickYaj');if(old)old.remove();
    var m=document.createElement('div');m.id='mPickYaj';m.className='modal';document.body.appendChild(m);
    var list=App.D.yajmans||[];
    var lh='';
    if(!list.length){lh='<p style="color:var(--g500);text-align:center;padding:16px">No saved yajmans</p>';}
    else{for(var i=0;i<list.length;i++){var y=list[i];
      lh+='<div class="lrow" style="cursor:pointer" onclick="window.NewPooja._selectYajman(\''+y.id+'\')">'
        +'<div class="lrow-i" style="background:var(--grad-b);width:32px;height:32px;font-size:.85rem">üë§</div>'
        +'<div class="lrow-b"><div class="lrow-n" style="font-size:.85rem">'+App.esc(y.name)+'</div>'
        +'<div class="lrow-m">'+(y.phone||'')+(y.city?' ‚Ä¢ '+y.city:'')+'</div></div></div>';}}
    m.innerHTML='<div class="modal-box"><div class="modal-h"><h3 class="modal-t">üìã Select Yajman</h3>'
      +'<button class="modal-x" onclick="document.getElementById(\'mPickYaj\').classList.remove(\'on\')">√ó</button></div>'
      +'<div class="modal-b"><input class="fi" placeholder="üîç Search..." oninput="window.NewPooja._filterPick(this.value)" style="margin-bottom:10px">'
      +'<div id="pickYajList" style="max-height:50vh;overflow:auto">'+lh+'</div></div></div>';
    m.classList.add('on');
  },

  _filterPick:function(q){
    q=q.toLowerCase();
    var list=App.D.yajmans.filter(function(y){return(y.name||'').toLowerCase().indexOf(q)!==-1||(y.phone||'').indexOf(q)!==-1});
    var h='';for(var i=0;i<list.length;i++){var y=list[i];
      h+='<div class="lrow" style="cursor:pointer" onclick="window.NewPooja._selectYajman(\''+y.id+'\')">'
        +'<div class="lrow-i" style="background:var(--grad-b);width:32px;height:32px;font-size:.85rem">üë§</div>'
        +'<div class="lrow-b"><div class="lrow-n" style="font-size:.85rem">'+App.esc(y.name)+'</div></div></div>';}
    if(!h)h='<p style="color:var(--g500);text-align:center;padding:10px">No match</p>';
    document.getElementById('pickYajList').innerHTML=h;
  },

  _selectYajman:function(id){
    var y=null;for(var i=0;i<App.D.yajmans.length;i++){if(App.D.yajmans[i].id===id){y=App.D.yajmans[i];break}}
    if(!y)return;
    document.getElementById('mPickYaj').classList.remove('on');
    UI.setVal('npYajman',y.name);UI.setVal('npPhone',String(y.phone||''));
    UI.setVal('npAddr',(y.address||'')+(y.city?', '+y.city:''));
    App._selectedYajman=y;UI.toast('Selected',y.name,'ok');
  },

  drawPoojas:function(){
    var el=document.getElementById('npPoojaList');if(!el)return;
    var all=App.uPoojas();
    var q='';try{q=(UI.val('npPSearch')||'').toLowerCase()}catch(e){}
    if(q)all=all.filter(function(n){return n.toLowerCase().indexOf(q)!==-1});
    if(!all.length){el.innerHTML='<div style="text-align:center;padding:16px"><p style="color:var(--g500)">'+(q?'No match':'No poojas. Add from Database tab.')+'</p></div>';return}
    var html='';
    for(var i=0;i<all.length;i++){
      var name=all[i];var cnt=0;
      for(var j=0;j<App.D.master.length;j++){if(App.D.master[j].pooja===name)cnt++}
      var sel=false;var idx=-1;
      for(var k=0;k<this._sel.length;k++){if(this._sel[k].name===name){sel=true;idx=k;break}}
      html+='<div class="lrow" style="cursor:pointer;'+(sel?'background:rgba(255,111,0,0.06);border-left:3px solid var(--bhagwa)':'')+'" onclick="window.NewPooja.togPooja(\''+App.esc(name).replace(/'/g,"\\'")+'\')">'
        +'<div style="width:22px;height:22px;border:2px solid '+(sel?'var(--bhagwa)':'var(--g500)')+';border-radius:5px;display:grid;place-items:center;flex-shrink:0;font-size:.7rem;'+(sel?'background:var(--grad-b);color:#fff':'')+'">'+(sel?'‚úì':'')+'</div>'
        +'<div class="lrow-b"><div class="lrow-n" style="font-size:.88rem">'+(sel?'<span style="background:rgba(255,111,0,0.2);color:var(--bhagwa-light);padding:1px 6px;border-radius:10px;font-size:.65rem;margin-right:4px">'+(idx+1)+'</span>':'')+App.esc(name)+'</div>'
        +'<div class="lrow-m">'+cnt+' items</div></div>';
      if(sel){html+='<div style="display:flex;gap:3px" onclick="event.stopPropagation()">'
        +'<button class="btn btn-xs btn-s" onclick="window.NewPooja.moveP('+idx+',-1)">‚ñ≤</button>'
        +'<button class="btn btn-xs btn-s" onclick="window.NewPooja.moveP('+idx+',1)">‚ñº</button></div>';}
      html+='</div>';
    }
    el.innerHTML=html;
    var sc=document.getElementById('npSelCount');if(sc)sc.textContent=this._sel.length+' selected';
  },

  togPooja:function(name){var f=-1;for(var i=0;i<this._sel.length;i++){if(this._sel[i].name===name){f=i;break}}
    if(f>-1)this._sel.splice(f,1);else this._sel.push({name:name,order:this._sel.length});this.drawPoojas()},
  moveP:function(i,d){var j=i+d;if(j<0||j>=this._sel.length)return;var t=this._sel[i];this._sel[i]=this._sel[j];this._sel[j]=t;this.drawPoojas()},
  selAll:function(){var a=App.uPoojas();this._sel=[];for(var i=0;i<a.length;i++)this._sel.push({name:a[i],order:i});this.drawPoojas()},
  selNone:function(){this._sel=[];this.drawPoojas()},

  goToMaterials:function(){
    var yaj=UI.val('npYajman');if(!yaj){UI.toast('Required','Enter yajman name','warn');return}
    if(!this._sel.length){UI.toast('Required','Select at least one pooja','warn');return}
    this.buildMats();this.drawMats();
    var w=document.getElementById('npMatsWrap');if(w)w.classList.remove('hide');
    var b=document.getElementById('npNextBtn');if(b)b.classList.add('hide');
    if(w)window.scrollTo({top:w.offsetTop-80,behavior:'smooth'});
  },

  buildMats:function(){
    var ex={};for(var i=0;i<this._mats.length;i++){var m=this._mats[i];ex[m.pooja+'||'+m.name]=m}
    var nm=[];
    for(var j=0;j<this._sel.length;j++){var p=this._sel[j];
      for(var k=0;k<App.D.master.length;k++){var d=App.D.master[k];
        if(d.pooja===p.name){var key=p.name+'||'+d.samagri;
          if(ex[key])nm.push(ex[key]);else nm.push({pooja:p.name,name:d.samagri,qty:'',unit:'',on:true,custom:false})}}
      for(var c=0;c<this._mats.length;c++){var cm=this._mats[c];
        if(cm.pooja===p.name&&cm.custom){var exists=false;
          for(var n=0;n<nm.length;n++){if(nm[n].pooja===cm.pooja&&nm[n].name===cm.name){exists=true;break}}
          if(!exists)nm.push(cm)}}}
    this._mats=nm;
  },

  drawMats:function(){
    var c=document.getElementById('npMatSections');if(!c)return;
    var fq='';try{fq=(UI.val('npMatSearch')||'').toLowerCase()}catch(e){}
    var units=['‡§ó‡•ç‡§∞‡§æ‡§Æ','‡§ï‡§ø‡§ó‡•ç‡§∞‡§æ','‡§®‡§ó','‡§™‡•à‡§ï‡•á‡§ü','‡§ú‡•ã‡§°‡§º‡§æ','‡§∞‡•Å‡§™‡§Ø‡•á','‡§≤‡•Ä‡§ü‡§∞','‡§≤‡§ö‡•ç‡§õ‡§æ','‡§Æ‡•Ä‡§ü‡§∞','‡§¨‡§£‡•ç‡§°‡§≤','‡§õ‡•ã‡§ü‡•Ä ‡§∂‡•Ä‡§∂‡•Ä','‡§¨‡§°‡§º‡•Ä ‡§∂‡•Ä‡§∂‡•Ä'];
    var html='';
    for(var s=0;s<this._sel.length;s++){
      var p=this._sel[s];var items=[];var total=0;var onCnt=0;
      for(var i=0;i<this._mats.length;i++){if(this._mats[i].pooja===p.name){total++;if(this._mats[i].on)onCnt++;
        if(!fq||this._mats[i].name.toLowerCase().indexOf(fq)!==-1)items.push({mat:this._mats[i],gi:i})}}
      html+='<div style="margin-bottom:12px"><div class="sec-h">üïâÔ∏è '+App.esc(p.name)+' <span class="sec-cnt">'+onCnt+'/'+total+'</span></div>';
      for(var j=0;j<items.length;j++){var m=items[j].mat;var gi=items[j].gi;
        var uO='<option value="">Unit</option>';for(var u=0;u<units.length;u++){uO+='<option'+(m.unit===units[u]?' selected':'')+'>'+units[u]+'</option>'}
        html+='<div style="display:grid;grid-template-columns:22px 1fr 65px 80px'+(m.custom?' 26px':'')+';gap:5px;align-items:center;padding:4px 8px;border-bottom:1px solid rgba(255,255,255,0.03);'+(!m.on?'opacity:.4':'')+(m.custom?'border-left:2px solid var(--gold);':'')+'">'
          +'<input type="checkbox" style="accent-color:var(--bhagwa)" '+(m.on?'checked':'')+' onchange="window.NewPooja._mats['+gi+'].on=this.checked;window.NewPooja.drawMats()">'
          +'<div style="font-size:.82rem;color:#fff;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+App.esc(m.name)+(m.custom?' ‚≠ê':'')+'</div>'
          +'<input style="padding:4px;background:rgba(255,255,255,0.04);border:1px solid var(--card-border);border-radius:4px;color:#fff;font-size:.8rem;text-align:center;outline:none" placeholder="Qty" value="'+(m.qty||'')+'" oninput="window.NewPooja._mats['+gi+'].qty=this.value">'
          +'<select style="padding:4px;background:rgba(255,255,255,0.04);border:1px solid var(--card-border);border-radius:4px;color:#fff;font-size:.78rem;outline:none" onchange="window.NewPooja._mats['+gi+'].unit=this.value">'+uO+'</select>';
        if(m.custom)html+='<button style="background:none;border:none;color:var(--err);cursor:pointer;font-size:.8rem" onclick="window.NewPooja._mats.splice('+gi+',1);window.NewPooja.drawMats()">üóëÔ∏è</button>';
        html+='</div>'}
      html+='<div style="display:flex;gap:4px;margin-top:4px;padding:4px 8px">'
        +'<input class="fi" id="npAdd_'+s+'" placeholder="‚ûï Add custom..." style="padding:6px 8px;font-size:.8rem;flex:1;border-style:dashed;border-color:rgba(255,111,0,0.3)" onkeydown="if(event.key===\'Enter\')window.NewPooja.addCustom(\''+App.esc(p.name).replace(/'/g,"\\'")+'\','+s+')">'
        +'<button class="btn btn-xs btn-p" onclick="window.NewPooja.addCustom(\''+App.esc(p.name).replace(/'/g,"\\'")+'\','+s+')">Add</button></div></div>'}
    c.innerHTML=html;
  },

  addCustom:function(pooja,secIdx){
    var inp=document.getElementById('npAdd_'+secIdx);if(!inp)return;var val=inp.value.trim();if(!val)return;
    for(var i=0;i<this._mats.length;i++){if(this._mats[i].pooja===pooja&&this._mats[i].name===val){UI.toast('Exists','Already added','warn');return}}
    this._mats.push({pooja:pooja,name:val,qty:'',unit:'',on:true,custom:true});inp.value='';this.drawMats();
    API.post({action:'addItem',pooja:pooja,samagri:val}).catch(function(){});
  },

  goToPreview:function(){
    var w=document.getElementById('npPreviewWrap');if(w)w.classList.remove('hide');
    if(w)window.scrollTo({top:w.offsetTop-80,behavior:'smooth'});
    var self=this;setTimeout(function(){self.buildPreview()},300);
  },

  /* ============================================================
     PROFESSIONAL 2-COLUMN PDF PREVIEW
     Pandit header/footer from profile
     2-column samagri layout
     Watermark for free users
     ============================================================ */
  buildPreview:function(){
    var el=document.getElementById('npPreview');if(!el)return;
    var enabled=[];
    for(var i=0;i<this._mats.length;i++){if(this._mats[i].on)enabled.push(this._mats[i])}

    var pi=PDFGen.getPanditInfo();
    var isPaid=!PDFWatermark.shouldAdd();
    var yajman=UI.val('npYajman')||'';
    var date=UI.val('npDate')||'';
    var phone=UI.val('npPhone')||'';
    var addr=UI.val('npAddr')||'';
    var poojaNames=this._sel.map(function(p){return p.name}).join(', ');

    /* Split items into 2 columns */
    var half=Math.ceil(enabled.length/2);
    var col1=enabled.slice(0,half);
    var col2=enabled.slice(half);

    /* Build rows for table */
    function buildRows(items,startIdx){
      var r='';
      for(var i=0;i<items.length;i++){
        var m=items[i];
        var num=startIdx+i+1;
        var qtyText=((m.qty||'')+' '+(m.unit||'')).trim();
        r+='<tr>'
          +'<td style="border:1px solid #d0d0d0;padding:3px 5px;text-align:center;font-size:10px;color:#666;width:22px">'+num+'</td>'
          +'<td style="border:1px solid #d0d0d0;padding:3px 6px;font-size:11px">'+App.esc(m.name)+'</td>'
          +'<td style="border:1px solid #d0d0d0;padding:3px 5px;font-size:10px;text-align:center;width:55px;color:#555">'+qtyText+'</td>'
          +'<td style="border:1px solid #d0d0d0;padding:3px 5px;text-align:center;width:22px;font-size:12px">‚òê</td>'
          +'</tr>';
      }
      return r;
    }

    var h='<div id="pdfRenderTarget" style="width:750px;background:#fff;color:#000;font-family:\'Noto Serif Devanagari\',\'Noto Sans Devanagari\',serif;padding:0;position:relative">';

    /* ===== WATERMARK FOR FREE ===== */
    if(!isPaid){
      h+='<div style="position:absolute;top:45%;left:50%;transform:translate(-50%,-50%) rotate(-35deg);font-size:52px;color:rgba(255,111,0,0.05);font-weight:900;white-space:nowrap;pointer-events:none;z-index:1;letter-spacing:8px">‡§∂‡•Å‡§≠‡§æ‡§∞‡§Ç‡§≠</div>';
    }

    /* ===== HEADER (from Pandit Profile) ===== */
    h+='<div style="padding:18px 24px 12px;border-bottom:3px double #E65100;position:relative;z-index:2">';

    /* Decorative top line */
    h+='<div style="text-align:center;font-size:11px;color:#E65100;letter-spacing:6px;font-weight:600;margin-bottom:6px">‡•• ‡§∂‡•ç‡§∞‡•Ä ‡§ó‡§£‡•á‡§∂‡§æ‡§Ø ‡§®‡§Æ‡§É ‡••</div>';

    /* Pandit name - big */
    if(pi.name){
      h+='<div style="text-align:center;font-size:22px;font-weight:800;color:#E65100;line-height:1.2">'+PDFGen._esc(pi.name)+'</div>';
    }

    /* Title */
    if(pi.title){
      h+='<div style="text-align:center;font-size:11px;color:#666;margin-top:1px">'+PDFGen._esc(pi.title)+'</div>';
    }

    /* Tagline */
    if(pi.tagline){
      h+='<div style="text-align:center;font-size:10px;color:#999;font-style:italic;margin-top:2px">„Äå'+PDFGen._esc(pi.tagline)+'„Äç</div>';
    }

    /* Contact line */
    var contactParts=[];
    if(pi.phone)contactParts.push('üìû '+PDFGen._esc(pi.phone));
    if(pi.address)contactParts.push('üìç '+PDFGen._esc(pi.address));
    if(pi.website)contactParts.push('üåê '+PDFGen._esc(pi.website));
    if(contactParts.length){
      h+='<div style="text-align:center;font-size:9px;color:#888;margin-top:4px">'+contactParts.join(' | ')+'</div>';
    }
    h+='</div>';

    /* ===== TITLE BAR ===== */
    h+='<div style="background:linear-gradient(135deg,#FF6F00,#FF8F00);padding:8px 24px;text-align:center">'
      +'<div style="font-size:16px;font-weight:700;color:#fff;letter-spacing:2px">‡§™‡•Ç‡§ú‡§æ ‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä ‡§∏‡•Ç‡§ö‡•Ä</div>'
      +'</div>';

    /* ===== YAJMAN DETAILS BAR ===== */
    h+='<div style="padding:10px 24px;background:#FFF8E1;border-bottom:1px solid #FFE0B2">';
    h+='<table style="width:100%;font-size:11px;color:#333"><tr>';
    h+='<td style="padding:2px 0"><b>‡§Ø‡§ú‡§Æ‡§æ‡§®:</b> '+PDFGen._esc(yajman)+'</td>';
    h+='<td style="padding:2px 0;text-align:right"><b>‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï:</b> '+App.fmtD(date)+'</td>';
    h+='</tr>';
    if(phone||addr){
      h+='<tr>';
      h+='<td style="padding:2px 0"><b>‡§™‡§§‡§æ:</b> '+PDFGen._esc(addr||'-')+'</td>';
      h+='<td style="padding:2px 0;text-align:right"><b>‡§´‡§º‡•ã‡§®:</b> '+PDFGen._esc(phone||'-')+'</td>';
      h+='</tr>';
    }
    h+='</table>';
    h+='<div style="font-size:10px;color:#E65100;margin-top:4px;font-weight:600">üïâÔ∏è ‡§™‡•Ç‡§ú‡§æ: '+PDFGen._esc(poojaNames)+'</div>';
    h+='</div>';

    /* ===== SAMAGRI TABLE - 2 COLUMNS ===== */
    h+='<div style="padding:12px 24px;position:relative;z-index:2">';

    /* Per-pooja sections if multiple poojas */
    if(this._sel.length>1){
      for(var s=0;s<this._sel.length;s++){
        var pName=this._sel[s].name;
        var pItems=[];
        for(var pi2=0;pi2<enabled.length;pi2++){
          if(enabled[pi2].pooja===pName)pItems.push(enabled[pi2]);
        }
        if(!pItems.length)continue;

        h+='<div style="background:#FFF3E0;padding:4px 10px;border-left:3px solid #FF6F00;font-weight:700;font-size:12px;color:#E65100;margin-bottom:6px;margin-top:'+(s>0?'12px':'0')+'">üïâÔ∏è '+PDFGen._esc(pName)+' ('+pItems.length+' items)</div>';

        var pH=Math.ceil(pItems.length/2);
        var pC1=pItems.slice(0,pH);
        var pC2=pItems.slice(pH);

        h+='<table style="width:100%;border-collapse:collapse" cellspacing="0"><tr><td style="vertical-align:top;width:50%;padding-right:6px">'
          +'<table style="width:100%;border-collapse:collapse">'
          +'<tr style="background:#FFF3E0"><th style="border:1px solid #ccc;padding:3px;font-size:9px;width:22px">#</th>'
          +'<th style="border:1px solid #ccc;padding:3px;font-size:9px;text-align:left">‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä</th>'
          +'<th style="border:1px solid #ccc;padding:3px;font-size:9px;width:55px">‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ</th>'
          +'<th style="border:1px solid #ccc;padding:3px;font-size:9px;width:22px">‚úì</th></tr>'
          +buildRows(pC1,0)
          +'</table></td>'
          +'<td style="vertical-align:top;width:50%;padding-left:6px">'
          +'<table style="width:100%;border-collapse:collapse">'
          +'<tr style="background:#FFF3E0"><th style="border:1px solid #ccc;padding:3px;font-size:9px;width:22px">#</th>'
          +'<th style="border:1px solid #ccc;padding:3px;font-size:9px;text-align:left">‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä</th>'
          +'<th style="border:1px solid #ccc;padding:3px;font-size:9px;width:55px">‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ</th>'
          +'<th style="border:1px solid #ccc;padding:3px;font-size:9px;width:22px">‚úì</th></tr>'
          +buildRows(pC2,pH)
          +'</table></td></tr></table>';
      }
    }else{
      /* Single pooja - all items in 2 columns */
      h+='<table style="width:100%;border-collapse:collapse" cellspacing="0"><tr>'
        +'<td style="vertical-align:top;width:50%;padding-right:6px">'
        +'<table style="width:100%;border-collapse:collapse">'
        +'<tr style="background:#FFF3E0"><th style="border:1px solid #ccc;padding:3px;font-size:9px;width:22px">#</th>'
        +'<th style="border:1px solid #ccc;padding:3px;font-size:9px;text-align:left">‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä</th>'
        +'<th style="border:1px solid #ccc;padding:3px;font-size:9px;width:55px">‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ</th>'
        +'<th style="border:1px solid #ccc;padding:3px;font-size:9px;width:22px">‚úì</th></tr>'
        +buildRows(col1,0)
        +'</table></td>'
        +'<td style="vertical-align:top;width:50%;padding-left:6px">'
        +'<table style="width:100%;border-collapse:collapse">'
        +'<tr style="background:#FFF3E0"><th style="border:1px solid #ccc;padding:3px;font-size:9px;width:22px">#</th>'
        +'<th style="border:1px solid #ccc;padding:3px;font-size:9px;text-align:left">‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä</th>'
        +'<th style="border:1px solid #ccc;padding:3px;font-size:9px;width:55px">‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ</th>'
        +'<th style="border:1px solid #ccc;padding:3px;font-size:9px;width:22px">‚úì</th></tr>'
        +buildRows(col2,half)
        +'</table></td></tr></table>';
    }

    h+='<div style="text-align:right;font-size:10px;color:#888;margin-top:6px">‡§ï‡•Å‡§≤ ‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä: '+enabled.length+' items</div>';
    h+='</div>';

    /* ===== NOTES SECTION ===== */
    h+='<div style="padding:0 24px 8px"><div style="border:1px dashed #FFB74D;border-radius:6px;padding:8px;background:#FFFDE7">'
      +'<div style="font-size:10px;font-weight:700;color:#E65100;margin-bottom:3px">üìù ‡§µ‡§ø‡§∂‡•á‡§∑ ‡§®‡§ø‡§∞‡•ç‡§¶‡•á‡§∂ / Special Instructions:</div>'
      +'<div style="min-height:30px;font-size:10px;color:#999">_______________________________________</div>'
      +'</div></div>';

    /* ===== FOOTER (from Pandit Profile) ===== */
    h+='<div style="padding:10px 24px;border-top:3px double #E65100;background:#FFF8E1;position:relative;z-index:2">';

    h+='<table style="width:100%;font-size:9px;color:#666"><tr>'
      +'<td style="vertical-align:top">';
    if(pi.name)h+='<div style="font-weight:700;color:#E65100;font-size:11px">'+PDFGen._esc(pi.name)+'</div>';
    if(pi.title)h+='<div style="color:#888">'+PDFGen._esc(pi.title)+'</div>';
    h+='</td><td style="text-align:right;vertical-align:top">';
    if(pi.phone)h+='<div>üìû '+PDFGen._esc(pi.phone)+'</div>';
    if(pi.address)h+='<div>üìç '+PDFGen._esc(pi.address)+'</div>';
    if(pi.website)h+='<div>üåê '+PDFGen._esc(pi.website)+'</div>';
    h+='</td></tr></table>';

    if(!isPaid){
      h+='<div style="text-align:center;margin-top:4px;padding:2px 6px;background:rgba(255,111,0,0.08);border-radius:3px;font-size:7px;color:#FF6F00">Generated by ‡§∂‡•Å‡§≠‡§æ‡§∞‡§Ç‡§≠ - Free Version | shubharambh.com</div>';
    }else{
      h+='<div style="text-align:center;margin-top:4px;font-size:7px;color:#ccc">Page 1</div>';
    }
    h+='</div>';

    h+='</div>';
    el.innerHTML=h;
  },

  saveCloud:function(){
    var name=UI.val('npYajman');if(!name){UI.toast('Required','Enter yajman name','warn');return}
    UI.load('Saving...');
    var self=this;
    API.post({
      action:'saveTemplate',name:name,date:UI.val('npDate'),
      poojas:this._sel.map(function(p){return p.name}).join(', '),
      samagri:this._mats.filter(function(m){return m.on}),
      phone:UI.val('npPhone'),address:UI.val('npAddr')
    }).then(function(){
      UI.unload();UI.toast('Saved!','Cloud saved','ok');
      return API.get('getTemplates');
    }).then(function(t){if(Array.isArray(t))App.D.templates=t;
    }).catch(function(e){UI.unload();UI.toast('Error',String(e.message||e),'err')});
  },

  dlPDF:function(){
    var target=document.getElementById('pdfRenderTarget');
    if(!target){UI.toast('Preview First','Build preview before downloading','warn');return}
    var isPaid=!PDFWatermark.shouldAdd();
    var pi=PDFGen.getPanditInfo();
    var yajName=UI.val('npYajman')||'Pooja';
    UI.load('Generating PDF...');

    html2canvas(target,{scale:2.5,useCORS:true,backgroundColor:'#ffffff',logging:false}).then(function(canvas){
      if(!isPaid)PDFWatermark.addToCanvas(canvas.getContext('2d'),canvas.width,canvas.height);
      var imgData=canvas.toDataURL('image/jpeg',0.95);
      var pdf=new jspdf.jsPDF('p','mm','a4');
      var pageW=pdf.internal.pageSize.getWidth();
      var pageH=pdf.internal.pageSize.getHeight();
      var imgW=pageW-16;
      var imgH=(canvas.height*imgW)/canvas.width;

      if(imgH<=pageH-16){
        pdf.addImage(imgData,'JPEG',8,8,imgW,imgH);
      }else{
        /* Multi page */
        var ratio=imgW/canvas.width;
        var pageImgH=(pageH-16)/ratio;
        var yPos=0;var pg=0;
        while(yPos<canvas.height){
          if(pg>0)pdf.addPage();
          var sliceH=Math.min(pageImgH,canvas.height-yPos);
          var sc=document.createElement('canvas');
          sc.width=canvas.width;sc.height=sliceH;
          var sx=sc.getContext('2d');
          sx.drawImage(canvas,0,yPos,canvas.width,sliceH,0,0,canvas.width,sliceH);
          var si=sc.toDataURL('image/jpeg',0.95);
          pdf.addImage(si,'JPEG',8,8,imgW,sliceH*ratio);
          yPos+=sliceH;pg++;
        }
      }
      pdf.save('Samagri_'+yajName.replace(/[^a-zA-Z0-9\u0900-\u097F]/g,'_')+'_'+new Date().toISOString().split('T')[0]+'.pdf');
      UI.unload();UI.toast('Downloaded!','PDF saved','ok');
    }).catch(function(e){UI.unload();UI.toast('Error','PDF failed: '+String(e.message||e),'err')});
  },

  dlImages:function(){
    var target=document.getElementById('pdfRenderTarget');
    if(!target){UI.toast('Preview First','Build preview first','warn');return}
    var isPaid=!PDFWatermark.shouldAdd();
    var yajName=UI.val('npYajman')||'Pooja';
    UI.load('Generating image...');
    html2canvas(target,{scale:2.5,useCORS:true,backgroundColor:'#ffffff'}).then(function(canvas){
      if(!isPaid)PDFWatermark.addToCanvas(canvas.getContext('2d'),canvas.width,canvas.height);
      canvas.toBlob(function(blob){
        if(!blob){UI.unload();UI.toast('Error','Failed','err');return}
        var a=document.createElement('a');a.href=URL.createObjectURL(blob);
        a.download='Samagri_'+yajName+'.png';a.click();URL.revokeObjectURL(a.href);
        UI.unload();UI.toast('Downloaded!','Image saved','ok');
      },'image/png');
    }).catch(function(e){UI.unload();UI.toast('Error',String(e.message||e),'err')});
  },

  share:function(){
    var yajName=UI.val('npYajman')||'Yajman';
    var enabled=this._mats.filter(function(m){return m.on});
    var pi=PDFGen.getPanditInfo();
    var msg='üïâÔ∏è *‡§™‡•Ç‡§ú‡§æ ‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä ‡§∏‡•Ç‡§ö‡•Ä*\n\nüë§ ‡§Ø‡§ú‡§Æ‡§æ‡§®: '+yajName+'\nüìÖ ‡§§‡§æ‡§∞‡•Ä‡§ñ: '+App.fmtD(UI.val('npDate'))+'\nüïâÔ∏è ‡§™‡•Ç‡§ú‡§æ: '+this._sel.map(function(p){return p.name}).join(', ')+'\n\nüì¶ *‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä:*\n';
    for(var i=0;i<enabled.length;i++){msg+=(i+1)+'. '+enabled[i].name+(enabled[i].qty?' - '+enabled[i].qty+' '+(enabled[i].unit||''):'')+'\n'}
    msg+='\nTotal: '+enabled.length+' items\n';
    if(pi.name)msg+='\nüôè '+pi.name;if(pi.phone)msg+='\nüìû '+pi.phone;
    if(navigator.share){navigator.share({title:'‡§™‡•Ç‡§ú‡§æ ‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä - '+yajName,text:msg}).catch(function(){})}
    else{var ph=UI.val('npPhone')||'';ph=ph.replace(/[^0-9]/g,'');
      window.open('https://wa.me/'+(ph?'91'+ph:'')+'?text='+encodeURIComponent(msg),'_blank')}
    UI.toast('Shared!','','ok');
  },

  addToHisab:function(){
    Nav.go('pgHisab');var self=this;
    setTimeout(function(){window.HisabPage.showAddPooja();
      setTimeout(function(){
        if(self._sel.length)UI.setVal('hpPooja',self._sel[0].name);
        if(App._selectedYajman)UI.setVal('hpYaj',App._selectedYajman.id);
      },300);
    },400);
  }
};
</script>

<!-- BLOCK 16: Yajman Page Stats Update (Enhancement for Block 10) -->
<script>
/* Enhance YajPage.render to update stats */
var _origYajRender=YajPage.render;
YajPage.render=function(){
  /* Update stats */
  var list=App.D.yajmans||[];
  var active=0;var inactive=0;var revenue=0;
  for(var i=0;i<list.length;i++){
    if(list[i].status==='inactive')inactive++;
    else active++;
    revenue+=parseFloat(list[i].totalAmount)||0;
  }
  UI.html('yajTotal',list.length);
  UI.html('yajActive',active);
  if(UI.$('yajInactive'))UI.html('yajInactive',inactive);
  if(UI.$('yajRevenue'))UI.html('yajRevenue',App.fmt$(revenue));

  /* Apply status filter if exists */
  var origRenderInner=function(){
    var el=UI.$('yajList');if(!el)return;
    var filtered=list.slice();
    var q=(UI.val('yajSrch')||'').toLowerCase();
    var fStatus=UI.val('yajFStatus')||'all';

    if(fStatus!=='all')filtered=filtered.filter(function(y){
      return fStatus==='active'?y.status!=='inactive':y.status==='inactive';
    });

    if(q)filtered=filtered.filter(function(y){
      return String(y.name||'').toLowerCase().includes(q)||
        String(y.phone||'').includes(q)||
        String(y.city||'').toLowerCase().includes(q)||
        String(y.gotra||'').toLowerCase().includes(q);
    });

    if(!filtered.length){
      el.innerHTML='<div style="text-align:center;padding:30px">'
        +'<div style="font-size:2.5rem;margin-bottom:10px">üë•</div>'
        +'<p style="color:var(--g500);margin-bottom:12px">'+(q||fStatus!=='all'?'No matches':'No yajmans yet')+'</p>'
        +(!q?'<button class="btn btn-sm btn-p" onclick="YajPage.showAdd()">‚ûï Add First Yajman</button>':'')
        +'</div>';
      return;
    }

    var html='';
    for(var i=0;i<filtered.length;i++){
      var y=filtered[i];
      var ph=String(y.phone||'').replace(/[^0-9]/g,'');
      var wa=String(y.whatsapp||y.phone||'').replace(/[^0-9]/g,'');
      var stClass=y.status==='inactive'?'badge-err':'badge-ok';

      html+='<div class="lrow" style="cursor:pointer" onclick="YajPage.showDetail(\''+y.id+'\')">'
        +'<div class="lrow-i" style="background:var(--grad-b)">üë§</div>'
        +'<div class="lrow-b">'
        +'<div class="lrow-n">'+App.esc(y.name)+' <span class="badge '+stClass+'">'+(y.status||'active')+'</span></div>'
        +'<div class="lrow-m">'
        +(y.phone?'üìû '+String(y.phone):'')
        +(y.city?' ‚Ä¢ üìç '+App.esc(y.city):'')
        +(y.gotra?' ‚Ä¢ üî± '+App.esc(y.gotra):'')
        +'</div></div>'
        +'<div class="lrow-r">'
        +'<div style="font-weight:800;color:var(--bhagwa-light)">'+App.fmt$(y.totalAmount)+'</div>'
        +'<div style="font-size:.65rem;color:var(--g500)">'+(y.totalPoojas||0)+' poojas</div>'
        +'</div>'
        +'<div class="lrow-a" onclick="event.stopPropagation()">'
        +(ph?'<button class="btn btn-xs btn-s" onclick="YajPage.callNum(\''+ph+'\')" title="Call">üìû</button>':'')
        +(wa?'<button class="btn btn-xs btn-g" onclick="YajPage.waNum(\''+wa+'\')" title="WhatsApp">üí¨</button>':'')
        +'</div></div>';
    }
    el.innerHTML=html;
  };

  origRenderInner();
};

/* Export yajman list */
YajPage.exportList=function(){
  var list=App.D.yajmans||[];
  if(!list.length){UI.toast('Empty','No yajmans to export','warn');return}

  var csv='Name,Phone,WhatsApp,City,Address,Gotra,Rashi,Status,Total Amount,Total Poojas\n';
  for(var i=0;i<list.length;i++){
    var y=list[i];
    csv+='"'+(y.name||'')+'","'+(y.phone||'')+'","'+(y.whatsapp||'')+'","'+(y.city||'')+'","'
      +(y.address||'')+'","'+(y.gotra||'')+'","'+(y.rashi||'')+'","'+(y.status||'active')+'","'
      +(y.totalAmount||0)+'","'+(y.totalPoojas||0)+'"\n';
  }

  var blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  var a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='Yajmans_'+new Date().toISOString().split('T')[0]+'.csv';
  a.click();URL.revokeObjectURL(a.href);
  UI.toast('Exported!','CSV downloaded','ok');
};
</script>
