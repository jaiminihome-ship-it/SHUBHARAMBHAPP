<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
<meta name="theme-color" content="#FF6F00">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<meta name="format-detection" content="telephone=no">
<title>‡§∂‡•Å‡§≠‡§æ‡§∞‡§Ç‡§≠ - Pooja Samagri Manager</title>

<!-- External Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&family=Noto+Sans+Devanagari:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
/* ============================================================
   PART A - BLOCK 1: CSS VARIABLES & RESET
   Complete Design System
   ============================================================ */
:root {
  /* Brand Colors */
  --brand: #FF6F00;
  --brand-dark: #E65100;
  --brand-light: #FFB74D;
  --brand-pale: #FFF3E0;
  --brand-glow: rgba(255, 111, 0, 0.15);
  --gold: #DAA520;

  /* Backgrounds */
  --bg-primary: #0a0a1a;
  --bg-secondary: #111128;
  --bg-card: rgba(255, 255, 255, 0.03);
  --bg-card-hover: rgba(255, 255, 255, 0.06);
  --bg-elevated: rgba(255, 255, 255, 0.05);
  --bg-input: rgba(255, 255, 255, 0.04);
  --bg-input-focus: rgba(255, 111, 0, 0.04);

  /* Borders */
  --border: rgba(255, 255, 255, 0.06);
  --border-light: rgba(255, 255, 255, 0.1);
  --border-brand: rgba(255, 111, 0, 0.2);
  --border-focus: rgba(255, 111, 0, 0.5);

  /* Text */
  --text-primary: #ffffff;
  --text-secondary: #b0b0c0;
  --text-muted: #6b6b80;
  --text-brand: #FFB74D;

  /* Status Colors */
  --success: #00C853;
  --success-bg: rgba(0, 200, 83, 0.08);
  --error: #FF1744;
  --error-bg: rgba(255, 23, 68, 0.08);
  --warning: #FFD600;
  --warning-bg: rgba(255, 214, 0, 0.08);
  --info: #2979FF;
  --info-bg: rgba(41, 121, 255, 0.08);

  /* Gradients */
  --grad-brand: linear-gradient(135deg, #FF6F00, #FF8F00, #FFA726);
  --grad-bg: linear-gradient(160deg, #0a0a1a, #111128, #0d1b2a);
  --grad-success: linear-gradient(135deg, #00C853, #00E676);
  --grad-error: linear-gradient(135deg, #FF1744, #FF5252);
  --grad-glass: linear-gradient(135deg,
    rgba(255,255,255,0.05), rgba(255,255,255,0.02));

  /* Shadows */
  --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.15);
  --shadow-md: 0 4px 20px rgba(0, 0, 0, 0.2);
  --shadow-lg: 0 8px 40px rgba(0, 0, 0, 0.3);
  --shadow-brand: 0 4px 20px rgba(255, 111, 0, 0.2);
  --shadow-glow: 0 0 30px rgba(255, 111, 0, 0.1);

  /* Radius */
  --r-xs: 6px;
  --r-sm: 8px;
  --r-md: 12px;
  --r-lg: 16px;
  --r-xl: 20px;
  --r-2xl: 28px;
  --r-full: 9999px;

  /* Spacing */
  --sp-xs: 4px;
  --sp-sm: 8px;
  --sp-md: 12px;
  --sp-lg: 16px;
  --sp-xl: 20px;
  --sp-2xl: 28px;

  /* Typography */
  --f-ui: 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
  --f-hi: 'Noto Sans Devanagari', sans-serif;

  /* Transitions */
  --ease: cubic-bezier(0.4, 0, 0.2, 1);
  --ease-bounce: cubic-bezier(0.34, 1.56, 0.64, 1);
  --dur-fast: 0.15s;
  --dur: 0.25s;
  --dur-slow: 0.4s;

  /* Z-index layers */
  --z-base: 1;
  --z-nav: 100;
  --z-sticky: 200;
  --z-modal-bg: 900;
  --z-modal: 950;
  --z-toast: 1000;
  --z-loader: 1100;
  --z-auth: 1200;

  /* Safe areas */
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
  --safe-left: env(safe-area-inset-left, 0px);
  --safe-right: env(safe-area-inset-right, 0px);

  /* Layout */
  --topbar-h: 60px;
  --tabbar-h: 64px;
  --max-w: 960px;
}

/* ============================================================
   BLOCK 2: CSS RESET & BASE
   ============================================================ */
*, *::before, *::after {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  -webkit-tap-highlight-color: transparent;
}

html {
  scroll-behavior: smooth;
  -webkit-text-size-adjust: 100%;
  -ms-text-size-adjust: 100%;
  overflow-x: hidden;
}

body {
  font-family: var(--f-ui);
  background: var(--grad-bg);
  color: var(--text-primary);
  min-height: 100vh;
  min-height: 100dvh; /* Dynamic viewport height for mobile */
  line-height: 1.6;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* Ambient glow effect */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background:
    radial-gradient(ellipse at 10% 40%, rgba(255,111,0,0.06), transparent 55%),
    radial-gradient(ellipse at 90% 15%, rgba(218,165,32,0.04), transparent 45%),
    radial-gradient(ellipse at 50% 90%, rgba(255,111,0,0.03), transparent 40%);
  pointer-events: none;
  z-index: 0;
}

/* Scrollbar */
::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb {
  background: var(--grad-brand);
  border-radius: 4px;
}
::selection {
  background: rgba(255, 111, 0, 0.25);
  color: #fff;
}

/* ============================================================
   BLOCK 3: UTILITY CLASSES
   ============================================================ */
.hide { display: none !important; }
.sr-only {
  position: absolute; width: 1px; height: 1px;
  padding: 0; margin: -1px; overflow: hidden;
  clip: rect(0,0,0,0); border: 0;
}
.truncate {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.flex-center {
  display: flex;
  align-items: center;
  justify-content: center;
}
.flex-between {
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.gap-xs { gap: var(--sp-xs); }
.gap-sm { gap: var(--sp-sm); }
.gap-md { gap: var(--sp-md); }
.gap-lg { gap: var(--sp-lg); }

/* ============================================================
   BLOCK 4: SHELL LAYOUT
   ============================================================ */
.shell {
  position: relative;
  z-index: var(--z-base);
  max-width: var(--max-w);
  margin: 0 auto;
  min-height: 100vh;
  min-height: 100dvh;
}

/* ============================================================
   BLOCK 5: TOP BAR (Sticky Header)
   ============================================================ */
.topbar {
  position: sticky;
  top: 0;
  z-index: var(--z-sticky);
  padding: var(--sp-sm) var(--sp-md);
  padding-top: calc(var(--sp-sm) + var(--safe-top));
}

.topbar-inner {
  background: rgba(10, 10, 26, 0.88);
  backdrop-filter: blur(20px) saturate(1.8);
  -webkit-backdrop-filter: blur(20px) saturate(1.8);
  border-radius: var(--r-xl);
  padding: var(--sp-sm) var(--sp-lg);
  display: flex;
  align-items: center;
  justify-content: space-between;
  border: 1px solid var(--border-brand);
  box-shadow: var(--shadow-md), var(--shadow-glow);
  min-height: 52px;
}

.brand {
  display: flex;
  align-items: center;
  gap: var(--sp-sm);
  min-width: 0;
}

.brand-icon {
  width: 38px;
  height: 38px;
  background: var(--grad-brand);
  border-radius: var(--r-md);
  display: grid;
  place-items: center;
  font-size: 1.2rem;
  flex-shrink: 0;
  box-shadow: var(--shadow-brand);
  animation: brandFloat 4s ease-in-out infinite;
}

@keyframes brandFloat {
  0%, 100% { transform: translateY(0) rotate(0deg); }
  50% { transform: translateY(-2px) rotate(2deg); }
}

.brand-text h1 {
  font-size: 1.05rem;
  font-weight: 800;
  background: var(--grad-brand);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  line-height: 1.2;
}

.brand-text small {
  font-size: 0.62rem;
  color: var(--text-muted);
  display: block;
  max-width: 120px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.top-actions {
  display: flex;
  align-items: center;
  gap: var(--sp-xs);
}

/* User pill */
.user-pill {
  display: flex;
  align-items: center;
  gap: var(--sp-xs);
  background: rgba(255, 111, 0, 0.08);
  border: 1px solid rgba(255, 111, 0, 0.12);
  padding: 3px 10px 3px 3px;
  border-radius: var(--r-full);
  cursor: pointer;
  transition: all var(--dur) var(--ease);
  max-width: 140px;
}

.user-pill:hover,
.user-pill:active {
  background: rgba(255, 111, 0, 0.15);
  transform: scale(0.98);
}

.user-pill .avatar {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  background: var(--grad-brand);
  display: grid;
  place-items: center;
  font-size: 0.75rem;
  flex-shrink: 0;
}

.user-pill .name {
  font-size: 0.72rem;
  font-weight: 600;
  color: var(--text-brand);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* Plan badge in topbar */
.plan-badge {
  font-size: 0.5rem;
  font-weight: 700;
  padding: 1px 5px;
  border-radius: var(--r-full);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.plan-badge.free {
  background: var(--warning-bg);
  color: var(--warning);
  border: 1px solid rgba(255, 214, 0, 0.2);
}
.plan-badge.pro {
  background: var(--success-bg);
  color: var(--success);
  border: 1px solid rgba(0, 200, 83, 0.2);
}

/* ============================================================
   BLOCK 6: TAB BAR (Bottom Navigation)
   Mobile-first, touch-friendly
   ============================================================ */
.tabbar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  z-index: var(--z-nav);
  padding: var(--sp-xs) var(--sp-sm);
  padding-bottom: calc(var(--sp-xs) + var(--safe-bottom));
}

.tabbar-inner {
  background: rgba(5, 5, 15, 0.95);
  backdrop-filter: blur(24px) saturate(2);
  -webkit-backdrop-filter: blur(24px) saturate(2);
  border-radius: var(--r-xl);
  padding: 4px;
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 2px;
  border: 1px solid rgba(255, 111, 0, 0.1);
  box-shadow: 0 -4px 30px rgba(0, 0, 0, 0.4);
  max-width: 480px;
  margin: 0 auto;
}

.tab-btn {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  padding: 6px 2px 5px;
  border-radius: var(--r-md);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 1px;
  font-size: 0.55rem;
  font-weight: 600;
  font-family: var(--f-ui);
  transition: all var(--dur) var(--ease);
  position: relative;
  user-select: none;
  min-height: 44px; /* Touch target */
  justify-content: center;
}

.tab-btn .tab-icon {
  font-size: 1.15rem;
  line-height: 1;
  transition: transform var(--dur) var(--ease-bounce);
}

.tab-btn.active {
  color: #fff;
}

.tab-btn.active::before {
  content: '';
  position: absolute;
  inset: 0;
  background: var(--grad-brand);
  border-radius: var(--r-md);
  z-index: -1;
  box-shadow: 0 2px 12px rgba(255, 111, 0, 0.3);
}

.tab-btn:not(.active):hover,
.tab-btn:not(.active):active {
  color: var(--text-brand);
}

.tab-btn:not(.active):hover .tab-icon {
  transform: translateY(-2px) scale(1.1);
}

.tab-btn:active {
  transform: scale(0.92);
}

/* Notification dot on tab */
.tab-btn .tab-dot {
  position: absolute;
  top: 4px;
  right: calc(50% - 14px);
  width: 6px;
  height: 6px;
  background: var(--error);
  border-radius: 50%;
  border: 1.5px solid var(--bg-primary);
}

/* ============================================================
   BLOCK 7: MAIN CONTENT AREA
   ============================================================ */
.main {
  padding: 0 var(--sp-md);
  padding-bottom: calc(var(--tabbar-h) + var(--safe-bottom) + 16px);
  min-height: calc(100vh - var(--topbar-h));
  min-height: calc(100dvh - var(--topbar-h));
}

.page {
  display: none;
  animation: pageIn 0.35s var(--ease);
  max-width: var(--max-w);
  margin: 0 auto;
}

.page.active {
  display: block;
}

@keyframes pageIn {
  from { opacity: 0; transform: translateY(12px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Page header */
.page-header {
  text-align: center;
  padding: var(--sp-sm) 0 var(--sp-lg);
}

.page-title {
  font-size: 1.5rem;
  font-weight: 800;
  background: var(--grad-brand);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  line-height: 1.3;
}

.page-subtitle {
  color: var(--text-muted);
  font-size: 0.8rem;
  margin-top: 2px;
}

/* ============================================================
   BLOCK 8: CARD SYSTEM
   ============================================================ */
.card {
  background: var(--bg-card);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border: 1px solid var(--border);
  border-radius: var(--r-lg);
  padding: var(--sp-lg);
  margin-bottom: var(--sp-md);
  transition: border-color var(--dur) var(--ease),
              box-shadow var(--dur) var(--ease),
              transform var(--dur) var(--ease);
}

.card:hover {
  border-color: var(--border-brand);
}

.card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: var(--sp-md);
  flex-wrap: wrap;
  gap: var(--sp-sm);
}

.card-title {
  font-size: 0.95rem;
  font-weight: 700;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: var(--sp-xs);
}

.card-actions {
  display: flex;
  gap: var(--sp-xs);
  flex-wrap: wrap;
}

/* Info banner inside cards */
.info-banner {
  padding: var(--sp-sm) var(--sp-md);
  background: rgba(255, 111, 0, 0.05);
  border-radius: var(--r-sm);
  margin-bottom: var(--sp-md);
  border-left: 3px solid var(--brand);
  font-size: 0.7rem;
  color: var(--text-brand);
  line-height: 1.5;
}

/* ============================================================
   BLOCK 9: FORM ELEMENTS
   All mobile-optimized with proper touch targets
   ============================================================ */
.form-group {
  margin-bottom: var(--sp-md);
}
.form-group:last-child {
  margin-bottom: 0;
}

.form-label {
  display: block;
  margin-bottom: var(--sp-xs);
  font-weight: 600;
  color: var(--text-secondary);
  font-size: 0.72rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.form-input,
.form-select,
.form-textarea {
  width: 100%;
  padding: 11px 14px;
  background: var(--bg-input);
  border: 1.5px solid var(--border);
  border-radius: var(--r-md);
  color: var(--text-primary);
  font-family: var(--f-ui);
  font-size: 0.9rem;
  transition: all var(--dur) var(--ease);
  outline: none;
  min-height: 44px; /* Touch target */
  -webkit-appearance: none;
  appearance: none;
}

.form-input:focus,
.form-select:focus,
.form-textarea:focus {
  border-color: var(--brand);
  background: var(--bg-input-focus);
  box-shadow: 0 0 0 3px rgba(255, 111, 0, 0.1);
}

.form-input::placeholder,
.form-textarea::placeholder {
  color: var(--text-muted);
}

.form-textarea {
  min-height: 90px;
  resize: vertical;
  font-family: var(--f-hi);
}

.form-select {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23FFB74D' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  padding-right: 36px;
}

.form-select option {
  background: var(--bg-secondary);
  color: var(--text-primary);
}

/* Responsive 2-column form row */
.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: var(--sp-md);
}

/* Password field with toggle */
.input-wrapper {
  position: relative;
}

.input-wrapper .form-input {
  padding-right: 44px;
}

.pass-toggle {
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  font-size: 1.1rem;
  padding: 6px;
  min-width: 36px;
  min-height: 36px;
  display: grid;
  place-items: center;
  border-radius: var(--r-sm);
  transition: color var(--dur) var(--ease);
}

.pass-toggle:hover {
  color: var(--text-brand);
}

/* ============================================================
   BLOCK 10: BUTTON SYSTEM
   ============================================================ */
.btn {
  padding: 10px 16px;
  border: none;
  border-radius: var(--r-md);
  font-family: var(--f-ui);
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  transition: all var(--dur) var(--ease);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 5px;
  user-select: none;
  min-height: 40px;
  text-decoration: none;
  line-height: 1.2;
}

.btn:active { transform: scale(0.95); }
.btn:disabled { opacity: 0.4; pointer-events: none; }

/* Primary */
.btn-primary {
  background: var(--grad-brand);
  color: #fff;
  box-shadow: var(--shadow-brand);
}
.btn-primary:hover:not(:disabled) {
  box-shadow: 0 6px 24px rgba(255, 111, 0, 0.4);
  transform: translateY(-1px);
}

/* Secondary / Ghost */
.btn-ghost {
  background: var(--bg-elevated);
  color: var(--text-primary);
  border: 1.5px solid var(--border-light);
}
.btn-ghost:hover:not(:disabled) {
  background: rgba(255, 255, 255, 0.08);
  border-color: var(--border-brand);
}

/* Success */
.btn-success {
  background: var(--grad-success);
  color: #fff;
}

/* Danger */
.btn-danger {
  background: var(--grad-error);
  color: #fff;
}

/* Size variants */
.btn-w { width: 100%; }
.btn-sm { padding: 6px 12px; font-size: 0.78rem; min-height: 34px; }
.btn-xs {
  padding: 4px 8px;
  font-size: 0.68rem;
  border-radius: var(--r-xs);
  min-height: 28px;
}

/* Icon button */
.btn-icon {
  width: 36px;
  height: 36px;
  padding: 0;
  border-radius: var(--r-md);
  border: 1px solid var(--border);
  background: var(--bg-card);
  color: var(--text-muted);
  display: grid;
  place-items: center;
  font-size: 1.05rem;
  min-height: 36px;
}

.btn-icon:hover {
  background: rgba(255, 111, 0, 0.1);
  color: var(--text-primary);
  border-color: var(--border-brand);
}

/* ============================================================
   BLOCK 11: STAT CARDS
   ============================================================ */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: var(--sp-sm);
  margin-bottom: var(--sp-lg);
}

.stat-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--r-lg);
  padding: var(--sp-md);
  text-align: center;
  cursor: pointer;
  transition: all var(--dur) var(--ease);
}

.stat-card:hover {
  border-color: var(--border-brand);
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.stat-card:active {
  transform: scale(0.97);
}

.stat-icon {
  width: 36px;
  height: 36px;
  margin: 0 auto var(--sp-xs);
  background: var(--grad-brand);
  border-radius: 50%;
  display: grid;
  place-items: center;
  font-size: 1rem;
}

.stat-value {
  font-size: 1.3rem;
  font-weight: 800;
  color: var(--text-primary);
  line-height: 1.2;
}

.stat-label {
  font-size: 0.6rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.4px;
  margin-top: 2px;
}

/* Summary cards (Income/Expense/etc) */
.summary-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
  gap: var(--sp-sm);
  margin-bottom: var(--sp-lg);
}

.summary-card {
  padding: var(--sp-md);
  border-radius: var(--r-lg);
  text-align: center;
  transition: all var(--dur) var(--ease);
  cursor: pointer;
}

.summary-card:hover { transform: translateY(-2px); }
.summary-card.type-income {
  background: var(--success-bg);
  border: 1px solid rgba(0, 200, 83, 0.12);
}
.summary-card.type-expense {
  background: var(--error-bg);
  border: 1px solid rgba(255, 23, 68, 0.12);
}
.summary-card.type-pending {
  background: var(--warning-bg);
  border: 1px solid rgba(255, 214, 0, 0.12);
}
.summary-card.type-profit {
  background: rgba(255, 111, 0, 0.06);
  border: 1px solid rgba(255, 111, 0, 0.12);
}

.summary-value {
  font-size: 1.2rem;
  font-weight: 800;
  line-height: 1.2;
}

.summary-value.green { color: #00E676; }
.summary-value.red { color: #FF5252; }
.summary-value.yellow { color: #FFD740; }
.summary-value.orange { color: var(--text-brand); }

.summary-label {
  font-size: 0.62rem;
  color: var(--text-muted);
  text-transform: uppercase;
  margin-top: 2px;
}

/* ============================================================
   BLOCK 12: LIST ROWS
   ============================================================ */
.list-row {
  display: flex;
  align-items: center;
  gap: var(--sp-sm);
  padding: var(--sp-md) 0;
  border-bottom: 1px solid rgba(255, 255, 255, 0.03);
  transition: background var(--dur-fast) var(--ease);
}

.list-row:hover {
  background: rgba(255, 255, 255, 0.015);
}

.list-row:last-child { border-bottom: none; }

.list-row-icon {
  width: 38px;
  height: 38px;
  border-radius: 50%;
  display: grid;
  place-items: center;
  font-size: 1rem;
  flex-shrink: 0;
}

.list-row-body {
  flex: 1;
  min-width: 0;
}

.list-row-title {
  font-weight: 600;
  color: var(--text-primary);
  font-size: 0.88rem;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.list-row-meta {
  font-size: 0.68rem;
  color: var(--text-muted);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.list-row-right {
  text-align: right;
  flex-shrink: 0;
}

.list-row-actions {
  display: flex;
  gap: 3px;
  flex-shrink: 0;
}

/* ============================================================
   BLOCK 13: BADGES
   ============================================================ */
.badge {
  display: inline-block;
  padding: 1px 7px;
  border-radius: var(--r-full);
  font-size: 0.58rem;
  font-weight: 700;
  letter-spacing: 0.3px;
}

.badge-success {
  background: var(--success-bg);
  color: var(--success);
}
.badge-error {
  background: var(--error-bg);
  color: var(--error);
}
.badge-warning {
  background: var(--warning-bg);
  color: var(--warning);
}
.badge-info {
  background: var(--info-bg);
  color: var(--info);
}
.badge-brand {
  background: rgba(255, 111, 0, 0.12);
  color: var(--text-brand);
}

/* ============================================================
   BLOCK 14: SECTION HEADERS (Collapsible)
   ============================================================ */
.section-header {
  background: rgba(255, 111, 0, 0.06);
  border-left: 3px solid var(--brand);
  padding: var(--sp-sm) var(--sp-md);
  border-radius: var(--r-sm);
  margin-bottom: var(--sp-xs);
  font-weight: 700;
  color: var(--text-primary);
  font-size: 0.85rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  cursor: pointer;
  transition: background var(--dur) var(--ease);
  min-height: 40px;
  user-select: none;
}

.section-header:hover {
  background: rgba(255, 111, 0, 0.1);
}

.section-header:active {
  background: rgba(255, 111, 0, 0.14);
}

.section-count {
  font-size: 0.65rem;
  color: var(--text-brand);
  font-weight: 400;
}

.section-arrow {
  transition: transform var(--dur) var(--ease);
  font-size: 0.7rem;
}

.section-header.open .section-arrow {
  transform: rotate(180deg);
}

/* ============================================================
   BLOCK 15: MODAL SYSTEM
   ============================================================ */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  z-index: var(--z-modal-bg);
  padding: var(--sp-md);
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

.modal-overlay.open {
  display: flex;
  align-items: flex-start;
  justify-content: center;
  padding-top: 5vh;
}

.modal-box {
  background: var(--bg-secondary);
  border-radius: var(--r-2xl);
  max-width: 540px;
  width: 100%;
  max-height: 88vh;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  border: 1px solid var(--border-brand);
  animation: modalPop 0.3s var(--ease);
  margin-bottom: 5vh;
}

@keyframes modalPop {
  from { opacity: 0; transform: scale(0.94) translateY(16px); }
  to { opacity: 1; transform: scale(1) translateY(0); }
}

.modal-header {
  padding: var(--sp-lg) var(--sp-lg) var(--sp-md);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  background: var(--bg-secondary);
  z-index: 2;
  border-radius: var(--r-2xl) var(--r-2xl) 0 0;
}

.modal-title {
  font-size: 1.05rem;
  font-weight: 700;
  color: var(--text-primary);
}

.modal-close {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  border: none;
  background: rgba(255, 255, 255, 0.06);
  color: var(--text-primary);
  cursor: pointer;
  display: grid;
  place-items: center;
  font-size: 1.2rem;
  transition: all var(--dur) var(--ease);
  flex-shrink: 0;
}

.modal-close:hover {
  background: var(--error);
  transform: rotate(90deg);
}

.modal-body {
  padding: var(--sp-lg);
}

.modal-footer {
  padding: var(--sp-md) var(--sp-lg);
  border-top: 1px solid var(--border);
  display: flex;
  gap: var(--sp-sm);
  justify-content: flex-end;
  position: sticky;
  bottom: 0;
  background: var(--bg-secondary);
  border-radius: 0 0 var(--r-2xl) var(--r-2xl);
}

/* ============================================================
   BLOCK 16: TOAST NOTIFICATIONS
   ============================================================ */
.toast-container {
  position: fixed;
  top: calc(var(--sp-md) + var(--safe-top));
  right: var(--sp-md);
  z-index: var(--z-toast);
  display: flex;
  flex-direction: column;
  gap: var(--sp-xs);
  max-width: 340px;
  pointer-events: none;
}

.toast {
  background: rgba(15, 15, 35, 0.95);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-radius: var(--r-md);
  padding: 10px 14px;
  display: flex;
  align-items: flex-start;
  gap: var(--sp-sm);
  box-shadow: var(--shadow-lg);
  border-left: 4px solid var(--brand);
  animation: toastIn 0.35s var(--ease);
  pointer-events: all;
}

.toast.success { border-left-color: var(--success); }
.toast.error { border-left-color: var(--error); }
.toast.warning { border-left-color: var(--warning); }

.toast-leaving {
  animation: toastOut 0.3s var(--ease) forwards;
}

@keyframes toastIn {
  from { opacity: 0; transform: translateX(100%) scale(0.9); }
  to { opacity: 1; transform: translateX(0) scale(1); }
}

@keyframes toastOut {
  to { opacity: 0; transform: translateX(100%) scale(0.9); }
}

.toast-icon { font-size: 1.1rem; flex-shrink: 0; line-height: 1.2; }
.toast-content { min-width: 0; }
.toast-title {
  font-weight: 600;
  color: var(--text-primary);
  font-size: 0.8rem;
}
.toast-message {
  font-size: 0.68rem;
  color: var(--text-muted);
  margin-top: 1px;
}

/* ============================================================
   BLOCK 17: LOADER / SPINNER
   ============================================================ */
.loader-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  z-index: var(--z-loader);
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: var(--sp-md);
}

.loader-overlay.active {
  display: flex;
}

.loader-spinner {
  width: 40px;
  height: 40px;
  border: 3px solid rgba(255, 255, 255, 0.06);
  border-top-color: var(--brand);
  border-radius: 50%;
  animation: spin 0.75s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

.loader-text {
  color: var(--text-primary);
  font-weight: 600;
  font-size: 0.9rem;
  text-align: center;
}

/* ============================================================
   BLOCK 18: AUTH SCREEN
   ============================================================ */
.auth-screen {
  position: fixed;
  inset: 0;
  background: var(--grad-bg);
  z-index: var(--z-auth);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: var(--sp-lg);
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

.auth-screen::before {
  content: '';
  position: absolute;
  inset: 0;
  background:
    radial-gradient(ellipse at 20% 30%, rgba(255,111,0,0.08), transparent 50%),
    radial-gradient(ellipse at 80% 70%, rgba(218,165,32,0.04), transparent 40%);
  pointer-events: none;
}

.auth-wrapper {
  position: relative;
  max-width: 400px;
  width: 100%;
  z-index: 1;
}

.auth-logo {
  text-align: center;
  margin-bottom: var(--sp-2xl);
}

.auth-logo-icon {
  width: 64px;
  height: 64px;
  background: var(--grad-brand);
  border-radius: var(--r-xl);
  display: grid;
  place-items: center;
  font-size: 1.8rem;
  margin: 0 auto var(--sp-md);
  box-shadow: 0 8px 36px rgba(255, 111, 0, 0.35);
  animation: brandFloat 4s ease-in-out infinite;
}

.auth-logo h1 {
  font-size: 1.8rem;
  font-weight: 900;
  background: var(--grad-brand);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.auth-logo p {
  color: var(--text-muted);
  font-size: 0.8rem;
}

.auth-card {
  background: var(--bg-card);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  border: 1px solid var(--border);
  border-radius: var(--r-2xl);
  padding: var(--sp-xl);
}

.auth-card h3 {
  text-align: center;
  color: var(--text-primary);
  font-size: 1.05rem;
  margin-bottom: var(--sp-lg);
}

.auth-switch {
  text-align: center;
  margin-top: var(--sp-md);
  color: var(--text-muted);
  font-size: 0.8rem;
}

.auth-switch a {
  color: var(--brand);
  text-decoration: none;
  font-weight: 700;
  cursor: pointer;
}

/* OTP Input */
.otp-container {
  display: flex;
  gap: var(--sp-sm);
  justify-content: center;
  margin: var(--sp-lg) 0;
}

.otp-input {
  width: 42px;
  height: 50px;
  text-align: center;
  font-size: 1.3rem;
  font-weight: 800;
  background: var(--bg-input);
  border: 2px solid var(--border);
  border-radius: var(--r-md);
  color: var(--text-brand);
  font-family: var(--f-ui);
  outline: none;
  transition: all var(--dur) var(--ease);
  caret-color: var(--brand);
}

.otp-input:focus {
  border-color: var(--brand);
  background: var(--bg-input-focus);
  box-shadow: 0 0 0 3px rgba(255, 111, 0, 0.12);
}

/* Auth features footer */
.auth-features {
  margin-top: var(--sp-xl);
  padding: var(--sp-md);
  background: rgba(255, 111, 0, 0.03);
  border-radius: var(--r-lg);
  border: 1px solid rgba(255, 111, 0, 0.08);
}

.auth-features h4 {
  color: var(--brand);
  text-align: center;
  margin-bottom: var(--sp-sm);
  font-size: 0.8rem;
}

.features-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 2px var(--sp-md);
  font-size: 0.7rem;
  color: var(--text-secondary);
}

/* ============================================================
   BLOCK 19: SEARCH INPUT (Enhanced)
   ============================================================ */
.search-input {
  position: relative;
}

.search-input .form-input {
  padding-left: 36px;
}

.search-input::before {
  content: 'üîç';
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 0.85rem;
  z-index: 1;
  pointer-events: none;
}

/* ============================================================
   BLOCK 20: RESPONSIVE BREAKPOINTS
   Mobile-first approach
   ============================================================ */

/* Small phones (< 360px) */
@media (max-width: 359px) {
  :root { --sp-md: 8px; --sp-lg: 12px; }
  .page-title { font-size: 1.2rem; }
  .form-row { grid-template-columns: 1fr; }
  .stats-grid { grid-template-columns: repeat(2, 1fr); }
  .summary-grid { grid-template-columns: repeat(2, 1fr); }
  .topbar-inner { padding: var(--sp-xs) var(--sp-sm); }
  .brand-text h1 { font-size: 0.9rem; }
  .otp-input { width: 36px; height: 44px; font-size: 1.1rem; }
  .otp-container { gap: 4px; }
  .card { padding: var(--sp-md); }
  .tabbar-inner { border-radius: var(--r-lg); }
  .tab-btn { font-size: 0.48rem; }
  .tab-btn .tab-icon { font-size: 1rem; }
}

/* Regular phones (360-479px) */
@media (max-width: 479px) {
  .form-row { grid-template-columns: 1fr; }
  .user-pill .name { display: none; }
  .stats-grid { grid-template-columns: repeat(2, 1fr); }
  .summary-grid { grid-template-columns: repeat(2, 1fr); }
  .toast-container {
    right: var(--sp-sm);
    left: var(--sp-sm);
    max-width: none;
  }
  .modal-overlay { padding: var(--sp-sm); }
  .modal-box { border-radius: var(--r-xl); max-height: 92vh; }
  .modal-header, .modal-footer {
    border-radius: 0;
  }
  .modal-header {
    border-radius: var(--r-xl) var(--r-xl) 0 0;
  }
  .modal-footer {
    border-radius: 0 0 var(--r-xl) var(--r-xl);
  }
}

/* Large phones / small tablets (480-767px) */
@media (min-width: 480px) and (max-width: 767px) {
  .form-row { grid-template-columns: 1fr 1fr; }
  .stats-grid { grid-template-columns: repeat(3, 1fr); }
}

/* Tablets (768-1024px) */
@media (min-width: 768px) {
  .main { padding: 0 var(--sp-xl); }
  .card { padding: var(--sp-xl); }
  .tabbar-inner {
    max-width: 520px;
    grid-template-columns: repeat(5, 1fr);
  }
  .stats-grid { grid-template-columns: repeat(4, 1fr); }
  .summary-grid { grid-template-columns: repeat(4, 1fr); }
  .modal-overlay { padding: var(--sp-xl); }
}

/* Desktop (1025+) */
@media (min-width: 1025px) {
  .main {
    padding: 0 var(--sp-2xl);
    padding-bottom: calc(var(--tabbar-h) + 24px);
  }
  .card { padding: 24px; }
  .topbar { padding: var(--sp-md) var(--sp-xl); }
}

/* Landscape phone fix */
@media (max-height: 480px) and (orientation: landscape) {
  .tabbar { display: none; }
  .main { padding-bottom: var(--sp-lg); }
  .auth-screen { align-items: flex-start; padding-top: var(--sp-md); }
  .auth-logo { margin-bottom: var(--sp-md); }
  .auth-logo-icon { width: 48px; height: 48px; font-size: 1.4rem; }
  .auth-logo h1 { font-size: 1.3rem; }
}

/* Print */
@media print {
  .topbar, .tabbar, .toast-container { display: none !important; }
  body { background: #fff; color: #000; }
  .card { border: 1px solid #ddd; background: #fff; }
}

/* Reduced motion */
@media (prefers-reduced-motion: reduce) {
  *, *::before, *::after {
    animation-duration: 0.01ms !important;
    transition-duration: 0.01ms !important;
  }
}

/* ============================================================
   BLOCK 21: RENDER ZONE (Off-screen PDF generation)
   ============================================================ */
.render-zone {
  position: absolute;
  left: -9999px;
  top: 0;
  z-index: -1;
  overflow: hidden;
}

/* ============================================================
   BLOCK 22: SUBSCRIPTION / PAYMENT UI
   ============================================================ */
.plan-card {
  border-radius: var(--r-xl);
  padding: var(--sp-xl);
  text-align: center;
  transition: all var(--dur) var(--ease);
  position: relative;
  overflow: hidden;
}

.plan-card.plan-free {
  background: var(--bg-card);
  border: 1px solid var(--border);
}

.plan-card.plan-pro {
  background: rgba(255, 111, 0, 0.05);
  border: 2px solid var(--brand);
  box-shadow: var(--shadow-glow);
}

.plan-card.plan-pro::before {
  content: '‚≠ê RECOMMENDED';
  position: absolute;
  top: 0;
  right: 0;
  background: var(--grad-brand);
  color: #fff;
  font-size: 0.55rem;
  font-weight: 700;
  padding: 3px 12px;
  border-radius: 0 0 0 var(--r-md);
  letter-spacing: 0.5px;
}

.plan-name {
  font-size: 1.1rem;
  font-weight: 800;
  margin-bottom: var(--sp-xs);
}

.plan-price {
  font-size: 2rem;
  font-weight: 900;
  color: var(--brand);
  line-height: 1;
}

.plan-price small {
  font-size: 0.7rem;
  font-weight: 400;
  color: var(--text-muted);
}

.plan-features {
  list-style: none;
  text-align: left;
  margin: var(--sp-lg) 0;
  font-size: 0.78rem;
  color: var(--text-secondary);
}

.plan-features li {
  padding: 4px 0;
  display: flex;
  align-items: center;
  gap: var(--sp-sm);
}

.plan-features li::before {
  content: '‚úÖ';
  font-size: 0.7rem;
}

.plan-features li.disabled {
  opacity: 0.4;
}

.plan-features li.disabled::before {
  content: '‚ùå';
}

/* UPI Payment */
.upi-section {
  text-align: center;
  padding: var(--sp-lg);
  background: rgba(255, 111, 0, 0.03);
  border-radius: var(--r-lg);
  border: 1px solid var(--border-brand);
}

.upi-qr {
  width: 180px;
  height: 180px;
  margin: var(--sp-md) auto;
  background: #fff;
  border-radius: var(--r-md);
  padding: var(--sp-sm);
  display: grid;
  place-items: center;
}

.upi-apps {
  display: flex;
  gap: var(--sp-sm);
  justify-content: center;
  flex-wrap: wrap;
  margin-top: var(--sp-md);
}

.upi-app-btn {
  padding: var(--sp-sm) var(--sp-md);
  border-radius: var(--r-md);
  border: 1px solid var(--border);
  background: var(--bg-card);
  color: var(--text-primary);
  font-size: 0.78rem;
  font-weight: 600;
  cursor: pointer;
  transition: all var(--dur) var(--ease);
  font-family: var(--f-ui);
  display: flex;
  align-items: center;
  gap: var(--sp-xs);
  min-height: 40px;
}

.upi-app-btn:hover {
  border-color: var(--brand);
  background: rgba(255, 111, 0, 0.06);
}

/* ============================================================
   BLOCK 23: EMPTY STATE
   ============================================================ */
.empty-state {
  text-align: center;
  padding: var(--sp-2xl) var(--sp-lg);
}

.empty-state-icon {
  font-size: 2.5rem;
  margin-bottom: var(--sp-sm);
  opacity: 0.8;
}

.empty-state-text {
  color: var(--text-muted);
  font-size: 0.85rem;
  margin-bottom: var(--sp-md);
}

.empty-state-hint {
  color: var(--text-muted);
  font-size: 0.72rem;
  opacity: 0.7;
}

/* ============================================================
   BLOCK 24: CHECKBOX (Custom styled)
   ============================================================ */
.checkbox-item {
  display: flex;
  align-items: center;
  gap: var(--sp-sm);
  padding: var(--sp-sm) 0;
  cursor: pointer;
  min-height: 40px;
  user-select: none;
}

.checkbox-box {
  width: 22px;
  height: 22px;
  border: 2px solid var(--text-muted);
  border-radius: 5px;
  display: grid;
  place-items: center;
  font-size: 0.7rem;
  flex-shrink: 0;
  transition: all var(--dur) var(--ease);
}

.checkbox-item.checked .checkbox-box {
  border-color: var(--brand);
  background: var(--grad-brand);
  color: #fff;
}

.checkbox-item:hover .checkbox-box {
  border-color: var(--brand);
}

/* ============================================================
   BLOCK 25: QUICK ACTIONS GRID
   ============================================================ */
.quick-actions {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
  gap: var(--sp-sm);
}

@media (max-width: 359px) {
  .quick-actions {
    grid-template-columns: repeat(2, 1fr);
  }
}

/* ============================================================
   BLOCK 26: REFRESH INDICATOR
   ============================================================ */
.refresh-indicator {
  text-align: center;
  overflow: hidden;
  max-height: 0;
  transition: max-height var(--dur) var(--ease),
              padding var(--dur) var(--ease);
  padding: 0;
}

.refresh-indicator.visible {
  max-height: 50px;
  padding: var(--sp-sm) 0;
}

.refresh-indicator-inner {
  display: inline-flex;
  align-items: center;
  gap: var(--sp-xs);
  color: var(--text-brand);
  font-size: 0.78rem;
}

.mini-spinner {
  width: 16px;
  height: 16px;
  border: 2px solid rgba(255, 111, 0, 0.15);
  border-top-color: var(--brand);
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
}
   /* ============================================================
   BLOCK 27: DRAWER MENU
   ============================================================ */
.drawer-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
  z-index: 800;
  transition: opacity var(--dur) var(--ease);
  opacity: 0;
}

.drawer-overlay.open {
  display: block;
  opacity: 1;
}

.drawer {
  position: fixed;
  top: 0;
  left: 0;
  width: 280px;
  max-width: 85vw;
  height: 100%;
  height: 100dvh;
  background: var(--bg-secondary);
  border-right: 1px solid var(--border-brand);
  z-index: 850;
  transform: translateX(-100%);
  transition: transform 0.3s var(--ease);
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  display: flex;
  flex-direction: column;
}

.drawer.open {
  transform: translateX(0);
}

.drawer-header {
  padding: var(--sp-xl) var(--sp-lg);
  padding-top: calc(var(--sp-xl) + var(--safe-top));
  background: rgba(255, 111, 0, 0.04);
  border-bottom: 1px solid var(--border);
  text-align: center;
  flex-shrink: 0;
}

.drawer-photo {
  width: 72px;
  height: 72px;
  border-radius: 50%;
  margin: 0 auto var(--sp-sm);
  background: var(--grad-brand);
  display: grid;
  place-items: center;
  font-size: 2rem;
  border: 3px solid rgba(255, 111, 0, 0.3);
  overflow: hidden;
  cursor: pointer;
  transition: transform var(--dur) var(--ease),
              box-shadow var(--dur) var(--ease);
  position: relative;
}

.drawer-photo:hover {
  transform: scale(1.05);
  box-shadow: 0 0 20px rgba(255, 111, 0, 0.3);
}

.drawer-photo img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 50%;
}

.drawer-photo-edit {
  position: absolute;
  bottom: 0;
  right: 0;
  width: 24px;
  height: 24px;
  background: var(--grad-brand);
  border-radius: 50%;
  display: grid;
  place-items: center;
  font-size: 0.6rem;
  border: 2px solid var(--bg-secondary);
  cursor: pointer;
}

.drawer-name {
  font-size: 1rem;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 2px;
}

.drawer-email {
  font-size: 0.68rem;
  color: var(--text-muted);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.drawer-plan {
  display: inline-block;
  margin-top: var(--sp-xs);
}

.drawer-body {
  flex: 1;
  padding: var(--sp-sm) 0;
  overflow-y: auto;
}

.drawer-section {
  padding: var(--sp-xs) var(--sp-lg);
  margin-top: var(--sp-xs);
}

.drawer-section-title {
  font-size: 0.6rem;
  font-weight: 700;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1px;
  padding: var(--sp-xs) 0;
}

.drawer-item {
  display: flex;
  align-items: center;
  gap: var(--sp-sm);
  padding: 10px var(--sp-lg);
  color: var(--text-secondary);
  font-size: 0.85rem;
  font-weight: 500;
  cursor: pointer;
  transition: all var(--dur-fast) var(--ease);
  border-radius: var(--r-sm);
  margin: 1px var(--sp-sm);
  min-height: 44px;
  user-select: none;
}

.drawer-item:hover,
.drawer-item:active {
  background: rgba(255, 111, 0, 0.08);
  color: var(--text-primary);
}

.drawer-item .drawer-icon {
  font-size: 1.1rem;
  width: 28px;
  text-align: center;
  flex-shrink: 0;
}

.drawer-item .drawer-label {
  flex: 1;
}

.drawer-item .drawer-badge {
  font-size: 0.55rem;
  padding: 1px 6px;
  border-radius: var(--r-full);
  font-weight: 700;
}

.drawer-item.danger {
  color: var(--error);
}

.drawer-item.danger:hover {
  background: var(--error-bg);
}

.drawer-divider {
  height: 1px;
  background: var(--border);
  margin: var(--sp-sm) var(--sp-lg);
}

.drawer-footer {
  padding: var(--sp-md) var(--sp-lg);
  padding-bottom: calc(var(--sp-md) + var(--safe-bottom));
  border-top: 1px solid var(--border);
  text-align: center;
  font-size: 0.6rem;
  color: var(--text-muted);
  flex-shrink: 0;
}

/* ============================================================
   BLOCK 28: PHOTO UPLOAD
   ============================================================ */
.photo-upload-area {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--sp-md);
  padding: var(--sp-lg);
}

.photo-preview {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  background: var(--bg-card);
  border: 3px dashed var(--border-brand);
  display: grid;
  place-items: center;
  overflow: hidden;
  cursor: pointer;
  transition: all var(--dur) var(--ease);
}

.photo-preview:hover {
  border-color: var(--brand);
  box-shadow: 0 0 20px rgba(255, 111, 0, 0.2);
}

.photo-preview img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.photo-preview-placeholder {
  text-align: center;
  color: var(--text-muted);
  font-size: 0.75rem;
}

.photo-preview-placeholder .photo-icon {
  font-size: 2rem;
  display: block;
  margin-bottom: var(--sp-xs);
}

.photo-actions {
  display: flex;
  gap: var(--sp-sm);
  flex-wrap: wrap;
  justify-content: center;
}

/* Hidden file input */
.photo-file-input {
  display: none;
}

/* ============================================================
   BLOCK 29: PDF THEME CUSTOMIZATION
   ============================================================ */
.pdf-theme-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: var(--sp-sm);
  margin-bottom: var(--sp-md);
}

.pdf-theme-card {
  border: 2px solid var(--border);
  border-radius: var(--r-md);
  padding: var(--sp-sm);
  cursor: pointer;
  transition: all var(--dur) var(--ease);
  text-align: center;
  position: relative;
  overflow: hidden;
  min-height: 80px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: var(--sp-xs);
}

.pdf-theme-card:hover {
  border-color: var(--brand);
  transform: translateY(-2px);
}

.pdf-theme-card.selected {
  border-color: var(--brand);
  background: rgba(255, 111, 0, 0.06);
  box-shadow: 0 0 15px rgba(255, 111, 0, 0.15);
}

.pdf-theme-card.selected::after {
  content: '‚úì';
  position: absolute;
  top: 4px;
  right: 6px;
  background: var(--grad-brand);
  color: #fff;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  display: grid;
  place-items: center;
  font-size: 0.6rem;
  font-weight: 700;
}

.pdf-theme-name {
  font-size: 0.75rem;
  font-weight: 700;
  color: var(--text-primary);
}

.pdf-theme-preview {
  font-size: 1.5rem;
}

.pdf-theme-desc {
  font-size: 0.58rem;
  color: var(--text-muted);
}

/* Color picker row */
.color-picker-row {
  display: flex;
  align-items: center;
  gap: var(--sp-sm);
  padding: var(--sp-sm) 0;
  border-bottom: 1px solid var(--border);
}

.color-picker-row:last-child {
  border-bottom: none;
}

.color-picker-label {
  flex: 1;
  font-size: 0.78rem;
  color: var(--text-secondary);
}

.color-picker-input {
  width: 40px;
  height: 34px;
  border: 2px solid var(--border);
  border-radius: var(--r-sm);
  background: none;
  cursor: pointer;
  padding: 2px;
  -webkit-appearance: none;
  appearance: none;
}

.color-picker-input::-webkit-color-swatch-wrapper {
  padding: 0;
}

.color-picker-input::-webkit-color-swatch {
  border: none;
  border-radius: 4px;
}

/* Toggle switch for show/hide options */
.toggle-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 0;
  border-bottom: 1px solid var(--border);
  min-height: 40px;
}

.toggle-row:last-child {
  border-bottom: none;
}

.toggle-label {
  font-size: 0.8rem;
  color: var(--text-secondary);
  display: flex;
  align-items: center;
  gap: var(--sp-xs);
}

.toggle-switch {
  position: relative;
  width: 44px;
  height: 24px;
  flex-shrink: 0;
}

.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.toggle-slider {
  position: absolute;
  inset: 0;
  background: var(--bg-elevated);
  border: 1.5px solid var(--border);
  border-radius: var(--r-full);
  cursor: pointer;
  transition: all var(--dur) var(--ease);
}

.toggle-slider::before {
  content: '';
  position: absolute;
  left: 3px;
  top: 50%;
  transform: translateY(-50%);
  width: 16px;
  height: 16px;
  background: var(--text-muted);
  border-radius: 50%;
  transition: all var(--dur) var(--ease);
}

.toggle-switch input:checked + .toggle-slider {
  background: rgba(255, 111, 0, 0.15);
  border-color: var(--brand);
}

.toggle-switch input:checked + .toggle-slider::before {
  left: calc(100% - 19px);
  background: var(--grad-brand);
}

/* Font selector */
.font-option {
  display: flex;
  align-items: center;
  gap: var(--sp-sm);
  padding: 8px var(--sp-md);
  border: 1.5px solid var(--border);
  border-radius: var(--r-sm);
  cursor: pointer;
  transition: all var(--dur) var(--ease);
  margin-bottom: var(--sp-xs);
}

.font-option:hover {
  border-color: var(--brand);
}

.font-option.selected {
  border-color: var(--brand);
  background: rgba(255, 111, 0, 0.06);
}

.font-option-radio {
  width: 18px;
  height: 18px;
  border: 2px solid var(--text-muted);
  border-radius: 50%;
  display: grid;
  place-items: center;
  flex-shrink: 0;
  transition: all var(--dur) var(--ease);
}

.font-option.selected .font-option-radio {
  border-color: var(--brand);
  background: var(--grad-brand);
}

.font-option.selected .font-option-radio::after {
  content: '';
  width: 6px;
  height: 6px;
  background: #fff;
  border-radius: 50%;
}

.font-option-name {
  font-size: 0.8rem;
  color: var(--text-primary);
  font-weight: 600;
}

.font-option-sample {
  font-size: 0.68rem;
  color: var(--text-muted);
}

/* ============================================================
   BLOCK 30: A4 PREVIEW CONTAINER
   ============================================================ */
.a4-preview-container {
  background: #666;
  border-radius: var(--r-md);
  padding: var(--sp-md);
  overflow: auto;
  -webkit-overflow-scrolling: touch;
  max-height: 70vh;
  position: relative;
}

.a4-page {
  width: 794px;
  min-height: 1123px;
  max-height: 1123px;
  background: #fff;
  margin: 0 auto var(--sp-md);
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  position: relative;
  overflow: hidden;
  transform-origin: top center;
}

/* Scale for mobile */
@media (max-width: 840px) {
  .a4-page {
    transform: scale(0.42);
    margin-bottom: calc(-1123px * 0.58 + 16px);
  }
  .a4-preview-container {
    max-height: none;
  }
}

@media (min-width: 841px) and (max-width: 1024px) {
  .a4-page {
    transform: scale(0.7);
    margin-bottom: calc(-1123px * 0.3 + 16px);
  }
}

.a4-page-number {
  position: absolute;
  bottom: 8px;
  right: 12px;
  font-size: 0.6rem;
  color: #999;
  background: rgba(255,255,255,0.9);
  padding: 2px 8px;
  border-radius: var(--r-full);
}

/* Preview zoom controls */
.preview-controls {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: var(--sp-sm);
  padding: var(--sp-sm);
  margin-bottom: var(--sp-sm);
}

/* ============================================================
   BLOCK 31: UPDATED TABBAR (3 tabs)
   ============================================================ */
.tabbar-inner.three-tabs {
  grid-template-columns: repeat(3, 1fr);
}

.tabbar-inner.three-tabs .tab-btn {
  padding: 8px 2px 7px;
  font-size: 0.65rem;
}

.tabbar-inner.three-tabs .tab-btn .tab-icon {
  font-size: 1.3rem;
}

/* Menu button in topbar */
.menu-btn {
  width: 38px;
  height: 38px;
  border-radius: var(--r-md);
  border: 1px solid var(--border);
  background: var(--bg-card);
  color: var(--text-brand);
  display: grid;
  place-items: center;
  font-size: 1.2rem;
  cursor: pointer;
  transition: all var(--dur) var(--ease);
  flex-shrink: 0;
}

.menu-btn:hover,
.menu-btn:active {
  background: rgba(255, 111, 0, 0.1);
  border-color: var(--border-brand);
  transform: scale(0.95);
}

/* Topbar photo */
.topbar-photo {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  overflow: hidden;
  background: var(--grad-brand);
  display: grid;
  place-items: center;
  font-size: 0.85rem;
  flex-shrink: 0;
  border: 2px solid rgba(255, 111, 0, 0.2);
}

.topbar-photo img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
</style>
</head>
<body>

<!-- ============================================================
     HTML BLOCK 1: GLOBAL OVERLAYS
     Toast, Loader
     ============================================================ -->
<div class="toast-container" id="toastContainer"></div>

<div class="loader-overlay" id="loader">
  <div class="loader-spinner"></div>
  <div class="loader-text" id="loaderMsg">Loading...</div>
</div>

<!-- ============================================================
     HTML BLOCK 2: AUTH SCREEN
     Login / Signup / OTP
     ============================================================ -->
<div class="auth-screen" id="authScreen">
  <div class="auth-wrapper">
    <div class="auth-logo">
      <div class="auth-logo-icon">üïâÔ∏è</div>
      <h1>‡§∂‡•Å‡§≠‡§æ‡§∞‡§Ç‡§≠</h1>
      <p>Professional Pooja Samagri Manager</p>
    </div>

    <!-- Login Form -->
    <div id="authLogin" class="auth-card">
      <h3>üîê Login</h3>
      <div class="form-group">
        <label class="form-label">Email</label>
        <input class="form-input" id="loginEmail" type="email"
               placeholder="your@email.com" autocomplete="email">
      </div>
      <div class="form-group">
        <label class="form-label">Password</label>
        <div class="input-wrapper">
          <input class="form-input" id="loginPass" type="password"
                 placeholder="Password" autocomplete="current-password">
          <button type="button" class="pass-toggle"
                  onclick="togglePassword('loginPass', this)">üëÅÔ∏è</button>
        </div>
      </div>
      <button class="btn btn-primary btn-w"
              onclick="Auth.login()" style="margin-top:8px">
        Login ‚Üí
      </button>
      <div class="auth-switch">
        New here?
        <a onclick="Auth.showForm('signup')">Create Free Account</a>
      </div>
    </div>

    <!-- Signup Form -->
    <div id="authSignup" class="auth-card hide">
      <h3>üÜï Create Account</h3>
      <div class="form-group">
        <label class="form-label">Full Name *</label>
        <input class="form-input" id="regName"
               placeholder="‡§Ü‡§™‡§ï‡§æ ‡§®‡§æ‡§Æ" autocomplete="name">
      </div>
      <div class="form-group">
        <label class="form-label">Email *</label>
        <input class="form-input" id="regEmail" type="email"
               placeholder="your@email.com" autocomplete="email">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Phone</label>
          <input class="form-input" id="regPhone" type="tel"
                 placeholder="+91" autocomplete="tel">
        </div>
        <div class="form-group">
          <label class="form-label">City</label>
          <input class="form-input" id="regCity" placeholder="‡§∂‡§π‡§∞">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Password * (min 6)</label>
        <div class="input-wrapper">
          <input class="form-input" id="regPass" type="password"
                 placeholder="Password" autocomplete="new-password">
          <button type="button" class="pass-toggle"
                  onclick="togglePassword('regPass', this)">üëÅÔ∏è</button>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Confirm Password *</label>
        <div class="input-wrapper">
          <input class="form-input" id="regPass2" type="password"
                 placeholder="Repeat password" autocomplete="new-password">
          <button type="button" class="pass-toggle"
                  onclick="togglePassword('regPass2', this)">üëÅÔ∏è</button>
        </div>
      </div>
      <button class="btn btn-primary btn-w"
              onclick="Auth.sendOTP()" style="margin-top:8px">
        Send OTP ‚Üí
      </button>
      <div class="auth-switch">
        Have account?
        <a onclick="Auth.showForm('login')">Login</a>
      </div>
    </div>

    <!-- OTP Verification -->
    <div id="authOTP" class="auth-card hide">
      <h3>üì© Verify Email</h3>
      <p style="text-align:center;color:var(--text-secondary);font-size:.82rem;margin-bottom:var(--sp-md)">
        OTP sent to
        <strong id="otpEmailDisplay" style="color:var(--text-brand)">-</strong>
      </p>
      <div class="otp-container" id="otpContainer">
        <input class="otp-input" maxlength="1" data-idx="0"
               inputmode="numeric" autocomplete="one-time-code">
        <input class="otp-input" maxlength="1" data-idx="1"
               inputmode="numeric">
        <input class="otp-input" maxlength="1" data-idx="2"
               inputmode="numeric">
        <input class="otp-input" maxlength="1" data-idx="3"
               inputmode="numeric">
        <input class="otp-input" maxlength="1" data-idx="4"
               inputmode="numeric">
        <input class="otp-input" maxlength="1" data-idx="5"
               inputmode="numeric">
      </div>
      <button class="btn btn-primary btn-w"
              onclick="Auth.verifyOTP()">
        Verify & Create Account ‚Üí
      </button>
      <div style="text-align:center;margin-top:var(--sp-md);display:flex;gap:var(--sp-sm);justify-content:center">
        <button class="btn btn-xs btn-ghost"
                onclick="Auth.resendOTP()" id="btnResend">Resend OTP</button>
        <button class="btn btn-xs btn-ghost"
                onclick="Auth.showForm('signup')">‚Üê Back</button>
      </div>
    </div>

    <!-- Features -->
    <div class="auth-features">
      <h4>üéâ Start Free</h4>
      <div class="features-grid">
        <span>‚úÖ Pooja Lists</span>
        <span>‚úÖ 2-Col PDF</span>
        <span>‚úÖ Yajman Manager</span>
        <span>‚úÖ Hisab Book</span>
        <span>‚úÖ WhatsApp Share</span>
        <span>‚úÖ Cloud Backup</span>
      </div>
    </div>
  </div>
</div>

<!-- ============================================================
     HTML BLOCK 3: APP SHELL
     Topbar, Main content area, Tab bar
     ============================================================ -->
  <!-- Top Bar -->
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand" style="gap:var(--sp-sm)">
        <button class="menu-btn" onclick="Drawer.toggle()" aria-label="Menu">‚ò∞</button>
        <div class="brand-text">
          <h1>‡§∂‡•Å‡§≠‡§æ‡§∞‡§Ç‡§≠</h1>
          <small id="topSubtitle">Welcome</small>
        </div>
      </div>
      <div class="top-actions">
        <span class="plan-badge free" id="topPlanBadge">FREE</span>
        <div class="topbar-photo" id="topbarPhoto" onclick="Drawer.toggle()">
          <span id="topbarPhotoInner">üë§</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Drawer Menu -->
  <div class="drawer-overlay" id="drawerOverlay" onclick="Drawer.close()"></div>
  <div class="drawer" id="drawerMenu">

    <!-- Drawer Header -->
    <div class="drawer-header">
      <div class="drawer-photo" id="drawerPhoto" onclick="PhotoUpload.show()">
        <span id="drawerPhotoInner">üë§</span>
        <div class="drawer-photo-edit">üì∑</div>
      </div>
      <div class="drawer-name" id="drawerName">User</div>
      <div class="drawer-email" id="drawerEmail">email@example.com</div>
      <div class="drawer-plan">
        <span class="plan-badge free" id="drawerPlanBadge">FREE</span>
      </div>
    </div>

    <!-- Drawer Body -->
    <div class="drawer-body">

      <!-- Main Navigation -->
      <div class="drawer-section">
        <div class="drawer-section-title">Navigation</div>
      </div>
      <div class="drawer-item" onclick="Drawer.goTo('home')">
        <span class="drawer-icon">üè†</span>
        <span class="drawer-label">Home Dashboard</span>
      </div>
      <div class="drawer-item" onclick="Drawer.goTo('new')">
        <span class="drawer-icon">‚ûï</span>
        <span class="drawer-label">New Pooja</span>
      </div>
      <div class="drawer-item" onclick="Drawer.goTo('hisab')">
        <span class="drawer-icon">üí∞</span>
        <span class="drawer-label">Hisab Book</span>
      </div>

      <div class="drawer-divider"></div>

      <!-- Management -->
      <div class="drawer-section">
        <div class="drawer-section-title">Management</div>
      </div>
      <div class="drawer-item" onclick="Drawer.goTo('yajman')">
        <span class="drawer-icon">üë•</span>
        <span class="drawer-label">Yajman Manager</span>
        <span class="drawer-badge badge-brand" id="drawerYajCount">0</span>
      </div>
      <div class="drawer-item" onclick="Drawer.goTo('database')">
        <span class="drawer-icon">üóÑÔ∏è</span>
        <span class="drawer-label">Pooja Database</span>
        <span class="drawer-badge badge-brand" id="drawerDBCount">0</span>
      </div>
      <div class="drawer-item" onclick="Drawer.goTo('library')">
        <span class="drawer-icon">üìö</span>
        <span class="drawer-label">Saved Templates</span>
        <span class="drawer-badge badge-brand" id="drawerTplCount">0</span>
      </div>

      <div class="drawer-divider"></div>

      <!-- PDF & Settings -->
      <div class="drawer-section">
        <div class="drawer-section-title">Customization</div>
      </div>
      <div class="drawer-item" onclick="Drawer.goTo('pdfSettings')">
        <span class="drawer-icon">üé®</span>
        <span class="drawer-label">PDF Settings</span>
        <span style="font-size:.6rem;color:var(--text-muted)">‚ñ∏</span>
      </div>

      <div class="drawer-divider"></div>

      <!-- Account -->
      <div class="drawer-section">
        <div class="drawer-section-title">Account</div>
      </div>
      <div class="drawer-item" onclick="Drawer.goTo('profile')">
        <span class="drawer-icon">üë§</span>
        <span class="drawer-label">Profile & Pandit Info</span>
      </div>
      <div class="drawer-item" onclick="Subscription.showUpgrade()">
        <span class="drawer-icon">‚≠ê</span>
        <span class="drawer-label">Upgrade to Pro</span>
        <span class="drawer-badge badge-warning" id="drawerProBadge">PRO</span>
      </div>
      <div class="drawer-item" onclick="ProfileUI.backup()">
        <span class="drawer-icon">üíæ</span>
        <span class="drawer-label">Backup & Export</span>
      </div>
      <div class="drawer-item" onclick="App.refresh()">
        <span class="drawer-icon">üîÑ</span>
        <span class="drawer-label">Refresh Data</span>
      </div>

      <div class="drawer-divider"></div>

      <div class="drawer-item danger" onclick="Auth.logout()">
        <span class="drawer-icon">üö™</span>
        <span class="drawer-label">Logout</span>
      </div>
    </div>

    <!-- Drawer Footer -->
    <div class="drawer-footer">
      ‡§∂‡•Å‡§≠‡§æ‡§∞‡§Ç‡§≠ v4.0 ‚Ä¢ Made with üôè for Pandits
    </div>
  </div>

  <!-- Refresh Indicator -->
  <div class="refresh-indicator" id="refreshIndicator">
    <div class="refresh-indicator-inner">
      <div class="mini-spinner"></div>
      <span id="refreshText">Refreshing...</span>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="main">
    <section id="pgHome"       class="page active"></section>
    <section id="pgNew"        class="page"></section>
    <section id="pgHisab"      class="page"></section>
    <section id="pgYajman"     class="page"></section>
    <section id="pgDatabase"   class="page"></section>
    <section id="pgLib"        class="page"></section>
    <section id="pgProfile"    class="page"></section>
    <section id="pgPdfSettings" class="page"></section>
  </div>

  <!-- Bottom Tab Bar - 3 tabs only -->
  <div class="tabbar">
    <div class="tabbar-inner three-tabs">
      <button class="tab-btn active" data-page="pgHome"
              onclick="Nav.go('home')">
        <span class="tab-icon">üè†</span>
        <span>Home</span>
      </button>
      <button class="tab-btn" data-page="pgNew"
              onclick="Nav.go('new')">
        <span class="tab-icon">‚ûï</span>
        <span>New Pooja</span>
      </button>
      <button class="tab-btn" data-page="pgProfile"
              onclick="Nav.go('profile')">
        <span class="tab-icon">üë§</span>
        <span>More</span>
      </button>
    </div>
  </div>
</div>

  <!-- Refresh Indicator (auto, no pull needed) -->
  <div class="refresh-indicator" id="refreshIndicator">
    <div class="refresh-indicator-inner">
      <div class="mini-spinner"></div>
      <span id="refreshText">Refreshing...</span>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="main">
    <section id="pgHome"    class="page active"></section>
    <section id="pgNew"     class="page"></section>
    <section id="pgHisab"   class="page"></section>
    <section id="pgLib"     class="page"></section>
    <section id="pgProfile" class="page"></section>
  </div>

  <!-- Bottom Tab Bar - Simplified to 5 tabs -->
  <div class="tabbar">
    <div class="tabbar-inner">
      <button class="tab-btn active" data-page="pgHome"
              onclick="Nav.go('home')">
        <span class="tab-icon">üè†</span>
        <span>Home</span>
      </button>
      <button class="tab-btn" data-page="pgNew"
              onclick="Nav.go('new')">
        <span class="tab-icon">‚ûï</span>
        <span>New</span>
      </button>
      <button class="tab-btn" data-page="pgHisab"
              onclick="Nav.go('hisab')">
        <span class="tab-icon">üí∞</span>
        <span>Hisab</span>
      </button>
      <button class="tab-btn" data-page="pgLib"
              onclick="Nav.go('library')">
        <span class="tab-icon">üìö</span>
        <span>Library</span>
      </button>
      <button class="tab-btn" data-page="pgProfile"
              onclick="Nav.go('profile')">
        <span class="tab-icon">üë§</span>
        <span>More</span>
      </button>
    </div>
  </div>
</div>

<!-- Off-screen render zone for PDF -->
<div class="render-zone" id="renderZone"></div>
<!-- ============================================================
     PART B - BLOCK 1: PASSWORD TOGGLE (Global Utility)
     ============================================================ -->
<script>
function togglePassword(inputId, btn) {
  var inp = document.getElementById(inputId);
  if (!inp) return;
  if (inp.type === 'password') {
    inp.type = 'text';
    if (btn) { btn.textContent = 'üôà'; }
  } else {
    inp.type = 'password';
    if (btn) { btn.textContent = 'üëÅÔ∏è'; }
  }
}
</script>

<!-- ============================================================
     PART B - BLOCK 2: CONFIGURATION
     Central config - easy to change
     ============================================================ -->
<script>
var CFG = {
  API: 'https://script.google.com/macros/s/AKfycbyuINXuIq-r6wtQ98BoRkFI6SynSSxsNBNXBf8vcYdXDd4SGPSxmjKKYg361SrxPSfo/exec',
  VER: '4.0',
  APP_NAME: '‡§∂‡•Å‡§≠‡§æ‡§∞‡§Ç‡§≠',
  SESSION_KEY: 'shubh_session_v4',
  REFRESH_INTERVAL: 5 * 60 * 1000,  // Auto refresh every 5 min
  TOAST_DURATION: 4000,
  MAX_FREE_PDF_PER_DAY: 1,
  PDF_COUNTER_KEY: 'shubh_pdf_count',

  /* Subscription Plans */
  PLANS: {
    free: {
      name: 'Free',
      price: 0,
      pdfPerDay: 1,
      watermark: true,
      imageDownload: false,
      zipDownload: false,
      features: ['1 PDF/day', 'Watermark on PDF', 'Basic Features', 'Cloud Save']
    },
    monthly: {
      name: 'Pro Monthly',
      price: 99,
      pdfPerDay: 999,
      watermark: false,
      imageDownload: true,
      zipDownload: true,
      features: ['Unlimited PDFs', 'No Watermark', 'Image Download', 'ZIP Multi-page', 'Priority Support']
    },
    yearly: {
      name: 'Pro Yearly',
      price: 799,
      pdfPerDay: 999,
      watermark: false,
      imageDownload: true,
      zipDownload: true,
      features: ['Everything in Monthly', 'Save ‚Çπ389/year', 'All Future Features']
    }
  },

  /* UPI Payment Config */
  UPI: {
    id: 'yourupi@paytm',         // <-- Change to your UPI ID
    name: 'ShubhArambh Premium', // <-- Merchant name
    currency: 'INR'
  },

  /* Hisab Categories */
  HISAB_CATS: {
    income: [
      { id: 'dakshina',     label: '‡§¶‡§ï‡•ç‡§∑‡§ø‡§£‡§æ',    icon: 'üôè' },
      { id: 'chadawa',      label: '‡§ö‡§¢‡§º‡§æ‡§µ‡§æ',      icon: 'ü™∑' },
      { id: 'donation',     label: '‡§¶‡§æ‡§®',         icon: 'üíù' },
      { id: 'other_income', label: '‡§Ö‡§®‡•ç‡§Ø ‡§Ü‡§Ø',    icon: 'üí∞' }
    ],
    expense: [
      { id: 'saman',         label: '‡§∏‡§æ‡§Æ‡§æ‡§® ‡§ñ‡§∞‡•ç‡§ö',     icon: 'üì¶' },
      { id: 'other_panji',   label: '‡§Ö‡§®‡•ç‡§Ø ‡§™‡§Ç‡§ú‡•Ä ‡§ï‡•ã ‡§¶‡§ø‡§Ø‡•á', icon: 'üë®‚Äçüè´' },
      { id: 'temple',        label: '‡§Æ‡§Ç‡§¶‡§ø‡§∞ ‡§Æ‡•á‡§Ç ‡§¶‡§ø‡§Ø‡•á',   icon: 'üõï' },
      { id: 'travel',        label: '‡§Ø‡§æ‡§§‡•ç‡§∞‡§æ ‡§ñ‡§∞‡•ç‡§ö',     icon: 'üöó' },
      { id: 'prasad',        label: '‡§™‡•ç‡§∞‡§∏‡§æ‡§¶',          icon: 'üç≤' },
      { id: 'other_expense', label: '‡§Ö‡§®‡•ç‡§Ø ‡§ñ‡§∞‡•ç‡§ö',      icon: 'üì§' }
    ]
  },

  /* Material Units */
  UNITS: [
    '‡§ó‡•ç‡§∞‡§æ‡§Æ', '‡§ï‡§ø‡§ó‡•ç‡§∞‡§æ', '‡§®‡§ó', '‡§™‡•à‡§ï‡•á‡§ü', '‡§ú‡•ã‡§°‡§º‡§æ', '‡§∞‡•Å‡§™‡§Ø‡•á',
    '‡§≤‡•Ä‡§ü‡§∞', '‡§≤‡§ö‡•ç‡§õ‡§æ', '‡§Æ‡•Ä‡§ü‡§∞', '‡§¨‡§£‡•ç‡§°‡§≤', '‡§õ‡•ã‡§ü‡•Ä ‡§∂‡•Ä‡§∂‡•Ä', '‡§¨‡§°‡§º‡•Ä ‡§∂‡•Ä‡§∂‡•Ä'
  ]
};
</script>

<!-- ============================================================
     PART B - BLOCK 3: UI HELPERS
     Toast, Loader, Modal, DOM shortcuts, Formatting
     ============================================================ -->
<script>
var UI = {

  /* ---- DOM Shortcuts ---- */
  $: function(id) {
    return document.getElementById(id);
  },

  val: function(id) {
    var el = this.$(id);
    return el ? el.value.trim() : '';
  },

  setVal: function(id, v) {
    var el = this.$(id);
    if (el) el.value = (v != null) ? v : '';
  },

  html: function(id, content) {
    var el = this.$(id);
    if (el) el.innerHTML = content;
  },

  text: function(id, content) {
    var el = this.$(id);
    if (el) el.textContent = content;
  },

  show: function(id) {
    var el = this.$(id);
    if (el) el.classList.remove('hide');
  },

  hide: function(id) {
    var el = this.$(id);
    if (el) el.classList.add('hide');
  },

  toggle: function(id, show) {
    var el = this.$(id);
    if (el) el.classList.toggle('hide', !show);
  },

  addClass: function(id, cls) {
    var el = this.$(id);
    if (el) el.classList.add(cls);
  },

  removeClass: function(id, cls) {
    var el = this.$(id);
    if (el) el.classList.remove(cls);
  },

  /* ---- Toast Notifications ---- */
  _toastTimer: null,

  toast: function(title, message, type) {
    var container = this.$('toastContainer');
    if (!container) return;

    var icons = { ok: '‚úÖ', error: '‚ùå', warn: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' };
    var classes = { ok: 'success', error: 'error', warn: 'warning', info: '' };

    var toast = document.createElement('div');
    toast.className = 'toast ' + (classes[type] || '');
    toast.innerHTML =
      '<div class="toast-icon">' + (icons[type] || '‚ÑπÔ∏è') + '</div>' +
      '<div class="toast-content">' +
        '<div class="toast-title">' + this.esc(title) + '</div>' +
        (message ? '<div class="toast-message">' + this.esc(message) + '</div>' : '') +
      '</div>';

    container.appendChild(toast);

    // Auto remove
    var dur = CFG.TOAST_DURATION;
    setTimeout(function() {
      toast.classList.add('toast-leaving');
      setTimeout(function() {
        if (toast.parentNode) toast.parentNode.removeChild(toast);
      }, 300);
    }, dur);

    // Keep max 4 toasts
    while (container.children.length > 4) {
      container.removeChild(container.firstChild);
    }
  },

  /* ---- Loader ---- */
  load: function(msg) {
    this.text('loaderMsg', msg || 'Loading...');
    this.addClass('loader', 'active');
  },

  unload: function() {
    this.removeClass('loader', 'active');
  },

  /* ---- Modal Management ---- */
  _modals: {},

  /**
   * Create or open a modal
   * @param {string} id - unique modal id
   * @param {object} opts - { title, body, footer, maxWidth, onClose }
   * @returns modal element
   */
  createModal: function(id, opts) {
    opts = opts || {};

    // Remove existing
    this.closeModal(id);

    var overlay = document.createElement('div');
    overlay.id = id;
    overlay.className = 'modal-overlay';

    var box = document.createElement('div');
    box.className = 'modal-box';
    if (opts.maxWidth) box.style.maxWidth = opts.maxWidth;

    // Header
    var header = document.createElement('div');
    header.className = 'modal-header';
    header.innerHTML =
      '<h3 class="modal-title">' + (opts.title || '') + '</h3>';

    var closeBtn = document.createElement('button');
    closeBtn.className = 'modal-close';
    closeBtn.textContent = '√ó';
    closeBtn.onclick = function() { UI.closeModal(id); };
    header.appendChild(closeBtn);

    box.appendChild(header);

    // Body
    var body = document.createElement('div');
    body.className = 'modal-body';
    body.id = id + '_body';
    if (typeof opts.body === 'string') {
      body.innerHTML = opts.body;
    } else if (opts.body) {
      body.appendChild(opts.body);
    }
    box.appendChild(body);

    // Footer
    if (opts.footer) {
      var footer = document.createElement('div');
      footer.className = 'modal-footer';
      footer.id = id + '_footer';
      if (typeof opts.footer === 'string') {
        footer.innerHTML = opts.footer;
      } else if (opts.footer) {
        footer.appendChild(opts.footer);
      }
      box.appendChild(footer);
    }

    overlay.appendChild(box);
    document.body.appendChild(overlay);

    // Store reference
    this._modals[id] = { overlay: overlay, onClose: opts.onClose };

    // Close on backdrop click
    overlay.addEventListener('click', function(e) {
      if (e.target === overlay) UI.closeModal(id);
    });

    // Open with animation
    requestAnimationFrame(function() {
      overlay.classList.add('open');
    });

    return overlay;
  },

  closeModal: function(id) {
    var existing = this.$(id);
    if (existing) {
      var info = this._modals[id];
      if (info && info.onClose) {
        try { info.onClose(); } catch(e) {}
      }
      existing.classList.remove('open');
      setTimeout(function() {
        if (existing.parentNode) existing.parentNode.removeChild(existing);
      }, 200);
      delete this._modals[id];
    }
  },

  closeAllModals: function() {
    var keys = Object.keys(this._modals);
    for (var i = 0; i < keys.length; i++) {
      this.closeModal(keys[i]);
    }
  },

  /* ---- Refresh Indicator (NO pull needed) ---- */
  showRefresh: function(msg) {
    this.text('refreshText', msg || 'Refreshing...');
    this.addClass('refreshIndicator', 'visible');
  },

  hideRefresh: function() {
    this.removeClass('refreshIndicator', 'visible');
  },

  /* ---- Escape HTML ---- */
  esc: function(s) {
    if (!s) return '';
    return String(s)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  },

  /* ---- Format Currency ---- */
  formatMoney: function(n) {
    n = parseFloat(n) || 0;
    if (Math.abs(n) >= 100000) return '‚Çπ' + (n / 100000).toFixed(1) + 'L';
    if (Math.abs(n) >= 1000) return '‚Çπ' + (n / 1000).toFixed(1) + 'K';
    return '‚Çπ' + n.toLocaleString('en-IN');
  },

  /* ---- Format Date ---- */
  formatDate: function(d) {
    if (!d) return '-';
    try {
      var dt = new Date(d);
      if (isNaN(dt.getTime())) return String(d);
      var dd = String(dt.getDate()).padStart(2, '0');
      var mm = String(dt.getMonth() + 1).padStart(2, '0');
      var yy = dt.getFullYear();
      return dd + '/' + mm + '/' + yy;
    } catch(e) { return String(d); }
  },

  /* ---- Format Date (Relative) ---- */
  formatRelative: function(d) {
    if (!d) return '';
    try {
      var dt = new Date(d);
      var now = new Date();
      var diff = Math.floor((now - dt) / 86400000);
      if (diff === 0) return 'Today';
      if (diff === 1) return 'Yesterday';
      if (diff < 7) return diff + ' days ago';
      if (diff < 30) return Math.floor(diff / 7) + 'w ago';
      return this.formatDate(d);
    } catch(e) { return this.formatDate(d); }
  },

  /* ---- Today's date string ---- */
  today: function() {
    try { return new Date().toISOString().split('T')[0]; }
    catch(e) { return ''; }
  },

  /* ---- Confirm dialog (styled) ---- */
  confirm: function(title, message, onYes, onNo) {
    var body =
      '<div style="text-align:center;padding:var(--sp-md) 0">' +
        '<div style="font-size:2rem;margin-bottom:var(--sp-sm)">‚ö†Ô∏è</div>' +
        '<p style="color:var(--text-primary);font-size:.9rem;font-weight:600">' +
          this.esc(title) + '</p>' +
        (message ? '<p style="color:var(--text-muted);font-size:.78rem;margin-top:4px">' +
          this.esc(message) + '</p>' : '') +
      '</div>';

    var footer =
      '<button class="btn btn-ghost" onclick="UI.closeModal(\'mConfirm\')">' +
        'Cancel</button>' +
      '<button class="btn btn-danger" id="confirmYesBtn">' +
        'Yes, Continue</button>';

    var modal = this.createModal('mConfirm', {
      title: '‚ö†Ô∏è Confirm',
      body: body,
      footer: footer,
      maxWidth: '380px'
    });

    // Attach yes handler
    var yesBtn = this.$('confirmYesBtn');
    if (yesBtn) {
      yesBtn.onclick = function() {
        UI.closeModal('mConfirm');
        if (onYes) onYes();
      };
    }

    return modal;
  }
};
</script>

<!-- ============================================================
     PART B - BLOCK 4: API HELPER
     Handles all communication with Google Apps Script
     Retry logic, error handling, timeout
     ============================================================ -->
<script>
var API = {
  user: null,

  /**
   * GET request
   * @param {string} action
   * @param {object} params (optional)
   * @param {number} timeout ms (default 30000)
   */
  get: function(action, params, timeout) {
    var url = CFG.API + '?action=' + encodeURIComponent(action);

    // Add userId
    if (this.user && this.user.userId) {
      url += '&userId=' + encodeURIComponent(this.user.userId);
    }

    // Add extra params
    if (params) {
      var keys = Object.keys(params);
      for (var i = 0; i < keys.length; i++) {
        if (params[keys[i]] != null) {
          url += '&' + keys[i] + '=' + encodeURIComponent(params[keys[i]]);
        }
      }
    }

    // Fetch with timeout
    var t = timeout || 30000;
    return this._fetchWithTimeout(url, { method: 'GET' }, t)
      .then(function(r) {
        if (!r.ok) throw new Error('Server error: ' + r.status);
        return r.json();
      });
  },

  /**
   * POST request
   * @param {object} payload
   * @param {number} timeout ms (default 30000)
   */
  post: function(payload, timeout) {
    if (this.user && this.user.userId && !payload.userId) {
      payload.userId = this.user.userId;
    }

    var body = JSON.stringify(payload);
    var t = timeout || 30000;
    var self = this;

    return this._fetchWithTimeout(CFG.API, {
      method: 'POST',
      redirect: 'follow',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: body
    }, t)
    .then(function(r) {
      return r.text();
    })
    .then(function(text) {
      try { return JSON.parse(text); }
      catch(e) { return { status: text }; }
    })
    .catch(function(err) {
      // Fallback: no-cors mode (for CORS issues)
      console.warn('POST fallback (no-cors):', err.message);
      return fetch(CFG.API, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: body
      }).then(function() {
        return { status: 'sent' };
      });
    });
  },

  /**
   * Fetch with timeout wrapper
   */
  _fetchWithTimeout: function(url, options, ms) {
    return new Promise(function(resolve, reject) {
      var timer = setTimeout(function() {
        reject(new Error('Request timeout (' + ms + 'ms)'));
      }, ms);

      fetch(url, options).then(function(response) {
        clearTimeout(timer);
        resolve(response);
      }).catch(function(err) {
        clearTimeout(timer);
        reject(err);
      });
    });
  }
};
</script>

<!-- ============================================================
     PART B - BLOCK 5: SUBSCRIPTION & PAYMENT SYSTEM
     Plan checking, PDF limits, UPI payment
     ============================================================ -->
<script>
var Subscription = {

  /**
   * Get current plan info
   */
  getPlan: function() {
    var user = API.user || {};
    var planId = user.plan || 'free';

    // Check if plan is valid
    if (planId === 'paid' || planId === 'premium' || planId === 'pro' ||
        planId === 'monthly' || planId === 'yearly') {
      return 'pro';
    }
    return 'free';
  },

  isPro: function() {
    return this.getPlan() === 'pro';
  },

  /**
   * Check if user can download PDF today
   */
  canDownloadPDF: function() {
    if (this.isPro()) return { allowed: true, remaining: 999 };

    var today = UI.today();
    var data = {};

    try {
      data = JSON.parse(localStorage.getItem(CFG.PDF_COUNTER_KEY) || '{}');
    } catch(e) { data = {}; }

    var count = 0;
    if (data.date === today) {
      count = data.count || 0;
    }

    var max = CFG.MAX_FREE_PDF_PER_DAY;
    return {
      allowed: count < max,
      remaining: Math.max(0, max - count),
      used: count,
      max: max
    };
  },

  /**
   * Record a PDF download
   */
  recordPDFDownload: function() {
    if (this.isPro()) return;

    var today = UI.today();
    var data = {};

    try {
      data = JSON.parse(localStorage.getItem(CFG.PDF_COUNTER_KEY) || '{}');
    } catch(e) { data = {}; }

    if (data.date !== today) {
      data = { date: today, count: 0 };
    }
    data.count = (data.count || 0) + 1;

    localStorage.setItem(CFG.PDF_COUNTER_KEY, JSON.stringify(data));
  },

  /**
   * Should add watermark
   */
  shouldWatermark: function() {
    return !this.isPro();
  },

  /**
   * Show upgrade modal
   */
  showUpgrade: function(reason) {
    var plans = CFG.PLANS;
    var currentPlan = this.getPlan();
    var pdfInfo = this.canDownloadPDF();

    var body = '';

    // Reason banner
    if (reason) {
      body += '<div class="info-banner" style="border-left-color:var(--warning)">' +
        '‚ö†Ô∏è ' + UI.esc(reason) + '</div>';
    }

    // Current status
    body += '<div style="text-align:center;padding:var(--sp-md);background:var(--bg-card);' +
      'border-radius:var(--r-md);margin-bottom:var(--sp-lg)">' +
      '<div style="font-size:.7rem;color:var(--text-muted);text-transform:uppercase">Current Plan</div>' +
      '<div style="font-size:1.2rem;font-weight:800;color:' +
        (currentPlan === 'pro' ? 'var(--success)' : 'var(--warning)') + '">' +
        (currentPlan === 'pro' ? '‚≠ê PRO' : 'üÜì FREE') + '</div>' +
      (currentPlan !== 'pro' ?
        '<div style="font-size:.7rem;color:var(--text-muted);margin-top:4px">' +
          'PDFs today: ' + pdfInfo.used + '/' + pdfInfo.max + '</div>' : '') +
      '</div>';

    // Plan cards
    body += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:var(--sp-md)">';

    // Monthly
    body += '<div class="plan-card plan-pro" style="position:relative">' +
      '<div class="plan-name" style="color:var(--brand)">Monthly</div>' +
      '<div class="plan-price">‚Çπ' + plans.monthly.price +
        '<small>/month</small></div>' +
      '<ul class="plan-features">';
    for (var i = 0; i < plans.monthly.features.length; i++) {
      body += '<li>' + plans.monthly.features[i] + '</li>';
    }
    body += '</ul>' +
      '<button class="btn btn-primary btn-w btn-sm" ' +
        'onclick="Subscription.initPayment(\'monthly\')">Subscribe</button>' +
      '</div>';

    // Yearly
    body += '<div class="plan-card plan-pro" style="position:relative">' +
      '<div class="plan-name" style="color:var(--brand)">Yearly</div>' +
      '<div class="plan-price">‚Çπ' + plans.yearly.price +
        '<small>/year</small></div>' +
      '<div style="font-size:.6rem;color:var(--success);font-weight:700;margin:4px 0">' +
        'üéâ Save ‚Çπ' + (plans.monthly.price * 12 - plans.yearly.price) + '/year</div>' +
      '<ul class="plan-features">';
    for (var j = 0; j < plans.yearly.features.length; j++) {
      body += '<li>' + plans.yearly.features[j] + '</li>';
    }
    body += '</ul>' +
      '<button class="btn btn-primary btn-w btn-sm" ' +
        'onclick="Subscription.initPayment(\'yearly\')">Subscribe</button>' +
      '</div>';

    body += '</div>';

    // Free plan comparison
    body += '<div style="margin-top:var(--sp-lg);padding:var(--sp-md);' +
      'background:var(--bg-card);border-radius:var(--r-md)">' +
      '<div style="font-size:.75rem;font-weight:700;color:var(--text-muted);margin-bottom:var(--sp-sm)">' +
        'Free Plan Limits:</div>' +
      '<ul class="plan-features" style="margin:0">';
    body += '<li class="disabled">Only ' + CFG.MAX_FREE_PDF_PER_DAY + ' PDF per day</li>';
    body += '<li class="disabled">Watermark on all PDFs</li>';
    body += '<li class="disabled">No image/ZIP download</li>';
    body += '</ul></div>';

    UI.createModal('mUpgrade', {
      title: '‚≠ê Upgrade to Pro',
      body: body,
      maxWidth: '520px'
    });
  },

  /**
   * Initialize UPI Payment
   */
  initPayment: function(planType) {
    var plan = CFG.PLANS[planType];
    if (!plan) return;

    UI.closeModal('mUpgrade');

    var amount = plan.price;
    var upi = CFG.UPI;
    var txnId = 'SHUBH' + Date.now() + Math.random().toString(36).substr(2, 6).toUpperCase();
    var note = CFG.APP_NAME + ' ' + plan.name + ' - ' + (API.user ? API.user.email : '');

    // Build UPI deep link
    var upiLink = 'upi://pay?' +
      'pa=' + encodeURIComponent(upi.id) +
      '&pn=' + encodeURIComponent(upi.name) +
      '&am=' + amount +
      '&cu=' + upi.currency +
      '&tn=' + encodeURIComponent(note) +
      '&tr=' + txnId;

    var body = '';

    // Transaction info
    body += '<div style="text-align:center;margin-bottom:var(--sp-lg)">' +
      '<div style="font-size:2rem;margin-bottom:var(--sp-sm)">üí≥</div>' +
      '<div style="font-size:1.5rem;font-weight:800;color:var(--brand)">‚Çπ' + amount + '</div>' +
      '<div style="font-size:.78rem;color:var(--text-muted)">' + plan.name + '</div>' +
      '<div style="font-size:.6rem;color:var(--text-muted);margin-top:4px">' +
        'TXN: ' + txnId + '</div>' +
      '</div>';

    // UPI Section
    body += '<div class="upi-section">' +
      '<div style="font-size:.85rem;font-weight:700;color:var(--text-primary);margin-bottom:var(--sp-sm)">' +
        'Pay via UPI</div>' +
      '<div style="font-size:.7rem;color:var(--text-muted);margin-bottom:var(--sp-md)">' +
        'UPI ID: <strong style="color:var(--text-brand)">' + upi.id + '</strong></div>';

    // QR Code placeholder
    body += '<div class="upi-qr">' +
      '<div style="text-align:center;color:#333;font-size:.7rem">' +
        '<div style="font-size:2rem;margin-bottom:4px">üì±</div>' +
        'Scan QR in any<br>UPI app to pay</div>' +
      '</div>';

    // UPI App buttons
    body += '<div class="upi-apps">' +
      '<a href="' + upiLink + '" class="upi-app-btn">üì± Open UPI App</a>' +
      '<a href="' + upiLink.replace('upi://', 'phonepe://') + '" class="upi-app-btn">PhonePe</a>' +
      '<a href="' + upiLink.replace('upi://', 'gpay://') + '" class="upi-app-btn">GPay</a>' +
      '<a href="' + upiLink.replace('upi://', 'paytmmp://') + '" class="upi-app-btn">Paytm</a>' +
      '</div>';

    // Manual UPI ID copy
    body += '<div style="margin-top:var(--sp-md);text-align:center">' +
      '<button class="btn btn-xs btn-ghost" onclick="Subscription._copyUPI()">' +
        'üìã Copy UPI ID</button>' +
      '</div>';

    body += '</div>';

    // After payment instruction
    body += '<div class="info-banner" style="margin-top:var(--sp-lg)">' +
      'üìå After payment, click "Verify Payment" below. ' +
      'Your account will be upgraded within 5 minutes. ' +
      'If not, contact support with TXN ID.</div>';

    var footer =
      '<button class="btn btn-ghost" onclick="UI.closeModal(\'mPayment\')">Cancel</button>' +
      '<button class="btn btn-primary" onclick="Subscription.verifyPayment(\'' +
        txnId + '\',\'' + planType + '\')">' +
        '‚úÖ Verify Payment</button>';

    UI.createModal('mPayment', {
      title: 'üí≥ Payment - ' + plan.name,
      body: body,
      footer: footer,
      maxWidth: '440px'
    });
  },

  _copyUPI: function() {
    var upiId = CFG.UPI.id;
    if (navigator.clipboard) {
      navigator.clipboard.writeText(upiId).then(function() {
        UI.toast('Copied!', upiId, 'ok');
      });
    } else {
      // Fallback
      var t = document.createElement('textarea');
      t.value = upiId;
      document.body.appendChild(t);
      t.select();
      document.execCommand('copy');
      document.body.removeChild(t);
      UI.toast('Copied!', upiId, 'ok');
    }
  },

  /**
   * Verify payment with server
   */
  verifyPayment: function(txnId, planType) {
    UI.closeModal('mPayment');
    UI.load('Verifying payment...');

    API.post({
      action: 'verifyPayment',
      transactionId: txnId,
      planType: planType,
      amount: CFG.PLANS[planType].price,
      email: API.user ? API.user.email : ''
    }).then(function(r) {
      UI.unload();

      if (r.error) {
        UI.toast('Verification Pending', r.error, 'warn');
        return;
      }

      // Update local plan
      if (API.user) {
        API.user.plan = 'pro';
        localStorage.setItem(CFG.SESSION_KEY, JSON.stringify(API.user));
      }

      UI.toast('üéâ Upgraded!', 'Welcome to Pro!', 'ok');

      // Refresh UI
      setTimeout(function() {
        App.updatePlanUI();
      }, 500);

    }).catch(function(e) {
      UI.unload();
      UI.toast('Pending',
        'Payment verification submitted. Will be activated within 5 minutes.',
        'warn');

      // Send verification request anyway
      API.post({
        action: 'pendingPayment',
        transactionId: txnId,
        planType: planType,
        amount: CFG.PLANS[planType].price,
        email: API.user ? API.user.email : ''
      }).catch(function() {});
    });
  },

  /**
   * Update plan badge in UI
   */
  updateBadge: function() {
    var badge = UI.$('topPlanBadge');
    if (!badge) return;

    if (this.isPro()) {
      badge.textContent = 'PRO';
      badge.className = 'plan-badge pro';
    } else {
      badge.textContent = 'FREE';
      badge.className = 'plan-badge free';
    }
  }
};
</script>

<!-- ============================================================
     PART B - BLOCK 6: AUTH SYSTEM
     Login, Signup, OTP, Session management
     ============================================================ -->
<script>
var Auth = {
  _signupData: {},

  /**
   * Switch between auth forms
   */
  showForm: function(form) {
    UI.hide('authLogin');
    UI.hide('authSignup');
    UI.hide('authOTP');

    if (form === 'login')  UI.show('authLogin');
    if (form === 'signup') UI.show('authSignup');
    if (form === 'otp')    UI.show('authOTP');
  },

  /**
   * Login
   */
  login: function() {
    var email = UI.val('loginEmail');
    var pass  = UI.val('loginPass');

    if (!email) { UI.toast('Required', 'Enter email', 'warn'); return; }
    if (!pass)  { UI.toast('Required', 'Enter password', 'warn'); return; }

    UI.load('Logging in...');

    API.post({ action: 'login', email: email, password: pass })
      .then(function(r) {
        UI.unload();
        if (r.error) {
          UI.toast('Login Failed', r.error, 'error');
          return;
        }
        Auth._onLoginSuccess(r);
      })
      .catch(function(e) {
        UI.unload();
        UI.toast('Error', 'Connection failed. Try again.', 'error');
      });
  },

  /**
   * Send OTP for signup
   */
  sendOTP: function() {
    var name  = UI.val('regName');
    var email = UI.val('regEmail');
    var pass  = UI.val('regPass');
    var pass2 = UI.val('regPass2');

    if (!name)  { UI.toast('Required', 'Enter name', 'warn'); return; }
    if (!email) { UI.toast('Required', 'Enter email', 'warn'); return; }
    if (!pass || pass.length < 6) {
      UI.toast('Weak Password', 'Min 6 characters', 'warn'); return;
    }
    if (pass !== pass2) {
      UI.toast('Mismatch', 'Passwords don\'t match', 'warn'); return;
    }

    this._signupData = {
      name: name,
      email: email,
      phone: UI.val('regPhone'),
      city: UI.val('regCity'),
      password: pass
    };

    UI.load('Sending OTP...');

    var self = this;
    API.post({
      action: 'sendOTP',
      name: name,
      email: email,
      phone: UI.val('regPhone'),
      password: pass
    }).then(function(r) {
      UI.unload();
      if (r.error) {
        UI.toast('Failed', r.error, 'error');
        return;
      }
      UI.toast('OTP Sent!', 'Check your email', 'ok');
      UI.text('otpEmailDisplay', email);
      self.showForm('otp');

      // Focus first OTP input
      setTimeout(function() {
        var first = document.querySelector('.otp-input');
        if (first) first.focus();
      }, 300);
    }).catch(function(e) {
      UI.unload();
      UI.toast('Error', e.message, 'error');
    });
  },

  /**
   * Resend OTP
   */
  resendOTP: function() {
    if (!this._signupData.email) {
      UI.toast('Error', 'Go back and fill details', 'error');
      return;
    }

    UI.load('Resending...');
    var d = this._signupData;

    API.post({
      action: 'sendOTP',
      name: d.name,
      email: d.email,
      phone: d.phone,
      password: d.password
    }).then(function(r) {
      UI.unload();
      if (r.error) { UI.toast('Failed', r.error, 'error'); return; }
      UI.toast('Resent!', 'Check email again', 'ok');
    }).catch(function(e) {
      UI.unload();
      UI.toast('Error', e.message, 'error');
    });
  },

  /**
   * Verify OTP
   */
  verifyOTP: function() {
    var otp = this._getOTPValue();
    if (otp.length !== 6) {
      UI.toast('Required', 'Enter all 6 digits', 'warn');
      return;
    }

    UI.load('Verifying...');

    var self = this;
    API.post({
      action: 'verifyOTP',
      email: self._signupData.email,
      otp: otp
    }).then(function(r) {
      UI.unload();
      if (r.error) {
        UI.toast('Failed', r.error, 'error');
        self._clearOTPInputs();
        return;
      }
      self._onLoginSuccess(r);
      UI.toast('üéâ Welcome!', 'Account created successfully', 'ok');
    }).catch(function(e) {
      UI.unload();
      UI.toast('Error', e.message, 'error');
    });
  },

  /**
   * Handle successful login/signup
   */
  _onLoginSuccess: function(userData) {
    API.user = userData;
    localStorage.setItem(CFG.SESSION_KEY, JSON.stringify(userData));
    App.enter();
    UI.toast('Welcome!', '‡§®‡§Æ‡§∏‡•ç‡§§‡•á ' + (userData.name || ''), 'ok');
  },

  /**
   * Check saved session
   */
  checkSession: function() {
    try {
      var saved = localStorage.getItem(CFG.SESSION_KEY);
      if (saved) {
        var data = JSON.parse(saved);
        if (data && data.userId) {
          API.user = data;
          return true;
        }
      }
    } catch(e) {
      localStorage.removeItem(CFG.SESSION_KEY);
    }
    return false;
  },

  /**
   * Logout
   */
  logout: function() {
    UI.confirm('Logout', 'Are you sure you want to logout?', function() {
      localStorage.removeItem(CFG.SESSION_KEY);
      API.user = null;
      UI.closeAllModals();

      UI.$('appShell').style.display = 'none';
      UI.show('authScreen');

      // Clear form fields
      UI.setVal('loginEmail', '');
      UI.setVal('loginPass', '');
      Auth.showForm('login');

      UI.toast('Logged Out', 'üôè See you soon!', 'ok');
    });
  },

  /* ---- OTP Input Helpers ---- */
  _getOTPValue: function() {
    var inputs = document.querySelectorAll('.otp-input');
    var otp = '';
    for (var i = 0; i < inputs.length; i++) {
      otp += inputs[i].value;
    }
    return otp;
  },

  _clearOTPInputs: function() {
    var inputs = document.querySelectorAll('.otp-input');
    for (var i = 0; i < inputs.length; i++) {
      inputs[i].value = '';
    }
    if (inputs[0]) inputs[0].focus();
  },

  /**
   * Setup OTP auto-advance
   */
  setupOTPHandlers: function() {
    var inputs = document.querySelectorAll('.otp-input');

    inputs.forEach(function(inp, idx) {

      inp.addEventListener('input', function() {
        // Only allow digits
        this.value = this.value.replace(/[^0-9]/g, '');

        if (this.value.length === 1 && idx < inputs.length - 1) {
          inputs[idx + 1].focus();
        }

        // Auto-submit on last digit
        if (idx === inputs.length - 1 && this.value.length === 1) {
          var full = Auth._getOTPValue();
          if (full.length === 6) {
            setTimeout(function() { Auth.verifyOTP(); }, 200);
          }
        }
      });

      inp.addEventListener('keydown', function(e) {
        if (e.key === 'Backspace' && !this.value && idx > 0) {
          inputs[idx - 1].focus();
          inputs[idx - 1].value = '';
          e.preventDefault();
        }
        if (e.key === 'Enter') {
          Auth.verifyOTP();
        }
      });

      // Handle paste
      inp.addEventListener('paste', function(e) {
        e.preventDefault();
        var pasted = (e.clipboardData || window.clipboardData)
          .getData('text').replace(/[^0-9]/g, '').substr(0, 6);
        if (pasted.length) {
          for (var p = 0; p < Math.min(pasted.length, inputs.length); p++) {
            inputs[p].value = pasted[p];
          }
          var focusIdx = Math.min(pasted.length, inputs.length - 1);
          inputs[focusIdx].focus();

          if (pasted.length === 6) {
            setTimeout(function() { Auth.verifyOTP(); }, 200);
          }
        }
      });
    });
  }
};
</script>

<!-- ============================================================
     PART B - BLOCK 7: NAVIGATION SYSTEM
     Page routing, tab management, history support
     ============================================================ -->
<script>
var Nav = {
  current: 'home',

  /* Page name to element ID mapping */
  _map: {
    'home':    'pgHome',
    'new':     'pgNew',
    'hisab':   'pgHisab',
    'library': 'pgLib',
    'profile': 'pgProfile'
  },

  /**
   * Navigate to a page
   */
  go: function(pageName) {
    // Map old-style IDs to new names
    if (pageName.indexOf('pg') === 0) {
      var keys = Object.keys(this._map);
      for (var k = 0; k < keys.length; k++) {
        if (this._map[keys[k]] === pageName) {
          pageName = keys[k];
          break;
        }
      }
    }

    var pageId = this._map[pageName];
    if (!pageId) {
      console.warn('Nav: Unknown page:', pageName);
      return;
    }

    // Deactivate all pages
    var pages = document.querySelectorAll('.page');
    for (var i = 0; i < pages.length; i++) {
      pages[i].classList.remove('active');
    }

    // Activate target page
    var target = UI.$(pageId);
    if (target) target.classList.add('active');

    // Update tab bar
    var tabs = document.querySelectorAll('.tab-btn');
    for (var j = 0; j < tabs.length; j++) {
      var tabPage = tabs[j].getAttribute('data-page');
      tabs[j].classList.toggle('active', tabPage === pageId);
    }

    // Scroll to top smoothly
    window.scrollTo({ top: 0, behavior: 'smooth' });

    // Store current
    this.current = pageName;

    // Trigger page render
    if (typeof PageController !== 'undefined' && PageController[pageName]) {
      try {
        PageController[pageName]();
      } catch(e) {
        console.error('Page render error [' + pageName + ']:', e);
      }
    }

    // Update URL hash (for back button support)
    if (history.replaceState) {
      history.replaceState(null, '', '#' + pageName);
    }
  },

  /**
   * Handle browser back button
   */
  setupHistory: function() {
    var self = this;
    window.addEventListener('hashchange', function() {
      var hash = location.hash.replace('#', '');
      if (hash && self._map[hash] && hash !== self.current) {
        self.go(hash);
      }
    });
  }
};
</script>

<!-- ============================================================
     PART B - BLOCK 8: APP CORE
     Data loading, refresh, page controllers registry
     ============================================================ -->
<script>
var App = {

  /* Central data store */
  D: {
    master: [],
    templates: [],
    yajmans: [],
    hisab: [],
    stats: {},
    lastRefresh: 0
  },

  /* Page render controllers - populated by each page module */
  /* PageController = { home: fn, new: fn, ... } */

  /**
   * Initialize app
   */
  init: function() {
    // Setup OTP handlers
    Auth.setupOTPHandlers();

    // Setup navigation history
    Nav.setupHistory();

    // Setup keyboard shortcuts
    this.setupKeyboard();

    // Setup visibility-based refresh
    this.setupAutoRefresh();

    // Check session
    if (Auth.checkSession()) {
      this.enter();
    }
  },

  /**
   * Enter the app (after login)
   */
  enter: function() {
    // Hide auth, show app
    UI.hide('authScreen');
    UI.$('appShell').style.display = 'block';

    // Update header
    var user = API.user || {};
    var displayName = (user.pandit && user.pandit.name) || user.name || 'User';
    UI.text('topUserName', user.name || 'User');
    UI.text('topSubtitle', displayName);

    // Update plan badge
    Subscription.updateBadge();

    // Load all data
    this.loadAll();
  },

  /**
   * Load all data from server
   */
  loadAll: function(silent) {
    var self = this;

    if (!silent) UI.load('Loading data...');
    if (silent) UI.showRefresh('Syncing...');

    Promise.allSettled([
      API.get('getMaster'),
      API.get('getTemplates'),
      API.get('getYajmans'),
      API.get('getStats'),
      API.get('getHisab')
    ]).then(function(results) {

      // Process results safely
      if (results[0].status === 'fulfilled' && Array.isArray(results[0].value)) {
        self.D.master = results[0].value;
      }
      if (results[1].status === 'fulfilled' && Array.isArray(results[1].value)) {
        self.D.templates = results[1].value;
      }
      if (results[2].status === 'fulfilled' && Array.isArray(results[2].value)) {
        self.D.yajmans = results[2].value;
      }
      if (results[3].status === 'fulfilled' && results[3].value) {
        self.D.stats = results[3].value;
      }
      if (results[4].status === 'fulfilled' && Array.isArray(results[4].value)) {
        self.D.hisab = results[4].value;
      }

      self.D.lastRefresh = Date.now();

      if (!silent) UI.unload();
      UI.hideRefresh();

      // Build all pages
      self.buildAllPages();

      // Navigate to current page
      Nav.go(Nav.current);

    }).catch(function(e) {
      console.error('loadAll error:', e);
      if (!silent) UI.unload();
      UI.hideRefresh();

      // Still try to build pages with whatever data we have
      self.buildAllPages();
      Nav.go(Nav.current);
    });
  },

  /**
   * Silent refresh (no loader, just indicator)
   */
  refresh: function() {
    return this.loadAll(true);
  },

  /**
   * Build all page HTML structures
   */
  buildAllPages: function() {
    if (typeof PageBuilder !== 'undefined') {
      var keys = Object.keys(PageBuilder);
      for (var i = 0; i < keys.length; i++) {
        try {
          PageBuilder[keys[i]]();
        } catch(e) {
          console.error('PageBuilder error [' + keys[i] + ']:', e);
        }
      }
    }
  },

  /**
   * Auto-refresh when tab becomes visible
   */
  setupAutoRefresh: function() {
    var self = this;

    // Refresh when tab becomes visible (if data is stale)
    document.addEventListener('visibilitychange', function() {
      if (!document.hidden && API.user) {
        var elapsed = Date.now() - self.D.lastRefresh;
        if (elapsed > CFG.REFRESH_INTERVAL) {
          self.refresh();
        }
      }
    });

    // Periodic refresh
    setInterval(function() {
      if (!document.hidden && API.user) {
        self.refresh();
      }
    }, CFG.REFRESH_INTERVAL);
  },

  /**
   * Keyboard shortcuts
   */
  setupKeyboard: function() {
    document.addEventListener('keydown', function(e) {
      // Enter to login
      if (e.key === 'Enter') {
        var authVisible = UI.$('authScreen') &&
          !UI.$('authScreen').classList.contains('hide');

        if (authVisible) {
          var loginVisible = UI.$('authLogin') &&
            !UI.$('authLogin').classList.contains('hide');
          if (loginVisible) Auth.login();
        }
      }

      // Escape to close modals
      if (e.key === 'Escape') {
        UI.closeAllModals();
      }
    });
  },

  /**
   * Update plan UI throughout the app
   */
  updatePlanUI: function() {
    Subscription.updateBadge();

    // Re-render current page
    Nav.go(Nav.current);
  },

  /* ---- Utility Methods ---- */

  /**
   * Get unique pooja names from master data
   */
  getUniquePoojas: function() {
    var seen = {};
    var result = [];
    for (var i = 0; i < this.D.master.length; i++) {
      var p = (this.D.master[i].pooja || '').trim();
      if (p && !seen[p]) {
        seen[p] = true;
        result.push(p);
      }
    }
    return result.sort();
  },

  /**
   * Get items for a specific pooja
   */
  getItemsForPooja: function(poojaName) {
    var items = [];
    for (var i = 0; i < this.D.master.length; i++) {
      if (this.D.master[i].pooja === poojaName) {
        items.push(this.D.master[i]);
      }
    }
    return items;
  },

  /**
   * Find yajman by ID
   */
  findYajman: function(id) {
    for (var i = 0; i < this.D.yajmans.length; i++) {
      if (this.D.yajmans[i].id === id) return this.D.yajmans[i];
    }
    return null;
  },

  /**
   * Get hisab category info
   */
  getCatInfo: function(type, catId) {
    var cats = (type === 'income') ? CFG.HISAB_CATS.income : CFG.HISAB_CATS.expense;
    for (var i = 0; i < cats.length; i++) {
      if (cats[i].id === catId) return cats[i];
    }
    return {
      id: catId || 'other',
      label: catId || '‡§Ö‡§®‡•ç‡§Ø',
      icon: (type === 'income') ? 'üí∞' : 'üì§'
    };
  },

  /**
   * Reload specific data type and re-render
   */
  reloadAndRender: function(dataType) {
    var self = this;
    var actionMap = {
      master: 'getMaster',
      templates: 'getTemplates',
      yajmans: 'getYajmans',
      hisab: 'getHisab',
      stats: 'getStats'
    };

    var action = actionMap[dataType];
    if (!action) return Promise.resolve();

    return API.get(action).then(function(data) {
      if (Array.isArray(data)) {
        self.D[dataType] = data;
      } else if (data && typeof data === 'object') {
        self.D[dataType] = data;
      }
      // Re-render current page
      Nav.go(Nav.current);
    }).catch(function(e) {
      console.error('Reload ' + dataType + ':', e);
    });
  }
};

/* ---- Page Builder Registry ---- */
/* Each page module will register here */
var PageBuilder = {};

/* ---- Page Controller Registry ---- */
/* Called when navigating to a page */
var PageController = {};

/* ---- Initialize on DOM ready ---- */
document.addEventListener('DOMContentLoaded', function() {
  App.init();
});
</script>

<!-- ============================================================
     PART B - BLOCK 9: PDF ENGINE BASE
     Header/Footer builder, Watermark, Plan checks
     ============================================================ -->
<script>
var PDFEngine = {

  /**
   * Get pandit info for PDF header/footer
   */
  getPanditInfo: function() {
    var user = API.user || {};
    var pandit = user.pandit || {};

    return {
      name:    pandit.name    || user.name    || '',
      title:   pandit.title   || '',
      phone:   pandit.phone   || user.phone   || '',
      address: pandit.address || '',
      website: pandit.website || '',
      tagline: pandit.tagline || '',
      email:   user.email     || '',
      upiId:   pandit.upiId   || '',
      upiName: pandit.upiName || ''
    };
  },

  /**
   * Escape for HTML in PDF
   */
  _e: function(s) {
    return UI.esc(s);
  },

  /**
   * Build PDF Header HTML
   */
  buildHeader: function(extra) {
    var p = this.getPanditInfo();

    var h = '<div style="text-align:center;border-bottom:3px double #E65100;' +
      'padding-bottom:12px;margin-bottom:14px;position:relative;z-index:2">';

    // Decorative mantra
    h += '<div style="font-size:11px;color:#E65100;letter-spacing:6px;' +
      'font-weight:600;margin-bottom:6px">‡•• ‡§∂‡•ç‡§∞‡•Ä ‡§ó‡§£‡•á‡§∂‡§æ‡§Ø ‡§®‡§Æ‡§É ‡••</div>';

    // Pandit name
    if (p.name) {
      h += '<div style="font-size:22px;font-weight:800;color:#E65100;' +
        'line-height:1.2">' + this._e(p.name) + '</div>';
    }

    // Title
    if (p.title) {
      h += '<div style="font-size:11px;color:#666;margin-top:1px">' +
        this._e(p.title) + '</div>';
    }

    // Tagline
    if (p.tagline) {
      h += '<div style="font-size:10px;color:#999;font-style:italic;' +
        'margin-top:2px">„Äå' + this._e(p.tagline) + '„Äç</div>';
    }

    // Contact line
    var contact = [];
    if (p.phone)   contact.push('üìû ' + this._e(p.phone));
    if (p.address) contact.push('üìç ' + this._e(p.address));
    if (p.website) contact.push('üåê ' + this._e(p.website));

    if (contact.length) {
      h += '<div style="font-size:9px;color:#888;margin-top:4px">' +
        contact.join(' | ') + '</div>';
    }

    h += '</div>';

    // Extra content (like pooja name bar)
    if (extra) h += extra;

    return h;
  },

  /**
   * Build PDF Footer HTML
   */
  buildFooter: function(pageNum, totalPages) {
    var p = this.getPanditInfo();
    var isPro = Subscription.isPro();

    var f = '<div style="border-top:3px double #E65100;padding-top:10px;' +
      'margin-top:14px;position:relative;z-index:2">';

    f += '<table style="width:100%;font-size:9px;color:#666"><tr>';
    f += '<td style="vertical-align:top">';

    if (p.name) {
      f += '<div style="font-weight:700;color:#E65100;font-size:11px">' +
        this._e(p.name) + '</div>';
    }
    if (p.title) {
      f += '<div style="color:#888">' + this._e(p.title) + '</div>';
    }

    f += '</td><td style="text-align:right;vertical-align:top">';

    if (p.phone)   f += '<div>üìû ' + this._e(p.phone) + '</div>';
    if (p.address) f += '<div>üìç ' + this._e(p.address) + '</div>';
    if (p.website) f += '<div>üåê ' + this._e(p.website) + '</div>';

    f += '</td></tr></table>';

    // Page number
    if (pageNum) {
      f += '<div style="text-align:center;font-size:8px;color:#999;' +
        'margin-top:6px">Page ' + pageNum +
        (totalPages ? '/' + totalPages : '') + '</div>';
    }

    // Free version branding
    if (!isPro) {
      f += '<div style="text-align:center;margin-top:4px;padding:2px 8px;' +
        'background:rgba(255,111,0,0.06);border-radius:4px;display:inline-block;' +
        'font-size:7px;color:#FF6F00;width:100%">' +
        'Generated by ‡§∂‡•Å‡§≠‡§æ‡§∞‡§Ç‡§≠ - Free Version | Upgrade for no watermark</div>';
    }

    f += '</div>';
    return f;
  },

  /**
   * Add watermark to canvas (for free users)
   */
  addWatermark: function(ctx, width, height) {
    if (!Subscription.shouldWatermark()) return;

    ctx.save();
    ctx.globalAlpha = 0.06;
    ctx.font = 'bold 48px Arial';
    ctx.fillStyle = '#FF6F00';
    ctx.translate(width / 2, height / 2);
    ctx.rotate(-35 * Math.PI / 180);
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('‡§∂‡•Å‡§≠‡§æ‡§∞‡§Ç‡§≠ FREE', 0, -40);
    ctx.fillText('SHUBHARAMBH', 0, 40);
    ctx.restore();
  },

  /**
   * Check if PDF download is allowed (plan limits)
   * Shows upgrade modal if not
   * @returns boolean
   */
  checkPDFAllowed: function() {
    var check = Subscription.canDownloadPDF();
    if (!check.allowed) {
      Subscription.showUpgrade(
        'Daily PDF limit reached (' + check.max + '/day). ' +
        'Upgrade to Pro for unlimited PDFs!'
      );
      return false;
    }
    return true;
  },

  /**
   * Render HTML to canvas and generate PDF
   * Universal method used by all PDF generators
   *
   * @param {HTMLElement} element - The element to render
   * @param {string} filename - Output filename
   * @param {object} opts - { onComplete, orientation }
   */
  generatePDF: function(element, filename, opts) {
    opts = opts || {};

    if (!this.checkPDFAllowed()) return;

    UI.load('Generating PDF...');

    var isPro = Subscription.isPro();

    html2canvas(element, {
      scale: 2.5,
      useCORS: true,
      backgroundColor: '#ffffff',
      logging: false,
      allowTaint: true
    }).then(function(canvas) {

      // Add watermark for free users
      if (!isPro) {
        PDFEngine.addWatermark(
          canvas.getContext('2d'), canvas.width, canvas.height
        );
      }

      var imgData = canvas.toDataURL('image/jpeg', 0.94);
      var orientation = opts.orientation || 'p';
      var pdf = new jspdf.jsPDF(orientation, 'mm', 'a4');

      var pageW = pdf.internal.pageSize.getWidth();
      var pageH = pdf.internal.pageSize.getHeight();
      var margin = 8;
      var imgW = pageW - (margin * 2);
      var imgH = (canvas.height * imgW) / canvas.width;

      if (imgH <= pageH - (margin * 2)) {
        // Single page
        pdf.addImage(imgData, 'JPEG', margin, margin, imgW, imgH);
      } else {
        // Multi-page
        var ratio = imgW / canvas.width;
        var pageImgH = (pageH - (margin * 2)) / ratio;
        var yPos = 0;
        var pageNum = 0;

        while (yPos < canvas.height) {
          if (pageNum > 0) pdf.addPage();

          var sliceH = Math.min(pageImgH, canvas.height - yPos);
          var sliceCanvas = document.createElement('canvas');
          sliceCanvas.width = canvas.width;
          sliceCanvas.height = sliceH;

          var sliceCtx = sliceCanvas.getContext('2d');
          sliceCtx.drawImage(canvas,
            0, yPos, canvas.width, sliceH,
            0, 0, canvas.width, sliceH
          );

          var sliceImg = sliceCanvas.toDataURL('image/jpeg', 0.94);
          pdf.addImage(sliceImg, 'JPEG',
            margin, margin, imgW, sliceH * ratio
          );

          yPos += sliceH;
          pageNum++;
        }
      }

      // Save PDF
      pdf.save(filename);

      // Record usage
      Subscription.recordPDFDownload();

      UI.unload();
      UI.toast('Downloaded!', 'PDF saved successfully', 'ok');

      if (opts.onComplete) opts.onComplete();

    }).catch(function(e) {
      UI.unload();
      UI.toast('Error', 'PDF generation failed: ' + e.message, 'error');
    });
  },

  /**
   * Generate image download
   */
  generateImage: function(element, filename, opts) {
    opts = opts || {};

    if (!Subscription.isPro()) {
      Subscription.showUpgrade('Image download is a Pro feature. Upgrade now!');
      return;
    }

    UI.load('Generating image...');

    html2canvas(element, {
      scale: 2.5,
      useCORS: true,
      backgroundColor: '#ffffff',
      logging: false
    }).then(function(canvas) {
      canvas.toBlob(function(blob) {
        if (!blob) {
          UI.unload();
          UI.toast('Error', 'Image generation failed', 'error');
          return;
        }

        // Mobile-friendly download
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = filename || 'download.png';

        // For mobile browsers
        if (/Android|iPhone|iPad/i.test(navigator.userAgent)) {
          // Try opening in new tab for mobile
          a.target = '_blank';
        }

        document.body.appendChild(a);
        a.click();

        setTimeout(function() {
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }, 1000);

        UI.unload();
        UI.toast('Downloaded!', 'Image saved', 'ok');

        if (opts.onComplete) opts.onComplete();
      }, 'image/png');

    }).catch(function(e) {
      UI.unload();
      UI.toast('Error', 'Image failed: ' + e.message, 'error');
    });
  },

  /**
   * Generate multi-page images as ZIP
   */
  generateZIP: function(elements, baseFilename, opts) {
    opts = opts || {};

    if (!Subscription.isPro()) {
      Subscription.showUpgrade('ZIP download is a Pro feature!');
      return;
    }

    if (!window.JSZip) {
      UI.toast('Error', 'ZIP library not loaded', 'error');
      return;
    }

    UI.load('Generating ZIP (0/' + elements.length + ')...');

    var zip = new JSZip();
    var imgFolder = zip.folder('images');
    var completed = 0;
    var total = elements.length;

    function processElement(idx) {
      if (idx >= total) {
        // All done, generate ZIP
        UI.load('Creating ZIP file...');
        zip.generateAsync({ type: 'blob' }).then(function(blob) {
          var url = URL.createObjectURL(blob);
          var a = document.createElement('a');
          a.href = url;
          a.download = (baseFilename || 'images') + '.zip';

          if (/Android|iPhone|iPad/i.test(navigator.userAgent)) {
            a.target = '_blank';
          }

          document.body.appendChild(a);
          a.click();

          setTimeout(function() {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          }, 1000);

          UI.unload();
          UI.toast('Downloaded!', total + ' images in ZIP', 'ok');

          if (opts.onComplete) opts.onComplete();
        }).catch(function(e) {
          UI.unload();
          UI.toast('Error', 'ZIP failed: ' + e.message, 'error');
        });
        return;
      }

      UI.text('loaderMsg',
        'Generating image ' + (idx + 1) + '/' + total + '...');

      html2canvas(elements[idx], {
        scale: 2,
        useCORS: true,
        backgroundColor: '#ffffff',
        logging: false
      }).then(function(canvas) {
        return new Promise(function(resolve) {
          canvas.toBlob(function(blob) {
            if (blob) {
              imgFolder.file(
                'page_' + String(idx + 1).padStart(2, '0') + '.png',
                blob
              );
            }
            completed++;
            resolve();
          }, 'image/png');
        });
      }).then(function() {
        // Process next
        processElement(idx + 1);
      }).catch(function(e) {
        console.error('ZIP image ' + idx + ':', e);
        processElement(idx + 1);
      });
    }

    processElement(0);
  }
};
</script>
<!-- ============================================================
     PART C - BLOCK 1: HOME PAGE BUILDER
     Dashboard with stats, overview, quick actions,
     pending dues, recent activity
     ============================================================ -->
<script>
PageBuilder.home = function() {
  var u = API.user || {};
  var pName = (u.pandit && u.pandit.name) || u.name || '';
  var hour = new Date().getHours();
  var greet = hour < 12 ? 'üåÖ ‡§∏‡•Å‡§™‡•ç‡§∞‡§≠‡§æ‡§§' :
              hour < 17 ? 'üåû ‡§®‡§Æ‡§∏‡•ç‡§ï‡§æ‡§∞' : 'üåô ‡§∂‡•Å‡§≠ ‡§∏‡§Ç‡§ß‡•ç‡§Ø‡§æ';

  UI.html('pgHome',

    /* ---- Page Header ---- */
    '<div class="page-header">' +
      '<h2 class="page-title">üè† Dashboard</h2>' +
      '<p class="page-subtitle" id="homeGreet">' +
        greet + ', ' + UI.esc(pName || u.name || 'User') + ' üôè</p>' +
    '</div>' +

    /* ---- Refresh Indicator Area ---- */
    '<div id="homeRefreshArea"></div>' +

    /* ---- Stats Grid ---- */
    '<div class="stats-grid" id="homeStats">' +
      HomeUI.statCard('homeStatYaj', 'üë•', '0', 'Yajmans', "Nav.go('profile')") +
      HomeUI.statCard('homeStatPooja', 'üïâÔ∏è', '0', 'Poojas', "Nav.go('profile')") +
      HomeUI.statCard('homeStatTpl', 'üìÑ', '0', 'Templates', "Nav.go('library')") +
      HomeUI.statCard('homeStatMonth', 'üí∞', '‚Çπ0', 'This Month', "Nav.go('hisab')") +
    '</div>' +

    /* ---- Monthly Overview ---- */
    '<div class="card" id="homeOverviewCard">' +
      '<div class="card-header">' +
        '<h3 class="card-title">üìä Monthly Overview</h3>' +
        '<span class="badge badge-brand" id="homeMonthLabel"></span>' +
      '</div>' +
      '<div class="summary-grid" id="homeOverview" style="margin-bottom:0">' +
        '<div class="summary-card type-income">' +
          '<div class="summary-value green" id="homeMonInc">‚Çπ0</div>' +
          '<div class="summary-label">Income</div></div>' +
        '<div class="summary-card type-expense">' +
          '<div class="summary-value red" id="homeMonExp">‚Çπ0</div>' +
          '<div class="summary-label">Expense</div></div>' +
        '<div class="summary-card type-pending">' +
          '<div class="summary-value yellow" id="homeMonPend">‚Çπ0</div>' +
          '<div class="summary-label">Pending</div></div>' +
        '<div class="summary-card type-profit">' +
          '<div class="summary-value orange" id="homeMonProfit">‚Çπ0</div>' +
          '<div class="summary-label">Profit</div></div>' +
      '</div>' +
    '</div>' +

    /* ---- Quick Actions ---- */
    '<div class="card">' +
      '<div class="card-header">' +
        '<h3 class="card-title">‚ö° Quick Actions</h3>' +
      '</div>' +
      '<div class="quick-actions">' +
        '<button class="btn btn-primary btn-sm" onclick="Nav.go(\'new\')">' +
          '‚ûï New Pooja</button>' +
        '<button class="btn btn-ghost btn-sm" onclick="HomeUI.quickAddYajman()">' +
          'üë• Add Yajman</button>' +
        '<button class="btn btn-ghost btn-sm" onclick="Nav.go(\'hisab\')">' +
          'üí∞ Hisab</button>' +
        '<button class="btn btn-ghost btn-sm" onclick="HomeUI.quickAddDB()">' +
          'üóÑÔ∏è Database</button>' +
        '<button class="btn btn-ghost btn-sm" onclick="Subscription.showUpgrade()">' +
          '‚≠ê Upgrade</button>' +
        '<button class="btn btn-ghost btn-sm" onclick="App.refresh()">' +
          'üîÑ Refresh</button>' +
      '</div>' +
    '</div>' +

    /* ---- Pending Dues ---- */
    '<div class="card" id="homePendingCard" style="display:none">' +
      '<div class="card-header">' +
        '<h3 class="card-title">‚ö†Ô∏è Pending Dues</h3>' +
        '<button class="btn btn-xs btn-ghost" ' +
          'onclick="Nav.go(\'hisab\')">View All ‚Üí</button>' +
      '</div>' +
      '<div id="homePendingList"></div>' +
    '</div>' +

    /* ---- Recent Yajmans ---- */
    '<div class="card">' +
      '<div class="card-header">' +
        '<h3 class="card-title">üë• Recent Yajmans</h3>' +
        '<div class="card-actions">' +
          '<button class="btn btn-xs btn-ghost" ' +
            'onclick="HomeUI.quickAddYajman()">‚ûï Add</button>' +
          '<button class="btn btn-xs btn-ghost" ' +
            'onclick="HomeUI.showAllYajmans()">View All ‚Üí</button>' +
        '</div>' +
      '</div>' +
      '<div id="homeRecentYaj"></div>' +
    '</div>' +

    /* ---- Recent Templates ---- */
    '<div class="card">' +
      '<div class="card-header">' +
        '<h3 class="card-title">üìÑ Recent Templates</h3>' +
        '<button class="btn btn-xs btn-ghost" ' +
          'onclick="Nav.go(\'library\')">View All ‚Üí</button>' +
      '</div>' +
      '<div id="homeRecentTpl"></div>' +
    '</div>' +

    /* ---- Plan Status ---- */
    '<div class="card" id="homePlanCard">' +
      '<div style="display:flex;align-items:center;justify-content:space-between;' +
        'flex-wrap:wrap;gap:var(--sp-sm)">' +
        '<div>' +
          '<div style="font-size:.85rem;font-weight:700;color:var(--text-primary)">' +
            'üìã Your Plan</div>' +
          '<div style="font-size:.7rem;color:var(--text-muted)" id="homePlanInfo">' +
            'Loading...</div>' +
        '</div>' +
        '<button class="btn btn-xs btn-primary" ' +
          'onclick="Subscription.showUpgrade()" id="homePlanBtn">' +
          '‚≠ê Upgrade</button>' +
      '</div>' +
    '</div>'
  );
};

/* ---- Home Page Controller ---- */
PageController.home = function() {
  HomeUI.updateStats();
  HomeUI.updateOverview();
  HomeUI.updatePending();
  HomeUI.updateRecentYajmans();
  HomeUI.updateRecentTemplates();
  HomeUI.updatePlanCard();
  HomeUI.updateMonthLabel();
};
</script>

<!-- ============================================================
     PART C - BLOCK 2: HOME PAGE UI LOGIC
     All home page dynamic updates
     ============================================================ -->
<script>
var HomeUI = {

  /* Helper: Build stat card HTML */
  statCard: function(id, icon, value, label, onclick) {
    return '<div class="stat-card" onclick="' + (onclick || '') + '">' +
      '<div class="stat-icon">' + icon + '</div>' +
      '<div class="stat-value" id="' + id + '">' + value + '</div>' +
      '<div class="stat-label">' + label + '</div>' +
    '</div>';
  },

  /* Update stat numbers */
  updateStats: function() {
    var yajmans = App.D.yajmans || [];
    var poojas = App.getUniquePoojas();
    var templates = App.D.templates || [];
    var hisab = App.D.hisab || [];

    UI.text('homeStatYaj', String(yajmans.length));
    UI.text('homeStatPooja', String(poojas.length));
    UI.text('homeStatTpl', String(templates.length));

    // This month income
    var now = new Date();
    var thisM = now.getMonth();
    var thisY = now.getFullYear();
    var monthIncome = 0;

    for (var i = 0; i < hisab.length; i++) {
      try {
        var dt = new Date(hisab[i].date);
        if (!isNaN(dt.getTime()) &&
            dt.getMonth() === thisM &&
            dt.getFullYear() === thisY &&
            hisab[i].type === 'income') {
          monthIncome += parseFloat(hisab[i].amount) || 0;
        }
      } catch(e) {}
    }

    UI.text('homeStatMonth', UI.formatMoney(monthIncome));
  },

  /* Update month label */
  updateMonthLabel: function() {
    var months = ['Jan','Feb','Mar','Apr','May','Jun',
                  'Jul','Aug','Sep','Oct','Nov','Dec'];
    var now = new Date();
    var el = UI.$('homeMonthLabel');
    if (el) el.textContent = months[now.getMonth()] + ' ' + now.getFullYear();
  },

  /* Update monthly overview */
  updateOverview: function() {
    var hisab = App.D.hisab || [];
    var now = new Date();
    var thisM = now.getMonth();
    var thisY = now.getFullYear();
    var mI = 0, mE = 0, mP = 0;

    for (var i = 0; i < hisab.length; i++) {
      var h = hisab[i];
      try {
        var dt = new Date(h.date);
        if (isNaN(dt.getTime())) continue;
        if (dt.getMonth() !== thisM || dt.getFullYear() !== thisY) continue;

        var amt = parseFloat(h.amount) || 0;
        if (h.type === 'income') {
          mI += amt;
          mP += parseFloat(h.pendingAmount) || 0;
        } else {
          mE += amt;
        }
      } catch(e) {}
    }

    UI.text('homeMonInc', UI.formatMoney(mI));
    UI.text('homeMonExp', UI.formatMoney(mE));
    UI.text('homeMonPend', UI.formatMoney(mP));
    UI.text('homeMonProfit', UI.formatMoney(mI - mE));

    // Color profit
    var profEl = UI.$('homeMonProfit');
    if (profEl) {
      profEl.className = 'summary-value ' + ((mI - mE) >= 0 ? 'green' : 'red');
    }
  },

  /* Update pending dues */
  updatePending: function() {
    var hisab = App.D.hisab || [];
    var pending = [];

    for (var i = 0; i < hisab.length; i++) {
      var h = hisab[i];
      var pend = parseFloat(h.pendingAmount) || 0;
      if (pend > 0 && h.type === 'income') {
        pending.push(h);
      }
    }

    var card = UI.$('homePendingCard');
    var list = UI.$('homePendingList');
    if (!card || !list) return;

    if (!pending.length) {
      card.style.display = 'none';
      return;
    }

    card.style.display = 'block';

    // Sort by amount (highest first)
    pending.sort(function(a, b) {
      return (parseFloat(b.pendingAmount) || 0) - (parseFloat(a.pendingAmount) || 0);
    });

    var html = '';
    var max = Math.min(pending.length, 5);

    for (var j = 0; j < max; j++) {
      var p = pending[j];
      html += '<div class="list-row">' +
        '<div class="list-row-icon" style="background:var(--warning-bg)">‚ö†Ô∏è</div>' +
        '<div class="list-row-body">' +
          '<div class="list-row-title">' +
            UI.esc(p.yajmanName || p.poojaName || 'Unknown') + '</div>' +
          '<div class="list-row-meta">' +
            UI.formatDate(p.date) +
            (p.poojaName ? ' ‚Ä¢ üïâÔ∏è ' + UI.esc(p.poojaName) : '') +
          '</div>' +
        '</div>' +
        '<div class="list-row-right">' +
          '<div style="font-weight:800;color:#FFD740;font-size:.9rem">' +
            UI.formatMoney(p.pendingAmount) + '</div>' +
          '<div style="font-size:.6rem;color:var(--text-muted)">pending</div>' +
        '</div>' +
      '</div>';
    }

    if (pending.length > max) {
      html += '<div style="text-align:center;padding:var(--sp-sm);' +
        'font-size:.72rem;color:var(--text-muted)">' +
        '+' + (pending.length - max) + ' more pending</div>';
    }

    list.innerHTML = html;
  },

  /* Update recent yajmans */
  updateRecentYajmans: function() {
    var el = UI.$('homeRecentYaj');
    if (!el) return;

    var yajmans = (App.D.yajmans || []).slice();

    if (!yajmans.length) {
      el.innerHTML = '<div class="empty-state">' +
        '<div class="empty-state-icon">üë•</div>' +
        '<div class="empty-state-text">No yajmans yet</div>' +
        '<button class="btn btn-sm btn-primary" ' +
          'onclick="HomeUI.quickAddYajman()">‚ûï Add First Yajman</button>' +
      '</div>';
      return;
    }

    // Show last 5 (newest first)
    var recent = yajmans.slice(-5).reverse();
    var html = '';

    for (var i = 0; i < recent.length; i++) {
      var y = recent[i];
      var statusBadge = y.status === 'inactive' ? 'badge-error' : 'badge-success';

      html += '<div class="list-row" style="cursor:pointer" ' +
        'onclick="HomeUI.showYajmanDetail(\'' + y.id + '\')">' +
        '<div class="list-row-icon" style="background:var(--grad-brand)">üë§</div>' +
        '<div class="list-row-body">' +
          '<div class="list-row-title">' + UI.esc(y.name) +
            ' <span class="badge ' + statusBadge + '">' +
            (y.status || 'active') + '</span></div>' +
          '<div class="list-row-meta">' +
            (y.phone ? 'üìû ' + String(y.phone) : '') +
            (y.city ? ' ‚Ä¢ üìç ' + UI.esc(y.city) : '') +
          '</div>' +
        '</div>' +
        '<div class="list-row-right">' +
          '<div style="font-weight:700;color:var(--text-brand)">' +
            UI.formatMoney(y.totalAmount) + '</div>' +
          '<div style="font-size:.6rem;color:var(--text-muted)">' +
            (y.totalPoojas || 0) + ' poojas</div>' +
        '</div>' +
      '</div>';
    }

    el.innerHTML = html;
  },

  /* Update recent templates */
  updateRecentTemplates: function() {
    var el = UI.$('homeRecentTpl');
    if (!el) return;

    var templates = App.D.templates || [];

    if (!templates.length) {
      el.innerHTML = '<div class="empty-state">' +
        '<div class="empty-state-icon">üìÑ</div>' +
        '<div class="empty-state-text">No templates saved yet</div>' +
        '<div class="empty-state-hint">Create from ‚ûï New tab and save to cloud</div>' +
      '</div>';
      return;
    }

    var recent = templates.slice(-3).reverse();
    var html = '';

    for (var i = 0; i < recent.length; i++) {
      var t = recent[i];
      var poojaList = (t.poojas || '').split(',');
      var poojaCount = 0;
      for (var p = 0; p < poojaList.length; p++) {
        if (poojaList[p].trim()) poojaCount++;
      }

      html += '<div class="list-row" style="cursor:pointer" ' +
        'onclick="HomeUI.openTemplate(\'' + t.id + '\')">' +
        '<div class="list-row-icon" style="background:rgba(255,111,0,0.1)">üìÑ</div>' +
        '<div class="list-row-body">' +
          '<div class="list-row-title">' + UI.esc(t.name) + '</div>' +
          '<div class="list-row-meta">' +
            'üìÖ ' + UI.formatDate(t.date) +
            ' ‚Ä¢ üïâÔ∏è ' + poojaCount + ' pooja' +
            (poojaCount !== 1 ? 's' : '') +
          '</div>' +
        '</div>' +
        '<div class="list-row-actions">' +
          '<button class="btn btn-xs btn-primary" ' +
            'onclick="event.stopPropagation();HomeUI.openTemplate(\'' + t.id + '\')">' +
            'üìÇ</button>' +
        '</div>' +
      '</div>';
    }

    el.innerHTML = html;
  },

  /* Update plan card */
  updatePlanCard: function() {
    var isPro = Subscription.isPro();
    var pdfInfo = Subscription.canDownloadPDF();
    var infoEl = UI.$('homePlanInfo');
    var btnEl = UI.$('homePlanBtn');

    if (infoEl) {
      if (isPro) {
        infoEl.innerHTML = '‚≠ê <strong style="color:var(--success)">PRO</strong>' +
          ' ‚Ä¢ Unlimited PDFs ‚Ä¢ No Watermark';
      } else {
        infoEl.innerHTML = 'üÜì Free Plan ‚Ä¢ PDFs today: ' +
          '<strong style="color:' +
          (pdfInfo.remaining > 0 ? 'var(--success)' : 'var(--error)') + '">' +
          pdfInfo.used + '/' + pdfInfo.max + '</strong>' +
          ' ‚Ä¢ Watermark on PDF';
      }
    }

    if (btnEl) {
      if (isPro) {
        btnEl.textContent = '‚úÖ Pro Active';
        btnEl.className = 'btn btn-xs btn-success';
        btnEl.onclick = function() {
          UI.toast('Pro Active', 'You are on Pro plan! üéâ', 'ok');
        };
      }
    }
  },

  /* ---- Quick Actions from Home ---- */

  quickAddYajman: function() {
    if (typeof YajmanUI !== 'undefined' && YajmanUI.showAddModal) {
      YajmanUI.showAddModal();
    } else {
      Nav.go('profile');
      UI.toast('Navigate', 'Yajman management in Profile', 'info');
    }
  },

  quickAddDB: function() {
    if (typeof DBPage !== 'undefined' && DBPage.showAdd) {
      DBPage.showAdd();
    } else {
      Nav.go('profile');
    }
  },

  showYajmanDetail: function(id) {
    if (typeof YajmanUI !== 'undefined' && YajmanUI.showDetail) {
      YajmanUI.showDetail(id);
    }
  },

  showAllYajmans: function() {
    if (typeof YajmanUI !== 'undefined') {
      YajmanUI.showListModal();
    }
  },

  openTemplate: function(id) {
    if (typeof LibUI !== 'undefined' && LibUI.load) {
      LibUI.load(id);
    } else {
      Nav.go('library');
    }
  }
};
</script>

<!-- ============================================================
     PART C - BLOCK 3: PROFILE PAGE BUILDER
     Profile, Pandit details, Yajman Management,
     Database, Password, Settings, Backup
     ============================================================ -->
<script>
PageBuilder.profile = function() {
  var u = API.user || {};
  var p = u.pandit || {};
  var isPro = Subscription.isPro();

  UI.html('pgProfile',

    /* ---- Page Header ---- */
    '<div class="page-header">' +
      '<h2 class="page-title">üë§ Profile & Settings</h2>' +
      '<p class="page-subtitle">Manage everything</p>' +
    '</div>' +

    /* ---- User Card ---- */
    '<div class="card" style="text-align:center">' +
      '<div style="width:64px;height:64px;border-radius:50%;' +
        'background:var(--grad-brand);display:grid;place-items:center;' +
        'font-size:1.8rem;margin:0 auto var(--sp-sm)">üôè</div>' +
      '<h3 style="color:var(--text-primary);font-size:1.1rem">' +
        UI.esc(u.name || '') + '</h3>' +
      '<p style="color:var(--text-muted);font-size:.78rem">' +
        UI.esc(u.email || '') + '</p>' +
      '<div style="margin-top:var(--sp-sm)">' +
        '<span class="badge ' + (isPro ? 'badge-success' : 'badge-warning') + '">' +
          (isPro ? '‚≠ê PRO' : 'üÜì FREE') + '</span>' +
      '</div>' +
      (!isPro ? '<button class="btn btn-xs btn-primary" ' +
        'onclick="Subscription.showUpgrade()" ' +
        'style="margin-top:var(--sp-sm)">‚≠ê Upgrade to Pro</button>' : '') +
    '</div>' +

    /* ---- Menu-Based Settings ---- */
    '<div class="card">' +
      '<div class="card-header">' +
        '<h3 class="card-title">‚öôÔ∏è Settings</h3>' +
      '</div>' +
      
      /* Menu Item: Pandit Details */
      '<div class="menu-item" onclick="ProfileUI.showPanditDetails()" ' +
        'style="display:flex;align-items:center;padding:var(--sp-md);' +
        'border-bottom:1px solid var(--border);cursor:pointer;' +
        'transition:background .15s ease" ' +
        'onmouseover="this.style.background=\'rgba(255,255,255,0.02)\'" ' +
        'onmouseout="this.style.background=\'transparent\'">' +
        '<div style="width:36px;height:36px;border-radius:8px;' +
          'background:rgba(255,111,0,0.1);display:grid;place-items:center;' +
          'margin-right:var(--sp-md);flex-shrink:0">üôè</div>' +
        '<div style="flex:1">' +
          '<div style="font-weight:600;color:var(--text-primary);font-size:.88rem">' +
            'Pandit Details</div>' +
          '<div style="color:var(--text-muted);font-size:.72rem">' +
            'PDF header/footer info</div>' +
        '</div>' +
        '<div style="color:var(--text-muted);font-size:1.1rem">‚Ä∫</div>' +
      '</div>' +
      
      /* Menu Item: Change Password */
      '<div class="menu-item" onclick="ProfileUI.showChangePassword()" ' +
        'style="display:flex;align-items:center;padding:var(--sp-md);' +
        'border-bottom:1px solid var(--border);cursor:pointer;' +
        'transition:background .15s ease" ' +
        'onmouseover="this.style.background=\'rgba(255,255,255,0.02)\'" ' +
        'onmouseout="this.style.background=\'transparent\'">' +
        '<div style="width:36px;height:36px;border-radius:8px;' +
          'background:rgba(41,121,255,0.1);display:grid;place-items:center;' +
          'margin-right:var(--sp-md);flex-shrink:0">üîê</div>' +
        '<div style="flex:1">' +
          '<div style="font-weight:600;color:var(--text-primary);font-size:.88rem">' +
            'Change Password</div>' +
          '<div style="color:var(--text-muted);font-size:.72rem">' +
            'Update your security</div>' +
        '</div>' +
        '<div style="color:var(--text-muted);font-size:1.1rem">‚Ä∫</div>' +
      '</div>' +
      
      /* Menu Item: Yajman Management */
      '<div class="menu-item" onclick="ProfileUI.showYajmanManagement()" ' +
        'style="display:flex;align-items:center;padding:var(--sp-md);' +
        'border-bottom:1px solid var(--border);cursor:pointer;' +
        'transition:background .15s ease" ' +
        'onmouseover="this.style.background=\'rgba(255,255,255,0.02)\'" ' +
        'onmouseout="this.style.background=\'transparent\'">' +
        '<div style="width:36px;height:36px;border-radius:8px;' +
          'background:rgba(0,200,83,0.1);display:grid;place-items:center;' +
          'margin-right:var(--sp-md);flex-shrink:0">üë•</div>' +
        '<div style="flex:1">' +
          '<div style="font-weight:600;color:var(--text-primary);font-size:.88rem">' +
            'Yajman Management</div>' +
          '<div style="color:var(--text-muted);font-size:.72rem">' +
            'Manage your clients</div>' +
        '</div>' +
        '<div style="color:var(--text-muted);font-size:1.1rem">‚Ä∫</div>' +
      '</div>' +
      
      /* Menu Item: Pooja Database */
      '<div class="menu-item" onclick="ProfileUI.showDatabase()" ' +
        'style="display:flex;align-items:center;padding:var(--sp-md);' +
        'cursor:pointer;transition:background .15s ease" ' +
        'onmouseover="this.style.background=\'rgba(255,255,255,0.02)\'" ' +
        'onmouseout="this.style.background=\'transparent\'">' +
        '<div style="width:36px;height:36px;border-radius:8px;' +
          'background:rgba(218,165,32,0.1);display:grid;place-items:center;' +
          'margin-right:var(--sp-md);flex-shrink:0">üóÑÔ∏è</div>' +
        '<div style="flex:1">' +
          '<div style="font-weight:600;color:var(--text-primary);font-size:.88rem">' +
            'Pooja Database</div>' +
          '<div style="color:var(--text-muted);font-size:.72rem">' +
            'Manage samagri items</div>' +
        '</div>' +
        '<div style="color:var(--text-muted);font-size:1.1rem">‚Ä∫</div>' +
      '</div>' +
    '</div>' +

    /* Content Area for Menu Items */
    '<div id="prMenuContent"></div>' +

    /* ---- Backup & Logout ---- */
    '<div class="card">' +
      '<div style="display:grid;gap:var(--sp-sm)">' +
        '<button class="btn btn-ghost btn-w" onclick="ProfileUI.backup()">' +
          'üíæ Download Backup (JSON)</button>' +
        '<button class="btn btn-ghost btn-w" onclick="App.refresh()">' +
          'üîÑ Refresh All Data</button>' +
        '<button class="btn btn-danger btn-w" onclick="Auth.logout()">' +
          'üö™ Logout</button>' +
      '</div>' +
    '</div>' +

    /* ---- App Info ---- */
    '<div style="text-align:center;padding:var(--sp-lg);' +
      'color:var(--text-muted);font-size:.68rem">' +
      CFG.APP_NAME + ' v' + CFG.VER + '<br>' +
      'Made with üôè for Pandits' +
    '</div>'
  );
};

/* Profile Page Controller */
PageController.profile = function() {
  YajmanUI.renderList();
  YajmanUI.updateStats();
  DBPage.render();
};
</script>

<!-- ============================================================
     PART C - BLOCK 4: PROFILE UI LOGIC
     Save, preview, password, backup
     ============================================================ -->
<script>
var ProfileUI = {

  scrollTo: function(id) {
    var el = UI.$(id);
    if (el) {
      el.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  },

  /* Save pandit profile */
  savePandit: function() {
    UI.load('Saving profile...');

    var data = {
      action: 'updateProfile',
      panditName:    UI.val('prPanditName'),
      panditTitle:   UI.val('prPanditTitle'),
      panditPhone:   UI.val('prPanditPhone'),
      panditWebsite: UI.val('prPanditWeb'),
      panditAddress: UI.val('prPanditAddr'),
      panditTagline: UI.val('prPanditTag'),
      upiId:         UI.val('prPanditUPI'),
      upiName:       UI.val('prPanditUPIName')
    };

    API.post(data).then(function(r) {
      // Update local data
      if (API.user) {
        API.user.pandit = {
          name:    UI.val('prPanditName'),
          title:   UI.val('prPanditTitle'),
          phone:   UI.val('prPanditPhone'),
          website: UI.val('prPanditWeb'),
          address: UI.val('prPanditAddr'),
          tagline: UI.val('prPanditTag'),
          upiId:   UI.val('prPanditUPI'),
          upiName: UI.val('prPanditUPIName')
        };
        localStorage.setItem(CFG.SESSION_KEY, JSON.stringify(API.user));

        // Update topbar
        UI.text('topSubtitle', API.user.pandit.name || API.user.name || '');
      }

      UI.unload();
      UI.toast('Saved!', 'Pandit profile updated', 'ok');
    }).catch(function(e) {
      UI.unload();
      UI.toast('Error', e.message, 'error');
    });
  },

  /* Preview PDF header/footer */
  previewPDF: function() {
    var el = UI.$('prPDFPreview');
    if (!el) return;

    // Temporarily update pandit info for preview
    var tempPandit = {
      name:    UI.val('prPanditName'),
      title:   UI.val('prPanditTitle'),
      phone:   UI.val('prPanditPhone'),
      website: UI.val('prPanditWeb'),
      address: UI.val('prPanditAddr'),
      tagline: UI.val('prPanditTag')
    };

    var origPandit = API.user ? API.user.pandit : null;
    if (API.user) API.user.pandit = tempPandit;

    var isPro = Subscription.isPro();

    var preview = '';

    // Header preview
    preview += '<div style="background:#fff;border-radius:var(--r-md);' +
      'padding:var(--sp-md);margin-bottom:var(--sp-sm);' +
      'border:2px solid var(--brand)">';
    preview += '<div style="font-size:.55rem;color:var(--text-muted);' +
      'margin-bottom:4px">üìÑ HEADER PREVIEW</div>';
    preview += '<div style="text-align:center;border-bottom:3px double #E65100;' +
      'padding-bottom:8px;color:#000">';
    preview += '<div style="font-size:10px;color:#E65100;letter-spacing:3px">' +
      '‡•• ‡§∂‡•ç‡§∞‡•Ä ‡§ó‡§£‡•á‡§∂‡§æ‡§Ø ‡§®‡§Æ‡§É ‡••</div>';
    preview += '<div style="font-size:1.1rem;font-weight:800;color:#E65100">' +
      (UI.val('prPanditName') || 'Your Name') + '</div>';

    if (UI.val('prPanditTitle')) {
      preview += '<div style="font-size:.7rem;color:#666">' +
        UI.esc(UI.val('prPanditTitle')) + '</div>';
    }
    if (UI.val('prPanditTag')) {
      preview += '<div style="font-size:.6rem;color:#999;font-style:italic">' +
        UI.esc(UI.val('prPanditTag')) + '</div>';
    }

    var contacts = [];
    if (UI.val('prPanditPhone')) contacts.push('üìû ' + UI.val('prPanditPhone'));
    if (UI.val('prPanditWeb'))   contacts.push('üåê ' + UI.val('prPanditWeb'));
    if (contacts.length) {
      preview += '<div style="font-size:.55rem;color:#888;margin-top:3px">' +
        contacts.join(' | ') + '</div>';
    }

    preview += '</div></div>';

    // Footer preview
    preview += '<div style="background:#fff;border-radius:var(--r-md);' +
      'padding:var(--sp-md);border:2px solid var(--brand)">';
    preview += '<div style="font-size:.55rem;color:var(--text-muted);' +
      'margin-bottom:4px">üìÑ FOOTER PREVIEW</div>';
    preview += '<div style="border-top:2px solid #E65100;padding-top:6px;' +
      'text-align:center;color:#000">';
    preview += '<div style="font-size:.7rem;color:#555;font-weight:600">' +
      (UI.val('prPanditName') || 'Name') + '</div>';

    if (UI.val('prPanditAddr')) {
      preview += '<div style="font-size:.55rem;color:#888">üìç ' +
        UI.esc(UI.val('prPanditAddr')) + '</div>';
    }

    preview += '</div>';

    if (!isPro) {
      preview += '<div style="margin-top:6px;padding:3px;' +
        'background:rgba(255,111,0,0.08);border-radius:4px;' +
        'font-size:.55rem;color:var(--brand);font-weight:600;text-align:center">' +
        '‚ö†Ô∏è FREE: Watermark will appear on PDF</div>';
    } else {
      preview += '<div style="margin-top:6px;font-size:.55rem;' +
        'color:var(--success);text-align:center">‚úÖ Pro: Clean PDF, no watermark</div>';
    }

    preview += '</div>';

    el.innerHTML = preview;

    // Restore
    if (API.user) API.user.pandit = origPandit;
  },

  /* Change password */
  changePassword: function() {
    var cur = UI.val('prCurPass');
    var np  = UI.val('prNewPass');
    var np2 = UI.val('prConfirmPass');

    if (!cur) { UI.toast('Required', 'Enter current password', 'warn'); return; }
    if (!np || np.length < 6) {
      UI.toast('Weak', 'Min 6 characters', 'warn'); return;
    }
    if (np !== np2) {
      UI.toast('Mismatch', 'Passwords don\'t match', 'warn'); return;
    }

    UI.load('Changing password...');

    API.post({
      action: 'changePassword',
      currentPassword: cur,
      newPassword: np
    }).then(function(r) {
      UI.unload();
      if (r.error) {
        UI.toast('Error', r.error, 'error');
        return;
      }
      UI.toast('Done!', 'Password changed successfully', 'ok');
      UI.setVal('prCurPass', '');
      UI.setVal('prNewPass', '');
      UI.setVal('prConfirmPass', '');
    }).catch(function(e) {
      UI.unload();
      UI.toast('Error', e.message, 'error');
    });
  },

  /* Backup data */
  backup: function() {
    try {
      var data = {
        exportDate: new Date().toISOString(),
        version: CFG.VER,
        app: CFG.APP_NAME,
        user: {
          name: (API.user && API.user.name) || '',
          email: (API.user && API.user.email) || ''
        },
        data: {
          master: App.D.master || [],
          templates: App.D.templates || [],
          yajmans: App.D.yajmans || [],
          hisab: App.D.hisab || []
        }
      };

      var json = JSON.stringify(data, null, 2);
      var blob = new Blob([json], { type: 'application/json' });
      var url = URL.createObjectURL(blob);

      var a = document.createElement('a');
      a.href = url;
      a.download = CFG.APP_NAME + '_Backup_' + UI.today() + '.json';

      // Mobile-friendly
      if (/Android|iPhone|iPad/i.test(navigator.userAgent)) {
        a.target = '_blank';
      }

      document.body.appendChild(a);
      a.click();

      setTimeout(function() {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 1000);

      UI.toast('Exported!', 'Backup file downloaded', 'ok');
    } catch(e) {
      UI.toast('Error', e.message, 'error');
    }
  },

  /* ===== NEW MENU-BASED FUNCTIONS ===== */

  showPanditDetails: function() {
    var u = API.user || {};
    var p = u.pandit || {};
    
    var content = '<div class="card">' +
      '<div class="card-header">' +
        '<h3 class="card-title">üôè Pandit Profile</h3>' +
      '</div>' +
      '<div class="info-banner">' +
        'üìå This information appears on your PDF header and footer. ' +
        'Fill it completely for professional-looking PDFs.' +
      '</div>' +
      '<div class="form-group">' +
        '<label class="form-label">Name (PDF ‡§Æ‡•á‡§Ç ‡§®‡§æ‡§Æ)</label>' +
        '<input class="form-input" id="prPanditName" ' +
          'value="' + UI.esc(p.name || u.name || '') + '" ' +
          'placeholder="‡§™‡§Ç‡§°‡§ø‡§§ ‡§ú‡•Ä ‡§ï‡§æ ‡§®‡§æ‡§Æ">' +
      '</div>' +
      '<div class="form-group">' +
        '<label class="form-label">Title / ‡§â‡§™‡§æ‡§ß‡§ø</label>' +
        '<input class="form-input" id="prPanditTitle" ' +
          'value="' + UI.esc(p.title || '') + '" ' +
          'placeholder="e.g. ‡§∂‡§æ‡§∏‡•ç‡§§‡•ç‡§∞‡•Ä, ‡§Ü‡§ö‡§æ‡§∞‡•ç‡§Ø, ‡§™‡•Å‡§∞‡•ã‡§π‡§ø‡§§">' +
      '</div>' +
      '<div class="form-row">' +
        '<div class="form-group">' +
          '<label class="form-label">Phone</label>' +
          '<input class="form-input" id="prPanditPhone" ' +
            'value="' + UI.esc(p.phone || u.phone || '') + '" ' +
            'type="tel" placeholder="üìû Phone">' +
        '</div>' +
        '<div class="form-group">' +
          '<label class="form-label">Website</label>' +
          '<input class="form-input" id="prPanditWeb" ' +
            'value="' + UI.esc(p.website || '') + '" ' +
            'placeholder="üåê Website">' +
        '</div>' +
      '</div>' +
      '<div class="form-group">' +
        '<label class="form-label">Address (PDF footer)</label>' +
        '<input class="form-input" id="prPanditAddr" ' +
          'value="' + UI.esc(p.address || '') + '" ' +
          'placeholder="üìç Full address">' +
      '</div>' +
      '<div class="form-group">' +
        '<label class="form-label">Tagline / ‡§ü‡•à‡§ó‡§≤‡§æ‡§á‡§®</label>' +
        '<input class="form-input" id="prPanditTag" ' +
          'value="' + UI.esc(p.tagline || '') + '" ' +
          'placeholder="e.g. ‡§∏‡§≠‡•Ä ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ ‡§ï‡•á ‡§ß‡§æ‡§∞‡•ç‡§Æ‡§ø‡§ï ‡§ï‡§æ‡§∞‡•ç‡§Ø">' +
      '</div>' +
      '<div class="form-row">' +
        '<div class="form-group">' +
          '<label class="form-label">UPI ID (for payments)</label>' +
          '<input class="form-input" id="prPanditUPI" ' +
            'value="' + UI.esc(p.upiId || '') + '" ' +
            'placeholder="yourname@paytm">' +
        '</div>' +
        '<div class="form-group">' +
          '<label class="form-label">UPI Name</label>' +
          '<input class="form-input" id="prPanditUPIName" ' +
            'value="' + UI.esc(p.upiName || '') + '" ' +
            'placeholder="Display name">' +
        '</div>' +
      '</div>' +
      '<button class="btn btn-primary btn-w" onclick="ProfileUI.savePandit()">' +
        'üíæ Save Pandit Profile</button>' +
    '</div>' +
    
    '<div class="card">' +
      '<div class="card-header">' +
        '<h3 class="card-title">üìÑ PDF Preview</h3>' +
        '<button class="btn btn-xs btn-ghost" ' +
          'onclick="ProfileUI.previewPDF()">üëÅÔ∏è Preview</button>' +
      '</div>' +
      '<div id="prPDFPreview" style="background:rgba(255,255,255,0.02);' +
        'border-radius:var(--r-md);padding:var(--sp-lg);min-height:60px">' +
        '<p style="color:var(--text-muted);font-size:.8rem;text-align:center">' +
          'Click üëÅÔ∏è Preview to see how your PDF will look</p>' +
      '</div>' +
    '</div>' +
    
    '<button class="btn btn-ghost btn-w" onclick="ProfileUI.closeMenuContent()">' +
      '‚Üê Back to Profile</button>';
    
    UI.html('prMenuContent', content);
    this.scrollTo('prMenuContent');
  },

  showChangePassword: function() {
    var content = '<div class="card">' +
      '<div class="card-header">' +
        '<h3 class="card-title">üîê Change Password</h3>' +
      '</div>' +
      '<div class="form-group">' +
        '<label class="form-label">Current Password</label>' +
        '<div class="input-wrapper">' +
          '<input class="form-input" id="prCurPass" type="password" ' +
            'placeholder="Current password">' +
          '<button type="button" class="pass-toggle" ' +
            'onclick="togglePassword(\'prCurPass\',this)">üëÅÔ∏è</button>' +
        '</div>' +
      '</div>' +
      '<div class="form-group">' +
        '<label class="form-label">New Password (min 6)</label>' +
        '<div class="input-wrapper">' +
          '<input class="form-input" id="prNewPass" type="password" ' +
            'placeholder="New password">' +
          '<button type="button" class="pass-toggle" ' +
            'onclick="togglePassword(\'prNewPass\',this)">üëÅÔ∏è</button>' +
        '</div>' +
      '</div>' +
      '<div class="form-group">' +
        '<label class="form-label">Confirm New Password</label>' +
        '<div class="input-wrapper">' +
          '<input class="form-input" id="prConfirmPass" type="password" ' +
            'placeholder="Confirm new password">' +
          '<button type="button" class="pass-toggle" ' +
            'onclick="togglePassword(\'prConfirmPass\',this)">üëÅÔ∏è</button>' +
        '</div>' +
      '</div>' +
      '<button class="btn btn-primary btn-w" onclick="ProfileUI.changePassword()">' +
        'üîë Change Password</button>' +
    '</div>' +
    
    '<button class="btn btn-ghost btn-w" onclick="ProfileUI.closeMenuContent()">' +
      '‚Üê Back to Profile</button>';
    
    UI.html('prMenuContent', content);
    this.scrollTo('prMenuContent');
  },

  showYajmanManagement: function() {
    var content = '<div class="card">' +
      '<div class="card-header">' +
        '<h3 class="card-title">üë• Yajman Management</h3>' +
        '<div class="card-actions">' +
          '<button class="btn btn-xs btn-primary" ' +
            'onclick="YajmanUI.showAddModal()">‚ûï Add</button>' +
          '<button class="btn btn-xs btn-ghost" ' +
            'onclick="YajmanUI.exportList()">üì§ Export</button>' +
        '</div>' +
      '</div>' +

      '<div class="stats-grid" style="margin-bottom:var(--sp-md)">' +
        '<div class="stat-card" style="padding:var(--sp-sm)">' +
          '<div class="stat-value" style="font-size:1.1rem" id="prYajTotal">0</div>' +
          '<div class="stat-label">Total</div></div>' +
        '<div class="stat-card" style="padding:var(--sp-sm)">' +
          '<div class="stat-value" style="font-size:1.1rem;color:var(--success)" ' +
            'id="prYajActive">0</div>' +
          '<div class="stat-label">Active</div></div>' +
        '<div class="stat-card" style="padding:var(--sp-sm)">' +
          '<div class="stat-value" style="font-size:1.1rem;color:var(--text-brand)" ' +
            'id="prYajRevenue">‚Çπ0</div>' +
          '<div class="stat-label">Revenue</div></div>' +
      '</div>' +

      '<div style="display:flex;gap:var(--sp-sm);margin-bottom:var(--sp-md);flex-wrap:wrap">' +
        '<div class="search-input" style="flex:1;min-width:150px">' +
          '<input class="form-input" id="prYajSearch" placeholder="Search yajmans..." ' +
            'oninput="YajmanUI.renderList()">' +
        '</div>' +
        '<select class="form-select" id="prYajFilter" onchange="YajmanUI.renderList()" ' +
          'style="width:auto;min-width:90px">' +
          '<option value="all">All</option>' +
          '<option value="active">Active</option>' +
          '<option value="inactive">Inactive</option>' +
        '</select>' +
      '</div>' +

      '<div id="prYajList"></div>' +
    '</div>' +
    
    '<button class="btn btn-ghost btn-w" onclick="ProfileUI.closeMenuContent()">' +
      '‚Üê Back to Profile</button>';
    
    UI.html('prMenuContent', content);
    YajmanUI.renderList();
    this.scrollTo('prMenuContent');
  },

  showDatabase: function() {
    var content = '<div class="card">' +
      '<div class="card-header">' +
        '<h3 class="card-title">üóÑÔ∏è Pooja Database</h3>' +
        '<button class="btn btn-xs btn-primary" onclick="DBPage.showAdd()">' +
          '‚ûï Add Items</button>' +
      '</div>' +

      '<div class="stats-grid" style="margin-bottom:var(--sp-md)">' +
        '<div class="stat-card" style="padding:var(--sp-sm)">' +
          '<div class="stat-value" style="font-size:1.1rem" id="prDBPoojas">0</div>' +
          '<div class="stat-label">Poojas</div></div>' +
        '<div class="stat-card" style="padding:var(--sp-sm)">' +
          '<div class="stat-value" style="font-size:1.1rem" id="prDBItems">0</div>' +
          '<div class="stat-label">Items</div></div>' +
        '<div class="stat-card" style="padding:var(--sp-sm)">' +
          '<div class="stat-value" style="font-size:1.1rem;color:var(--text-brand)" ' +
            'id="prDBCustom">0</div>' +
          '<div class="stat-label">Custom</div></div>' +
      '</div>' +

      '<div class="search-input" style="margin-bottom:var(--sp-md)">' +
        '<input class="form-input" id="prDBSearch" placeholder="Search items..." ' +
          'oninput="DBPage.render()">' +
      '</div>' +

      '<div id="prDBList" style="max-height:50vh;overflow-y:auto;' +
        '-webkit-overflow-scrolling:touch"></div>' +
    '</div>' +
    
    '<button class="btn btn-ghost btn-w" onclick="ProfileUI.closeMenuContent()">' +
      '‚Üê Back to Profile</button>';
    
    UI.html('prMenuContent', content);
    DBPage.render();
    this.scrollTo('prMenuContent');
  },

  closeMenuContent: function() {
    UI.html('prMenuContent', '');
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
};
</script>

<!-- ============================================================
     PART C - BLOCK 5: YAJMAN UI SYSTEM (Complete)
     Add, Edit, Delete, Detail, List, Call, WhatsApp
     Used in Profile page and Home page
     ============================================================ -->
<script>
var YajmanUI = {

  /* ---- Update Stats ---- */
  updateStats: function() {
    var list = App.D.yajmans || [];
    var active = 0;
    var revenue = 0;

    for (var i = 0; i < list.length; i++) {
      if (list[i].status !== 'inactive') active++;
      revenue += parseFloat(list[i].totalAmount) || 0;
    }

    UI.text('prYajTotal', String(list.length));
    UI.text('prYajActive', String(active));
    UI.text('prYajRevenue', UI.formatMoney(revenue));
  },

  /* ---- Render Yajman List ---- */
  renderList: function() {
    var el = UI.$('prYajList');
    if (!el) return;

    this.updateStats();

    var list = App.D.yajmans || [];
    var q = (UI.val('prYajSearch') || '').toLowerCase();
    var filter = UI.val('prYajFilter') || 'all';

    // Apply filters
    var filtered = list.filter(function(y) {
      // Status filter
      if (filter === 'active' && y.status === 'inactive') return false;
      if (filter === 'inactive' && y.status !== 'inactive') return false;

      // Search filter
      if (q) {
        return String(y.name || '').toLowerCase().indexOf(q) !== -1 ||
          String(y.phone || '').indexOf(q) !== -1 ||
          String(y.city || '').toLowerCase().indexOf(q) !== -1 ||
          String(y.gotra || '').toLowerCase().indexOf(q) !== -1;
      }
      return true;
    });

    if (!filtered.length) {
      el.innerHTML = '<div class="empty-state">' +
        '<div class="empty-state-icon">üë•</div>' +
        '<div class="empty-state-text">' +
          (q || filter !== 'all' ? 'No matches found' : 'No yajmans yet') +
        '</div>' +
        (!q ? '<button class="btn btn-sm btn-primary" ' +
          'onclick="YajmanUI.showAddModal()">‚ûï Add First Yajman</button>' : '') +
      '</div>';
      return;
    }

    var html = '';
    for (var i = 0; i < filtered.length; i++) {
      var y = filtered[i];
      var ph = String(y.phone || '').replace(/[^0-9]/g, '');
      var wa = String(y.whatsapp || y.phone || '').replace(/[^0-9]/g, '');
      var statusBadge = y.status === 'inactive' ? 'badge-error' : 'badge-success';

      html += '<div class="list-row" style="cursor:pointer" ' +
        'onclick="YajmanUI.showDetail(\'' + y.id + '\')">' +
        '<div class="list-row-icon" style="background:var(--grad-brand)">üë§</div>' +
        '<div class="list-row-body">' +
          '<div class="list-row-title">' + UI.esc(y.name) +
            ' <span class="badge ' + statusBadge + '">' +
              (y.status || 'active') + '</span></div>' +
          '<div class="list-row-meta">' +
            (y.phone ? 'üìû ' + String(y.phone) : '') +
            (y.city ? ' ‚Ä¢ üìç ' + UI.esc(y.city) : '') +
            (y.gotra ? ' ‚Ä¢ üî± ' + UI.esc(y.gotra) : '') +
          '</div>' +
        '</div>' +
        '<div class="list-row-right">' +
          '<div style="font-weight:800;color:var(--text-brand)">' +
            UI.formatMoney(y.totalAmount) + '</div>' +
          '<div style="font-size:.6rem;color:var(--text-muted)">' +
            (y.totalPoojas || 0) + ' poojas</div>' +
        '</div>' +
        '<div class="list-row-actions" onclick="event.stopPropagation()">' +
          (ph ? '<button class="btn btn-xs btn-ghost" ' +
            'onclick="YajmanUI.call(\'' + ph + '\')" title="Call">üìû</button>' : '') +
          (wa ? '<button class="btn btn-xs btn-success" ' +
            'onclick="YajmanUI.whatsapp(\'' + wa + '\')" title="WhatsApp">üí¨</button>' : '') +
        '</div>' +
      '</div>';
    }

    el.innerHTML = html;
  },

  /* ---- Show Add/Edit Modal ---- */
  showAddModal: function(editData) {
    var d = editData || {};
    var isEdit = !!d.id;

    var rashis = ['‡§Æ‡•á‡§∑','‡§µ‡•É‡§∑‡§≠','‡§Æ‡§ø‡§•‡•Å‡§®','‡§ï‡§∞‡•ç‡§ï','‡§∏‡§ø‡§Ç‡§π','‡§ï‡§®‡•ç‡§Ø‡§æ',
                  '‡§§‡•Å‡§≤‡§æ','‡§µ‡•É‡§∂‡•ç‡§ö‡§ø‡§ï','‡§ß‡§®‡•Å','‡§Æ‡§ï‡§∞','‡§ï‡•Å‡§Ç‡§≠','‡§Æ‡•Ä‡§®'];
    var rashiOpts = '<option value="">‚Äî Select ‚Äî</option>';
    for (var i = 0; i < rashis.length; i++) {
      rashiOpts += '<option' +
        (d.rashi === rashis[i] ? ' selected' : '') + '>' +
        rashis[i] + '</option>';
    }

    var body =
      '<input type="hidden" id="ymId" value="' + (d.id || '') + '">' +

      '<div class="form-group">' +
        '<label class="form-label">Name *</label>' +
        '<input class="form-input" id="ymName" ' +
          'value="' + UI.esc(d.name || '') + '" placeholder="‡§Ø‡§ú‡§Æ‡§æ‡§® ‡§ï‡§æ ‡§®‡§æ‡§Æ">' +
      '</div>' +

      '<div class="form-row">' +
        '<div class="form-group">' +
          '<label class="form-label">Phone</label>' +
          '<input class="form-input" id="ymPhone" type="tel" ' +
            'value="' + UI.esc(String(d.phone || '')) + '" placeholder="9876543210">' +
        '</div>' +
        '<div class="form-group">' +
          '<label class="form-label">WhatsApp</label>' +
          '<input class="form-input" id="ymWhatsapp" type="tel" ' +
            'value="' + UI.esc(String(d.whatsapp || '')) + '" ' +
            'placeholder="Same or different">' +
        '</div>' +
      '</div>' +

      '<div class="form-group">' +
        '<label class="form-label">Address</label>' +
        '<input class="form-input" id="ymAddr" ' +
          'value="' + UI.esc(d.address || '') + '" placeholder="‡§™‡•Ç‡§∞‡§æ ‡§™‡§§‡§æ">' +
      '</div>' +

      '<div class="form-row">' +
        '<div class="form-group">' +
          '<label class="form-label">City</label>' +
          '<input class="form-input" id="ymCity" ' +
            'value="' + UI.esc(d.city || '') + '" placeholder="‡§∂‡§π‡§∞">' +
        '</div>' +
        '<div class="form-group">' +
          '<label class="form-label">Gotra</label>' +
          '<input class="form-input" id="ymGotra" ' +
            'value="' + UI.esc(d.gotra || '') + '" placeholder="‡§ó‡•ã‡§§‡•ç‡§∞">' +
        '</div>' +
      '</div>' +

      '<div class="form-row">' +
        '<div class="form-group">' +
          '<label class="form-label">Rashi</label>' +
          '<select class="form-select" id="ymRashi">' + rashiOpts + '</select>' +
        '</div>' +
        '<div class="form-group">' +
          '<label class="form-label">Status</label>' +
          '<select class="form-select" id="ymStatus">' +
            '<option value="active"' +
              ((d.status || 'active') === 'active' ? ' selected' : '') +
              '>Active</option>' +
            '<option value="inactive"' +
              (d.status === 'inactive' ? ' selected' : '') +
              '>Inactive</option>' +
          '</select>' +
        '</div>' +
      '</div>' +

      '<div class="form-group">' +
        '<label class="form-label">Notes</label>' +
        '<textarea class="form-textarea" id="ymNotes" ' +
          'placeholder="‡§µ‡§ø‡§∂‡•á‡§∑ ‡§ü‡§ø‡§™‡•ç‡§™‡§£‡•Ä">' + UI.esc(d.notes || '') + '</textarea>' +
      '</div>';

    var footer =
      '<button class="btn btn-ghost" onclick="UI.closeModal(\'mYajAdd\')">Cancel</button>' +
      '<button class="btn btn-primary" onclick="YajmanUI.save()">üíæ ' +
        (isEdit ? 'Update' : 'Save') + '</button>';

    UI.createModal('mYajAdd', {
      title: (isEdit ? '‚úèÔ∏è Edit' : '‚ûï Add') + ' Yajman',
      body: body,
      footer: footer
    });
  },

  /* ---- Save Yajman ---- */
  save: function() {
    var name = UI.val('ymName');
    if (!name) { UI.toast('Required', 'Enter name', 'warn'); return; }

    var id = UI.val('ymId');
    UI.closeModal('mYajAdd');
    UI.load(id ? 'Updating...' : 'Saving...');

    var payload = {
      action: id ? 'updateYajman' : 'addYajman',
      name: name,
      phone: UI.val('ymPhone'),
      whatsapp: UI.val('ymWhatsapp') || UI.val('ymPhone'),
      address: UI.val('ymAddr'),
      city: UI.val('ymCity'),
      gotra: UI.val('ymGotra'),
      rashi: UI.val('ymRashi'),
      notes: UI.val('ymNotes'),
      status: UI.val('ymStatus')
    };
    if (id) payload.id = id;

    API.post(payload).then(function(r) {
      UI.unload();
      if (r.error) { UI.toast('Error', r.error, 'error'); return; }
      UI.toast('Saved!', name, 'ok');
      return App.reloadAndRender('yajmans');
    }).catch(function(e) {
      UI.unload();
      UI.toast('Error', e.message, 'error');
    });
  },

  /* ---- Show Detail Modal ---- */
  showDetail: function(id) {
    var y = App.findYajman(id);
    if (!y) { UI.toast('Error', 'Yajman not found', 'error'); return; }

    var ph = String(y.phone || '').replace(/[^0-9]/g, '');
    var wa = String(y.whatsapp || y.phone || '').replace(/[^0-9]/g, '');

    var body = '';

    /* Profile header */
    body += '<div style="text-align:center;padding:var(--sp-lg);' +
      'background:rgba(255,111,0,0.04);border-radius:var(--r-lg);' +
      'margin-bottom:var(--sp-md)">' +
      '<div style="width:50px;height:50px;border-radius:50%;' +
        'background:var(--grad-brand);display:grid;place-items:center;' +
        'font-size:1.4rem;margin:0 auto var(--sp-sm)">üë§</div>' +
      '<h3 style="color:var(--text-primary);font-size:1rem">' +
        UI.esc(y.name) + '</h3>' +
      '<span class="badge ' +
        (y.status === 'inactive' ? 'badge-error' : 'badge-success') + '">' +
        (y.status || 'active') + '</span>' +
    '</div>';

    /* Stats */
    body += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;' +
      'gap:var(--sp-sm);margin-bottom:var(--sp-md)">' +
      '<div class="stat-card" style="padding:var(--sp-sm)">' +
        '<div class="stat-value" style="font-size:1rem">' +
          (y.totalPoojas || 0) + '</div>' +
        '<div class="stat-label">Poojas</div></div>' +
      '<div class="stat-card" style="padding:var(--sp-sm)">' +
        '<div class="stat-value" style="font-size:1rem">' +
          UI.formatMoney(y.totalAmount) + '</div>' +
        '<div class="stat-label">Total</div></div>' +
      '<div class="stat-card" style="padding:var(--sp-sm)">' +
        '<div class="stat-value" style="font-size:1rem">' +
          UI.formatDate(y.lastPoojaDate) + '</div>' +
        '<div class="stat-label">Last</div></div>' +
    '</div>';

    /* Contact details */
    body += '<div class="card" style="padding:var(--sp-md);margin-bottom:var(--sp-sm)">' +
      '<h4 style="color:var(--brand);font-size:.72rem;' +
        'text-transform:uppercase;margin-bottom:var(--sp-sm)">üìã Contact</h4>';

    if (y.phone) body += '<div style="font-size:.82rem;color:var(--text-secondary);' +
      'margin-bottom:3px">üìû ' + String(y.phone) + '</div>';
    if (y.whatsapp && String(y.whatsapp) !== String(y.phone))
      body += '<div style="font-size:.82rem;color:var(--text-secondary);' +
        'margin-bottom:3px">üí¨ ' + String(y.whatsapp) + ' (WhatsApp)</div>';
    if (y.address) body += '<div style="font-size:.82rem;color:var(--text-secondary);' +
      'margin-bottom:3px">üìç ' + UI.esc(y.address) +
      (y.city ? ', ' + UI.esc(y.city) : '') + '</div>';
    if (y.gotra) body += '<div style="font-size:.82rem;color:var(--text-secondary);' +
      'margin-bottom:3px">üî± ‡§ó‡•ã‡§§‡•ç‡§∞: ' + UI.esc(y.gotra) + '</div>';
    if (y.rashi) body += '<div style="font-size:.82rem;color:var(--text-secondary);' +
      'margin-bottom:3px">‚≠ê ‡§∞‡§æ‡§∂‡§ø: ' + UI.esc(y.rashi) + '</div>';
    if (y.notes) body += '<div style="margin-top:var(--sp-sm);padding:var(--sp-sm);' +
      'background:rgba(255,255,255,0.02);border-radius:var(--r-sm);' +
      'font-size:.78rem;color:var(--text-muted)">üìù ' + UI.esc(y.notes) + '</div>';

    body += '</div>';

    /* Action buttons */
    body += '<div style="display:grid;grid-template-columns:1fr 1fr;' +
      'gap:var(--sp-sm);margin-bottom:var(--sp-sm)">' +
      '<button class="btn btn-primary btn-w btn-sm" ' +
        'onclick="UI.closeModal(\'mYajDetail\');YajmanUI.createPoojaFor(\'' + y.id + '\')">' +
        'üïâÔ∏è Create Pooja</button>' +
      '<button class="btn btn-success btn-w btn-sm" ' +
        'onclick="UI.closeModal(\'mYajDetail\');YajmanUI.addHisabFor(\'' + y.id + '\')">' +
        'üí∞ Add Hisab</button>' +
    '</div>';

    body += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;' +
      'gap:var(--sp-xs);margin-bottom:var(--sp-md)">';
    if (ph) body += '<button class="btn btn-xs btn-ghost btn-w" ' +
      'onclick="YajmanUI.call(\'' + ph + '\')">üìû Call</button>';
    else body += '<div></div>';

    if (wa) body += '<button class="btn btn-xs btn-success btn-w" ' +
      'onclick="YajmanUI.whatsapp(\'' + wa + '\')">üí¨ WhatsApp</button>';
    else body += '<div></div>';

    if (wa) body += '<button class="btn btn-xs btn-ghost btn-w" ' +
      'onclick="YajmanUI.sendReminder(\'' + y.id + '\')">‚ö†Ô∏è Remind</button>';
    else body += '<div></div>';
    body += '</div>';

    /* Payment & Pooja History placeholders */
    body += '<div class="card" style="padding:var(--sp-md);margin-bottom:var(--sp-sm)">' +
      '<div style="display:flex;justify-content:space-between;align-items:center;' +
        'margin-bottom:var(--sp-sm)">' +
        '<h4 style="color:var(--brand);font-size:.72rem;text-transform:uppercase">' +
          'üí∞ Payment History</h4>' +
      '</div>' +
      '<div id="ydHisab_' + y.id + '">' +
        '<div style="text-align:center;padding:var(--sp-sm);' +
          'color:var(--text-muted);font-size:.75rem">Loading...</div>' +
      '</div>' +
    '</div>';

    var footer =
      '<button class="btn btn-ghost" ' +
        'onclick="UI.closeModal(\'mYajDetail\');' +
          'YajmanUI.showAddModal(App.findYajman(\'' + y.id + '\'))">‚úèÔ∏è Edit</button>' +
      '<button class="btn btn-danger" ' +
        'onclick="YajmanUI.deleteYajman(\'' + y.id + '\')">üóëÔ∏è Delete</button>' +
      '<button class="btn btn-ghost" ' +
        'onclick="UI.closeModal(\'mYajDetail\')">Close</button>';

    UI.createModal('mYajDetail', {
      title: 'üë§ ' + UI.esc(y.name),
      body: body,
      footer: footer,
      maxWidth: '600px'
    });

    // Load detail data
    this._loadDetailData(y.id);
  },

  /* Load payment history for detail modal */
  _loadDetailData: function(yajId) {
    API.get('getYajmanDetail', { yajmanId: yajId }).then(function(r) {
      if (r.error) return;

      var hEl = UI.$('ydHisab_' + yajId);
      if (hEl) {
        if (!r.hisab || !r.hisab.length) {
          hEl.innerHTML = '<p style="color:var(--text-muted);font-size:.78rem;' +
            'text-align:center">No payment records yet</p>';
        } else {
          var html = '';
          var entries = r.hisab.slice(-6).reverse();
          for (var i = 0; i < entries.length; i++) {
            var h = entries[i];
            var isInc = h.type === 'income';
            var stBadge = h.paymentStatus === 'paid' ? 'badge-success' :
              h.paymentStatus === 'partial' ? 'badge-warning' : 'badge-error';

            html += '<div class="list-row" style="padding:var(--sp-xs) 0">' +
              '<div class="list-row-icon" style="width:26px;height:26px;font-size:.7rem;' +
                'background:' + (isInc ? 'var(--success-bg)' : 'var(--error-bg)') + '">' +
                (isInc ? 'üí∞' : 'üì§') + '</div>' +
              '<div class="list-row-body">' +
                '<div class="list-row-title" style="font-size:.78rem">' +
                  UI.esc(h.poojaName || 'Payment') + '</div>' +
                '<div class="list-row-meta">' + UI.formatDate(h.date) +
                  ' ‚Ä¢ <span class="badge ' + stBadge + '">' +
                  (h.paymentStatus || 'pending') + '</span></div>' +
              '</div>' +
              '<div style="font-weight:700;font-size:.82rem;color:' +
                (isInc ? 'var(--success)' : 'var(--error)') + '">' +
                UI.formatMoney(h.amount) + '</div>' +
            '</div>';
          }
          hEl.innerHTML = html;
        }
      }
    }).catch(function(e) {
      console.error('Detail load:', e);
    });
  },

  /* ---- Helper Methods ---- */

  call: function(phone) {
    if (!phone) return;
    window.location.href = 'tel:+91' + phone;
  },

  whatsapp: function(phone, msg) {
    if (!phone) return;
    var url = 'https://wa.me/91' + phone;
    if (msg) url += '?text=' + encodeURIComponent(msg);
    window.open(url, '_blank');
  },

  sendReminder: function(yajId) {
    var y = App.findYajman(yajId);
    if (!y) return;

    var wa = String(y.whatsapp || y.phone || '').replace(/[^0-9]/g, '');
    if (!wa) { UI.toast('Error', 'No phone number', 'error'); return; }

    var pandit = (API.user && API.user.pandit && API.user.pandit.name) ||
      (API.user && API.user.name) || '';

    var msg = 'üôè ‡§®‡§Æ‡§∏‡•ç‡§§‡•á ' + String(y.name) + ' ‡§ú‡•Ä,\n\n' +
      '‡§Ü‡§™‡§ï‡•Ä ‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§∞‡§æ‡§∂‡§ø ‚Çπ' + (y.totalAmount || 0) + ' ‡§π‡•à‡•§\n' +
      '‡§ï‡•É‡§™‡§Ø‡§æ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡§∞‡•á‡§Ç‡•§\n\n' +
      '‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶ üôè\n' + pandit;

    this.whatsapp(wa, msg);
  },

  createPoojaFor: function(yajId) {
    var y = App.findYajman(yajId);
    if (!y) return;

    App._selectedYajman = y;
    Nav.go('new');

    setTimeout(function() {
      UI.setVal('npYajman', y.name || '');
      UI.setVal('npPhone', String(y.phone || ''));
      UI.setVal('npAddr', (y.address || '') + (y.city ? ', ' + y.city : ''));
    }, 400);

    UI.toast('Selected', y.name, 'ok');
  },

  addHisabFor: function(yajId) {
    Nav.go('hisab');
    setTimeout(function() {
      if (typeof HisabUI !== 'undefined' && HisabUI.showAddSingle) {
        HisabUI.showAddSingle('income', yajId);
      }
    }, 500);
  },

  deleteYajman: function(id) {
    UI.confirm('Delete Yajman', 'This will permanently remove this yajman.', function() {
      UI.closeModal('mYajDetail');
      UI.load('Deleting...');

      API.post({ action: 'deleteYajman', id: id }).then(function() {
        UI.unload();
        UI.toast('Deleted', 'Yajman removed', 'ok');
        return App.reloadAndRender('yajmans');
      }).catch(function(e) {
        UI.unload();
        UI.toast('Error', e.message, 'error');
      });
    });
  },

  /* Show all yajmans in a modal (from home) */
  showListModal: function() {
    Nav.go('profile');
    setTimeout(function() {
      ProfileUI.scrollTo('prYajSection');
    }, 300);
  },

  /* Export CSV */
  exportList: function() {
    var list = App.D.yajmans || [];
    if (!list.length) { UI.toast('Empty', 'No yajmans', 'warn'); return; }

    var csv = '\uFEFF'; // BOM for Excel
    csv += 'Name,Phone,WhatsApp,City,Address,Gotra,Rashi,Status,Amount,Poojas\n';

    for (var i = 0; i < list.length; i++) {
      var y = list[i];
      csv += '"' + (y.name || '') + '","' + (y.phone || '') + '","' +
        (y.whatsapp || '') + '","' + (y.city || '') + '","' +
        (y.address || '') + '","' + (y.gotra || '') + '","' +
        (y.rashi || '') + '","' + (y.status || 'active') + '","' +
        (y.totalAmount || 0) + '","' + (y.totalPoojas || 0) + '"\n';
    }

    var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'Yajmans_' + UI.today() + '.csv';
    document.body.appendChild(a);
    a.click();
    setTimeout(function() {
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }, 1000);

    UI.toast('Exported!', 'CSV downloaded', 'ok');
  }
};
</script>

<!-- ============================================================
     PART C - BLOCK 6: DATABASE PAGE SYSTEM
     Pooja items management - add, edit, delete, bulk add
     ============================================================ -->
<script>
var DBPage = {

  /* ---- Render Database List ---- */
  render: function() {
    var data = App.D.master || [];
    var poojas = App.getUniquePoojas();
    var custom = 0;

    for (var i = 0; i < data.length; i++) {
      if (data[i].source === 'user') custom++;
    }

    UI.text('prDBPoojas', String(poojas.length));
    UI.text('prDBItems', String(data.length));
    UI.text('prDBCustom', String(custom));

    var el = UI.$('prDBList');
    if (!el) return;

    var q = (UI.val('prDBSearch') || '').toLowerCase();
    var filtered = data;

    if (q) {
      filtered = data.filter(function(d) {
        return (d.pooja || '').toLowerCase().indexOf(q) !== -1 ||
          (d.samagri || '').toLowerCase().indexOf(q) !== -1;
      });
    }

    if (!filtered.length) {
      el.innerHTML = '<div class="empty-state">' +
        '<div class="empty-state-icon">üóÑÔ∏è</div>' +
        '<div class="empty-state-text">' +
          (q ? 'No matches found' : 'No data in database') + '</div>' +
        (!q ? '<button class="btn btn-sm btn-primary" ' +
          'onclick="DBPage.showAdd()">‚ûï Add First Items</button>' : '') +
      '</div>';
      return;
    }

    /* Group by pooja */
    var groups = {};
    for (var j = 0; j < filtered.length; j++) {
      var d = filtered[j];
      var pj = d.pooja || 'Unknown';
      if (!groups[pj]) groups[pj] = [];
      groups[pj].push(d);
    }

    var keys = Object.keys(groups).sort();
    var html = '';

    for (var k = 0; k < keys.length; k++) {
      var pooja = keys[k];
      var items = groups[pooja];
      var secId = 'dbSec_' + k;

      html += '<div class="section-header" ' +
        'onclick="var e=UI.$(\''+secId+'\');if(e){e.classList.toggle(\'hide\');' +
          'this.classList.toggle(\'open\')}">' +
        '<span>üïâÔ∏è ' + UI.esc(pooja) + '</span>' +
        '<span class="section-count">' + items.length + ' items ‚ñº</span>' +
      '</div>';

      html += '<div id="' + secId + '" class="hide" ' +
        'style="margin-bottom:var(--sp-sm)">';

      for (var m = 0; m < items.length; m++) {
        var item = items[m];
        var isCustom = item.source === 'user';
        // Escape quotes for onclick
        var escapedPooja = UI.esc(item.pooja).replace(/'/g, "\\'");
        var escapedSamagri = UI.esc(item.samagri).replace(/'/g, "\\'");

        html += '<div style="display:flex;align-items:center;gap:var(--sp-sm);' +
          'padding:var(--sp-xs) var(--sp-md);border-bottom:1px solid var(--border);' +
          'font-size:.8rem;min-height:36px">' +
          '<span style="flex:1;color:var(--text-secondary)">' +
            UI.esc(item.samagri) + '</span>' +
          '<span style="font-size:.58rem;color:' +
            (isCustom ? 'var(--brand)' : 'var(--text-muted)') + '">' +
            (isCustom ? '‚≠ê Custom' : 'Master') + '</span>' +
          '<button class="btn btn-xs btn-ghost" ' +
            'onclick="DBPage.editItem(\'' + escapedPooja + '\',\'' +
              escapedSamagri + '\')">‚úèÔ∏è</button>' +
          '<button class="btn btn-xs btn-danger" style="padding:3px 6px" ' +
            'onclick="DBPage.deleteItem(\'' + escapedPooja + '\',\'' +
              escapedSamagri + '\')">üóëÔ∏è</button>' +
        '</div>';
      }

      /* Inline add */
      html += '<div style="display:flex;gap:var(--sp-xs);padding:var(--sp-xs) var(--sp-md)">' +
        '<input class="form-input" id="dbInl_' + k + '" ' +
          'placeholder="‚ûï Add item to ' + UI.esc(pooja) + '..." ' +
          'style="flex:1;padding:6px 10px;font-size:.78rem;' +
            'border-style:dashed;border-color:rgba(255,111,0,0.25)" ' +
          'onkeydown="if(event.key===\'Enter\')DBPage.addInline(\'' +
            escapedPooja + '\',' + k + ')">' +
        '<button class="btn btn-xs btn-primary" ' +
          'onclick="DBPage.addInline(\'' + escapedPooja + '\',' + k + ')">' +
          'Add</button>' +
      '</div>';

      html += '</div>';
    }

    el.innerHTML = html;
  },

  /* ---- Show Bulk Add Modal ---- */
  showAdd: function() {
    var poojas = App.getUniquePoojas();
    var opts = '<option value="">‚Äî Select Existing ‚Äî</option>';
    for (var i = 0; i < poojas.length; i++) {
      opts += '<option value="' + UI.esc(poojas[i]) + '">' +
        UI.esc(poojas[i]) + '</option>';
    }

    var body =
      '<div class="info-banner">' +
        'üìå Type a new pooja name or select existing. ' +
        'Add samagri items one per line.' +
      '</div>' +
      '<div class="form-group">' +
        '<label class="form-label">Pooja Name *</label>' +
        '<input class="form-input" id="dbAddPooja" ' +
          'placeholder="Enter new or select below">' +
        '<select class="form-select" id="dbAddPoojaSelect" ' +
          'onchange="UI.setVal(\'dbAddPooja\',this.value)" ' +
          'style="margin-top:var(--sp-xs)">' + opts + '</select>' +
      '</div>' +
      '<div class="form-group">' +
        '<label class="form-label">Samagri Items (one per line) *</label>' +
        '<textarea class="form-textarea" id="dbAddItems" ' +
          'placeholder="‡§∞‡•ã‡§≤‡•Ä\n‡§Æ‡•å‡§≤‡•Ä\n‡§ö‡§æ‡§µ‡§≤\n‡§ï‡§™‡•Ç‡§∞\n‡§ß‡•Ç‡§™‡§¨‡§§‡•ç‡§§‡•Ä" ' +
          'style="min-height:140px"></textarea>' +
      '</div>';

    var footer =
      '<button class="btn btn-ghost" onclick="UI.closeModal(\'mDBAdd\')">Cancel</button>' +
      '<button class="btn btn-primary" onclick="DBPage.addBulk()">‚ûï Add Items</button>';

    UI.createModal('mDBAdd', {
      title: '‚ûï Add Items to Database',
      body: body,
      footer: footer
    });
  },

  /* ---- Add Bulk Items ---- */
  addBulk: function() {
    var pooja = UI.val('dbAddPooja');
    var txt = UI.val('dbAddItems');

    if (!pooja) { UI.toast('Required', 'Enter pooja name', 'warn'); return; }
    if (!txt) { UI.toast('Required', 'Enter items', 'warn'); return; }

    var lines = txt.split('\n');
    var items = [];
    for (var i = 0; i < lines.length; i++) {
      var s = lines[i].trim();
      if (s) items.push(s);
    }
    if (!items.length) { UI.toast('Empty', 'No valid items', 'warn'); return; }

    UI.closeModal('mDBAdd');
    UI.load('Adding ' + items.length + ' items...');

    var payload = { action: 'addBulkItems', items: [] };
    for (var j = 0; j < items.length; j++) {
      payload.items.push({ pooja: pooja, samagri: items[j] });
    }

    API.post(payload).then(function(r) {
      UI.unload();
      UI.toast('Added!', (r.added || items.length) + ' items to ' + pooja, 'ok');
      return App.reloadAndRender('master');
    }).catch(function(e) {
      UI.unload();
      UI.toast('Error', e.message, 'error');
    });
  },

  /* ---- Add Inline Item ---- */
  addInline: function(pooja, secIdx) {
    var inp = UI.$('dbInl_' + secIdx);
    if (!inp) return;

    var val = inp.value.trim();
    if (!val) { UI.toast('Empty', 'Type item name', 'warn'); return; }

    /* Check duplicate */
    for (var i = 0; i < App.D.master.length; i++) {
      if (App.D.master[i].pooja === pooja && App.D.master[i].samagri === val) {
        UI.toast('Exists', 'Already in database', 'warn');
        return;
      }
    }

    inp.value = '';
    UI.load('Adding...');

    API.post({ action: 'addItem', pooja: pooja, samagri: val })
      .then(function() {
        UI.unload();
        UI.toast('Added', val + ' ‚Üí ' + pooja, 'ok');
        return App.reloadAndRender('master');
      })
      .catch(function(e) {
        UI.unload();
        UI.toast('Error', e.message, 'error');
      });
  },

  /* ---- Edit Item ---- */
  editItem: function(pooja, samagri) {
    var body =
      '<div class="form-group">' +
        '<label class="form-label">Item Name</label>' +
        '<input class="form-input" id="dbEditName" value="' +
          UI.esc(samagri) + '">' +
      '</div>' +
      '<div class="info-banner">' +
        'üìå Pooja: ' + UI.esc(pooja) +
      '</div>';

    var footer =
      '<button class="btn btn-ghost" onclick="UI.closeModal(\'mDBEdit\')">Cancel</button>' +
      '<button class="btn btn-primary" onclick="DBPage._saveEdit(\'' +
        UI.esc(pooja).replace(/'/g, "\\'") + '\',\'' +
        UI.esc(samagri).replace(/'/g, "\\'") + '\')">üíæ Save</button>';

    UI.createModal('mDBEdit', {
      title: '‚úèÔ∏è Edit Item',
      body: body,
      footer: footer,
      maxWidth: '400px'
    });
  },

  _saveEdit: function(pooja, oldSamagri) {
    var newName = UI.val('dbEditName');
    if (!newName || newName === oldSamagri) {
      UI.closeModal('mDBEdit');
      return;
    }

    UI.closeModal('mDBEdit');
    UI.load('Updating...');

    API.post({
      action: 'updateItem',
      pooja: pooja,
      oldSamagri: oldSamagri,
      newSamagri: newName
    }).then(function(r) {
      UI.unload();
      if (r.error) { UI.toast('Error', r.error, 'error'); return; }
      UI.toast('Updated', oldSamagri + ' ‚Üí ' + newName, 'ok');
      return App.reloadAndRender('master');
    }).catch(function(e) {
      UI.unload();
      UI.toast('Error', e.message, 'error');
    });
  },

  /* ---- Delete Item ---- */
  deleteItem: function(pooja, samagri) {
    UI.confirm('Remove Item',
      'Remove "' + samagri + '" from ' + pooja + '?',
      function() {
        UI.load('Removing...');
        API.post({
          action: 'deleteItem',
          pooja: pooja,
          samagri: samagri
        }).then(function() {
          UI.unload();
          UI.toast('Removed', samagri, 'ok');
          return App.reloadAndRender('master');
        }).catch(function(e) {
          UI.unload();
          UI.toast('Error', e.message, 'error');
        });
      }
    );
  }
};
</script>
<!-- ============================================================
     PART D - BLOCK 1: HISAB PAGE BUILDER
     Complete layout with summary, pooja-wise, transactions
     ============================================================ -->
<script>
PageBuilder.hisab = function() {

  UI.html('pgHisab',

    /* ---- Page Header ---- */
    '<div class="page-header">' +
      '<h2 class="page-title">üí∞ Hisab Book</h2>' +
      '<p class="page-subtitle">Per-pooja accounting & tracking</p>' +
    '</div>' +

    /* ---- Summary Cards ---- */
    '<div id="hisabSummary"></div>' +

    /* ---- Monthly Mini Stats ---- */
    '<div class="stats-grid" id="hisabMonthStats" style="margin-bottom:var(--sp-lg)"></div>' +

    /* ---- Pooja-wise Hisab Section ---- */
    '<div class="card">' +
      '<div class="card-header">' +
        '<h3 class="card-title">üïâÔ∏è Pooja-wise Hisab</h3>' +
        '<div class="card-actions">' +
          '<button class="btn btn-xs btn-primary" ' +
            'onclick="HisabUI.showAddPooja()">‚ûï Pooja Entry</button>' +
          '<button class="btn btn-xs btn-ghost" ' +
            'onclick="HisabUI.downloadPDF()">üìÑ PDF</button>' +
        '</div>' +
      '</div>' +

      '<div class="info-banner">' +
        'üìå Each pooja entry: Income (‡§¶‡§ï‡•ç‡§∑‡§ø‡§£‡§æ, ‡§ö‡§¢‡§º‡§æ‡§µ‡§æ) + Expenses ' +
        '(‡§∏‡§æ‡§Æ‡§æ‡§®, ‡§Ö‡§®‡•ç‡§Ø ‡§™‡§Ç‡§ú‡•Ä, ‡§Æ‡§Ç‡§¶‡§ø‡§∞) ‚Äî all in one form</div>' +

      /* Filters row */
      '<div style="display:flex;gap:var(--sp-sm);flex-wrap:wrap;' +
        'margin-bottom:var(--sp-md)">' +
        '<div class="search-input" style="flex:1;min-width:140px">' +
          '<input class="form-input" id="hPoojaSearch" ' +
            'placeholder="Search poojas..." oninput="HisabUI.renderPoojaWise()">' +
        '</div>' +
        '<select class="form-select" id="hPoojaTime" ' +
          'onchange="HisabUI.renderPoojaWise()" ' +
          'style="width:auto;min-width:100px">' +
          '<option value="all">All Time</option>' +
          '<option value="thisMonth">This Month</option>' +
          '<option value="lastMonth">Last Month</option>' +
          '<option value="thisYear">This Year</option>' +
        '</select>' +
      '</div>' +

      /* Pooja-wise list */
      '<div id="hPoojaList"></div>' +
    '</div>' +

    /* ---- All Transactions Section ---- */
    '<div class="card">' +
      '<div class="card-header">' +
        '<h3 class="card-title">üìã All Transactions</h3>' +
        '<div class="card-actions">' +
          '<button class="btn btn-xs btn-success" ' +
            'onclick="HisabUI.showAddSingle(\'income\')">‚ûï Income</button>' +
          '<button class="btn btn-xs btn-danger" ' +
            'onclick="HisabUI.showAddSingle(\'expense\')">‚ûï Expense</button>' +
        '</div>' +
      '</div>' +

      /* Transaction filters */
      '<div style="display:flex;gap:var(--sp-sm);flex-wrap:wrap;' +
        'margin-bottom:var(--sp-md)">' +
        '<select class="form-select" id="hTxnType" ' +
          'onchange="HisabUI.renderTransactions()" ' +
          'style="width:auto;min-width:80px">' +
          '<option value="all">All Type</option>' +
          '<option value="income">Income</option>' +
          '<option value="expense">Expense</option>' +
        '</select>' +
        '<select class="form-select" id="hTxnStatus" ' +
          'onchange="HisabUI.renderTransactions()" ' +
          'style="width:auto;min-width:80px">' +
          '<option value="all">All Status</option>' +
          '<option value="paid">Paid</option>' +
          '<option value="pending">Pending</option>' +
          '<option value="partial">Partial</option>' +
        '</select>' +
        '<select class="form-select" id="hTxnCat" ' +
          'onchange="HisabUI.renderTransactions()" ' +
          'style="width:auto;min-width:80px">' +
          '<option value="all">All Category</option>' +
          '<option value="dakshina">‡§¶‡§ï‡•ç‡§∑‡§ø‡§£‡§æ</option>' +
          '<option value="chadawa">‡§ö‡§¢‡§º‡§æ‡§µ‡§æ</option>' +
          '<option value="donation">‡§¶‡§æ‡§®</option>' +
          '<option value="saman">‡§∏‡§æ‡§Æ‡§æ‡§®</option>' +
          '<option value="other_panji">‡§Ö‡§®‡•ç‡§Ø ‡§™‡§Ç‡§ú‡•Ä</option>' +
          '<option value="temple">‡§Æ‡§Ç‡§¶‡§ø‡§∞</option>' +
          '<option value="travel">‡§Ø‡§æ‡§§‡•ç‡§∞‡§æ</option>' +
          '<option value="prasad">‡§™‡•ç‡§∞‡§∏‡§æ‡§¶</option>' +
        '</select>' +
        '<div class="search-input" style="flex:1;min-width:80px">' +
          '<input class="form-input" id="hTxnSearch" ' +
            'placeholder="Search..." oninput="HisabUI.renderTransactions()">' +
        '</div>' +
      '</div>' +

      /* Transaction list */
      '<div id="hTxnList"></div>' +
    '</div>'
  );
};

/* ---- Hisab Page Controller ---- */
PageController.hisab = function() {
  HisabUI.loadAndRender();
};
</script>

<!-- ============================================================
     PART D - BLOCK 2: HISAB DATA MANAGEMENT
     Load, filter, calculate
     ============================================================ -->
<script>
var HisabUI = {

  /* Local hisab data cache */
  _data: [],

  /* ---- Load and Render All ---- */
  loadAndRender: function() {
    var self = this;
    this._loadData().then(function() {
      self.renderSummary();
      self.renderMonthStats();
      self.renderPoojaWise();
      self.renderTransactions();
    });
  },

  /* ---- Load Data ---- */
  _loadData: function() {
    var self = this;
    return API.get('getHisab').then(function(d) {
      if (Array.isArray(d)) {
        self._data = d;
        App.D.hisab = d;
      }
    }).catch(function(e) {
      console.error('Hisab load:', e);
      self._data = App.D.hisab || [];
    });
  },

  /* ---- Reload After Changes ---- */
  _refresh: function() {
    var self = this;
    return this._loadData().then(function() {
      self.renderSummary();
      self.renderMonthStats();
      self.renderPoojaWise();
      self.renderTransactions();
    });
  },

  /* ---- Time Filter Helper ---- */
  _filterByTime: function(data, timeVal) {
    var period = timeVal || 'all';
    if (period === 'all') return data;

    var now = new Date();
    var result = [];

    for (var i = 0; i < data.length; i++) {
      try {
        var dt = new Date(data[i].date);
        if (isNaN(dt.getTime())) continue;

        var ok = false;
        if (period === 'thisMonth') {
          ok = (dt.getMonth() === now.getMonth() &&
                dt.getFullYear() === now.getFullYear());
        } else if (period === 'lastMonth') {
          var lm = now.getMonth() - 1;
          var ly = now.getFullYear();
          if (lm < 0) { lm = 11; ly--; }
          ok = (dt.getMonth() === lm && dt.getFullYear() === ly);
        } else if (period === 'thisYear') {
          ok = (dt.getFullYear() === now.getFullYear());
        }

        if (ok) result.push(data[i]);
      } catch(e) {}
    }
    return result;
  },

  /* ---- Get Category Info ---- */
  _catInfo: function(type, catId) {
    return App.getCatInfo(type, catId);
  },
  /* ============================================================
     PART D - BLOCK 3: SUMMARY RENDERING
     Top-level overview cards
     ============================================================ */

  renderSummary: function() {
    var el = UI.$('hisabSummary');
    if (!el) return;

    var inc = 0, exp = 0, pend = 0;
    var now = new Date();
    var thisM = now.getMonth();
    var thisY = now.getFullYear();

    for (var i = 0; i < this._data.length; i++) {
      var h = this._data[i];
      var amt = parseFloat(h.amount) || 0;

      if (h.type === 'income') {
        inc += amt;
        pend += parseFloat(h.pendingAmount) || 0;
      } else {
        exp += amt;
      }
    }

    el.innerHTML =
      '<div class="summary-grid">' +
        '<div class="summary-card type-income" onclick="HisabUI.setTypeFilter(\'income\')">' +
          '<div class="summary-value green">' + UI.formatMoney(inc) + '</div>' +
          '<div class="summary-label">Total Income</div></div>' +
        '<div class="summary-card type-expense" onclick="HisabUI.setTypeFilter(\'expense\')">' +
          '<div class="summary-value red">' + UI.formatMoney(exp) + '</div>' +
          '<div class="summary-label">Total Expense</div></div>' +
        '<div class="summary-card type-pending" onclick="HisabUI.setStatusFilter(\'pending\')">' +
          '<div class="summary-value yellow">' + UI.formatMoney(pend) + '</div>' +
          '<div class="summary-label">Pending</div></div>' +
        '<div class="summary-card type-profit">' +
          '<div class="summary-value ' + ((inc - exp) >= 0 ? 'green' : 'red') + '">' +
            UI.formatMoney(inc - exp) + '</div>' +
          '<div class="summary-label">Net Profit</div></div>' +
      '</div>';
  },

  /* Monthly mini stats */
  renderMonthStats: function() {
    var el = UI.$('hisabMonthStats');
    if (!el) return;

    var now = new Date();
    var thisM = now.getMonth();
    var thisY = now.getFullYear();
    var mI = 0, mE = 0, cnt = 0;

    for (var i = 0; i < this._data.length; i++) {
      try {
        var dt = new Date(this._data[i].date);
        if (isNaN(dt.getTime())) continue;
        if (dt.getMonth() !== thisM || dt.getFullYear() !== thisY) continue;

        cnt++;
        var amt = parseFloat(this._data[i].amount) || 0;
        if (this._data[i].type === 'income') mI += amt;
        else mE += amt;
      } catch(e) {}
    }

    el.innerHTML =
      '<div class="stat-card" style="padding:var(--sp-sm)">' +
        '<div class="stat-value" style="font-size:1.05rem;color:var(--success)">' +
          UI.formatMoney(mI) + '</div>' +
        '<div class="stat-label">Month Income</div></div>' +
      '<div class="stat-card" style="padding:var(--sp-sm)">' +
        '<div class="stat-value" style="font-size:1.05rem;color:var(--error)">' +
          UI.formatMoney(mE) + '</div>' +
        '<div class="stat-label">Month Expense</div></div>' +
      '<div class="stat-card" style="padding:var(--sp-sm)">' +
        '<div class="stat-value" style="font-size:1.05rem;color:' +
          ((mI - mE) >= 0 ? 'var(--success)' : 'var(--error)') + '">' +
          UI.formatMoney(mI - mE) + '</div>' +
        '<div class="stat-label">Month Profit</div></div>' +
      '<div class="stat-card" style="padding:var(--sp-sm)">' +
        '<div class="stat-value" style="font-size:1.05rem">' + cnt + '</div>' +
        '<div class="stat-label">Entries</div></div>';
  },
  /* ============================================================
     PART D - BLOCK 4: POOJA-WISE BREAKDOWN
     Grouped by pooja with income/expense categories
     ============================================================ */

  renderPoojaWise: function() {
    var el = UI.$('hPoojaList');
    if (!el) return;

    var timeVal = UI.val('hPoojaTime') || 'all';
    var data = this._filterByTime(this._data, timeVal);

    var sq = (UI.val('hPoojaSearch') || '').toLowerCase();
    if (sq) {
      data = data.filter(function(h) {
        return String(h.poojaName || '').toLowerCase().indexOf(sq) !== -1 ||
          String(h.yajmanName || '').toLowerCase().indexOf(sq) !== -1;
      });
    }

    /* Group by pooja */
    var groups = {};
    for (var i = 0; i < data.length; i++) {
      var h = data[i];
      var key = h.poojaName || '‡§Ö‡§®‡•ç‡§Ø (Other)';

      if (!groups[key]) {
        groups[key] = {
          pooja: key,
          count: 0,
          income: 0,
          expense: 0,
          pending: 0,
          incByCat: {},
          expByCat: {},
          entries: []
        };
      }

      var g = groups[key];
      g.count++;
      var amt = parseFloat(h.amount) || 0;

      if (h.type === 'income') {
        g.income += amt;
        var ic = h.category || 'other_income';
        g.incByCat[ic] = (g.incByCat[ic] || 0) + amt;
      } else {
        g.expense += amt;
        var ec = h.category || 'other_expense';
        g.expByCat[ec] = (g.expByCat[ec] || 0) + amt;
      }
      g.pending += parseFloat(h.pendingAmount) || 0;
      g.entries.push(h);
    }

    var arr = [];
    for (var k in groups) {
      if (groups.hasOwnProperty(k)) arr.push(groups[k]);
    }
    arr.sort(function(a, b) { return b.income - a.income; });

    if (!arr.length) {
      el.innerHTML = '<div class="empty-state">' +
        '<div class="empty-state-icon">üïâÔ∏è</div>' +
        '<div class="empty-state-text">' +
          (sq ? 'No matches found' : 'No hisab data yet') + '</div>' +
        '<button class="btn btn-sm btn-primary" ' +
          'onclick="HisabUI.showAddPooja()">‚ûï Add First Entry</button>' +
      '</div>';
      return;
    }

    var html = '';
    for (var j = 0; j < arr.length; j++) {
      var grp = arr[j];
      var profit = grp.income - grp.expense;
      var sid = 'hpSec_' + j;

      /* Section header */
      html += '<div style="margin-bottom:var(--sp-sm)">';
      html += '<div class="section-header" ' +
        'onclick="var e=UI.$(\''+sid+'\');if(e){e.classList.toggle(\'hide\');' +
          'this.classList.toggle(\'open\')}">' +
        '<span>üïâÔ∏è ' + UI.esc(grp.pooja) +
          ' <span style="font-size:.6rem;color:var(--text-muted)">(' +
            grp.count + '√ó)</span></span>' +
        '<span style="font-size:.75rem;font-weight:700;color:' +
          (profit >= 0 ? 'var(--success)' : 'var(--error)') + '">' +
          UI.formatMoney(profit) + ' ‚ñº</span>' +
      '</div>';

      /* Expandable content */
      html += '<div id="' + sid + '" class="hide" ' +
        'style="padding:var(--sp-md);background:rgba(255,255,255,0.01);' +
          'border:1px solid var(--border);border-top:none;' +
          'border-radius:0 0 var(--r-sm) var(--r-sm)">';

      /* Summary row */
      html += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;' +
        'gap:var(--sp-sm);margin-bottom:var(--sp-md)">' +
        '<div style="text-align:center;padding:var(--sp-sm);' +
          'background:var(--success-bg);border-radius:var(--r-sm)">' +
          '<div style="font-weight:700;color:var(--success);font-size:.88rem">' +
            UI.formatMoney(grp.income) + '</div>' +
          '<div style="font-size:.55rem;color:var(--text-muted)">INCOME</div></div>' +
        '<div style="text-align:center;padding:var(--sp-sm);' +
          'background:var(--error-bg);border-radius:var(--r-sm)">' +
          '<div style="font-weight:700;color:var(--error);font-size:.88rem">' +
            UI.formatMoney(grp.expense) + '</div>' +
          '<div style="font-size:.55rem;color:var(--text-muted)">EXPENSE</div></div>' +
        '<div style="text-align:center;padding:var(--sp-sm);' +
          'background:rgba(255,111,0,0.05);border-radius:var(--r-sm)">' +
          '<div style="font-weight:700;color:' +
            (profit >= 0 ? 'var(--success)' : 'var(--error)') +
            ';font-size:.88rem">' + UI.formatMoney(profit) + '</div>' +
          '<div style="font-size:.55rem;color:var(--text-muted)">PROFIT</div></div>' +
      '</div>';

      /* Income breakdown */
      html += this._renderCatBreakdown('income', grp.incByCat);

      /* Expense breakdown */
      html += this._renderCatBreakdown('expense', grp.expByCat);

      /* Pending warning */
      if (grp.pending > 0) {
        html += '<div style="padding:var(--sp-xs) var(--sp-sm);' +
          'background:var(--warning-bg);border-radius:var(--r-sm);' +
          'margin-bottom:var(--sp-sm);font-size:.72rem;color:var(--warning)">' +
          '‚ö†Ô∏è Pending: ' + UI.formatMoney(grp.pending) + '</div>';
      }

      /* Recent entries */
      var ents = grp.entries.slice().reverse();
      var showMax = Math.min(ents.length, 5);

      for (var e = 0; e < showMax; e++) {
        var en = ents[e];
        var isI = en.type === 'income';
        var ec = this._catInfo(en.type, en.category);

        html += '<div style="display:flex;align-items:center;gap:var(--sp-sm);' +
          'padding:var(--sp-xs) 0;border-bottom:1px solid var(--border);' +
          'font-size:.75rem">' +
          '<span style="color:' + (isI ? 'var(--success)' : 'var(--error)') + '">' +
            ec.icon + '</span>' +
          '<span style="flex:1;color:var(--text-secondary);overflow:hidden;' +
            'text-overflow:ellipsis;white-space:nowrap">' +
            UI.esc(en.yajmanName || en.description || ec.label) +
            ' ‚Ä¢ ' + UI.formatDate(en.date) + '</span>' +
          '<span style="font-weight:700;color:' +
            (isI ? 'var(--success)' : 'var(--error)') + '">' +
            (isI ? '+' : '-') + UI.formatMoney(en.amount) + '</span>' +
        '</div>';
      }

      if (ents.length > showMax) {
        html += '<div style="text-align:center;padding:var(--sp-xs);' +
          'font-size:.65rem;color:var(--text-muted)">+' +
          (ents.length - showMax) + ' more entries</div>';
      }

      html += '</div></div>';
    }

    el.innerHTML = html;
  },

  /* Helper: Category breakdown HTML */
  _renderCatBreakdown: function(type, catMap) {
    var keys = Object.keys(catMap);
    if (!keys.length) return '';

    var isInc = type === 'income';
    var html = '<div style="margin-bottom:var(--sp-sm)">' +
      '<div style="font-size:.68rem;font-weight:600;color:' +
        (isInc ? 'var(--success)' : 'var(--error)') + ';' +
        'margin-bottom:var(--sp-xs)">' +
        (isInc ? 'üí∞ Income' : 'üì§ Expense') + ' Breakdown:</div>';

    for (var i = 0; i < keys.length; i++) {
      var ci = this._catInfo(type, keys[i]);
      html += '<div style="display:flex;justify-content:space-between;' +
        'padding:2px var(--sp-sm);font-size:.72rem;' +
        'border-bottom:1px solid var(--border)">' +
        '<span style="color:var(--text-secondary)">' +
          ci.icon + ' ' + ci.label + '</span>' +
        '<span style="color:' + (isInc ? 'var(--success)' : 'var(--error)') +
          ';font-weight:600">' + UI.formatMoney(catMap[keys[i]]) + '</span>' +
      '</div>';
    }

    html += '</div>';
    return html;
  },
  /* ============================================================
     PART D - BLOCK 5: ALL TRANSACTIONS LIST
     Filtered, searchable list of all entries
     ============================================================ */

  renderTransactions: function() {
    var el = UI.$('hTxnList');
    if (!el) return;

    var list = this._data.slice();

    /* Apply filters */
    var ft = UI.val('hTxnType') || 'all';
    var fs = UI.val('hTxnStatus') || 'all';
    var fc = UI.val('hTxnCat') || 'all';
    var fq = (UI.val('hTxnSearch') || '').toLowerCase();

    if (ft !== 'all') {
      list = list.filter(function(h) { return h.type === ft; });
    }
    if (fs !== 'all') {
      list = list.filter(function(h) { return h.paymentStatus === fs; });
    }
    if (fc !== 'all') {
      list = list.filter(function(h) { return h.category === fc; });
    }
    if (fq) {
      list = list.filter(function(h) {
        return String(h.yajmanName || '').toLowerCase().indexOf(fq) !== -1 ||
          String(h.poojaName || '').toLowerCase().indexOf(fq) !== -1 ||
          String(h.description || '').toLowerCase().indexOf(fq) !== -1;
      });
    }

    /* Newest first */
    list = list.reverse();

    if (!list.length) {
      el.innerHTML = '<div class="empty-state">' +
        '<div class="empty-state-icon">üí∞</div>' +
        '<div class="empty-state-text">' +
          (fq || ft !== 'all' || fs !== 'all' || fc !== 'all' ?
            'No matching entries' : 'No entries yet') + '</div>' +
        '<div style="display:flex;gap:var(--sp-sm);justify-content:center">' +
          '<button class="btn btn-sm btn-success" ' +
            'onclick="HisabUI.showAddSingle(\'income\')">‚ûï Income</button>' +
          '<button class="btn btn-sm btn-danger" ' +
            'onclick="HisabUI.showAddSingle(\'expense\')">‚ûï Expense</button>' +
        '</div>' +
      '</div>';
      return;
    }

    var html = '';
    var maxShow = 50; // Performance limit

    for (var i = 0; i < Math.min(list.length, maxShow); i++) {
      var h = list[i];
      var isI = h.type === 'income';
      var ci = this._catInfo(h.type, h.category);
      var stBadge = h.paymentStatus === 'paid' ? 'badge-success' :
        h.paymentStatus === 'partial' ? 'badge-warning' : 'badge-error';

      html += '<div class="list-row">' +
        '<div class="list-row-icon" style="background:' +
          (isI ? 'var(--success-bg)' : 'var(--error-bg)') + '">' +
          ci.icon + '</div>' +
        '<div class="list-row-body">' +
          '<div class="list-row-title">' +
            UI.esc(h.yajmanName || h.description || ci.label) +
            ' <span style="font-size:.55rem;color:var(--text-muted);' +
              'background:var(--bg-elevated);padding:1px 5px;' +
              'border-radius:var(--r-full)">' + ci.label + '</span>' +
          '</div>' +
          '<div class="list-row-meta">' +
            UI.formatDate(h.date) +
            (h.poojaName ? ' ‚Ä¢ üïâÔ∏è ' + UI.esc(h.poojaName) : '') +
            ' ‚Ä¢ <span class="badge ' + stBadge + '">' +
              (h.paymentStatus || 'pending') + '</span>' +
          '</div>' +
        '</div>' +
        '<div class="list-row-right">' +
          '<div style="font-weight:800;font-size:.9rem;color:' +
            (isI ? 'var(--success)' : 'var(--error)') + '">' +
            (isI ? '+' : '-') + UI.formatMoney(h.amount) + '</div>' +
          (parseFloat(h.pendingAmount) > 0 ?
            '<div style="font-size:.58rem;color:var(--warning)">' +
              '‚Çπ' + h.pendingAmount + ' due</div>' : '') +
        '</div>' +
        '<div class="list-row-actions" style="flex-direction:column;gap:2px">' +
          (parseFloat(h.pendingAmount) > 0 ?
            '<button class="btn btn-xs btn-success" ' +
              'onclick="HisabUI.markPaid(\'' + h.id + '\')" title="Mark Paid">‚úÖ</button>' : '') +
          '<button class="btn btn-xs btn-ghost" ' +
            'onclick="HisabUI.showEditEntry(\'' + h.id + '\')" title="Edit">‚úèÔ∏è</button>' +
          '<button class="btn btn-xs btn-danger" style="padding:3px 5px" ' +
            'onclick="HisabUI.deleteEntry(\'' + h.id + '\')" title="Delete">üóëÔ∏è</button>' +
        '</div>' +
      '</div>';
    }

    if (list.length > maxShow) {
      html += '<div style="text-align:center;padding:var(--sp-md);' +
        'color:var(--text-muted);font-size:.75rem">' +
        'Showing ' + maxShow + ' of ' + list.length + ' entries. ' +
        'Use filters to narrow down.</div>';
    }

    el.innerHTML = html;
  },

  /* Filter shortcuts (called from summary cards) */
  setTypeFilter: function(type) {
    UI.setVal('hTxnType', type);
    UI.setVal('hTxnStatus', 'all');
    UI.setVal('hTxnCat', 'all');
    UI.setVal('hTxnSearch', '');
    this.renderTransactions();

    /* Scroll to transactions */
    var el = UI.$('hTxnList');
    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
  },

  setStatusFilter: function(status) {
    UI.setVal('hTxnType', 'all');
    UI.setVal('hTxnStatus', status);
    UI.setVal('hTxnCat', 'all');
    UI.setVal('hTxnSearch', '');
    this.renderTransactions();

    var el = UI.$('hTxnList');
    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
  },
  /* ============================================================
     PART D - BLOCK 6: ADD COMPLETE POOJA ENTRY
     Multi Income + Multi Expense in one form
     ============================================================ */

  showAddPooja: function() {

    /* Build yajman options */
    var yO = '<option value="">‚Äî Select Yajman ‚Äî</option>';
    var yajmans = App.D.yajmans || [];
    for (var i = 0; i < yajmans.length; i++) {
      yO += '<option value="' + yajmans[i].id + '">' +
        UI.esc(yajmans[i].name) + '</option>';
    }

    /* Build pooja options */
    var pList = App.getUniquePoojas();
    var pO = '<option value="">‚Äî Select Pooja ‚Äî</option>';
    for (var j = 0; j < pList.length; j++) {
      pO += '<option value="' + UI.esc(pList[j]) + '">' +
        UI.esc(pList[j]) + '</option>';
    }

    var today = UI.today();

    var body =
      /* Info banner */
      '<div class="info-banner">' +
        'üìå ‡§¶‡§ï‡•ç‡§∑‡§ø‡§£‡§æ, ‡§ö‡§¢‡§º‡§æ‡§µ‡§æ (income) + ‡§∏‡§æ‡§Æ‡§æ‡§®, ‡§Ö‡§®‡•ç‡§Ø ‡§™‡§Ç‡§ú‡•Ä, ‡§Æ‡§Ç‡§¶‡§ø‡§∞ ' +
        '(expenses) ‚Äî ‡§∏‡§¨ ‡§è‡§ï ‡§∏‡§æ‡§• add ‡§ï‡§∞‡•á‡§Ç</div>' +

      /* Date + Pooja */
      '<div class="form-row">' +
        '<div class="form-group">' +
          '<label class="form-label">Date *</label>' +
          '<input class="form-input" id="hpDate" type="date" value="' + today + '">' +
        '</div>' +
        '<div class="form-group">' +
          '<label class="form-label">Pooja *</label>' +
          '<select class="form-select" id="hpPooja">' + pO + '</select>' +
        '</div>' +
      '</div>' +

      /* Yajman */
      '<div class="form-group">' +
        '<label class="form-label">Yajman</label>' +
        '<select class="form-select" id="hpYaj">' + yO + '</select>' +
      '</div>' +

      /* ---- INCOME SECTION ---- */
      '<div style="margin-top:var(--sp-md);padding:var(--sp-sm) var(--sp-md);' +
        'background:var(--success-bg);border-radius:var(--r-sm);' +
        'border-left:3px solid var(--success);font-weight:700;' +
        'color:var(--success);font-size:.82rem;margin-bottom:var(--sp-sm)">' +
        'üí∞ Income (‡§Ü‡§Ø)</div>' +

      '<div class="form-row">' +
        '<div class="form-group">' +
          '<label class="form-label">üôè ‡§¶‡§ï‡•ç‡§∑‡§ø‡§£‡§æ ‚Çπ</label>' +
          '<input class="form-input" id="hpDakshina" type="number" ' +
            'placeholder="‚Çπ" inputmode="numeric" oninput="HisabUI._calcTotals()">' +
        '</div>' +
        '<div class="form-group">' +
          '<label class="form-label">ü™∑ ‡§ö‡§¢‡§º‡§æ‡§µ‡§æ ‚Çπ</label>' +
          '<input class="form-input" id="hpChadawa" type="number" ' +
            'placeholder="‚Çπ" inputmode="numeric" oninput="HisabUI._calcTotals()">' +
        '</div>' +
      '</div>' +

      '<div class="form-row">' +
        '<div class="form-group">' +
          '<label class="form-label">üíù ‡§¶‡§æ‡§® ‚Çπ</label>' +
          '<input class="form-input" id="hpDonation" type="number" ' +
            'placeholder="‚Çπ" inputmode="numeric" oninput="HisabUI._calcTotals()">' +
        '</div>' +
        '<div class="form-group">' +
          '<label class="form-label">üí∞ ‡§Ö‡§®‡•ç‡§Ø ‡§Ü‡§Ø ‚Çπ</label>' +
          '<input class="form-input" id="hpOtherInc" type="number" ' +
            'placeholder="‚Çπ" inputmode="numeric" oninput="HisabUI._calcTotals()">' +
        '</div>' +
      '</div>' +

      '<div style="text-align:right;font-size:.78rem;color:var(--success);' +
        'font-weight:700;padding:var(--sp-xs) var(--sp-sm);' +
        'background:rgba(0,200,83,0.03);border-radius:var(--r-sm);' +
        'margin-bottom:var(--sp-md)">' +
        'Total Income: <span id="hpTotalInc">‚Çπ0</span></div>' +

      /* ---- EXPENSE SECTION ---- */
      '<div style="padding:var(--sp-sm) var(--sp-md);' +
        'background:var(--error-bg);border-radius:var(--r-sm);' +
        'border-left:3px solid var(--error);font-weight:700;' +
        'color:var(--error);font-size:.82rem;margin-bottom:var(--sp-sm)">' +
        'üì§ Expense (‡§ñ‡§∞‡•ç‡§ö)</div>' +

      '<div class="form-row">' +
        '<div class="form-group">' +
          '<label class="form-label">üì¶ ‡§∏‡§æ‡§Æ‡§æ‡§® ‚Çπ</label>' +
          '<input class="form-input" id="hpSaman" type="number" ' +
            'placeholder="‚Çπ" inputmode="numeric" oninput="HisabUI._calcTotals()">' +
        '</div>' +
        '<div class="form-group">' +
          '<label class="form-label">üë®‚Äçüè´ ‡§Ö‡§®‡•ç‡§Ø ‡§™‡§Ç‡§ú‡•Ä ‚Çπ</label>' +
          '<input class="form-input" id="hpOtherPanji" type="number" ' +
            'placeholder="‚Çπ" inputmode="numeric" oninput="HisabUI._calcTotals()">' +
        '</div>' +
      '</div>' +

      '<div class="form-row">' +
        '<div class="form-group">' +
          '<label class="form-label">üõï ‡§Æ‡§Ç‡§¶‡§ø‡§∞ ‚Çπ</label>' +
          '<input class="form-input" id="hpTemple" type="number" ' +
            'placeholder="‚Çπ" inputmode="numeric" oninput="HisabUI._calcTotals()">' +
        '</div>' +
        '<div class="form-group">' +
          '<label class="form-label">üöó ‡§Ø‡§æ‡§§‡•ç‡§∞‡§æ ‚Çπ</label>' +
          '<input class="form-input" id="hpTravel" type="number" ' +
            'placeholder="‚Çπ" inputmode="numeric" oninput="HisabUI._calcTotals()">' +
        '</div>' +
      '</div>' +

      '<div class="form-row">' +
        '<div class="form-group">' +
          '<label class="form-label">üç≤ ‡§™‡•ç‡§∞‡§∏‡§æ‡§¶ ‚Çπ</label>' +
          '<input class="form-input" id="hpPrasad" type="number" ' +
            'placeholder="‚Çπ" inputmode="numeric" oninput="HisabUI._calcTotals()">' +
        '</div>' +
        '<div class="form-group">' +
          '<label class="form-label">üì§ ‡§Ö‡§®‡•ç‡§Ø ‡§ñ‡§∞‡•ç‡§ö ‚Çπ</label>' +
          '<input class="form-input" id="hpOtherExp" type="number" ' +
            'placeholder="‚Çπ" inputmode="numeric" oninput="HisabUI._calcTotals()">' +
        '</div>' +
      '</div>' +

      '<div style="text-align:right;font-size:.78rem;color:var(--error);' +
        'font-weight:700;padding:var(--sp-xs) var(--sp-sm);' +
        'background:rgba(255,23,68,0.03);border-radius:var(--r-sm);' +
        'margin-bottom:var(--sp-md)">' +
        'Total Expense: <span id="hpTotalExp">‚Çπ0</span></div>' +

      /* ---- PROFIT DISPLAY ---- */
      '<div style="text-align:center;padding:var(--sp-md);' +
        'background:rgba(255,111,0,0.04);border-radius:var(--r-lg);' +
        'border:1px solid rgba(255,111,0,0.12);margin-bottom:var(--sp-md)">' +
        '<div style="font-size:.65rem;color:var(--text-muted);' +
          'text-transform:uppercase">NET PROFIT (‡§∂‡•Å‡§¶‡•ç‡§ß ‡§≤‡§æ‡§≠)</div>' +
        '<div style="font-size:1.4rem;font-weight:800;color:var(--success)" ' +
          'id="hpProfit">‚Çπ0</div>' +
      '</div>' +

      /* Status + Mode */
      '<div class="form-row">' +
        '<div class="form-group">' +
          '<label class="form-label">Payment Status</label>' +
          '<select class="form-select" id="hpPayStatus">' +
            '<option value="paid">‚úÖ Paid (‡§™‡•Ç‡§∞‡§æ ‡§Æ‡§ø‡§≤‡§æ)</option>' +
            '<option value="partial">‚è≥ Partial (‡§ï‡•Å‡§õ ‡§¨‡§æ‡§ï‡•Ä)</option>' +
            '<option value="pending">‚ùå Pending (‡§¨‡§æ‡§ï‡•Ä ‡§π‡•à)</option>' +
          '</select>' +
        '</div>' +
        '<div class="form-group">' +
          '<label class="form-label">Payment Mode</label>' +
          '<select class="form-select" id="hpPayMode">' +
            '<option value="cash">üíµ Cash</option>' +
            '<option value="upi">üì± UPI</option>' +
            '<option value="bank">üè¶ Bank</option>' +
            '<option value="mixed">üîÑ Mixed</option>' +
          '</select>' +
        '</div>' +
      '</div>' +

      /* Notes */
      '<div class="form-group">' +
        '<label class="form-label">Notes</label>' +
        '<input class="form-input" id="hpNotes" placeholder="‡§Ö‡§§‡§ø‡§∞‡§ø‡§ï‡•ç‡§§ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä">' +
      '</div>';

    var footer =
      '<button class="btn btn-ghost" onclick="UI.closeModal(\'mHisabPooja\')">' +
        'Cancel</button>' +
      '<button class="btn btn-primary" onclick="HisabUI.savePooja()">' +
        'üíæ Save Pooja Hisab</button>';

    UI.createModal('mHisabPooja', {
      title: 'üïâÔ∏è Complete Pooja Hisab',
      body: body,
      footer: footer,
      maxWidth: '580px'
    });
  },

  /* Auto-calculate totals */
  _calcTotals: function() {
    var incIds = ['hpDakshina', 'hpChadawa', 'hpDonation', 'hpOtherInc'];
    var expIds = ['hpSaman', 'hpOtherPanji', 'hpTemple', 'hpTravel',
                  'hpPrasad', 'hpOtherExp'];
    var ti = 0, te = 0;

    for (var a = 0; a < incIds.length; a++) {
      var el = UI.$(incIds[a]);
      if (el) ti += parseFloat(el.value) || 0;
    }
    for (var b = 0; b < expIds.length; b++) {
      var el2 = UI.$(expIds[b]);
      if (el2) te += parseFloat(el2.value) || 0;
    }

    UI.text('hpTotalInc', '‚Çπ' + ti.toLocaleString('en-IN'));
    UI.text('hpTotalExp', '‚Çπ' + te.toLocaleString('en-IN'));

    var profEl = UI.$('hpProfit');
    if (profEl) {
      var profit = ti - te;
      profEl.textContent = '‚Çπ' + profit.toLocaleString('en-IN');
      profEl.style.color = profit >= 0 ?
        'var(--success)' : 'var(--error)';
    }
  },

  /* Save complete pooja entry */
  savePooja: function() {
    var pooja = UI.val('hpPooja');
    if (!pooja) { UI.toast('Required', 'Select a pooja', 'warn'); return; }

    var date = UI.val('hpDate');
    var ySelEl = UI.$('hpYaj');
    var yId = '', yN = '';
    if (ySelEl && ySelEl.value) {
      yId = ySelEl.value;
      yN = ySelEl.options[ySelEl.selectedIndex].text;
    }

    var notes = UI.val('hpNotes');
    var ps = UI.val('hpPayStatus');
    var pm = UI.val('hpPayMode');

    /* Build entries */
    var entries = [];

    var incFields = [
      { id: 'hpDakshina',  cat: 'dakshina',     l: '‡§¶‡§ï‡•ç‡§∑‡§ø‡§£‡§æ' },
      { id: 'hpChadawa',   cat: 'chadawa',      l: '‡§ö‡§¢‡§º‡§æ‡§µ‡§æ' },
      { id: 'hpDonation',  cat: 'donation',     l: '‡§¶‡§æ‡§®' },
      { id: 'hpOtherInc',  cat: 'other_income', l: '‡§Ö‡§®‡•ç‡§Ø ‡§Ü‡§Ø' }
    ];

    for (var i = 0; i < incFields.length; i++) {
      var el = UI.$(incFields[i].id);
      var amt = el ? parseFloat(el.value) || 0 : 0;
      if (amt > 0) {
        entries.push({
          date: date, type: 'income', category: incFields[i].cat,
          amount: amt,
          receivedAmount: ps === 'paid' ? amt : 0,
          pendingAmount: ps === 'paid' ? 0 : amt,
          yajmanId: yId, yajmanName: yN,
          poojaName: pooja, description: incFields[i].l,
          paymentMode: pm, paymentStatus: ps, notes: notes
        });
      }
    }

    var expFields = [
      { id: 'hpSaman',      cat: 'saman',         l: '‡§∏‡§æ‡§Æ‡§æ‡§® ‡§ñ‡§∞‡•ç‡§ö' },
      { id: 'hpOtherPanji', cat: 'other_panji',   l: '‡§Ö‡§®‡•ç‡§Ø ‡§™‡§Ç‡§ú‡•Ä ‡§ï‡•ã ‡§¶‡§ø‡§Ø‡•á' },
      { id: 'hpTemple',     cat: 'temple',        l: '‡§Æ‡§Ç‡§¶‡§ø‡§∞ ‡§Æ‡•á‡§Ç ‡§¶‡§ø‡§Ø‡•á' },
      { id: 'hpTravel',     cat: 'travel',        l: '‡§Ø‡§æ‡§§‡•ç‡§∞‡§æ ‡§ñ‡§∞‡•ç‡§ö' },
      { id: 'hpPrasad',     cat: 'prasad',        l: '‡§™‡•ç‡§∞‡§∏‡§æ‡§¶' },
      { id: 'hpOtherExp',   cat: 'other_expense', l: '‡§Ö‡§®‡•ç‡§Ø ‡§ñ‡§∞‡•ç‡§ö' }
    ];

    for (var j = 0; j < expFields.length; j++) {
      var el2 = UI.$(expFields[j].id);
      var eAmt = el2 ? parseFloat(el2.value) || 0 : 0;
      if (eAmt > 0) {
        entries.push({
          date: date, type: 'expense', category: expFields[j].cat,
          amount: eAmt,
          receivedAmount: 0, pendingAmount: 0,
          yajmanId: yId, yajmanName: yN,
          poojaName: pooja, description: expFields[j].l,
          paymentMode: pm, paymentStatus: 'paid', notes: notes
        });
      }
    }

    if (!entries.length) {
      UI.toast('Empty', 'Enter at least one amount', 'warn');
      return;
    }

    UI.closeModal('mHisabPooja');
    UI.load('Saving ' + entries.length + ' entries...');

    var self = this;

    /* Try bulk, fallback to one-by-one */
    API.post({ action: 'addBulkHisab', entries: entries })
      .then(function(r) {
        if (r.error) return self._saveSequential(entries);
        return 'done';
      })
      .catch(function() {
        return self._saveSequential(entries);
      })
      .then(function() {
        UI.unload();
        UI.toast('Saved!', entries.length + ' entries for ' + pooja, 'ok');
        self._refresh();
      })
      .catch(function(e) {
        UI.unload();
        UI.toast('Error', e.message, 'error');
      });
  },

  /* Sequential save fallback */
  _saveSequential: function(entries) {
    var chain = Promise.resolve();
    for (var i = 0; i < entries.length; i++) {
      (function(entry) {
        chain = chain.then(function() {
          entry.action = 'addHisab';
          return API.post(entry);
        });
      })(entries[i]);
    }
    return chain;
  },
  /* ============================================================
     PART D - BLOCK 7: ADD SINGLE ENTRY
     Quick income or expense entry
     ============================================================ */

  showAddSingle: function(type, preYajId) {
    var isIncome = (type === 'income');

    /* Yajman options */
    var yO = '<option value="">‚Äî Select Yajman ‚Äî</option>';
    var yajmans = App.D.yajmans || [];
    for (var i = 0; i < yajmans.length; i++) {
      var y = yajmans[i];
      yO += '<option value="' + y.id + '"' +
        (preYajId === y.id ? ' selected' : '') + '>' +
        UI.esc(y.name) + '</option>';
    }

    /* Category options */
    var cats = isIncome ? CFG.HISAB_CATS.income : CFG.HISAB_CATS.expense;
    var cO = '';
    for (var c = 0; c < cats.length; c++) {
      cO += '<option value="' + cats[c].id + '">' +
        cats[c].icon + ' ' + cats[c].label + '</option>';
    }

    /* Pooja datalist */
    var pList = App.getUniquePoojas();
    var pDL = '';
    for (var p = 0; p < pList.length; p++) {
      pDL += '<option value="' + UI.esc(pList[p]) + '">';
    }

    var today = UI.today();

    var body =
      '<input type="hidden" id="hsType" value="' + type + '">' +
      '<input type="hidden" id="hsEditId" value="">' +

      /* Type indicator */
      '<div style="padding:var(--sp-sm) var(--sp-md);background:' +
        (isIncome ? 'var(--success-bg)' : 'var(--error-bg)') +
        ';border-radius:var(--r-sm);margin-bottom:var(--sp-md);' +
        'border-left:3px solid ' + (isIncome ? 'var(--success)' : 'var(--error)') + '">' +
        '<div style="font-weight:700;color:' +
          (isIncome ? 'var(--success)' : 'var(--error)') + ';font-size:.85rem">' +
          (isIncome ? 'üí∞ Income Entry' : 'üì§ Expense Entry') + '</div>' +
        '<div style="font-size:.62rem;color:var(--text-muted)">' +
          (isIncome ? '‡§¶‡§ï‡•ç‡§∑‡§ø‡§£‡§æ, ‡§ö‡§¢‡§º‡§æ‡§µ‡§æ, ‡§¶‡§æ‡§® ‡§Ü‡§¶‡§ø' : '‡§∏‡§æ‡§Æ‡§æ‡§®, ‡§Ö‡§®‡•ç‡§Ø ‡§™‡§Ç‡§ú‡•Ä, ‡§Æ‡§Ç‡§¶‡§ø‡§∞ ‡§Ü‡§¶‡§ø') +
        '</div>' +
      '</div>' +

      '<div class="form-row">' +
        '<div class="form-group">' +
          '<label class="form-label">Date *</label>' +
          '<input class="form-input" id="hsDate" type="date" value="' + today + '">' +
        '</div>' +
        '<div class="form-group">' +
          '<label class="form-label">Amount ‚Çπ *</label>' +
          '<input class="form-input" id="hsAmt" type="number" ' +
            'placeholder="‚Çπ ‡§∞‡§æ‡§∂‡§ø" inputmode="numeric">' +
        '</div>' +
      '</div>' +

      '<div class="form-group">' +
        '<label class="form-label">Category *</label>' +
        '<select class="form-select" id="hsCat">' + cO + '</select>' +
      '</div>' +

      '<div class="form-group">' +
        '<label class="form-label">Yajman</label>' +
        '<select class="form-select" id="hsYaj">' + yO + '</select>' +
      '</div>' +

      '<div class="form-group">' +
        '<label class="form-label">Pooja</label>' +
        '<input class="form-input" id="hsPooja" placeholder="Type or select" ' +
          'list="hsPjDL">' +
        '<datalist id="hsPjDL">' + pDL + '</datalist>' +
      '</div>' +

      '<div class="form-group">' +
        '<label class="form-label">Description</label>' +
        '<input class="form-input" id="hsDesc" placeholder="‡§µ‡§ø‡§µ‡§∞‡§£">' +
      '</div>' +

      '<div class="form-row">';

    if (isIncome) {
      body += '<div class="form-group">' +
        '<label class="form-label">Received ‚Çπ</label>' +
        '<input class="form-input" id="hsRec" type="number" ' +
          'placeholder="‚Çπ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§" inputmode="numeric">' +
      '</div>';
    } else {
      body += '<div class="form-group">' +
        '<label class="form-label">Paid To (‡§ï‡§ø‡§∏‡§ï‡•ã)</label>' +
        '<input class="form-input" id="hsPaidTo" placeholder="‡§ï‡§ø‡§∏‡§ï‡•ã ‡§¶‡§ø‡§Ø‡§æ">' +
        '<input type="hidden" id="hsRec" value="0">' +
      '</div>';
    }

    body += '<div class="form-group">' +
        '<label class="form-label">Payment Mode</label>' +
        '<select class="form-select" id="hsMode">' +
          '<option value="cash">üíµ Cash</option>' +
          '<option value="upi">üì± UPI</option>' +
          '<option value="bank">üè¶ Bank</option>' +
          '<option value="other">Other</option>' +
        '</select>' +
      '</div>' +
    '</div>' +

    '<div class="form-group">' +
      '<label class="form-label">Notes</label>' +
      '<input class="form-input" id="hsNotes" placeholder="‡§Ö‡§§‡§ø‡§∞‡§ø‡§ï‡•ç‡§§ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä">' +
    '</div>';

    var footer =
      '<button class="btn btn-ghost" onclick="UI.closeModal(\'mHisabSingle\')">' +
        'Cancel</button>' +
      '<button class="btn btn-primary" onclick="HisabUI.saveSingle()">' +
        'üíæ Save</button>';

    UI.createModal('mHisabSingle', {
      title: isIncome ? 'üí∞ Add Income' : 'üì§ Add Expense',
      body: body,
      footer: footer
    });
  },

  /* Save single entry */
  saveSingle: function() {
    var amt = UI.val('hsAmt');
    if (!amt) { UI.toast('Required', 'Enter amount', 'warn'); return; }

    var ySelEl = UI.$('hsYaj');
    var yId = '', yN = '';
    if (ySelEl && ySelEl.value) {
      yId = ySelEl.value;
      yN = ySelEl.options[ySelEl.selectedIndex].text;
    }

    var editId = UI.val('hsEditId');
    var received = parseFloat(UI.val('hsRec')) || 0;
    var amount = parseFloat(amt) || 0;
    var type = UI.val('hsType');
    var desc = UI.val('hsDesc');

    // For expense, check paidTo
    var paidToEl = UI.$('hsPaidTo');
    if (paidToEl && paidToEl.value.trim() && !desc) {
      desc = 'Paid to: ' + paidToEl.value.trim();
    }

    UI.closeModal('mHisabSingle');
    UI.load(editId ? 'Updating...' : 'Saving...');

    var self = this;
    var payload = {
      action: editId ? 'updateHisab' : 'addHisab',
      date: UI.val('hsDate'),
      type: type,
      category: UI.val('hsCat'),
      amount: amount,
      receivedAmount: received,
      pendingAmount: Math.max(0, amount - received),
      yajmanId: yId,
      yajmanName: yN,
      poojaName: UI.val('hsPooja'),
      description: desc,
      paymentMode: UI.val('hsMode'),
      paymentStatus: received >= amount ? 'paid' :
        received > 0 ? 'partial' : 'pending',
      notes: UI.val('hsNotes')
    };
    if (editId) payload.id = editId;

    API.post(payload).then(function(r) {
      UI.unload();
      if (r.error) { UI.toast('Error', r.error, 'error'); return; }
      UI.toast('Saved!', 'Entry ' + (editId ? 'updated' : 'added'), 'ok');
      self._refresh();
    }).catch(function(e) {
      UI.unload();
      UI.toast('Error', e.message, 'error');
    });
  },
  /* ============================================================
     PART D - BLOCK 8: EDIT, DELETE, MARK PAID, PDF
     Entry operations and export
     ============================================================ */

  /* Edit existing entry */
  showEditEntry: function(entryId) {
    var h = null;
    for (var i = 0; i < this._data.length; i++) {
      if (this._data[i].id === entryId) { h = this._data[i]; break; }
    }
    if (!h) { UI.toast('Error', 'Entry not found', 'error'); return; }

    /* Open the add form with pre-filled data */
    this.showAddSingle(h.type, h.yajmanId);

    /* Fill values after modal opens */
    setTimeout(function() {
      UI.setVal('hsEditId', h.id);
      UI.setVal('hsDate', h.date || '');
      UI.setVal('hsAmt', h.amount || '');
      UI.setVal('hsCat', h.category || '');
      UI.setVal('hsPooja', h.poojaName || '');
      UI.setVal('hsDesc', h.description || '');
      UI.setVal('hsRec', h.receivedAmount || '');
      UI.setVal('hsMode', h.paymentMode || 'cash');
      UI.setVal('hsNotes', h.notes || '');

      /* Update modal title */
      var titleEl = document.querySelector('#mHisabSingle .modal-title');
      if (titleEl) titleEl.textContent = '‚úèÔ∏è Edit Entry';
    }, 250);
  },

  /* Mark entry as paid */
  markPaid: function(id) {
    UI.confirm('Mark Paid', 'Mark this entry as fully paid?', function() {
      UI.load('Updating...');
      API.post({ action: 'markPaid', id: id }).then(function(r) {
        UI.unload();
        if (r && r.error) { UI.toast('Error', r.error, 'error'); return; }
        UI.toast('Done', 'Marked as paid ‚úÖ', 'ok');
        HisabUI._refresh();
      }).catch(function(e) {
        UI.unload();
        UI.toast('Error', e.message, 'error');
      });
    });
  },

  /* Delete entry */
  deleteEntry: function(id) {
    UI.confirm('Delete Entry', 'This will permanently remove this entry.', function() {
      UI.load('Deleting...');
      API.post({ action: 'deleteHisab', id: id }).then(function(r) {
        UI.unload();
        if (r && r.error) { UI.toast('Error', r.error, 'error'); return; }
        UI.toast('Deleted', 'Entry removed', 'ok');
        HisabUI._refresh();
      }).catch(function(e) {
        UI.unload();
        UI.toast('Error', e.message, 'error');
      });
    });
  },

  /* ---- External Access Methods ---- */

  /* Called from Yajman detail */
  filterByYajman: function(yajId) {
    Nav.go('hisab');
    var self = this;
    setTimeout(function() {
      var y = App.findYajman(yajId);
      if (y) {
        UI.setVal('hTxnType', 'all');
        UI.setVal('hTxnStatus', 'all');
        UI.setVal('hTxnCat', 'all');
        UI.setVal('hTxnSearch', y.name);
        self.renderTransactions();
      }
    }, 500);
  },

  /* ============================================================
     HISAB PDF EXPORT
     ============================================================ */

  downloadPDF: function() {
    if (!this._data || !this._data.length) {
      UI.toast('Empty', 'No data to export', 'warn');
      return;
    }

    if (!PDFEngine.checkPDFAllowed()) return;

    /* Group data by pooja */
    var groups = {};
    for (var i = 0; i < this._data.length; i++) {
      var h = this._data[i];
      var k = h.poojaName || '‡§Ö‡§®‡•ç‡§Ø';
      if (!groups[k]) groups[k] = { p: k, inc: 0, exp: 0, ent: [] };
      if (h.type === 'income') groups[k].inc += parseFloat(h.amount) || 0;
      else groups[k].exp += parseFloat(h.amount) || 0;
      groups[k].ent.push(h);
    }

    /* Build HTML for PDF */
    var pi = PDFEngine.getPanditInfo();
    var isPro = Subscription.isPro();

    var html = '<div id="hisabPdfNode" style="width:700px;' +
      'font-family:Noto Sans Devanagari,sans-serif;' +
      'padding:20px;background:#fff;color:#000;position:relative">';

    /* Watermark */
    if (!isPro) {
      html += '<div style="position:absolute;top:45%;left:50%;' +
        'transform:translate(-50%,-50%) rotate(-35deg);' +
        'font-size:48px;color:rgba(255,111,0,0.04);font-weight:900;' +
        'white-space:nowrap;pointer-events:none;z-index:1">' +
        '‡§∂‡•Å‡§≠‡§æ‡§∞‡§Ç‡§≠ FREE</div>';
    }

    html += PDFEngine.buildHeader();
    html += '<h3 style="text-align:center;color:#E65100;' +
      'margin-bottom:14px;position:relative;z-index:2">' +
      '‡§π‡§ø‡§∏‡§æ‡§¨ ‡§ï‡§ø‡§§‡§æ‡§¨</h3>';

    var arr = [];
    for (var k2 in groups) {
      if (groups.hasOwnProperty(k2)) arr.push(groups[k2]);
    }
    arr.sort(function(a, b) { return b.inc - a.inc; });

    var grandInc = 0, grandExp = 0;

    for (var g = 0; g < arr.length; g++) {
      var gr = arr[g];
      grandInc += gr.inc;
      grandExp += gr.exp;
      var grProfit = gr.inc - gr.exp;

      html += '<div style="margin-bottom:12px;position:relative;z-index:2">' +
        '<div style="background:#FFF3E0;padding:6px 10px;' +
          'border-left:3px solid #FF6F00;font-weight:700;font-size:12px">' +
          'üïâÔ∏è ' + PDFEngine._e(gr.p) +
          ' <span style="float:right;color:' +
            (grProfit >= 0 ? 'green' : 'red') + '">‚Çπ' + grProfit + '</span>' +
        '</div>' +
        '<table style="width:100%;border-collapse:collapse;font-size:10px">' +
          '<tr style="background:#f5f5f5">' +
            '<th style="border:1px solid #ddd;padding:3px">Date</th>' +
            '<th style="border:1px solid #ddd;padding:3px">Type</th>' +
            '<th style="border:1px solid #ddd;padding:3px">Details</th>' +
            '<th style="border:1px solid #ddd;padding:3px;text-align:right">‚Çπ</th>' +
          '</tr>';

      for (var e = 0; e < gr.ent.length; e++) {
        var en = gr.ent[e];
        var isI = en.type === 'income';

        html += '<tr>' +
          '<td style="border:1px solid #eee;padding:2px">' +
            UI.formatDate(en.date) + '</td>' +
          '<td style="border:1px solid #eee;padding:2px;color:' +
            (isI ? 'green' : 'red') + '">' +
            (isI ? '‡§Ü‡§Ø' : '‡§ñ‡§∞‡•ç‡§ö') + '</td>' +
          '<td style="border:1px solid #eee;padding:2px">' +
            PDFEngine._e(en.description || en.yajmanName || '') + '</td>' +
          '<td style="border:1px solid #eee;padding:2px;text-align:right;color:' +
            (isI ? 'green' : 'red') + '">‚Çπ' + en.amount + '</td>' +
        '</tr>';
      }

      html += '</table></div>';
    }

    /* Grand Total */
    html += '<div style="padding:12px;background:#FFF3E0;' +
      'border:2px solid #FF6F00;border-radius:8px;' +
      'text-align:center;margin-top:10px;position:relative;z-index:2">' +
      '<div style="font-weight:700;color:#E65100">Grand Total</div>' +
      '<div style="font-size:12px">' +
        '<span style="color:green">Income: ‚Çπ' + grandInc + '</span> | ' +
        '<span style="color:red">Expense: ‚Çπ' + grandExp + '</span> | ' +
        '<span style="color:#E65100;font-weight:800">Profit: ‚Çπ' +
          (grandInc - grandExp) + '</span>' +
      '</div>' +
    '</div>';

    html += PDFEngine.buildFooter(1, 1);
    html += '</div>';

    /* Render off-screen */
    var zone = UI.$('renderZone');
    if (!zone) return;
    zone.innerHTML = html;

    var node = UI.$('hisabPdfNode');
    if (!node) return;

    var fileName = 'Hisab_' +
      (pi.name || 'ShubhArambh').replace(/[^a-zA-Z0-9\u0900-\u097F]/g, '_') +
      '_' + UI.today() + '.pdf';

    PDFEngine.generatePDF(node, fileName, {
      onComplete: function() {
        zone.innerHTML = '';
      }
    });
  }
};
</script>

<!-- ============================================================
     PART D - BLOCK 9: BACKWARD COMPATIBILITY
     Aliases so old code references still work
     ============================================================ -->
<script>
/* Make HisabPage point to HisabUI for any legacy references */
window.HisabPage = HisabUI;

/* Ensure Home page quick hisab works */
if (typeof HomeUI !== 'undefined') {
  HomeUI.quickAddHisab = function(type) {
    Nav.go('hisab');
    setTimeout(function() {
      HisabUI.showAddSingle(type || 'income');
    }, 400);
  };
}
</script>
<!-- ============================================================
     PART E - BLOCK 1: NEW POOJA PAGE BUILDER (DEBUG + FIXED v2)
     ============================================================ -->
<script>
PageBuilder.new = function() {
  var pName = '';
  try {
    pName = UI.esc((API.user.pandit && API.user.pandit.name) || API.user.name || '');
  } catch(e) {}

  var today = UI.today();

  UI.html('pgNew',

    '<div class="page-header">' +
      '<h2 class="page-title">‚ûï New Pooja Setup</h2>' +
      '<p class="page-subtitle" id="npPoojaCountLabel">Loading...</p>' +
    '</div>' +

    /* Step 1: Yajman */
    '<div class="card">' +
      '<div class="card-header">' +
        '<h3 class="card-title">üë§ Step 1: Yajman Details</h3>' +
        '<button class="btn btn-xs btn-ghost" onclick="NewPoojaUI.pickYajman()">' +
          'üìã Saved</button>' +
      '</div>' +
      '<div class="form-row">' +
        '<div class="form-group">' +
          '<label class="form-label">Yajman Name *</label>' +
          '<input class="form-input" id="npYajman" placeholder="‡§Ø‡§ú‡§Æ‡§æ‡§® ‡§ï‡§æ ‡§®‡§æ‡§Æ">' +
        '</div>' +
        '<div class="form-group">' +
          '<label class="form-label">Phone</label>' +
          '<input class="form-input" id="npPhone" type="tel" placeholder="Phone">' +
        '</div>' +
      '</div>' +
      '<div class="form-group">' +
        '<label class="form-label">Address</label>' +
        '<input class="form-input" id="npAddr" placeholder="‡§™‡§§‡§æ">' +
      '</div>' +
      '<div class="form-row">' +
        '<div class="form-group">' +
          '<label class="form-label">Date</label>' +
          '<input class="form-input" id="npDate" type="date" value="' + today + '">' +
        '</div>' +
        '<div class="form-group">' +
          '<label class="form-label">Pandit</label>' +
          '<input class="form-input" id="npPandit" value="' + pName + '" ' +
            'readonly style="opacity:.6">' +
        '</div>' +
      '</div>' +
    '</div>' +

    /* Step 2: Poojas */
    '<div class="card">' +
      '<div class="card-header">' +
        '<h3 class="card-title">üïâÔ∏è Step 2: Select Poojas</h3>' +
        '<div class="card-actions">' +
          '<button class="btn btn-xs btn-ghost" onclick="NewPoojaUI.selectAll()">All</button>' +
          '<button class="btn btn-xs btn-ghost" onclick="NewPoojaUI.selectNone()">Clear</button>' +
          '<button class="btn btn-xs btn-primary" onclick="NewPoojaUI.reloadData()">üîÑ</button>' +
          '<span style="font-size:.75rem;color:var(--text-brand);padding:2px 6px;' +
            'font-weight:700" id="npSelCount">0</span>' +
        '</div>' +
      '</div>' +

      /* Debug info - will show data status */
      '<div id="npDebugInfo" style="padding:6px 10px;margin-bottom:8px;' +
        'background:rgba(41,121,255,0.06);border-radius:var(--r-sm);' +
        'border-left:3px solid var(--info);font-size:.65rem;color:var(--text-muted)">' +
        'Checking data...' +
      '</div>' +

      /* Search */
      '<div class="search-input" style="margin-bottom:var(--sp-sm)">' +
        '<input class="form-input" id="npPoojaSearch" placeholder="Search poojas..." ' +
          'oninput="NewPoojaUI.renderPoojas()">' +
      '</div>' +

      /* Pooja list container */
      '<div id="npPoojaList" style="max-height:50vh;overflow-y:auto;' +
        '-webkit-overflow-scrolling:touch">' +
        '<div style="text-align:center;padding:20px">' +
          '<div class="mini-spinner" style="margin:0 auto 8px"></div>' +
          '<p style="color:var(--text-muted);font-size:.8rem">Loading poojas...</p>' +
        '</div>' +
      '</div>' +
    '</div>' +

    /* Next button */
    '<button class="btn btn-primary btn-w" onclick="NewPoojaUI.goToMaterials()" ' +
      'id="npNextBtn" style="margin-bottom:var(--sp-md)">Next: Select Materials ‚Üí</button>' +

    /* Step 3: Materials (hidden) */
    '<div id="npMatsWrap" class="hide">' +
      '<div class="card">' +
        '<div class="card-header">' +
          '<h3 class="card-title">üì¶ Step 3: Materials</h3>' +
          '<div class="search-input" style="width:140px">' +
            '<input class="form-input" id="npMatSearch" placeholder="Search..." ' +
              'oninput="NewPoojaUI.renderMaterials()" ' +
              'style="padding:6px 6px 6px 30px;font-size:.78rem">' +
          '</div>' +
        '</div>' +
        '<div id="npMatSections"></div>' +
      '</div>' +
      '<div class="card">' +
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:var(--sp-sm)">' +
          '<button class="btn btn-success btn-w" onclick="NewPoojaUI.saveToCloud()">' +
            'üíæ Save</button>' +
          '<button class="btn btn-primary btn-w" onclick="NewPoojaUI.goToPreview()">' +
            'üìÑ Preview ‚Üí</button>' +
        '</div>' +
      '</div>' +
    '</div>' +

    /* Step 4: Preview (hidden) */
    '<div id="npPreviewWrap" class="hide">' +
      '<div class="card">' +
        '<div class="card-header">' +
          '<h3 class="card-title">üìÑ Step 4: Preview</h3>' +
          '<button class="btn btn-xs btn-ghost" onclick="NewPoojaUI.buildPreview()">' +
            'üîÑ Refresh</button>' +
        '</div>' +
        '<div id="npPlanInfo"></div>' +
        '<div id="npPreviewArea" style="background:#c0c0c0;border-radius:var(--r-md);' +
          'padding:var(--sp-sm);max-height:65vh;overflow:auto;' +
          '-webkit-overflow-scrolling:touch">' +
          '<p style="color:#666;text-align:center;padding:20px">Click üîÑ Refresh</p>' +
        '</div>' +
      '</div>' +
      '<div class="card">' +
        '<div class="card-header"><h3 class="card-title">‚¨áÔ∏è Download & Share</h3></div>' +
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:var(--sp-sm)">' +
          '<button class="btn btn-primary btn-w" onclick="NewPoojaUI.downloadPDF()">' +
            'üìÑ PDF</button>' +
          '<button class="btn btn-success btn-w" onclick="NewPoojaUI.downloadImages()">' +
            'üñºÔ∏è Image</button>' +
          '<button class="btn btn-ghost btn-w" onclick="NewPoojaUI.downloadZIP()">' +
            'üì¶ ZIP</button>' +
          '<button class="btn btn-ghost btn-w" onclick="NewPoojaUI.shareWhatsApp()">' +
            'üì§ WhatsApp</button>' +
        '</div>' +
        '<button class="btn btn-ghost btn-w" onclick="NewPoojaUI.addToHisab()" ' +
          'style="margin-top:var(--sp-sm)">üí∞ Add to Hisab</button>' +
      '</div>' +
    '</div>'
  );
};

/* Page Controller - runs when user navigates to New tab */
<!-- ============================================================
     PART E - BLOCK 2: NEW POOJA LOGIC (COMPLETE REWRITE v3)
     Fixed: Data loading, pooja rendering, all edge cases
     ============================================================ -->
<script>
var NewPoojaUI = {

  _selected: [],
  _materials: [],
  _dataLoaded: false,

  /* ============================================================
     CRITICAL: Initialize pooja list
     This is the MAIN function that handles data loading
     ============================================================ */
  _initPoojaList: function() {
    var self = this;
    var master = App.D.master;
    var debugEl = UI.$('npDebugInfo');

    /* Case 1: Data already loaded and has items */
    if (master && Array.isArray(master) && master.length > 0) {
      self._dataLoaded = true;

      /* Detect the data structure */
      var sample = master[0];
      var keys = Object.keys(sample);

      if (debugEl) {
        debugEl.innerHTML = '‚úÖ Data loaded: ' + master.length + ' items | ' +
          'Keys: ' + keys.join(', ') + ' | ' +
          'Sample: ' + JSON.stringify(sample).substring(0, 100);
        debugEl.style.borderLeftColor = 'var(--success)';
      }

      /* Now render */
      self.renderPoojas();
      return;
    }

    /* Case 2: No data - need to load */
    if (debugEl) {
      debugEl.innerHTML = '‚è≥ Loading pooja data from server...';
      debugEl.style.borderLeftColor = 'var(--warning)';
    }

    self.reloadData();
  },

  /* ============================================================
     RELOAD DATA FROM SERVER
     ============================================================ */
  reloadData: function() {
    var self = this;
    var debugEl = UI.$('npDebugInfo');
    var listEl = UI.$('npPoojaList');

    /* Show loading in list */
    if (listEl) {
      listEl.innerHTML = '<div style="text-align:center;padding:24px">' +
        '<div class="mini-spinner" style="margin:0 auto 8px"></div>' +
        '<p style="color:var(--text-muted);font-size:.8rem">Loading from server...</p></div>';
    }

    if (debugEl) {
      debugEl.innerHTML = '‚è≥ Fetching getMaster from API...';
      debugEl.style.borderLeftColor = 'var(--warning)';
    }

    API.get('getMaster').then(function(data) {
      console.log('=== getMaster response ===');
      console.log('Type:', typeof data);
      console.log('IsArray:', Array.isArray(data));
      console.log('Length:', data ? data.length : 'null');
      if (data && data.length > 0) {
        console.log('First item:', JSON.stringify(data[0]));
        console.log('First item keys:', Object.keys(data[0]));
      }

      if (data && Array.isArray(data) && data.length > 0) {
        App.D.master = data;
        self._dataLoaded = true;

        var sample = data[0];
        if (debugEl) {
          debugEl.innerHTML = '‚úÖ Loaded ' + data.length + ' items | ' +
            'Keys: ' + Object.keys(sample).join(', ');
          debugEl.style.borderLeftColor = 'var(--success)';
        }

        self.renderPoojas();
      } else if (data && Array.isArray(data) && data.length === 0) {
        /* Empty array - no data in database */
        if (debugEl) {
          debugEl.innerHTML = '‚ö†Ô∏è Server returned empty array. Add poojas in Database first.';
          debugEl.style.borderLeftColor = 'var(--warning)';
        }
        self.renderPoojas();
      } else {
        /* Unexpected response */
        if (debugEl) {
          debugEl.innerHTML = '‚ùå Unexpected response: ' +
            JSON.stringify(data).substring(0, 200);
          debugEl.style.borderLeftColor = 'var(--error)';
        }
        self.renderPoojas();
      }
    }).catch(function(e) {
      console.error('getMaster failed:', e);
      if (debugEl) {
        debugEl.innerHTML = '‚ùå API Error: ' + (e.message || e) +
          ' <button class="btn btn-xs btn-primary" ' +
          'onclick="NewPoojaUI.reloadData()" style="margin-left:6px">üîÑ Retry</button>';
        debugEl.style.borderLeftColor = 'var(--error)';
      }

      /* Show error in list area too */
      if (listEl) {
        listEl.innerHTML = '<div style="text-align:center;padding:20px">' +
          '<div style="font-size:2rem;margin-bottom:8px">‚ùå</div>' +
          '<p style="color:var(--text-muted);font-size:.82rem;margin-bottom:10px">' +
            'Failed to load: ' + UI.esc(e.message || 'Network error') + '</p>' +
          '<button class="btn btn-sm btn-primary" onclick="NewPoojaUI.reloadData()">' +
            'üîÑ Try Again</button></div>';
      }
    });
  },

  /* ============================================================
     GET UNIQUE POOJA NAMES (ROBUST VERSION)
     Handles multiple possible data structures
     ============================================================ */
  _getUniquePoojas: function() {
    var master = App.D.master || [];
    if (!master.length) return [];

    var seen = {};
    var result = [];

    for (var i = 0; i < master.length; i++) {
      var item = master[i];
      if (!item) continue;

      /* Try multiple possible field names */
      var poojaName = item.pooja || item.Pooja || item.POOJA ||
                      item.poojaName || item.PoojaName ||
                      item.name || item.Name || '';

      if (typeof poojaName === 'string') {
        poojaName = poojaName.trim();
      } else {
        poojaName = String(poojaName || '').trim();
      }

      if (poojaName && !seen[poojaName]) {
        seen[poojaName] = true;
        result.push(poojaName);
      }
    }

    return result.sort();
  },

  /* ============================================================
     GET ITEMS FOR A SPECIFIC POOJA (ROBUST VERSION)
     ============================================================ */
  _getItemsForPooja: function(poojaName) {
    var master = App.D.master || [];
    var items = [];

    for (var i = 0; i < master.length; i++) {
      var item = master[i];
      if (!item) continue;

      var pName = item.pooja || item.Pooja || item.POOJA ||
                  item.poojaName || item.PoojaName ||
                  item.name || item.Name || '';

      if (typeof pName === 'string') pName = pName.trim();
      else pName = String(pName || '').trim();

      if (pName === poojaName) {
        items.push(item);
      }
    }

    return items;
  },

  /* ============================================================
     GET SAMAGRI NAME FROM ITEM (ROBUST VERSION)
     ============================================================ */
  _getSamagriName: function(item) {
    if (!item) return '';
    return item.samagri || item.Samagri || item.SAMAGRI ||
           item.item || item.Item || item.itemName ||
           item.material || item.Material || '';
  },

  /* ============================================================
     RENDER POOJA SELECTION LIST (FULLY FIXED)
     ============================================================ */
  renderPoojas: function() {
    var el = UI.$('npPoojaList');
    if (!el) return;

    /* Use our robust getter */
    var all = this._getUniquePoojas();

    /* Search filter */
    var q = '';
    try { q = (UI.val('npPoojaSearch') || '').toLowerCase(); } catch(e) {}
    if (q) {
      all = all.filter(function(n) {
        return n.toLowerCase().indexOf(q) !== -1;
      });
    }

    /* Update count label */
    var totalPoojas = this._getUniquePoojas().length;
    UI.text('npPoojaCountLabel', totalPoojas + ' poojas available');

    /* Empty state */
    if (!all.length) {
      var master = App.D.master || [];
      var msg = '';

      if (master.length === 0 && !this._dataLoaded) {
        msg = '<div style="font-size:2rem;margin-bottom:8px">‚è≥</div>' +
          '<p style="color:var(--text-muted);margin-bottom:10px">No pooja data loaded</p>' +
          '<div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap">' +
            '<button class="btn btn-sm btn-primary" onclick="NewPoojaUI.reloadData()">' +
              'üîÑ Load Poojas</button>' +
            '<button class="btn btn-sm btn-ghost" onclick="Nav.go(\'profile\')">' +
              'üóÑÔ∏è Go to Database</button></div>';
      } else if (master.length === 0 && this._dataLoaded) {
        msg = '<div style="font-size:2rem;margin-bottom:8px">üóÑÔ∏è</div>' +
          '<p style="color:var(--text-muted);margin-bottom:10px">' +
            'Database is empty. Add poojas first!</p>' +
          '<button class="btn btn-sm btn-primary" onclick="Nav.go(\'profile\')">' +
            '‚ûï Go to Database & Add</button>';
      } else if (q) {
        msg = '<div style="font-size:2rem;margin-bottom:8px">üîç</div>' +
          '<p style="color:var(--text-muted)">No poojas matching "' + UI.esc(q) + '"</p>';
      } else {
        msg = '<div style="font-size:2rem;margin-bottom:8px">üïâÔ∏è</div>' +
          '<p style="color:var(--text-muted);margin-bottom:10px">No poojas found</p>' +
          '<button class="btn btn-sm btn-primary" onclick="NewPoojaUI.reloadData()">' +
            'üîÑ Reload</button>';
      }

      el.innerHTML = '<div style="text-align:center;padding:20px">' + msg + '</div>';
      UI.text('npSelCount', '0');
      return;
    }

    /* Build the pooja list */
    var html = '';
    for (var i = 0; i < all.length; i++) {
      var name = all[i];
      var itemCount = this._getItemsForPooja(name).length;

      /* Check if this pooja is selected */
      var selIdx = -1;
      for (var k = 0; k < this._selected.length; k++) {
        if (this._selected[k].name === name) { selIdx = k; break; }
      }
      var isSel = selIdx !== -1;

      /* Safe escape for onclick */
      var safeName = name.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"');

      html += '<div style="display:flex;align-items:center;gap:10px;' +
        'padding:10px 12px;border-bottom:1px solid rgba(255,255,255,0.03);' +
        'cursor:pointer;transition:background .15s ease;min-height:44px;' +
        (isSel ? 'background:rgba(255,111,0,0.06);border-left:3px solid var(--brand)' :
          'border-left:3px solid transparent') +
        '" onclick="NewPoojaUI.togglePooja(\'' + safeName + '\')" ' +
        'onmouseover="this.style.background=\'rgba(255,255,255,0.02)\'" ' +
        'onmouseout="this.style.background=\'' +
          (isSel ? 'rgba(255,111,0,0.06)' : 'transparent') + '\'">' +

        /* Checkbox */
        '<div style="width:22px;height:22px;border:2px solid ' +
          (isSel ? 'var(--brand)' : 'var(--text-muted)') +
          ';border-radius:5px;display:flex;align-items:center;justify-content:center;' +
          'flex-shrink:0;font-size:12px;transition:all .2s ease;' +
          (isSel ? 'background:var(--grad-brand);color:#fff' : '') + '">' +
          (isSel ? '‚úì' : '') +
        '</div>' +

        /* Name and count */
        '<div style="flex:1;min-width:0">' +
          '<div style="font-size:.85rem;font-weight:600;color:var(--text-primary);' +
            'overflow:hidden;text-overflow:ellipsis;white-space:nowrap">' +
            (isSel ? '<span style="display:inline-block;background:rgba(255,111,0,0.15);' +
              'color:var(--text-brand);padding:0 5px;border-radius:10px;' +
              'font-size:.6rem;margin-right:4px;min-width:16px;text-align:center">' +
              (selIdx + 1) + '</span>' : '') +
            UI.esc(name) +
          '</div>' +
          '<div style="font-size:.68rem;color:var(--text-muted)">' +
            itemCount + ' items</div>' +
        '</div>';

      /* Reorder buttons for selected items */
      if (isSel) {
        html += '<div style="display:flex;gap:2px" onclick="event.stopPropagation()">' +
          '<button class="btn btn-xs btn-ghost" ' +
            'onclick="NewPoojaUI.movePooja(' + selIdx + ',-1)" ' +
            'style="padding:2px 6px;font-size:.7rem">‚ñ≤</button>' +
          '<button class="btn btn-xs btn-ghost" ' +
            'onclick="NewPoojaUI.movePooja(' + selIdx + ',1)" ' +
            'style="padding:2px 6px;font-size:.7rem">‚ñº</button>' +
        '</div>';
      }

      html += '</div>';
    }

    el.innerHTML = html;
    UI.text('npSelCount', this._selected.length + ' selected');
  },

  /* ---- Toggle / Move / Select ---- */
  togglePooja: function(name) {
    var idx = -1;
    for (var i = 0; i < this._selected.length; i++) {
      if (this._selected[i].name === name) { idx = i; break; }
    }
    if (idx > -1) this._selected.splice(idx, 1);
    else this._selected.push({ name: name, order: this._selected.length });
    this.renderPoojas();
  },

  movePooja: function(idx, dir) {
    var j = idx + dir;
    if (j < 0 || j >= this._selected.length) return;
    var t = this._selected[idx];
    this._selected[idx] = this._selected[j];
    this._selected[j] = t;
    this.renderPoojas();
  },

  selectAll: function() {
    var all = this._getUniquePoojas();
    if (!all.length) {
      UI.toast('No Data', 'Load poojas first', 'warn');
      this.reloadData();
      return;
    }
    this._selected = [];
    for (var i = 0; i < all.length; i++) {
      this._selected.push({ name: all[i], order: i });
    }
    this.renderPoojas();
    UI.toast('Selected', all.length + ' poojas', 'ok');
  },

  selectNone: function() {
    this._selected = [];
    this.renderPoojas();
  },

  /* ---- Pick Yajman ---- */
  pickYajman: function() {
    var list = App.D.yajmans || [];
    var body = '';
    if (!list.length) {
      body = '<div class="empty-state"><div class="empty-state-icon">üë•</div>' +
        '<div class="empty-state-text">No saved yajmans</div></div>';
    } else {
      body = '<div class="search-input" style="margin-bottom:var(--sp-md)">' +
        '<input class="form-input" id="pickYajSearch" placeholder="Search..." ' +
          'oninput="NewPoojaUI._filterPickList()"></div>' +
        '<div id="pickYajListInner" style="max-height:50vh;overflow:auto"></div>';
    }
    UI.createModal('mPickYaj', { title: 'üìã Select Yajman', body: body, maxWidth: '440px' });
    if (list.length) this._renderPickList(list);
  },

  _renderPickList: function(list) {
    var el = UI.$('pickYajListInner');
    if (!el) return;
    var html = '';
    for (var i = 0; i < list.length; i++) {
      var y = list[i];
      html += '<div class="list-row" style="cursor:pointer" ' +
        'onclick="NewPoojaUI._applyYajman(\'' + y.id + '\')">' +
        '<div class="list-row-icon" style="background:var(--grad-brand);' +
          'width:32px;height:32px;font-size:.8rem">üë§</div>' +
        '<div class="list-row-body"><div class="list-row-title" style="font-size:.82rem">' +
          UI.esc(y.name) + '</div><div class="list-row-meta">' +
          (y.phone || '') + (y.city ? ' ‚Ä¢ ' + y.city : '') + '</div></div></div>';
    }
    el.innerHTML = html;
  },

  _filterPickList: function() {
    var q = (UI.val('pickYajSearch') || '').toLowerCase();
    var list = (App.D.yajmans || []).filter(function(y) {
      return (y.name || '').toLowerCase().indexOf(q) !== -1 ||
        (y.phone || '').indexOf(q) !== -1;
    });
    this._renderPickList(list);
  },

  _applyYajman: function(id) {
    var y = App.findYajman(id);
    if (!y) return;
    UI.closeModal('mPickYaj');
    UI.setVal('npYajman', y.name);
    UI.setVal('npPhone', String(y.phone || ''));
    UI.setVal('npAddr', (y.address || '') + (y.city ? ', ' + y.city : ''));
    App._selectedYajman = y;
    UI.toast('Selected', y.name, 'ok');
  },

  /* ---- Materials ---- */
  goToMaterials: function() {
    var yaj = UI.val('npYajman');
    if (!yaj) { UI.toast('Required', 'Enter yajman name', 'warn'); return; }
    if (!this._selected.length) {
      UI.toast('Required', 'Select at least one pooja', 'warn'); return;
    }
    this._buildMaterials();
    this.renderMaterials();
    UI.show('npMatsWrap');
    UI.hide('npNextBtn');
    var wrap = UI.$('npMatsWrap');
    if (wrap) setTimeout(function() {
      wrap.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);
  },

  _buildMaterials: function() {
    var existing = {};
    for (var i = 0; i < this._materials.length; i++) {
      var m = this._materials[i];
      existing[m.pooja + '||' + m.name] = m;
    }
    var newMats = [];
    for (var j = 0; j < this._selected.length; j++) {
      var pName = this._selected[j].name;
      var items = this._getItemsForPooja(pName);

      for (var k = 0; k < items.length; k++) {
        var samagriName = this._getSamagriName(items[k]);
        if (!samagriName) continue;

        var key = pName + '||' + samagriName;
        if (existing[key]) newMats.push(existing[key]);
        else newMats.push({
          pooja: pName, name: samagriName,
          qty: '', unit: '', on: true, custom: false
        });
      }
      /* Keep custom items */
      for (var c = 0; c < this._materials.length; c++) {
        var cm = this._materials[c];
        if (cm.pooja === pName && cm.custom) {
          var cExists = false;
          for (var n = 0; n < newMats.length; n++) {
            if (newMats[n].pooja === cm.pooja && newMats[n].name === cm.name) {
              cExists = true; break;
            }
          }
          if (!cExists) newMats.push(cm);
        }
      }
    }
    this._materials = newMats;
  },

  renderMaterials: function() {
    var container = UI.$('npMatSections');
    if (!container) return;
    var searchQ = '';
    try { searchQ = (UI.val('npMatSearch') || '').toLowerCase(); } catch(e) {}
    var units = CFG.UNITS;
    var html = '';

    for (var s = 0; s < this._selected.length; s++) {
      var pName = this._selected[s].name;
      var items = [];
      var total = 0, onCount = 0;
      for (var i = 0; i < this._materials.length; i++) {
        if (this._materials[i].pooja === pName) {
          total++;
          if (this._materials[i].on) onCount++;
          if (!searchQ || this._materials[i].name.toLowerCase().indexOf(searchQ) !== -1) {
            items.push({ mat: this._materials[i], idx: i });
          }
        }
      }

      html += '<div style="margin-bottom:var(--sp-md)">';
      html += '<div class="section-header" style="cursor:default">üïâÔ∏è ' + UI.esc(pName) +
        ' <span class="section-count">' + onCount + '/' + total + '</span></div>';

      for (var j = 0; j < items.length; j++) {
        var m = items[j].mat;
        var gi = items[j].idx;
        var unitOpts = '<option value="">Unit</option>';
        for (var u = 0; u < units.length; u++) {
          unitOpts += '<option' + (m.unit === units[u] ? ' selected' : '') + '>' +
            units[u] + '</option>';
        }

        html += '<div style="display:grid;grid-template-columns:24px 1fr 60px 78px' +
          (m.custom ? ' 28px' : '') + ';gap:4px;align-items:center;padding:3px 8px;' +
          'border-bottom:1px solid var(--border);' +
          (!m.on ? 'opacity:.35;' : '') + (m.custom ? 'border-left:2px solid var(--gold);' : '') + '">' +
          '<input type="checkbox" style="accent-color:var(--brand);width:18px;height:18px" ' +
            (m.on ? 'checked' : '') + ' onchange="NewPoojaUI._materials[' + gi +
            '].on=this.checked;NewPoojaUI.renderMaterials()">' +
          '<div style="font-size:.8rem;color:var(--text-primary);overflow:hidden;' +
            'text-overflow:ellipsis;white-space:nowrap">' + UI.esc(m.name) +
            (m.custom ? ' ‚≠ê' : '') + '</div>' +
          '<input style="padding:4px;background:var(--bg-input);border:1px solid var(--border);' +
            'border-radius:4px;color:var(--text-primary);font-size:.78rem;text-align:center;' +
            'outline:none;min-height:30px" placeholder="Qty" value="' + (m.qty || '') + '" ' +
            'oninput="NewPoojaUI._materials[' + gi + '].qty=this.value">' +
          '<select style="padding:4px;background:var(--bg-input);border:1px solid var(--border);' +
            'border-radius:4px;color:var(--text-primary);font-size:.72rem;outline:none;' +
            'min-height:30px" onchange="NewPoojaUI._materials[' + gi + '].unit=this.value">' +
            unitOpts + '</select>';
        if (m.custom) {
          html += '<button style="background:none;border:none;color:var(--error);cursor:pointer;' +
            'font-size:.78rem" onclick="NewPoojaUI._materials.splice(' + gi +
            ',1);NewPoojaUI.renderMaterials()">üóëÔ∏è</button>';
        }
        html += '</div>';
      }

      var ep = pName.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
      html += '<div style="display:flex;gap:4px;padding:4px 8px">' +
        '<input class="form-input" id="npCustom_' + s + '" placeholder="‚ûï Add custom..." ' +
          'style="flex:1;padding:6px 10px;font-size:.78rem;border-style:dashed;' +
            'border-color:rgba(255,111,0,0.25)" ' +
          'onkeydown="if(event.key===\'Enter\')NewPoojaUI.addCustomItem(\'' + ep + '\',' + s + ')">' +
        '<button class="btn btn-xs btn-primary" onclick="NewPoojaUI.addCustomItem(\'' +
          ep + '\',' + s + ')">Add</button></div>';
      html += '</div>';
    }
    container.innerHTML = html;
  },

  addCustomItem: function(pooja, secIdx) {
    var inp = UI.$('npCustom_' + secIdx);
    if (!inp) return;
    var val = inp.value.trim();
    if (!val) return;
    for (var i = 0; i < this._materials.length; i++) {
      if (this._materials[i].pooja === pooja && this._materials[i].name === val) {
        UI.toast('Exists', 'Already added', 'warn'); return;
      }
    }
    this._materials.push({ pooja: pooja, name: val, qty: '', unit: '', on: true, custom: true });
    inp.value = '';
    this.renderMaterials();
    API.post({ action: 'addItem', pooja: pooja, samagri: val }).catch(function() {});
  },
</script>

<!-- ============================================================
     PART E - BLOCK 3: PREVIEW & 2-COLUMN PDF (COMPLETE)
     ============================================================ -->
<script>
  NewPoojaUI.goToPreview = function() {
    UI.show('npPreviewWrap');
    var wrap = UI.$('npPreviewWrap');
    if (wrap) setTimeout(function() {
      wrap.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);
    this._showPlanInfo();
    var self = this;
    setTimeout(function() { self.buildPreview(); }, 200);
  };

  NewPoojaUI._showPlanInfo = function() {
    var el = UI.$('npPlanInfo');
    if (!el) return;
    var isPro = Subscription.isPro();
    var pdfInfo = Subscription.canDownloadPDF();
    if (isPro) {
      el.innerHTML = '<div class="info-banner" style="border-left-color:var(--success)">' +
        '‚úÖ Pro: No watermark ‚Ä¢ Unlimited PDFs ‚Ä¢ Image & ZIP</div>';
    } else {
      el.innerHTML = '<div class="info-banner" style="border-left-color:var(--warning)">' +
        '‚ö†Ô∏è Free: Watermark ‚Ä¢ ' + pdfInfo.remaining + '/' + pdfInfo.max + ' PDF today ‚Ä¢ ' +
        '<a style="color:var(--brand);cursor:pointer;font-weight:700" ' +
          'onclick="Subscription.showUpgrade()">Upgrade ‚≠ê</a></div>';
    }
  };

  NewPoojaUI.buildPreview = function() {
    var el = UI.$('npPreviewArea');
    if (!el) return;

    var enabled = [];
    for (var i = 0; i < this._materials.length; i++) {
      if (this._materials[i].on) enabled.push(this._materials[i]);
    }

    if (!enabled.length) {
      el.innerHTML = '<p style="color:#666;text-align:center;padding:20px">' +
        'No materials selected. Go back and select items.</p>';
      return;
    }

    var pi = PDFEngine.getPanditInfo();
    var isPro = Subscription.isPro();
    var yajman = UI.val('npYajman') || '';
    var date = UI.val('npDate') || '';
    var phone = UI.val('npPhone') || '';
    var addr = UI.val('npAddr') || '';
    var poojaNames = this._selected.map(function(p) { return p.name; }).join(', ');

    var h = '<div id="pdfRenderNode" style="width:750px;background:#fff;color:#000;' +
      'font-family:\'Noto Sans Devanagari\',serif;padding:0;position:relative">';

    if (!isPro) {
      h += '<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) ' +
        'rotate(-35deg);font-size:50px;color:rgba(255,111,0,0.04);font-weight:900;' +
        'white-space:nowrap;pointer-events:none;z-index:1">‡§∂‡•Å‡§≠‡§æ‡§∞‡§Ç‡§≠ FREE</div>';
    }

    /* Header */
    h += '<div style="padding:16px 24px 10px;border-bottom:3px double #E65100;position:relative;z-index:2">';
    h += '<div style="text-align:center;font-size:11px;color:#E65100;letter-spacing:6px;font-weight:600;margin-bottom:5px">‡•• ‡§∂‡•ç‡§∞‡•Ä ‡§ó‡§£‡•á‡§∂‡§æ‡§Ø ‡§®‡§Æ‡§É ‡••</div>';
    if (pi.name) h += '<div style="text-align:center;font-size:22px;font-weight:800;color:#E65100;line-height:1.2">' + PDFEngine._e(pi.name) + '</div>';
    if (pi.title) h += '<div style="text-align:center;font-size:11px;color:#666">' + PDFEngine._e(pi.title) + '</div>';
    if (pi.tagline) h += '<div style="text-align:center;font-size:10px;color:#999;font-style:italic;margin-top:2px">„Äå' + PDFEngine._e(pi.tagline) + '„Äç</div>';
    var contacts = [];
    if (pi.phone) contacts.push('üìû ' + pi.phone);
    if (pi.address) contacts.push('üìç ' + pi.address);
    if (pi.website) contacts.push('üåê ' + pi.website);
    if (contacts.length) h += '<div style="text-align:center;font-size:9px;color:#888;margin-top:3px">' + contacts.join(' | ') + '</div>';
    h += '</div>';

    h += '<div style="background:linear-gradient(135deg,#FF6F00,#FF8F00);padding:7px 24px;text-align:center"><div style="font-size:15px;font-weight:700;color:#fff;letter-spacing:2px">‡§™‡•Ç‡§ú‡§æ ‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä ‡§∏‡•Ç‡§ö‡•Ä</div></div>';

    h += '<div style="padding:8px 24px;background:#FFF8E1;border-bottom:1px solid #FFE0B2">';
    h += '<table style="width:100%;font-size:11px;color:#333"><tr><td style="padding:2px 0"><b>‡§Ø‡§ú‡§Æ‡§æ‡§®:</b> ' + PDFEngine._e(yajman) + '</td><td style="padding:2px 0;text-align:right"><b>‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï:</b> ' + UI.formatDate(date) + '</td></tr>';
    if (phone || addr) h += '<tr><td style="padding:2px 0"><b>‡§™‡§§‡§æ:</b> ' + PDFEngine._e(addr || '-') + '</td><td style="padding:2px 0;text-align:right"><b>‡§´‡§º‡•ã‡§®:</b> ' + PDFEngine._e(phone || '-') + '</td></tr>';
    h += '</table><div style="font-size:10px;color:#E65100;margin-top:3px;font-weight:600">üïâÔ∏è ‡§™‡•Ç‡§ú‡§æ: ' + PDFEngine._e(poojaNames) + '</div></div>';

    /* 2-Column Table */
    h += '<div style="padding:10px 24px;position:relative;z-index:2">';

    function bRows(items, start) {
      var r = '';
      for (var x = 0; x < items.length; x++) {
        var m = items[x];
        var qt = ((m.qty || '') + ' ' + (m.unit || '')).trim();
        r += '<tr><td style="border:1px solid #d0d0d0;padding:3px 4px;text-align:center;font-size:12px;width:20px;color:#999">‚òê</td><td style="border:1px solid #d0d0d0;padding:3px 6px;font-size:11px">' + UI.esc(m.name) + '</td><td style="border:1px solid #d0d0d0;padding:3px 4px;font-size:10px;text-align:center;width:60px;color:#555">' + qt + '</td></tr>';
      }
      return r;
    }

    function tHdr() {
      return '<tr style="background:#FFF3E0"><th style="border:1px solid #ccc;padding:3px;font-size:9px;width:20px">‚úì</th><th style="border:1px solid #ccc;padding:3px;font-size:9px;text-align:left">‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä</th><th style="border:1px solid #ccc;padding:3px;font-size:9px;width:60px">‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ</th></tr>';
    }

    function twoCol(list) {
      var half = Math.ceil(list.length / 2);
      return '<table style="width:100%;border-collapse:collapse"><tr><td style="vertical-align:top;width:50%;padding-right:5px"><table style="width:100%;border-collapse:collapse">' + tHdr() + bRows(list.slice(0, half), 0) + '</table></td><td style="vertical-align:top;width:50%;padding-left:5px"><table style="width:100%;border-collapse:collapse">' + tHdr() + bRows(list.slice(half), half) + '</table></td></tr></table>';
    }

    if (this._selected.length > 1) {
      for (var s = 0; s < this._selected.length; s++) {
        var sn = this._selected[s].name;
        var si = enabled.filter(function(m) { return m.pooja === sn; });
        if (!si.length) continue;
        h += '<div style="background:#FFF3E0;padding:4px 10px;border-left:3px solid #FF6F00;font-weight:700;font-size:12px;color:#E65100;margin-bottom:5px;margin-top:' + (s > 0 ? '10px' : '0') + '">üïâÔ∏è ' + PDFEngine._e(sn) + ' (' + si.length + ')</div>';
        h += twoCol(si);
      }
    } else {
      h += twoCol(enabled);
    }

    h += '<div style="text-align:right;font-size:10px;color:#888;margin-top:5px">‡§ï‡•Å‡§≤: ' + enabled.length + ' items</div></div>';

    h += '<div style="padding:0 24px 6px"><div style="border:1px dashed #FFB74D;border-radius:6px;padding:8px;background:#FFFDE7"><div style="font-size:10px;font-weight:700;color:#E65100;margin-bottom:3px">üìù ‡§µ‡§ø‡§∂‡•á‡§∑ ‡§®‡§ø‡§∞‡•ç‡§¶‡•á‡§∂:</div><div style="min-height:24px;font-size:10px;color:#999">_____________________________________________</div></div></div>';

    h += '<div style="padding:10px 24px;border-top:3px double #E65100;background:#FFF8E1;position:relative;z-index:2">';
    h += '<table style="width:100%;font-size:9px;color:#666"><tr><td style="vertical-align:top">';
    if (pi.name) h += '<div style="font-weight:700;color:#E65100;font-size:11px">' + PDFEngine._e(pi.name) + '</div>';
    if (pi.title) h += '<div style="color:#888">' + PDFEngine._e(pi.title) + '</div>';
    h += '</td><td style="text-align:right;vertical-align:top">';
    if (pi.phone) h += '<div>üìû ' + PDFEngine._e(pi.phone) + '</div>';
    if (pi.address) h += '<div>üìç ' + PDFEngine._e(pi.address) + '</div>';
    if (pi.website) h += '<div>üåê ' + PDFEngine._e(pi.website) + '</div>';
    h += '</td></tr></table>';
    if (!isPro) h += '<div style="text-align:center;margin-top:4px;padding:2px 6px;background:rgba(255,111,0,0.06);border-radius:3px;font-size:7px;color:#FF6F00">Generated by ‡§∂‡•Å‡§≠‡§æ‡§∞‡§Ç‡§≠ Free</div>';
    else h += '<div style="text-align:center;margin-top:3px;font-size:7px;color:#ccc">Page 1</div>';
    h += '</div></div>';

    el.innerHTML = h;
  };
</script>

<!-- ============================================================
     PART E - BLOCK 4: DOWNLOADS & SHARE (COMPLETE)
     ============================================================ -->
<script>
  NewPoojaUI.downloadPDF = function() {
    var target = UI.$('pdfRenderNode');
    if (!target) { this.buildPreview(); var self = this; setTimeout(function() { self.downloadPDF(); }, 1000); return; }
    var yaj = (UI.val('npYajman') || 'Pooja').replace(/[^a-zA-Z0-9\u0900-\u097F\s]/g, '_').replace(/\s+/g, '_');
    PDFEngine.generatePDF(target, 'Samagri_' + yaj + '_' + UI.today() + '.pdf');
  };

  NewPoojaUI.downloadImages = function() {
    var target = UI.$('pdfRenderNode');
    if (!target) { this.buildPreview(); return; }
    var yaj = (UI.val('npYajman') || 'Pooja').replace(/[^a-zA-Z0-9\u0900-\u097F\s]/g, '_').replace(/\s+/g, '_');
    PDFEngine.generateImage(target, 'Samagri_' + yaj + '_' + UI.today() + '.png');
  };

  NewPoojaUI.downloadZIP = function() {
    var target = UI.$('pdfRenderNode');
    if (!target) { this.buildPreview(); return; }
    var yaj = (UI.val('npYajman') || 'Pooja').replace(/[^a-zA-Z0-9\u0900-\u097F\s]/g, '_').replace(/\s+/g, '_');
    if (this._selected.length > 1) this._generateMultiPageZIP(yaj);
    else PDFEngine.generateZIP([target], 'Samagri_' + yaj + '_' + UI.today());
  };

  NewPoojaUI._generateMultiPageZIP = function(baseName) {
    if (!Subscription.isPro()) { Subscription.showUpgrade('ZIP is Pro!'); return; }
    var zone = UI.$('renderZone');
    if (!zone) return;
    UI.load('Preparing...');
    var self = this;
    var pi = PDFEngine.getPanditInfo();
    var yajman = UI.val('npYajman') || '';
    var date = UI.val('npDate') || '';
    var pages = '';
    for (var s = 0; s < this._selected.length; s++) {
      var sn = this._selected[s].name;
      var si = this._materials.filter(function(m) { return m.on && m.pooja === sn; });
      if (!si.length) continue;
      var half = Math.ceil(si.length / 2);
      function mkR(items) { var r = ''; for (var x = 0; x < items.length; x++) { var m = items[x]; var qt = ((m.qty||'') + ' ' + (m.unit||'')).trim(); r += '<tr><td style="border:1px solid #d0d0d0;padding:3px 4px;text-align:center;font-size:12px;width:20px;color:#999">‚òê</td><td style="border:1px solid #d0d0d0;padding:3px 6px;font-size:11px">' + UI.esc(m.name) + '</td><td style="border:1px solid #d0d0d0;padding:3px 4px;font-size:10px;text-align:center;width:60px;color:#555">' + qt + '</td></tr>'; } return r; }
      var th = '<tr style="background:#FFF3E0"><th style="border:1px solid #ccc;padding:3px;font-size:9px;width:20px">‚úì</th><th style="border:1px solid #ccc;padding:3px;font-size:9px;text-align:left">‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä</th><th style="border:1px solid #ccc;padding:3px;font-size:9px;width:60px">‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ</th></tr>';
      var pid = 'zipPage_' + s;
      pages += '<div id="' + pid + '" style="width:750px;background:#fff;color:#000;font-family:Noto Sans Devanagari,serif;padding:0;margin-bottom:20px">';
      pages += PDFEngine.buildHeader('<div style="background:linear-gradient(135deg,#FF6F00,#FF8F00);padding:6px 24px;text-align:center"><div style="font-size:14px;font-weight:700;color:#fff">' + PDFEngine._e(sn) + '</div></div><div style="padding:6px 24px;background:#FFF8E1;font-size:10px;color:#555">‡§Ø‡§ú‡§Æ‡§æ‡§®: ' + PDFEngine._e(yajman) + ' | ' + UI.formatDate(date) + '</div>');
      pages += '<div style="padding:10px 24px"><table style="width:100%;border-collapse:collapse"><tr><td style="vertical-align:top;width:50%;padding-right:5px"><table style="width:100%;border-collapse:collapse">' + th + mkR(si.slice(0, half)) + '</table></td><td style="vertical-align:top;width:50%;padding-left:5px"><table style="width:100%;border-collapse:collapse">' + th + mkR(si.slice(half)) + '</table></td></tr></table></div>';
      pages += PDFEngine.buildFooter(s + 1, self._selected.length);
      pages += '</div>';
    }
    zone.innerHTML = pages;
    setTimeout(function() {
      var els = [];
      for (var p = 0; p < self._selected.length; p++) { var pe = UI.$('zipPage_' + p); if (pe) els.push(pe); }
      if (els.length) PDFEngine.generateZIP(els, 'Samagri_' + baseName + '_' + UI.today(), { onComplete: function() { zone.innerHTML = ''; } });
      else { UI.unload(); zone.innerHTML = ''; }
    }, 500);
  };

  NewPoojaUI.shareWhatsApp = function() {
    var yaj = UI.val('npYajman') || 'Yajman';
    var enabled = this._materials.filter(function(m) { return m.on; });
    var pi = PDFEngine.getPanditInfo();
    var msg = 'üïâÔ∏è *‡§™‡•Ç‡§ú‡§æ ‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä ‡§∏‡•Ç‡§ö‡•Ä*\n\nüë§ ‡§Ø‡§ú‡§Æ‡§æ‡§®: ' + yaj + '\nüìÖ ‡§§‡§æ‡§∞‡•Ä‡§ñ: ' + UI.formatDate(UI.val('npDate')) + '\nüïâÔ∏è ‡§™‡•Ç‡§ú‡§æ: ' + this._selected.map(function(p) { return p.name; }).join(', ') + '\n\nüì¶ *‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä:*\n';
    for (var i = 0; i < enabled.length; i++) { msg += (i + 1) + '. ' + enabled[i].name; if (enabled[i].qty) msg += ' - ' + enabled[i].qty + ' ' + (enabled[i].unit || ''); msg += '\n'; }
    msg += '\nTotal: ' + enabled.length + ' items\n';
    if (pi.name) msg += '\nüôè ' + pi.name;
    if (pi.phone) msg += '\nüìû ' + pi.phone;
    if (navigator.share) navigator.share({ title: '‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä - ' + yaj, text: msg }).catch(function() {});
    else { var ph = (UI.val('npPhone') || '').replace(/[^0-9]/g, ''); window.open('https://wa.me/' + (ph ? '91' + ph : '') + '?text=' + encodeURIComponent(msg), '_blank'); }
    UI.toast('Shared!', '', 'ok');
  };

  NewPoojaUI.saveToCloud = function() {
    var name = UI.val('npYajman');
    if (!name) { UI.toast('Required', 'Enter yajman name', 'warn'); return; }
    UI.load('Saving...');
    API.post({ action: 'saveTemplate', name: name, date: UI.val('npDate'), poojas: this._selected.map(function(p) { return p.name; }).join(', '), samagri: this._materials.filter(function(m) { return m.on; }), phone: UI.val('npPhone'), address: UI.val('npAddr') }).then(function(r) { UI.unload(); if (r.error) { UI.toast('Error', r.error, 'error'); return; } UI.toast('Saved!', '‚òÅÔ∏è', 'ok'); return App.reloadAndRender('templates'); }).catch(function(e) { UI.unload(); UI.toast('Error', e.message, 'error'); });
  };

  NewPoojaUI.addToHisab = function() {
    Nav.go('hisab');
    var self = this;
    setTimeout(function() { HisabUI.showAddPooja(); setTimeout(function() { if (self._selected.length) UI.setVal('hpPooja', self._selected[0].name); if (App._selectedYajman) UI.setVal('hpYaj', App._selectedYajman.id); }, 300); }, 400);
  };

  window.NewPooja = NewPoojaUI;
</script>

<!-- ============================================================
     PART E - BLOCK 3: NEW POOJA PAGE CONTROLLER
     ============================================================ -->
<script>
PageController.new = function() {
  console.log('=== PageController.new called ===');
  console.log('App.D.master length:', (App.D.master || []).length);
  console.log('App.D.master sample:', App.D.master ? App.D.master[0] : 'EMPTY');

  NewPoojaUI._initPoojaList();
};
</script>

<!-- ============================================================
     PART E - BLOCK 5: LIBRARY PAGE (COMPLETE)
     ============================================================ -->
<script>
PageBuilder.library = function() {
  UI.html('pgLib',
    '<div class="page-header"><h2 class="page-title">üìö Saved Templates</h2><p class="page-subtitle">Cloud-saved lists</p></div>' +
    '<div class="card" style="padding:var(--sp-md)"><div class="search-input"><input class="form-input" id="libSearch" placeholder="Search..." oninput="LibUI.render()"></div></div>' +
    '<div id="libGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:var(--sp-md)"></div>'
  );
};
PageController.library = function() { LibUI.render(); };

var LibUI = {
  render: function() {
    var el = UI.$('libGrid'); if (!el) return;
    var list = App.D.templates || [];
    var q = (UI.val('libSearch') || '').toLowerCase();
    if (q) list = list.filter(function(t) { return (t.name || '').toLowerCase().indexOf(q) !== -1 || (t.poojas || '').toLowerCase().indexOf(q) !== -1; });
    if (!list.length) { el.innerHTML = '<div class="card" style="text-align:center;padding:30px;grid-column:1/-1"><div class="empty-state"><div class="empty-state-icon">üìö</div><div class="empty-state-text">' + (q ? 'No match' : 'No templates yet') + '</div><button class="btn btn-sm btn-primary" onclick="Nav.go(\'new\')" style="margin-top:10px">‚ûï Create</button></div></div>'; return; }
    var sorted = list.slice().reverse(); var html = '';
    for (var i = 0; i < sorted.length; i++) {
      var t = sorted[i];
      var pList = (t.poojas || '').split(','); var pc = 0; for (var p = 0; p < pList.length; p++) { if (pList[p].trim()) pc++; }
      var ic = 0; try { if (t.samagri && Array.isArray(t.samagri)) ic = t.samagri.length; } catch(e) {}
      html += '<div class="card" style="margin:0"><div style="margin-bottom:8px"><div style="font-weight:700;color:var(--text-primary);font-size:.9rem">' + UI.esc(t.name) + '</div><div style="font-size:.68rem;color:var(--text-muted);margin-top:2px">üìÖ ' + UI.formatDate(t.date) + ' ‚Ä¢ üïâÔ∏è ' + pc + ' pooja' + (pc !== 1 ? 's' : '') + (ic ? ' ‚Ä¢ üì¶ ' + ic : '') + '</div></div>';
      if (t.poojas) { html += '<div style="display:flex;flex-wrap:wrap;gap:3px;margin-bottom:8px">'; for (var j = 0; j < pList.length; j++) { var pn = pList[j].trim(); if (pn) html += '<span style="font-size:.58rem;color:var(--text-brand);background:rgba(255,111,0,0.08);padding:1px 6px;border-radius:99px">' + UI.esc(pn) + '</span>'; } html += '</div>'; }
      html += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px"><button class="btn btn-xs btn-primary" onclick="LibUI.load(\'' + t.id + '\')">üìÇ Open</button><button class="btn btn-xs btn-ghost" onclick="LibUI.duplicate(\'' + t.id + '\')">üìã Copy</button><button class="btn btn-xs btn-danger" style="padding:4px 6px" onclick="LibUI.del(\'' + t.id + '\')">üóëÔ∏è</button></div></div>';
    }
    el.innerHTML = html;
  },
  load: function(id) {
    var t = null; for (var i = 0; i < App.D.templates.length; i++) { if (App.D.templates[i].id === id) { t = App.D.templates[i]; break; } }
    if (!t) { UI.toast('Error', 'Not found', 'error'); return; }
    Nav.go('new');
    setTimeout(function() {
      UI.setVal('npYajman', t.name || ''); UI.setVal('npPhone', String(t.phone || '')); UI.setVal('npAddr', t.address || ''); if (t.date) UI.setVal('npDate', t.date);
      NewPoojaUI._selected = [];
      if (t.poojas) { var pl = t.poojas.split(','); for (var j = 0; j < pl.length; j++) { var pn = pl[j].trim(); if (pn) NewPoojaUI._selected.push({ name: pn, order: j }); } }
      NewPoojaUI.renderPoojas();
      if (t.samagri && Array.isArray(t.samagri)) { NewPoojaUI._materials = []; for (var k = 0; k < t.samagri.length; k++) { var s = t.samagri[k]; NewPoojaUI._materials.push({ pooja: s.pooja || '', name: s.name || s.samagri || '', qty: s.qty || '', unit: s.unit || '', on: s.on !== false, custom: !!s.custom }); } }
      if (NewPoojaUI._selected.length) setTimeout(function() { NewPoojaUI.goToMaterials(); }, 300);
      UI.toast('Loaded', t.name, 'ok');
    }, 400);
  },
  duplicate: function(id) {
    var t = null; for (var i = 0; i < App.D.templates.length; i++) { if (App.D.templates[i].id === id) { t = App.D.templates[i]; break; } }
    if (!t) return;
    UI.createModal('mDup', { title: 'üìã Duplicate', body: '<div class="form-group"><label class="form-label">New Name</label><input class="form-input" id="dupName" value="' + UI.esc(t.name + ' (Copy)') + '"></div>', footer: '<button class="btn btn-ghost" onclick="UI.closeModal(\'mDup\')">Cancel</button><button class="btn btn-primary" onclick="LibUI._saveDup(\'' + id + '\')">üìã Save</button>', maxWidth: '400px' });
  },
  _saveDup: function(origId) {
    var t = null; for (var i = 0; i < App.D.templates.length; i++) { if (App.D.templates[i].id === origId) { t = App.D.templates[i]; break; } }
    if (!t) return; var nn = UI.val('dupName'); if (!nn) return;
    UI.closeModal('mDup'); UI.load('Duplicating...');
    API.post({ action: 'saveTemplate', name: nn, date: UI.today(), poojas: t.poojas, samagri: t.samagri, phone: t.phone, address: t.address }).then(function(r) { UI.unload(); UI.toast('Done!', nn, 'ok'); return App.reloadAndRender('templates'); }).catch(function(e) { UI.unload(); UI.toast('Error', e.message, 'error'); });
  },
  del: function(id) {
    UI.confirm('Delete?', 'Remove permanently?', function() { UI.load('Deleting...'); API.post({ action: 'deleteTemplate', id: id }).then(function() { UI.unload(); UI.toast('Deleted', '', 'ok'); return App.reloadAndRender('templates'); }).catch(function(e) { UI.unload(); UI.toast('Error', e.message, 'error'); }); });
  }
};
window.LibPage = LibUI;
</script>

<!-- ============================================================
     PART E - BLOCK 6: CLOSE
     ============================================================ -->
</body>
</html>
