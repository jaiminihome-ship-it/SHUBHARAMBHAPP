<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
<meta name="theme-color" content="#FF6F00">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="manifest.json">
<title>‡§∂‡•Å‡§≠‡§æ‡§∞‡§Ç‡§≠ Pro - Ultimate Pooja Management System</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=Noto+Serif+Devanagari:wght@400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--bhagwa:#FF6F00;--bhagwa-dark:#E65100;--bhagwa-light:#FFB74D;--bhagwa-pale:#FFF3E0;--maroon:#800000;--gold:#DAA520;--deep-black:#1A1A2E;--dark-bg:#0F0F23;--card-bg:rgba(255,255,255,0.04);--card-border:rgba(255,255,255,0.08);--white:#FFFFFF;--gray-100:#F5F5F5;--gray-200:#EEEEEE;--gray-300:#E0E0E0;--gray-400:#BDBDBD;--gray-500:#9E9E9E;--gray-600:#757575;--success:#00C853;--error:#FF1744;--warning:#FFD600;--info:#2979FF;--gradient-bhagwa:linear-gradient(135deg,#FF6F00 0%,#FF8F00 50%,#FFA726 100%);--gradient-dark:linear-gradient(160deg,#0F0F23 0%,#1A1A2E 40%,#16213E 100%);--gradient-gold:linear-gradient(135deg,#DAA520 0%,#FFD700 100%);--shadow-sm:0 2px 8px rgba(0,0,0,0.1);--shadow-md:0 4px 20px rgba(0,0,0,0.15);--shadow-lg:0 8px 40px rgba(0,0,0,0.2);--shadow-glow:0 0 30px rgba(255,111,0,0.15);--radius-sm:8px;--radius-md:12px;--radius-lg:16px;--radius-xl:24px;--radius-full:9999px;--ease:cubic-bezier(0.4,0,0.2,1);--font-ui:'Poppins',sans-serif;--font-hindi:'Noto Serif Devanagari',serif;--font-hindi-sans:'Noto Sans Devanagari',sans-serif}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth;-webkit-text-size-adjust:100%}
body{font-family:var(--font-ui);background:var(--gradient-dark);color:var(--white);overflow-x:hidden;min-height:100vh;line-height:1.6}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at 15% 50%,rgba(255,111,0,0.08) 0%,transparent 60%),radial-gradient(ellipse at 85% 20%,rgba(218,165,32,0.05) 0%,transparent 50%);pointer-events:none;z-index:0}
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:rgba(255,255,255,0.03)}
::-webkit-scrollbar-thumb{background:var(--gradient-bhagwa);border-radius:3px}
::selection{background:rgba(255,111,0,0.3);color:white}
.shell{position:relative;z-index:1;max-width:1400px;margin:0 auto;min-height:100vh}
.topbar{position:sticky;top:0;z-index:900;padding:0.75rem 1rem}
.topbar-inner{background:rgba(15,15,35,0.92);backdrop-filter:blur(24px) saturate(1.8);border-radius:var(--radius-xl);padding:0.875rem 1.25rem;display:flex;align-items:center;justify-content:space-between;border:1px solid rgba(255,111,0,0.15);box-shadow:var(--shadow-md),var(--shadow-glow)}
.brand{display:flex;align-items:center;gap:0.75rem}
.brand-logo{width:44px;height:44px;background:var(--gradient-bhagwa);border-radius:var(--radius-md);display:grid;place-items:center;font-size:1.4rem;box-shadow:0 4px 12px rgba(255,111,0,0.35);animation:gentleFloat 4s ease-in-out infinite}
@keyframes gentleFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-3px)}}
.brand-info h1{font-size:1.15rem;font-weight:800;line-height:1.2;background:var(--gradient-bhagwa);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.brand-info p{font-size:0.7rem;color:var(--gray-500);font-weight:500}
.topbar-actions{display:flex;gap:0.4rem}
.icon-btn{width:38px;height:38px;border-radius:var(--radius-md);border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.04);color:var(--gray-400);cursor:pointer;display:grid;place-items:center;font-size:1.15rem;transition:all 0.25s var(--ease)}
.icon-btn:hover{background:rgba(255,111,0,0.15);color:white;transform:translateY(-1px)}
.tabbar{position:fixed;bottom:0;left:0;right:0;z-index:900;padding:0.75rem 1rem;pointer-events:none}
.tabbar-inner{background:rgba(15,15,35,0.96);backdrop-filter:blur(24px) saturate(1.8);border-radius:var(--radius-xl);padding:0.5rem 0.4rem;display:grid;grid-template-columns:repeat(6,1fr);gap:0.25rem;border:1px solid rgba(255,111,0,0.15);box-shadow:0 -4px 30px rgba(0,0,0,0.3);max-width:680px;margin:0 auto;pointer-events:all}
.tab{background:none;border:none;color:var(--gray-500);cursor:pointer;padding:0.6rem 0.25rem;border-radius:var(--radius-md);display:flex;flex-direction:column;align-items:center;gap:0.15rem;font-size:0.65rem;font-weight:600;font-family:var(--font-ui);transition:all 0.25s var(--ease);position:relative}
.tab .tab-ico{font-size:1.35rem;transition:transform 0.25s var(--ease)}
.tab.on{color:white}
.tab.on::before{content:'';position:absolute;inset:0;background:var(--gradient-bhagwa);opacity:1;border-radius:var(--radius-md);z-index:-1}
.tab:not(.on):hover{color:var(--bhagwa-light)}
.tab:not(.on):hover .tab-ico{transform:translateY(-2px)}
.main{padding:0 1rem 7rem}
.page{display:none;animation:pageIn 0.4s var(--ease)}
.page.on{display:block}
@keyframes pageIn{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
.page-head{text-align:center;margin-bottom:1.75rem;padding-top:0.5rem}
.page-title{font-size:1.75rem;font-weight:800;background:var(--gradient-bhagwa);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.page-sub{color:var(--gray-500);font-size:0.9rem;margin-top:0.25rem}
.card{background:var(--card-bg);backdrop-filter:blur(16px);border:1px solid var(--card-border);border-radius:var(--radius-lg);padding:1.25rem;margin-bottom:1rem;transition:border-color 0.3s var(--ease),box-shadow 0.3s var(--ease)}
.card:hover{border-color:rgba(255,111,0,0.2);box-shadow:var(--shadow-glow)}
.card-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;flex-wrap:wrap;gap:0.5rem}
.card-label{font-size:1.1rem;font-weight:700;color:white;display:flex;align-items:center;gap:0.5rem}
.fg{margin-bottom:1.25rem}
.fl{display:block;margin-bottom:0.4rem;font-weight:600;color:var(--gray-300);font-size:0.8rem;text-transform:uppercase;letter-spacing:0.6px}
.fi,.fs,.ft{width:100%;padding:0.8rem 1rem;background:rgba(255,255,255,0.04);border:2px solid rgba(255,255,255,0.08);border-radius:var(--radius-md);color:white;font-family:var(--font-ui);font-size:0.95rem;transition:all 0.25s var(--ease);outline:none}
.fi:focus,.fs:focus,.ft:focus{border-color:var(--bhagwa);background:rgba(255,111,0,0.04);box-shadow:0 0 0 3px rgba(255,111,0,0.1)}
.ft{min-height:100px;resize:vertical;font-family:var(--font-hindi-sans)}
.fs option{background:var(--deep-black);color:white}
.btn{padding:0.8rem 1.25rem;border:none;border-radius:var(--radius-md);font-family:var(--font-ui);font-size:0.9rem;font-weight:600;cursor:pointer;transition:all 0.25s var(--ease);display:inline-flex;align-items:center;justify-content:center;gap:0.4rem;text-decoration:none;line-height:1.4}
.btn:active{transform:scale(0.97)}
.btn:disabled{opacity:0.45;cursor:not-allowed}
.btn-p{background:var(--gradient-bhagwa);color:white;box-shadow:0 4px 14px rgba(255,111,0,0.3)}
.btn-p:hover:not(:disabled){box-shadow:0 6px 22px rgba(255,111,0,0.45);transform:translateY(-1px)}
.btn-s{background:rgba(255,255,255,0.06);color:white;border:1.5px solid rgba(255,255,255,0.12)}
.btn-s:hover:not(:disabled){background:rgba(255,255,255,0.1);border-color:rgba(255,255,255,0.2)}
.btn-g{background:linear-gradient(135deg,#00C853,#00E676);color:white}
.btn-d{background:linear-gradient(135deg,#FF1744,#FF5252);color:white}
.btn-w{width:100%}
.btn-sm{padding:0.45rem 0.8rem;font-size:0.8rem}
.btn-xs{padding:0.3rem 0.6rem;font-size:0.72rem;border-radius:6px}
.pandit-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem}
.pandit-card{background:rgba(255,255,255,0.03);border:2px solid rgba(255,255,255,0.08);border-radius:var(--radius-lg);padding:1.25rem;cursor:pointer;transition:all 0.3s var(--ease)}
.pandit-card:hover{border-color:rgba(255,111,0,0.3)}
.pandit-card.picked{border-color:var(--bhagwa);background:rgba(255,111,0,0.08);box-shadow:0 0 20px rgba(255,111,0,0.1)}
.pandit-top{display:flex;align-items:center;gap:0.75rem;margin-bottom:0.75rem}
.pandit-av{width:52px;height:52px;border-radius:50%;background:var(--gradient-bhagwa);display:grid;place-items:center;font-size:1.6rem;flex-shrink:0}
.pandit-nm{font-size:1rem;font-weight:700;color:white}
.pandit-tl{font-size:0.8rem;color:var(--gray-400)}
.pandit-det{display:flex;flex-direction:column;gap:0.35rem;font-size:0.82rem;color:var(--gray-300)}
.pandit-det span{display:flex;align-items:center;gap:0.4rem}
.pooja-list{display:grid;gap:0.6rem}
.pooja-search-wrap{margin-bottom:1rem}
.pooja-row{background:rgba(255,255,255,0.03);border:2px solid rgba(255,255,255,0.08);border-radius:var(--radius-md);padding:0.85rem;display:flex;align-items:center;gap:0.75rem;cursor:pointer;transition:all 0.25s var(--ease);user-select:none}
.pooja-row:hover{background:rgba(255,255,255,0.06)}
.pooja-row.picked{background:rgba(255,111,0,0.08);border-color:var(--bhagwa)}
.pooja-tick{width:22px;height:22px;border:2px solid var(--gray-500);border-radius:5px;display:grid;place-items:center;flex-shrink:0;transition:all 0.25s var(--ease);font-size:0.75rem}
.pooja-row.picked .pooja-tick{background:var(--gradient-bhagwa);border-color:var(--bhagwa);color:white}
.pooja-tick::after{content:'\2713';opacity:0;transform:scale(0);transition:all 0.2s var(--ease)}
.pooja-row.picked .pooja-tick::after{opacity:1;transform:scale(1)}
.pooja-body{flex:1;min-width:0}
.pooja-nm{font-weight:600;color:white;font-size:0.95rem}
.pooja-ct{font-size:0.72rem;color:var(--gray-500)}
.pooja-arrows{display:flex;gap:0.3rem}
.arr-btn{width:28px;height:28px;border-radius:5px;border:none;background:rgba(255,255,255,0.08);color:white;cursor:pointer;display:grid;place-items:center;font-size:0.8rem;transition:all 0.2s var(--ease)}
.arr-btn:hover{background:var(--bhagwa)}
.mat-section{margin-bottom:1.5rem}
.mat-head{background:rgba(255,111,0,0.1);border-left:4px solid var(--bhagwa);padding:0.85rem 1rem;border-radius:var(--radius-md);margin-bottom:0.75rem;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:0.5rem}
.mat-head-title{font-weight:700;color:white;display:flex;align-items:center;gap:0.5rem}
.mat-head-count{font-size:0.75rem;color:var(--bhagwa-light);background:rgba(255,111,0,0.2);padding:0.15rem 0.5rem;border-radius:var(--radius-full)}
.mat-grid{display:grid;gap:0.4rem}
.mat-row{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:var(--radius-sm);padding:0.6rem 0.75rem;display:grid;grid-template-columns:24px 1fr 80px 90px 30px;gap:0.6rem;align-items:center;transition:all 0.2s var(--ease)}
.mat-row:hover{background:rgba(255,255,255,0.04)}
.mat-row.mat-off{opacity:0.4}
.mat-row.mat-custom{border-left:3px solid var(--gold)}
.mat-chk{width:18px;height:18px;accent-color:var(--bhagwa);cursor:pointer}
.mat-nm{color:white;font-weight:500;font-size:0.9rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.mat-qty,.mat-unit{padding:0.4rem 0.5rem;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:5px;color:white;font-size:0.85rem;font-family:var(--font-ui);outline:none;transition:border-color 0.2s var(--ease)}
.mat-qty:focus,.mat-unit:focus{border-color:var(--bhagwa)}
.mat-qty{text-align:center}
.mat-del-btn{width:26px;height:26px;border-radius:4px;border:none;background:transparent;color:var(--gray-600);cursor:pointer;display:grid;place-items:center;font-size:0.8rem;transition:all 0.2s var(--ease)}
.mat-del-btn:hover{background:rgba(255,23,68,0.2);color:var(--error)}
.add-item-row{display:flex;gap:0.5rem;margin-top:0.5rem}
.add-item-input{flex:1;padding:0.5rem 0.75rem;background:rgba(255,255,255,0.04);border:1.5px dashed rgba(255,111,0,0.3);border-radius:var(--radius-sm);color:white;font-size:0.85rem;outline:none;font-family:var(--font-hindi-sans)}
.add-item-input::placeholder{color:var(--gray-600)}
.add-item-input:focus{border-color:var(--bhagwa);background:rgba(255,111,0,0.04)}
.preview-wrap{background:#d0d0d0;border-radius:var(--radius-lg);padding:1.5rem;max-height:70vh;overflow-y:auto;overflow-x:auto;display:flex;flex-direction:column;gap:2rem;align-items:center}
.preview-page{background:white;box-shadow:0 4px 24px rgba(0,0,0,0.25);width:210mm;max-width:210mm;position:relative;border:none;flex-shrink:0;transform-origin:top center}
.preview-page-num{position:absolute;top:8px;right:12px;background:var(--bhagwa);color:white;padding:0.15rem 0.6rem;border-radius:var(--radius-full);font-size:0.7rem;font-weight:700;z-index:5}
@media(max-width:900px){.preview-wrap{padding:0.5rem;align-items:flex-start}.preview-page{transform:scale(var(--preview-scale,0.45));transform-origin:top left;margin-bottom:calc(-297mm*(1 - var(--preview-scale,0.45)))}}
.pdfpage{padding:30px;font-family:'Noto Sans Devanagari',sans-serif;color:#000;font-size:14px;line-height:1.5;background:white;position:relative;min-height:auto}
.pdfpage.render-mode{min-height:297mm;width:210mm;position:absolute;left:-9999px;top:0}
.pdf-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.pdf-swastik{font-size:60px;color:var(--bhagwa);font-weight:bold;line-height:1}
.pdf-hdr-center{text-align:center;flex:1}
.pdf-hdr-center h1{color:var(--bhagwa);font-size:36px;font-weight:800;margin:0;font-family:'Noto Serif Devanagari',serif}
.pdf-hdr-center h2{color:#222;font-size:26px;font-weight:700;margin:3px 0 0;font-family:'Noto Serif Devanagari',serif}
.pdf-divider{border-bottom:3px solid var(--bhagwa);margin:8px 0 12px}
.pdf-swastika-line{text-align:center;color:var(--bhagwa);font-size:16px;margin:10px 0 6px;letter-spacing:10px;font-weight:bold;border-top:2px solid var(--bhagwa);padding-top:4px}
.pdf-info{display:grid;grid-template-columns:1.2fr 1fr;gap:6px 12px;font-weight:700;color:#111;font-size:16px;padding:12px 14px;background:#fff8f0;border-radius:6px;border:1.5px solid #ffe0b2;margin-bottom:6px}
.pdf-info b{color:var(--bhagwa);font-family:'Noto Serif Devanagari',serif}
.pdf-info .full{grid-column:span 2}
.pdf-info .editable-inline{border:none;border-bottom:2px dotted var(--bhagwa);font-size:16px;font-weight:700;color:#111;background:transparent;outline:none;font-family:'Noto Sans Devanagari',sans-serif;width:85%}
.pdf-section-title,.pdf-pooja-title{background:var(--bhagwa);color:white;padding:6px 10px;margin:10px 0 6px;border-radius:4px;font-weight:700;font-size:15px;font-family:'Noto Serif Devanagari',serif}
.pdf-tbl{width:100%;border-collapse:collapse;border:2.5px solid #222;margin-bottom:10px}
.pdf-tbl th,.pdf-tbl td{border:1.5px solid #555;padding:5px 8px;text-align:left;font-size:13px;color:#111;font-weight:600}
.pdf-tbl th{background:var(--bhagwa-pale);color:var(--bhagwa);font-family:'Noto Serif Devanagari',serif;font-weight:700}
.pdf-tbl .chk-cell{width:24px;text-align:center}
.pdf-tbl .chk-box{width:14px;height:14px;border:1.5px solid #555;border-radius:2px;display:inline-block}
.pdf-tbl .rmk-cell{width:60px}
.pdf-remark-section{margin-top:12px;border:2px solid #555;border-radius:4px;padding:10px}
.pdf-remark-title{font-weight:700;color:var(--bhagwa);font-size:14px;margin-bottom:6px;font-family:'Noto Serif Devanagari',serif}
.remark-box{width:100%;min-height:80px;border:1.5px dashed #999;padding:8px;font-size:13px;font-family:'Noto Sans Devanagari',sans-serif;outline:none;resize:none;color:#111}
.pdf-ftr{margin-top:12px;padding-top:10px;border-top:3.5px solid var(--bhagwa);text-align:center;color:#444;font-size:12px;font-weight:600}
.pdf-ftr div{margin-bottom:3px}
.pdf-ftr strong{color:#222}
.pdf-theme-royal .pdf-section-title,.pdf-theme-royal .pdf-pooja-title{background:linear-gradient(135deg,#800000,#b71c1c)}.pdf-theme-royal .pdf-hdr-center h1{color:#800000}.pdf-theme-royal .pdf-info{background:#fef0f0;border-color:#e57373}.pdf-theme-royal .pdf-info b{color:#800000}.pdf-theme-royal .pdf-divider{border-color:#800000}.pdf-theme-royal .pdf-swastik{color:#800000}.pdf-theme-royal .pdf-swastika-line{color:#800000;border-color:#800000}.pdf-theme-royal .pdf-tbl th{background:#fce4ec;color:#800000}.pdf-theme-royal .pdf-ftr{border-color:#800000}.pdf-theme-royal .pdf-remark-title{color:#800000}
.pdf-theme-gold .pdf-section-title,.pdf-theme-gold .pdf-pooja-title{background:linear-gradient(135deg,#B8860B,#DAA520)}.pdf-theme-gold .pdf-hdr-center h1{color:#B8860B}.pdf-theme-gold .pdf-info{background:#fffde7;border-color:#ffd54f}.pdf-theme-gold .pdf-info b{color:#B8860B}.pdf-theme-gold .pdf-divider{border-color:#DAA520}.pdf-theme-gold .pdf-swastik{color:#DAA520}.pdf-theme-gold .pdf-swastika-line{color:#DAA520;border-color:#DAA520}.pdf-theme-gold .pdf-tbl th{background:#fff8e1;color:#B8860B}.pdf-theme-gold .pdf-ftr{border-color:#DAA520}.pdf-theme-gold .pdf-remark-title{color:#B8860B}
.pdf-theme-green .pdf-section-title,.pdf-theme-green .pdf-pooja-title{background:linear-gradient(135deg,#1B5E20,#2E7D32)}.pdf-theme-green .pdf-hdr-center h1{color:#1B5E20}.pdf-theme-green .pdf-info{background:#e8f5e9;border-color:#a5d6a7}.pdf-theme-green .pdf-info b{color:#1B5E20}.pdf-theme-green .pdf-divider{border-color:#2E7D32}.pdf-theme-green .pdf-swastik{color:#2E7D32}.pdf-theme-green .pdf-swastika-line{color:#2E7D32;border-color:#2E7D32}.pdf-theme-green .pdf-tbl th{background:#e8f5e9;color:#1B5E20}.pdf-theme-green .pdf-ftr{border-color:#2E7D32}.pdf-theme-green .pdf-remark-title{color:#1B5E20}
.pdf-theme-blue .pdf-section-title,.pdf-theme-blue .pdf-pooja-title{background:linear-gradient(135deg,#0D47A1,#1565C0)}.pdf-theme-blue .pdf-hdr-center h1{color:#0D47A1}.pdf-theme-blue .pdf-info{background:#e3f2fd;border-color:#90caf9}.pdf-theme-blue .pdf-info b{color:#0D47A1}.pdf-theme-blue .pdf-divider{border-color:#1565C0}.pdf-theme-blue .pdf-swastik{color:#1565C0}.pdf-theme-blue .pdf-swastika-line{color:#1565C0;border-color:#1565C0}.pdf-theme-blue .pdf-tbl th{background:#e3f2fd;color:#0D47A1}.pdf-theme-blue .pdf-ftr{border-color:#1565C0}.pdf-theme-blue .pdf-remark-title{color:#0D47A1}
.pdf-theme-purple .pdf-section-title,.pdf-theme-purple .pdf-pooja-title{background:linear-gradient(135deg,#4A148C,#6A1B9A)}.pdf-theme-purple .pdf-hdr-center h1{color:#4A148C}.pdf-theme-purple .pdf-info{background:#f3e5f5;border-color:#ce93d8}.pdf-theme-purple .pdf-info b{color:#4A148C}.pdf-theme-purple .pdf-divider{border-color:#6A1B9A}.pdf-theme-purple .pdf-swastik{color:#6A1B9A}.pdf-theme-purple .pdf-swastika-line{color:#6A1B9A;border-color:#6A1B9A}.pdf-theme-purple .pdf-tbl th{background:#f3e5f5;color:#4A148C}.pdf-theme-purple .pdf-ftr{border-color:#6A1B9A}.pdf-theme-purple .pdf-remark-title{color:#4A148C}
.pdf-theme-teal .pdf-section-title,.pdf-theme-teal .pdf-pooja-title{background:linear-gradient(135deg,#004D40,#00695C)}.pdf-theme-teal .pdf-hdr-center h1{color:#004D40}.pdf-theme-teal .pdf-info{background:#e0f2f1;border-color:#80cbc4}.pdf-theme-teal .pdf-info b{color:#004D40}.pdf-theme-teal .pdf-divider{border-color:#00695C}.pdf-theme-teal .pdf-swastik{color:#00695C}.pdf-theme-teal .pdf-swastika-line{color:#00695C;border-color:#00695C}.pdf-theme-teal .pdf-tbl th{background:#e0f2f1;color:#004D40}.pdf-theme-teal .pdf-ftr{border-color:#00695C}.pdf-theme-teal .pdf-remark-title{color:#004D40}
.pdf-theme-rose .pdf-section-title,.pdf-theme-rose .pdf-pooja-title{background:linear-gradient(135deg,#880E4F,#AD1457)}.pdf-theme-rose .pdf-hdr-center h1{color:#880E4F}.pdf-theme-rose .pdf-info{background:#fce4ec;border-color:#f48fb1}.pdf-theme-rose .pdf-info b{color:#880E4F}.pdf-theme-rose .pdf-divider{border-color:#AD1457}.pdf-theme-rose .pdf-swastik{color:#AD1457}.pdf-theme-rose .pdf-swastika-line{color:#AD1457;border-color:#AD1457}.pdf-theme-rose .pdf-tbl th{background:#fce4ec;color:#880E4F}.pdf-theme-rose .pdf-ftr{border-color:#AD1457}.pdf-theme-rose .pdf-remark-title{color:#880E4F}
.pdf-theme-amber .pdf-section-title,.pdf-theme-amber .pdf-pooja-title{background:linear-gradient(135deg,#FF8F00,#FFA000)}.pdf-theme-amber .pdf-hdr-center h1{color:#FF8F00}.pdf-theme-amber .pdf-info{background:#fff8e1;border-color:#ffe082}.pdf-theme-amber .pdf-info b{color:#FF8F00}.pdf-theme-amber .pdf-divider{border-color:#FFA000}.pdf-theme-amber .pdf-swastik{color:#FFA000}.pdf-theme-amber .pdf-swastika-line{color:#FFA000;border-color:#FFA000}.pdf-theme-amber .pdf-tbl th{background:#fff8e1;color:#FF8F00}.pdf-theme-amber .pdf-ftr{border-color:#FFA000}.pdf-theme-amber .pdf-remark-title{color:#FF8F00}
.pdf-theme-indigo .pdf-section-title,.pdf-theme-indigo .pdf-pooja-title{background:linear-gradient(135deg,#1A237E,#283593)}.pdf-theme-indigo .pdf-hdr-center h1{color:#1A237E}.pdf-theme-indigo .pdf-info{background:#e8eaf6;border-color:#9fa8da}.pdf-theme-indigo .pdf-info b{color:#1A237E}.pdf-theme-indigo .pdf-divider{border-color:#283593}.pdf-theme-indigo .pdf-swastik{color:#283593}.pdf-theme-indigo .pdf-swastika-line{color:#283593;border-color:#283593}.pdf-theme-indigo .pdf-tbl th{background:#e8eaf6;color:#1A237E}.pdf-theme-indigo .pdf-ftr{border-color:#283593}.pdf-theme-indigo .pdf-remark-title{color:#1A237E}
.pdf-theme-brown .pdf-section-title,.pdf-theme-brown .pdf-pooja-title{background:linear-gradient(135deg,#3E2723,#4E342E)}.pdf-theme-brown .pdf-hdr-center h1{color:#3E2723}.pdf-theme-brown .pdf-info{background:#efebe9;border-color:#bcaaa4}.pdf-theme-brown .pdf-info b{color:#3E2723}.pdf-theme-brown .pdf-divider{border-color:#4E342E}.pdf-theme-brown .pdf-swastik{color:#4E342E}.pdf-theme-brown .pdf-swastika-line{color:#4E342E;border-color:#4E342E}.pdf-theme-brown .pdf-tbl th{background:#efebe9;color:#3E2723}.pdf-theme-brown .pdf-ftr{border-color:#4E342E}.pdf-theme-brown .pdf-remark-title{color:#3E2723}
.pdf-theme-cyan .pdf-section-title,.pdf-theme-cyan .pdf-pooja-title{background:linear-gradient(135deg,#006064,#00838F)}.pdf-theme-cyan .pdf-hdr-center h1{color:#006064}.pdf-theme-cyan .pdf-info{background:#e0f7fa;border-color:#80deea}.pdf-theme-cyan .pdf-info b{color:#006064}.pdf-theme-cyan .pdf-divider{border-color:#00838F}.pdf-theme-cyan .pdf-swastik{color:#00838F}.pdf-theme-cyan .pdf-swastika-line{color:#00838F;border-color:#00838F}.pdf-theme-cyan .pdf-tbl th{background:#e0f7fa;color:#006064}.pdf-theme-cyan .pdf-ftr{border-color:#00838F}.pdf-theme-cyan .pdf-remark-title{color:#006064}
.pdf-theme-deeporange .pdf-section-title,.pdf-theme-deeporange .pdf-pooja-title{background:linear-gradient(135deg,#BF360C,#D84315)}.pdf-theme-deeporange .pdf-hdr-center h1{color:#BF360C}.pdf-theme-deeporange .pdf-info{background:#fbe9e7;border-color:#ffab91}.pdf-theme-deeporange .pdf-info b{color:#BF360C}.pdf-theme-deeporange .pdf-divider{border-color:#D84315}.pdf-theme-deeporange .pdf-swastik{color:#D84315}.pdf-theme-deeporange .pdf-swastika-line{color:#D84315;border-color:#D84315}.pdf-theme-deeporange .pdf-tbl th{background:#fbe9e7;color:#BF360C}.pdf-theme-deeporange .pdf-ftr{border-color:#D84315}.pdf-theme-deeporange .pdf-remark-title{color:#BF360C}
.pdf-theme-lime .pdf-section-title,.pdf-theme-lime .pdf-pooja-title{background:linear-gradient(135deg,#827717,#9E9D24)}.pdf-theme-lime .pdf-hdr-center h1{color:#827717}.pdf-theme-lime .pdf-info{background:#f9fbe7;border-color:#dce775}.pdf-theme-lime .pdf-info b{color:#827717}.pdf-theme-lime .pdf-divider{border-color:#9E9D24}.pdf-theme-lime .pdf-swastik{color:#9E9D24}.pdf-theme-lime .pdf-swastika-line{color:#9E9D24;border-color:#9E9D24}.pdf-theme-lime .pdf-tbl th{background:#f9fbe7;color:#827717}.pdf-theme-lime .pdf-ftr{border-color:#9E9D24}.pdf-theme-lime .pdf-remark-title{color:#827717}
.pdf-theme-black .pdf-section-title,.pdf-theme-black .pdf-pooja-title{background:linear-gradient(135deg,#212121,#424242)}.pdf-theme-black .pdf-hdr-center h1{color:#212121}.pdf-theme-black .pdf-info{background:#f5f5f5;border-color:#bdbdbd}.pdf-theme-black .pdf-info b{color:#212121}.pdf-theme-black .pdf-divider{border-color:#424242}.pdf-theme-black .pdf-swastik{color:#424242}.pdf-theme-black .pdf-swastika-line{color:#424242;border-color:#424242}.pdf-theme-black .pdf-tbl th{background:#eee;color:#212121}.pdf-theme-black .pdf-ftr{border-color:#424242}.pdf-theme-black .pdf-remark-title{color:#212121}
.pdf-theme-wine .pdf-section-title,.pdf-theme-wine .pdf-pooja-title{background:linear-gradient(135deg,#4A0E2C,#722F37)}.pdf-theme-wine .pdf-hdr-center h1{color:#4A0E2C}.pdf-theme-wine .pdf-info{background:#fdf0f4;border-color:#d4a0b0}.pdf-theme-wine .pdf-info b{color:#4A0E2C}.pdf-theme-wine .pdf-divider{border-color:#722F37}.pdf-theme-wine .pdf-swastik{color:#722F37}.pdf-theme-wine .pdf-swastika-line{color:#722F37;border-color:#722F37}.pdf-theme-wine .pdf-tbl th{background:#fdf0f4;color:#4A0E2C}.pdf-theme-wine .pdf-ftr{border-color:#722F37}.pdf-theme-wine .pdf-remark-title{color:#4A0E2C}
.pdf-theme-navy .pdf-section-title,.pdf-theme-navy .pdf-pooja-title{background:linear-gradient(135deg,#0A1929,#1B3A5C)}.pdf-theme-navy .pdf-hdr-center h1{color:#0A1929}.pdf-theme-navy .pdf-info{background:#e8eef5;border-color:#7fa0c4}.pdf-theme-navy .pdf-info b{color:#0A1929}.pdf-theme-navy .pdf-divider{border-color:#1B3A5C}.pdf-theme-navy .pdf-swastik{color:#1B3A5C}.pdf-theme-navy .pdf-swastika-line{color:#1B3A5C;border-color:#1B3A5C}.pdf-theme-navy .pdf-tbl th{background:#e8eef5;color:#0A1929}.pdf-theme-navy .pdf-ftr{border-color:#1B3A5C}.pdf-theme-navy .pdf-remark-title{color:#0A1929}
.pdf-theme-olive .pdf-section-title,.pdf-theme-olive .pdf-pooja-title{background:linear-gradient(135deg,#556B2F,#6B8E23)}.pdf-theme-olive .pdf-hdr-center h1{color:#556B2F}.pdf-theme-olive .pdf-info{background:#f1f5e6;border-color:#aed581}.pdf-theme-olive .pdf-info b{color:#556B2F}.pdf-theme-olive .pdf-divider{border-color:#6B8E23}.pdf-theme-olive .pdf-swastik{color:#6B8E23}.pdf-theme-olive .pdf-swastika-line{color:#6B8E23;border-color:#6B8E23}.pdf-theme-olive .pdf-tbl th{background:#f1f5e6;color:#556B2F}.pdf-theme-olive .pdf-ftr{border-color:#6B8E23}.pdf-theme-olive .pdf-remark-title{color:#556B2F}
.pdf-theme-coral .pdf-section-title,.pdf-theme-coral .pdf-pooja-title{background:linear-gradient(135deg,#E65100,#FF5722)}.pdf-theme-coral .pdf-hdr-center h1{color:#E65100}.pdf-theme-coral .pdf-info{background:#fff3e0;border-color:#ffcc80}.pdf-theme-coral .pdf-info b{color:#E65100}.pdf-theme-coral .pdf-divider{border-color:#FF5722}.pdf-theme-coral .pdf-swastik{color:#FF5722}.pdf-theme-coral .pdf-swastika-line{color:#FF5722;border-color:#FF5722}.pdf-theme-coral .pdf-tbl th{background:#fff3e0;color:#E65100}.pdf-theme-coral .pdf-ftr{border-color:#FF5722}.pdf-theme-coral .pdf-remark-title{color:#E65100}
.pdf-theme-emerald .pdf-section-title,.pdf-theme-emerald .pdf-pooja-title{background:linear-gradient(135deg,#047857,#059669)}.pdf-theme-emerald .pdf-hdr-center h1{color:#047857}.pdf-theme-emerald .pdf-info{background:#ecfdf5;border-color:#a7f3d0}.pdf-theme-emerald .pdf-info b{color:#047857}.pdf-theme-emerald .pdf-divider{border-color:#059669}.pdf-theme-emerald .pdf-swastik{color:#059669}.pdf-theme-emerald .pdf-swastika-line{color:#059669;border-color:#059669}.pdf-theme-emerald .pdf-tbl th{background:#ecfdf5;color:#047857}.pdf-theme-emerald .pdf-ftr{border-color:#059669}.pdf-theme-emerald .pdf-remark-title{color:#047857}
.pdf-theme-crimson .pdf-section-title,.pdf-theme-crimson .pdf-pooja-title{background:linear-gradient(135deg,#991B1B,#B91C1C)}.pdf-theme-crimson .pdf-hdr-center h1{color:#991B1B}.pdf-theme-crimson .pdf-info{background:#fef2f2;border-color:#fca5a5}.pdf-theme-crimson .pdf-info b{color:#991B1B}.pdf-theme-crimson .pdf-divider{border-color:#B91C1C}.pdf-theme-crimson .pdf-swastik{color:#B91C1C}.pdf-theme-crimson .pdf-swastika-line{color:#B91C1C;border-color:#B91C1C}.pdf-theme-crimson .pdf-tbl th{background:#fef2f2;color:#991B1B}.pdf-theme-crimson .pdf-ftr{border-color:#B91C1C}.pdf-theme-crimson .pdf-remark-title{color:#991B1B}
.pdf-theme-sapphire .pdf-section-title,.pdf-theme-sapphire .pdf-pooja-title{background:linear-gradient(135deg,#1E3A8A,#1E40AF)}.pdf-theme-sapphire .pdf-hdr-center h1{color:#1E3A8A}.pdf-theme-sapphire .pdf-info{background:#eff6ff;border-color:#93c5fd}.pdf-theme-sapphire .pdf-info b{color:#1E3A8A}.pdf-theme-sapphire .pdf-divider{border-color:#1E40AF}.pdf-theme-sapphire .pdf-swastik{color:#1E40AF}.pdf-theme-sapphire .pdf-swastika-line{color:#1E40AF;border-color:#1E40AF}.pdf-theme-sapphire .pdf-tbl th{background:#eff6ff;color:#1E3A8A}.pdf-theme-sapphire .pdf-ftr{border-color:#1E40AF}.pdf-theme-sapphire .pdf-remark-title{color:#1E3A8A}
.theme-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:0.5rem;margin-bottom:1rem}
.theme-swatch{border:3px solid transparent;border-radius:var(--radius-md);padding:0.5rem;text-align:center;cursor:pointer;transition:all 0.25s var(--ease);font-size:0.7rem;font-weight:600;background:rgba(255,255,255,0.04);color:var(--gray-300)}
.theme-swatch:hover{border-color:rgba(255,255,255,0.2);transform:translateY(-2px)}
.theme-swatch.picked{border-color:var(--bhagwa);background:rgba(255,111,0,0.1);color:white}
.theme-swatch .swatch-color{width:100%;height:24px;border-radius:4px;margin-bottom:0.3rem}
.tpl-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(290px,1fr));gap:1rem}
.tpl-card{background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius-lg);padding:1.25rem;transition:all 0.3s var(--ease)}
.tpl-card:hover{border-color:rgba(255,111,0,0.3);transform:translateY(-3px);box-shadow:var(--shadow-glow)}
.tpl-name{font-size:1.05rem;font-weight:700;color:white;margin-bottom:0.4rem}
.tpl-meta{display:flex;flex-wrap:wrap;gap:0.5rem;margin-bottom:0.75rem;font-size:0.8rem;color:var(--gray-400)}
.tpl-actions{display:grid;grid-template-columns:1fr 1fr 1fr;gap:0.4rem}
.dbtbl{width:100%;border-collapse:collapse;background:rgba(255,255,255,0.03);border-radius:var(--radius-md);overflow:hidden}
.dbtbl th,.dbtbl td{padding:0.75rem;text-align:left;border-bottom:1px solid rgba(255,255,255,0.06);font-size:0.85rem}
.dbtbl th{background:rgba(255,111,0,0.15);color:white;font-weight:700;position:sticky;top:0;z-index:2}
.dbtbl tr:hover{background:rgba(255,255,255,0.02)}
.db-acts{display:flex;gap:0.3rem}
.db-btn{padding:0.2rem 0.6rem;border-radius:4px;border:none;cursor:pointer;font-size:0.72rem;font-weight:600;transition:all 0.2s var(--ease)}
.db-btn-e{background:var(--bhagwa);color:white}
.db-btn-e:hover{background:var(--bhagwa-dark)}
.db-btn-d{background:var(--error);color:white}
.db-btn-d:hover{opacity:0.8}
.db-search{margin-bottom:1rem}
.db-table-wrap{max-height:60vh;overflow-y:auto;border-radius:var(--radius-md)}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:0.75rem;margin-bottom:1.5rem}
.stat{background:var(--card-bg);border:1px solid var(--card-border);border-radius:var(--radius-lg);padding:1.25rem;text-align:center}
.stat-ico{width:44px;height:44px;margin:0 auto 0.75rem;background:var(--gradient-bhagwa);border-radius:50%;display:grid;place-items:center;font-size:1.3rem}
.stat-val{font-size:1.75rem;font-weight:800;color:white}
.stat-lbl{font-size:0.75rem;color:var(--gray-500);text-transform:uppercase;letter-spacing:0.5px}
.cust-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:0.75rem}
.cust-item{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:var(--radius-md);padding:0.85rem}
.cust-item label{display:flex;align-items:center;gap:0.5rem;font-size:0.85rem;color:var(--gray-300);cursor:pointer}
.cust-item input[type="checkbox"]{accent-color:var(--bhagwa);width:16px;height:16px}
.cust-item input[type="range"]{width:100%;accent-color:var(--bhagwa);margin-top:0.3rem}
.cust-item .cust-val{font-size:0.75rem;color:var(--bhagwa);font-weight:700;text-align:right}
.toasts{position:fixed;top:1rem;right:1rem;z-index:9999;display:flex;flex-direction:column;gap:0.4rem;max-width:380px;pointer-events:none}
.toast-item{background:rgba(15,15,35,0.95);backdrop-filter:blur(20px);border-radius:var(--radius-md);padding:0.85rem 1.25rem;display:flex;align-items:center;gap:0.75rem;box-shadow:var(--shadow-lg);border-left:4px solid var(--bhagwa);animation:toastIn 0.35s var(--ease);pointer-events:all}
.toast-item.ok{border-left-color:var(--success)}
.toast-item.err{border-left-color:var(--error)}
.toast-item.warn{border-left-color:var(--warning)}
@keyframes toastIn{from{opacity:0;transform:translateX(100%)}to{opacity:1;transform:translateX(0)}}
.toast-ico{font-size:1.25rem;flex-shrink:0}
.toast-body{flex:1}
.toast-ttl{font-weight:600;color:white;font-size:0.85rem}
.toast-msg{font-size:0.78rem;color:var(--gray-400);margin-top:0.1rem}
.loader-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);backdrop-filter:blur(8px);z-index:9999;flex-direction:column;gap:1rem}
.loader-overlay.on{display:flex;align-items:center;justify-content:center}
.loader-spin{width:36px;height:36px;border:3px solid rgba(255,255,255,0.1);border-top-color:var(--bhagwa);border-radius:50%;animation:spin 0.8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loader-txt{color:white;font-weight:600;font-size:1rem}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.75);backdrop-filter:blur(8px);z-index:9999;padding:1rem}
.modal.on{display:flex;align-items:center;justify-content:center}
.modal-box{background:var(--deep-black);border-radius:var(--radius-xl);max-width:580px;width:100%;max-height:90vh;overflow-y:auto;border:1px solid rgba(255,111,0,0.2);animation:modalIn 0.3s var(--ease)}
@keyframes modalIn{from{opacity:0;transform:scale(0.95) translateY(10px)}to{opacity:1;transform:scale(1) translateY(0)}}
.modal-top{padding:1.25rem;border-bottom:1px solid rgba(255,255,255,0.06);display:flex;align-items:center;justify-content:space-between}
.modal-title{font-size:1.25rem;font-weight:700;color:white}
.modal-x{width:36px;height:36px;border-radius:50%;border:none;background:rgba(255,255,255,0.08);color:white;cursor:pointer;display:grid;place-items:center;font-size:1.3rem;transition:all 0.25s var(--ease)}
.modal-x:hover{background:var(--error);transform:rotate(90deg)}
.modal-body{padding:1.25rem}
.modal-foot{padding:1.25rem;border-top:1px solid rgba(255,255,255,0.06);display:flex;gap:0.75rem;justify-content:flex-end}
.activity-list{max-height:300px;overflow-y:auto}
.activity-item{display:flex;align-items:center;gap:0.75rem;padding:0.75rem;border-bottom:1px solid rgba(255,255,255,0.04);transition:background 0.2s var(--ease)}
.activity-item:hover{background:rgba(255,255,255,0.02)}
.activity-ico{width:36px;height:36px;border-radius:50%;background:rgba(255,111,0,0.1);display:grid;place-items:center;font-size:1rem;flex-shrink:0}
.activity-text{flex:1}
.activity-text .act-title{font-size:0.85rem;font-weight:600;color:white}
.activity-text .act-time{font-size:0.72rem;color:var(--gray-500)}
.badge{display:inline-block;padding:0.15rem 0.5rem;border-radius:var(--radius-full);font-size:0.7rem;font-weight:700}
.badge-bhagwa{background:rgba(255,111,0,0.2);color:var(--bhagwa-light)}
.fab{position:fixed;bottom:6rem;right:1.5rem;z-index:800;width:56px;height:56px;border-radius:50%;background:var(--gradient-bhagwa);border:none;color:white;font-size:1.5rem;cursor:pointer;box-shadow:0 4px 20px rgba(255,111,0,0.4);display:grid;place-items:center;transition:all 0.3s var(--ease)}
.fab:hover{transform:scale(1.1) rotate(90deg);box-shadow:0 6px 30px rgba(255,111,0,0.5)}
.confirm-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px);z-index:99999;align-items:center;justify-content:center;padding:1rem}
.confirm-overlay.on{display:flex}
.confirm-box{background:var(--deep-black);border:1px solid rgba(255,111,0,0.3);border-radius:var(--radius-xl);padding:2rem;max-width:400px;width:100%;text-align:center;animation:modalIn 0.3s var(--ease)}
.confirm-box .confirm-ico{font-size:3rem;margin-bottom:1rem}
.confirm-box .confirm-msg{color:var(--gray-300);margin-bottom:1.5rem;font-size:0.95rem}
.confirm-box .confirm-btns{display:flex;gap:0.75rem;justify-content:center}
.rashi-container{width:100%;min-height:calc(100vh - 250px);border:none;border-radius:var(--radius-lg);overflow:hidden;background:#050505}
.rashi-container iframe{width:100%;height:calc(100vh - 250px);border:none}
#renderZone{position:absolute;left:-9999px;top:0;z-index:-1}
@media(max-width:768px){.page-title{font-size:1.4rem}.pandit-grid,.tpl-grid{grid-template-columns:1fr}.stats{grid-template-columns:repeat(2,1fr)}.mat-row{grid-template-columns:22px 1fr 60px 75px 26px;gap:0.3rem;padding:0.5rem}.mat-nm{font-size:0.8rem}.pdfpage{padding:18px}.pdf-hdr-center h1{font-size:26px}.pdf-hdr-center h2{font-size:20px}.pdf-swastik{font-size:40px}.pdf-info{font-size:13px;grid-template-columns:1fr}.pdf-info .full{grid-column:span 1}.cust-grid{grid-template-columns:1fr}.theme-grid{grid-template-columns:repeat(auto-fill,minmax(75px,1fr))}}
</style>
</head>
<body>
<div class="toasts" id="toasts"></div>
<div class="loader-overlay" id="loader"><div class="loader-spin"></div><div class="loader-txt" id="loaderTxt">Processing...</div></div>
<div class="confirm-overlay" id="confirmDlg"><div class="confirm-box"><div class="confirm-ico" id="confirmIco">‚ö†Ô∏è</div><div class="confirm-msg" id="confirmMsg">Are you sure?</div><div class="confirm-btns"><button class="btn btn-s" id="confirmNo">Cancel</button><button class="btn btn-d" id="confirmYes">Delete</button></div></div></div>
<div class="modal" id="mAdd"><div class="modal-box"><div class="modal-top"><h3 class="modal-title">‚ûï Add to Database</h3><button class="modal-x" onclick="V.modal('mAdd',0)">√ó</button></div><div class="modal-body"><div class="fg"><label class="fl">Pooja Name</label><input class="fi" id="mAddPooja" placeholder="Enter pooja name"><select class="fs" id="mAddSel" onchange="V.pickExisting()" style="margin-top:0.5rem"><option value="">‚Äî or select existing ‚Äî</option></select></div><div class="fg"><label class="fl">Samagri Items (one per line)</label><textarea class="ft" id="mAddItems" placeholder="Enter samagri items, one per line"></textarea></div></div><div class="modal-foot"><button class="btn btn-s" onclick="V.modal('mAdd',0)">Cancel</button><button class="btn btn-p" onclick="V.dbAdd()">Add to Database</button></div></div></div>
<div class="modal" id="mYajman"><div class="modal-box"><div class="modal-top"><h3 class="modal-title">‚ûï Add Yajman</h3><button class="modal-x" onclick="V.modal('mYajman',0)">√ó</button></div><div class="modal-body"></div><div class="modal-foot"></div></div></div>
<div class="modal" id="mEdit"><div class="modal-box"><div class="modal-top"><h3 class="modal-title">‚úèÔ∏è Edit Item</h3><button class="modal-x" onclick="V.modal('mEdit',0)">√ó</button></div><div class="modal-body"><div class="fg"><label class="fl">Pooja Name</label><input class="fi" id="mEditPooja" readonly style="opacity:0.7;"></div><div class="fg"><label class="fl">Samagri Name</label><input class="fi" id="mEditSamagri"></div><input type="hidden" id="mEditIdx"></div><div class="modal-foot"><button class="btn btn-s" onclick="V.modal('mEdit',0)">Cancel</button><button class="btn btn-p" onclick="V.dbUpdate()">Update</button></div></div></div>
<div class="modal" id="mSettings"><div class="modal-box" style="max-width:700px;"><div class="modal-top"><h3 class="modal-title">‚öôÔ∏è Settings & Themes</h3><button class="modal-x" onclick="V.modal('mSettings',0)">√ó</button></div><div class="modal-body">
<h4 style="color:var(--bhagwa);margin-bottom:0.75rem;font-size:0.9rem;">üìÑ Page Layout</h4>
<div class="cust-grid" style="margin-bottom:1.25rem;">
<div class="cust-item"><label class="fl">First Page Rows</label><input class="fi" type="number" id="sFirstRows" value="15" min="8" max="25" style="padding:0.5rem;"></div>
<div class="cust-item"><label class="fl">Next Page Rows</label><input class="fi" type="number" id="sNextRows" value="28" min="15" max="35" style="padding:0.5rem;"></div>
</div>
<h4 style="color:var(--bhagwa);margin-bottom:0.75rem;font-size:0.9rem;">üé® PDF Theme</h4>
<div class="theme-grid" id="themeGrid"></div>
<h4 style="color:var(--bhagwa);margin-bottom:0.75rem;font-size:0.9rem;">‚öôÔ∏è Customization</h4>
<div class="cust-grid">
<div class="cust-item"><label><input type="checkbox" id="sShowChk" checked> Show Checkbox Column</label></div>
<div class="cust-item"><label><input type="checkbox" id="sShowRmk" checked> Show Remark Column</label></div>
<div class="cust-item"><label><input type="checkbox" id="sShowHdr" checked> Show Header</label></div>
<div class="cust-item"><label><input type="checkbox" id="sShowFtr" checked> Show Footer</label></div>
<div class="cust-item" style="grid-column:span 2;"><label class="fl">Font Size: <span class="cust-val" id="sFontVal">14px</span></label><input type="range" id="sFontSize" min="10" max="20" value="14" oninput="document.getElementById('sFontVal').textContent=this.value+'px'"></div>
</div>
</div><div class="modal-foot"><button class="btn btn-s" onclick="V.modal('mSettings',0)">Close</button><button class="btn btn-p" onclick="V.saveSettings()">Save Settings</button></div></div></div>
<!-- ========== APP SHELL ========== -->
<div class="shell">
<div class="topbar"><div class="topbar-inner">
<div class="brand"><div class="brand-logo">üïâÔ∏è</div><div class="brand-info"><h1>‡§∂‡•Å‡§≠‡§æ‡§∞‡§Ç‡§≠</h1><p>Designed By Niranjan</p></div></div>
<div class="topbar-actions"><button class="icon-btn" onclick="V.refreshAll()" title="Refresh">üîÑ</button><button class="icon-btn" onclick="V.modal('mSettings',1)" title="Settings">‚öôÔ∏è</button></div>
</div></div>

<div class="main">

<!-- ===== HOME ===== -->
<section id="pgHome" class="page on">
<div class="page-head"><h2 class="page-title">Dashboard</h2><p class="page-sub">Welcome to your spiritual workspace</p></div>
<div class="stats">
<div class="stat"><div class="stat-ico">üë•</div><div class="stat-val" id="stYaj">0</div><div class="stat-lbl">Templates</div></div>
<div class="stat"><div class="stat-ico">üïâÔ∏è</div><div class="stat-val" id="stPooja">0</div><div class="stat-lbl">Poojas</div></div>
<div class="stat"><div class="stat-ico">üì¶</div><div class="stat-val" id="stItems">0</div><div class="stat-lbl">Samagri</div></div>
<div class="stat"><div class="stat-ico">‚òÅÔ∏è</div><div class="stat-val" id="stCloud">0</div><div class="stat-lbl">Cloud</div></div>
</div>
<div class="card">
<div class="card-head"><h3 class="card-label"><span>‚ö°</span>Quick Actions</h3></div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:0.75rem;">
<button class="btn btn-p" onclick="V.go('pgSetup')">‚ûï New Pooja</button>
<button class="btn btn-s" onclick="V.go('pgLib')">üìö Library</button>
<button class="btn btn-s" onclick="V.go('pgDB')">üóÑÔ∏è Database</button>
<button class="btn btn-s" onclick="V.modal('mAdd',1)">‚ûï Add Data</button>
<button class="btn btn-s" onclick="V.go('pgRashi')">üåü Rashifal</button>
<button class="btn btn-s" onclick="V.exportAllData()">üíæ Backup</button>
</div></div>
<div class="card">
<div class="card-head"><h3 class="card-label"><span>üìã</span>Recent Activity</h3></div>
<div class="activity-list" id="activityList"><div style="text-align:center;padding:1.5rem;color:var(--gray-500);">No recent activity</div></div>
</div>
</section>

<!-- ===== SETUP ===== -->
<section id="pgSetup" class="page">
<div class="page-head"><h2 class="page-title">New Pooja Setup</h2><p class="page-sub">Select pandit & enter yajman details</p></div>
<div class="card">
<div class="card-head"><h3 class="card-label"><span>üôè</span>Select Pandit</h3></div>
<div class="pandit-grid" id="panditGrid"></div>
</div>
<div class="card">
<div class="card-head"><h3 class="card-label"><span>üë§</span>Yajman Details</h3></div>
<div class="fg"><label class="fl">Yajman Name</label><input class="fi" id="inpYajman" placeholder="Enter name"></div>
<div class="fg"><label class="fl">Phone</label><input class="fi" id="inpPhone" placeholder="Phone number" type="tel"></div>
<div class="fg"><label class="fl">Address</label><input class="fi" id="inpAddress" placeholder="Enter address (optional)"></div>
<div class="fg"><label class="fl">Date</label><input class="fi" id="inpDate" type="date"></div>
</div>
<button class="btn btn-p btn-w" onclick="V.stepPooja()">Next: Select Poojas ‚Üí</button>
</section>

<!-- ===== POOJA SELECT ===== -->
<section id="pgPooja" class="page">
<div class="page-head"><h2 class="page-title">Select Poojas</h2><p class="page-sub">Choose & arrange in desired order</p></div>
<div class="card">
<div class="card-head">
<h3 class="card-label"><span>üïâÔ∏è</span>Available Poojas</h3>
<div style="display:flex;gap:0.4rem;">
<button class="btn btn-sm btn-s" onclick="V.selAll()">Select All</button>
<button class="btn btn-sm btn-s" onclick="V.selNone()">Clear</button>
</div></div>
<div class="pooja-search-wrap"><input class="fi" id="poojaSearch" placeholder="üîç Search poojas..." oninput="V.filterPoojas()"></div>
<div class="pooja-list" id="poojaList"></div>
<div style="margin-top:1rem;padding:0.75rem;background:rgba(255,111,0,0.05);border-radius:var(--radius-md);font-size:0.82rem;color:var(--gray-400);">
<strong style="color:var(--bhagwa-light);">üí° Tip:</strong> Use ‚ñ≤‚ñº arrows to reorder. Order here = order in PDF.
</div></div>
<div style="display:flex;gap:0.75rem;">
<button class="btn btn-s" onclick="V.go('pgSetup')" style="flex:0 0 auto;">‚Üê Back</button>
<button class="btn btn-p btn-w" onclick="V.stepMats()">Next: Manage Materials ‚Üí</button>
</div>
</section>

<!-- ===== MATERIALS ===== -->
<section id="pgMats" class="page">
<div class="page-head"><h2 class="page-title">Material Management</h2><p class="page-sub">Set quantities, add custom items</p></div>
<div class="card" style="margin-bottom:1rem;">
<div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
<input class="fi" id="matSearchGlobal" placeholder="üîç Search materials..." oninput="V.filterMats()" style="flex:1;min-width:200px;">
<button class="btn btn-sm btn-s" onclick="V.expandAllSections(true)">üìÇ Expand All</button>
<button class="btn btn-sm btn-s" onclick="V.expandAllSections(false)">üìÅ Collapse All</button>
</div></div>
<div id="matSections"></div>
<div class="card">
<div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;">
<button class="btn btn-g btn-w" onclick="V.saveCloud()">üíæ Save Cloud</button>
<button class="btn btn-s btn-w" onclick="V.go('pgPooja')">‚Üê Back</button>
</div>
<button class="btn btn-p btn-w" style="margin-top:0.75rem;" onclick="V.stepPreview()">Next: Preview & Download ‚Üí</button>
</div>
</section>

<!-- ===== PREVIEW ===== -->
<section id="pgPreview" class="page">
<div class="page-head"><h2 class="page-title">Preview & Download</h2><p class="page-sub">Edit fields inline, then download</p></div>
<div class="card">
<div class="card-head">
<h3 class="card-label"><span>üìÑ</span>Live Preview</h3>
<div style="display:flex;gap:0.4rem;flex-wrap:wrap;">
<button class="btn btn-sm btn-s" onclick="V.buildPreview()">üîÑ Refresh</button>
<button class="btn btn-sm btn-s" onclick="V.modal('mSettings',1)">üé® Theme</button>
</div></div>
<div class="preview-wrap" id="previewWrap"><p style="color:#666;text-align:center;padding:2rem;">Click Refresh to generate preview</p></div>
</div>
<div class="card">
<div class="card-head"><h3 class="card-label"><span>üì•</span>Download Options</h3></div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:0.75rem;">
<button class="btn btn-p" onclick="V.dlPDF()">üìÑ PDF Download</button>
<button class="btn btn-g" onclick="V.dlImages()">üñºÔ∏è Images (ZIP)</button>
<button class="btn btn-s" onclick="V.share()">üì§ Share / WhatsApp</button>
<button class="btn btn-s" onclick="window.print()">üñ®Ô∏è Print</button>
</div></div>
<button class="btn btn-s btn-w" onclick="V.go('pgMats')">‚Üê Back to Materials</button>
</section>

<!-- ===== YAJMANS PAGE ===== -->
<section id="pgYajmans" class="page">
<div class="page-head"><h2 class="page-title">üë• Yajman Management</h2><p class="page-sub">Manage your clients</p></div>
<div class="card">
<div class="card-head">
<h3 class="card-label"><span>üë•</span>Yajman List</h3>
<button class="btn btn-sm btn-p" onclick="V.showAddYajman()">‚ûï Add New</button>
</div>
<div class="fg"><input class="fi" id="yajSearch" placeholder="üîç Search yajmans..." oninput="V.renderYajmans()"></div>
<div id="yajList" style="display:grid;gap:0.75rem"></div>
</div>
</section>

<!-- ===== LIBRARY ===== -->
<section id="pgLib" class="page">
<div class="page-head"><h2 class="page-title">Cloud Library</h2><p class="page-sub">Saved templates</p></div>
<div class="card"><div class="fg"><input class="fi" id="libSearch" placeholder="üîç Search templates..." oninput="V.filterLib()"></div></div>
<div class="tpl-grid" id="tplGrid"></div>
</section>

<!-- ===== DATABASE ===== -->
<section id="pgDB" class="page">
<div class="page-head"><h2 class="page-title">Database Management</h2><p class="page-sub">Edit pooja & samagri master data</p></div>
<div class="card">
<div class="card-head">
<h3 class="card-label"><span>üóÑÔ∏è</span>Master Database</h3>
<div style="display:flex;gap:0.4rem;">
<button class="btn btn-sm btn-p" onclick="V.modal('mAdd',1)">‚ûï Add</button>
<button class="btn btn-sm btn-s" onclick="V.refreshAll()">üîÑ</button>
</div></div>
<div class="db-search"><input class="fi" id="dbSearch" placeholder="üîç Search database..." oninput="V.filterDB()"></div>
<div class="db-table-wrap" style="overflow-x:auto;">
<table class="dbtbl"><thead><tr><th>#</th><th>Pooja</th><th>Samagri</th><th>Actions</th></tr></thead><tbody id="dbBody"></tbody></table>
</div></div>
<div class="card">
<div class="card-head"><h3 class="card-label"><span>üìä</span>Stats</h3></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;">
<div style="text-align:center;padding:1rem;background:rgba(255,111,0,0.08);border-radius:var(--radius-md);"><div style="font-size:1.75rem;font-weight:800;color:white;" id="dbStP">0</div><div style="font-size:0.8rem;color:var(--gray-500);">Total Poojas</div></div>
<div style="text-align:center;padding:1rem;background:rgba(255,111,0,0.08);border-radius:var(--radius-md);"><div style="font-size:1.75rem;font-weight:800;color:white;" id="dbStS">0</div><div style="font-size:0.8rem;color:var(--gray-500);">Total Items</div></div>
</div></div>
</section>

<!-- ===== RASHIFAL ===== -->
<section id="pgRashi" class="page">
<div class="page-head"><h2 class="page-title">Rashifal Creator</h2><p class="page-sub">Beautiful horoscope posts</p></div>
<div class="rashi-container" id="rashiContainer">
<div style="text-align:center;padding:3rem;color:var(--gray-500);">
<p style="font-size:2rem;margin-bottom:1rem;">üåü</p>
<p>Click to load Rashifal Creator...</p>
</div>
</div>
</section>

</div><!-- /main -->

<button class="fab" onclick="V.go('pgSetup')" title="New Pooja">‚ûï</button>

<div class="tabbar"><div class="tabbar-inner">
<button class="tab on" data-pg="pgHome" onclick="V.go('pgHome')"><span class="tab-ico">üè†</span><span>Home</span></button>
<button class="tab" data-pg="pgSetup" onclick="V.go('pgSetup')"><span class="tab-ico">‚ûï</span><span>New</span></button>
<button class="tab" data-pg="pgYajmans" onclick="V.go('pgYajmans')"><span class="tab-ico">üë•</span><span>Yajmans</span></button>
<button class="tab" data-pg="pgDB" onclick="V.go('pgDB')"><span class="tab-ico">üóÑÔ∏è</span><span>Database</span></button>
<button class="tab" data-pg="pgLib" onclick="V.go('pgLib')"><span class="tab-ico">üìö</span><span>Library</span></button>
<button class="tab" onclick="V.modal('mSettings',1)"><span class="tab-ico">‚öôÔ∏è</span><span>Settings</span></button>
</div></div>
</div><!-- /shell -->

<div id="renderZone"></div>
<script>
const V={
API:"https://script.google.com/macros/s/AKfycbyhXVfu7WVAs2pQQLyH3lkkO3ZG-rmbqTmyygjqH8XeWyQPNgqx49whCIsa8WttKRZ4/exec",
CFG:{firstRows:15,nextRows:28,showChk:true,showRmk:true,showHdr:true,showFtr:true,fontSize:14,theme:'classic'},
THEMES:[
{id:'classic',name:'Classic',color:'#FF6F00'},{id:'royal',name:'Royal',color:'#800000'},
{id:'gold',name:'Gold',color:'#DAA520'},{id:'green',name:'Green',color:'#2E7D32'},
{id:'blue',name:'Blue',color:'#1565C0'},{id:'purple',name:'Purple',color:'#6A1B9A'},
{id:'teal',name:'Teal',color:'#00695C'},{id:'rose',name:'Rose',color:'#AD1457'},
{id:'amber',name:'Amber',color:'#FFA000'},{id:'indigo',name:'Indigo',color:'#283593'},
{id:'brown',name:'Brown',color:'#4E342E'},{id:'cyan',name:'Cyan',color:'#00838F'},
{id:'deeporange',name:'Deep Orange',color:'#D84315'},{id:'lime',name:'Lime',color:'#9E9D24'},
{id:'black',name:'Black',color:'#424242'},{id:'wine',name:'Wine',color:'#722F37'},
{id:'navy',name:'Navy',color:'#1B3A5C'},{id:'olive',name:'Olive',color:'#6B8E23'},
{id:'coral',name:'Coral',color:'#FF5722'},{id:'emerald',name:'Emerald',color:'#059669'},
{id:'crimson',name:'Crimson',color:'#B91C1C'},{id:'sapphire',name:'Sapphire',color:'#1E40AF'}
],
pandits:{
yugal:{id:'yugal',name:'‡§™‡§Ç. ‡§Ø‡•Å‡§ó‡§≤ ‡§Ü‡§ö‡§æ‡§∞‡•ç‡§Ø',title:'‡§µ‡•à‡§¶‡§ø‡§ï ‡§ú‡•ç‡§Ø‡•ã‡§§‡§ø‡§∑‡§æ‡§ö‡§æ‡§∞‡•ç‡§Ø ‡§è‡§µ‡§Ç ‡§µ‡§æ‡§∏‡•ç‡§§‡•Å ‡§µ‡§ø‡§∂‡•á‡§∑‡§ú‡•ç‡§û',phone:'+91 9928139485',website:'www.astroyugalacharya.in',address:'‡§ú‡§Ø‡§™‡•Å‡§∞, ‡§∞‡§æ‡§ú‡§∏‡•ç‡§•‡§æ‡§®'},
purushottam:{id:'purushottam',name:'‡§™‡§Ç. ‡§™‡•Å‡§∞‡•Å‡§∑‡•ã‡§§‡•ç‡§§‡§Æ ‡§∂‡§∞‡•ç‡§Æ‡§æ',title:'‡§ú‡•ç‡§Ø‡•ã‡§§‡§ø‡§∑‡§æ‡§ö‡§æ‡§∞‡•ç‡§Ø',phone:'+91 9680992496',website:'',address:'‡§∂‡•ç‡§∞‡•Ä ‡§∞‡§æ‡§Æ ‡§Æ‡§Ç‡§¶‡§ø‡§∞, ‡§ó‡§ø‡§∞‡§®‡§æ‡§∞ ‡§ï‡•â‡§≤‡•ã‡§®‡•Ä, ‡§µ‡•à‡§∂‡§æ‡§≤‡•Ä ‡§®‡§ó‡§∞, ‡§ú‡§Ø‡§™‡•Å‡§∞'}
},
S:{pandit:'yugal',yajman:'',phone:'',date:'',address:'',selPoojas:[],mats:[],master:[],templates:[],yajmans:[],editData:{},activities:[],collapsedSections:{},rashiLoaded:false},

async init(){
document.getElementById('inpDate').value=new Date().toISOString().split('T')[0];
this.loadCfg();this.loadState();this.drawThemeGrid();this.calcPreviewScale();
window.addEventListener('resize',()=>this.calcPreviewScale());
if('serviceWorker' in navigator){navigator.serviceWorker.register('sw.js').catch(function(){})}
try{await this.fetchMaster()}catch(e){console.error(e)}
try{await this.fetchTemplates()}catch(e){console.error(e)}
this.drawPandits();this.drawActivities();this.syncStats();
this.toast('Ready','System loaded','ok');
},

calcPreviewScale(){
var vw=window.innerWidth;
if(vw<=900){var s=Math.min(1,(vw-48)/793);document.documentElement.style.setProperty('--preview-scale',s.toFixed(3))}
},

go(id){
document.querySelectorAll('.page').forEach(function(p){p.classList.remove('on')});
var el=document.getElementById(id);if(el)el.classList.add('on');
document.querySelectorAll('.tab').forEach(function(t){t.classList.toggle('on',t.dataset.pg===id)});
window.scrollTo({top:0,behavior:'smooth'});
if(id==='pgDB'){this.drawDB();this.syncDBStats()}
if(id==='pgLib')this.drawLib();
if(id==='pgHome'){this.syncStats();this.drawActivities()}
if(id==='pgYajmans')this.renderYajmans();
if(id==='pgRashi'&&!this.S.rashiLoaded){this.loadRashiPage();this.S.rashiLoaded=true}
},

loadRashiPage(){
document.getElementById('rashiContainer').innerHTML='<iframe src="https://jaiminihome-ship-it.github.io/POOJASAMAGRI/Rashi.html" style="width:100%;height:calc(100vh - 250px);border:none;border-radius:12px;background:#050505;" loading="lazy"></iframe>';
},

modal(id,show){var el=document.getElementById(id);if(el)el.classList.toggle('on',!!show)},

confirm(msg,ico){
return new Promise(function(resolve){
document.getElementById('confirmMsg').textContent=msg;
document.getElementById('confirmIco').textContent=ico||'‚ö†Ô∏è';
document.getElementById('confirmDlg').classList.add('on');
var yB=document.getElementById('confirmYes'),nB=document.getElementById('confirmNo');
var cl=function(){document.getElementById('confirmDlg').classList.remove('on');yB.removeEventListener('click',onY);nB.removeEventListener('click',onN)};
var onY=function(){cl();resolve(true)};var onN=function(){cl();resolve(false)};
yB.addEventListener('click',onY);nB.addEventListener('click',onN);
});
},

toast(title,msg,type){
type=type||'info';var c=document.getElementById('toasts');
var icos={ok:'‚úÖ',err:'‚ùå',warn:'‚ö†Ô∏è',info:'‚ÑπÔ∏è'};
var d=document.createElement('div');d.className='toast-item '+type;
d.innerHTML='<div class="toast-ico">'+(icos[type]||'‚ÑπÔ∏è')+'</div><div class="toast-body"><div class="toast-ttl">'+title+'</div>'+(msg?'<div class="toast-msg">'+msg+'</div>':'')+'</div>';
c.appendChild(d);setTimeout(function(){if(d.parentNode)d.remove()},3000);
},

load(txt){document.getElementById('loaderTxt').textContent=txt||'Processing...';document.getElementById('loader').classList.add('on')},
unload(){document.getElementById('loader').classList.remove('on')},

logActivity(icon,title){
this.S.activities.unshift({icon:icon,title:title,time:new Date().toLocaleString('hi-IN')});
if(this.S.activities.length>30)this.S.activities.length=30;this.saveState();
},

drawActivities(){
var el=document.getElementById('activityList');
if(!this.S.activities||!this.S.activities.length){el.innerHTML='<div style="text-align:center;padding:1.5rem;color:var(--gray-500);">No recent activity</div>';return}
el.innerHTML=this.S.activities.slice(0,10).map(function(a){return'<div class="activity-item"><div class="activity-ico">'+a.icon+'</div><div class="activity-text"><div class="act-title">'+a.title+'</div><div class="act-time">'+a.time+'</div></div></div>'}).join('');
},

loadCfg(){
try{
var s=JSON.parse(localStorage.getItem('vedicCfg')||'{}');
if(s.firstRows)this.CFG.firstRows=s.firstRows;if(s.nextRows)this.CFG.nextRows=s.nextRows;
if(s.fontSize)this.CFG.fontSize=s.fontSize;
if(s.showChk!==undefined)this.CFG.showChk=s.showChk;if(s.showRmk!==undefined)this.CFG.showRmk=s.showRmk;
if(s.showHdr!==undefined)this.CFG.showHdr=s.showHdr;if(s.showFtr!==undefined)this.CFG.showFtr=s.showFtr;
if(s.theme)this.CFG.theme=s.theme;
}catch(e){}
this._syncSettingsUI();
},

_syncSettingsUI(){
var el=function(id){return document.getElementById(id)};
if(el('sFirstRows'))el('sFirstRows').value=this.CFG.firstRows;
if(el('sNextRows'))el('sNextRows').value=this.CFG.nextRows;
if(el('sFontSize'))el('sFontSize').value=this.CFG.fontSize;
if(el('sFontVal'))el('sFontVal').textContent=this.CFG.fontSize+'px';
if(el('sShowChk'))el('sShowChk').checked=this.CFG.showChk;
if(el('sShowRmk'))el('sShowRmk').checked=this.CFG.showRmk;
if(el('sShowHdr'))el('sShowHdr').checked=this.CFG.showHdr;
if(el('sShowFtr'))el('sShowFtr').checked=this.CFG.showFtr;
},

saveSettings(){
this.CFG.firstRows=parseInt(document.getElementById('sFirstRows').value)||15;
this.CFG.nextRows=parseInt(document.getElementById('sNextRows').value)||28;
this.CFG.fontSize=parseInt(document.getElementById('sFontSize').value)||14;
this.CFG.showChk=document.getElementById('sShowChk').checked;
this.CFG.showRmk=document.getElementById('sShowRmk').checked;
this.CFG.showHdr=document.getElementById('sShowHdr').checked;
this.CFG.showFtr=document.getElementById('sShowFtr').checked;
localStorage.setItem('vedicCfg',JSON.stringify(this.CFG));
this.modal('mSettings',0);this.toast('Saved','Settings updated','ok');this.logActivity('‚öôÔ∏è','Settings updated');
},

drawThemeGrid(){
var g=document.getElementById('themeGrid');if(!g)return;
var self=this;
g.innerHTML=this.THEMES.map(function(t){return'<div class="theme-swatch '+(self.CFG.theme===t.id?'picked':'')+'" onclick="V.pickTheme(\''+t.id+'\')"><div class="swatch-color" style="background:'+t.color+';"></div><div>'+t.name+'</div></div>'}).join('');
},

pickTheme(id){
this.CFG.theme=id;localStorage.setItem('vedicCfg',JSON.stringify(this.CFG));
this.drawThemeGrid();this.toast('Theme',id,'ok');
},

_themeClass(){return this.CFG.theme&&this.CFG.theme!=='classic'?' pdf-theme-'+this.CFG.theme:''},

saveState(){
try{
var o=JSON.parse(JSON.stringify(this.S));
if(o.editData)delete o.editData.remark;
localStorage.setItem('vedicState',JSON.stringify(o));
}catch(e){}
},

loadState(){
try{
var s=JSON.parse(localStorage.getItem('vedicState')||'{}');
if(s.pandit)this.S.pandit=s.pandit;
if(s.yajman)this.S.yajman=s.yajman;
if(s.phone)this.S.phone=s.phone;
if(s.date)this.S.date=s.date;
if(s.address)this.S.address=s.address;
if(Array.isArray(s.selPoojas))this.S.selPoojas=s.selPoojas;
if(Array.isArray(s.mats))this.S.mats=s.mats;
if(Array.isArray(s.activities))this.S.activities=s.activities;
if(s.collapsedSections)this.S.collapsedSections=s.collapsedSections;
if(s.editData){this.S.editData=s.editData;this.S.editData.remark=''}
}catch(e){}
},

async refreshAll(){
this.load('Refreshing...');
try{await this.fetchMaster();await this.fetchTemplates();this.syncStats();this.toast('Refreshed','Data updated','ok');this.logActivity('üîÑ','Refreshed')}
catch(e){this.toast('Error',e.message,'err')}
this.unload();
},

async fetchMaster(){
try{
var r=await fetch(this.API);if(!r.ok)throw new Error('HTTP '+r.status);
var data=await r.json();
if(Array.isArray(data))this.S.master=data.filter(function(x){return x&&x.pooja&&x.samagri});
}catch(e){console.error(e);if(!this.S.master.length)this.toast('Warning','Could not load data','warn')}
this.drawPoojaList();this.drawDB();this.syncDBStats();this.fillExistingSel();
},

async fetchTemplates(){
try{
var r=await fetch(this.API+'?action=getTemplates');if(!r.ok)throw new Error('HTTP '+r.status);
var data=await r.json();
if(Array.isArray(data)){
this.S.templates=data.map(function(row){return{
id:(row.id||Date.now()).toString(),name:row.name||'Unknown',date:row.date||'',
poojas:Array.isArray(row.poojas)?row.poojas.join(', '):(row.poojas||''),
poojasArr:Array.isArray(row.poojas)?row.poojas:(typeof row.poojas==='string'?row.poojas.split(',').map(function(p){return p.trim()}).filter(Boolean):[]),
samagri:row.samagri||[]
}});
}
}catch(e){console.error(e)}
this.drawLib();this.syncStats();
},

async apiPost(payload){
try{
var r=await fetch(this.API,{method:'POST',redirect:'follow',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(payload)});
var text=await r.text();try{return JSON.parse(text)}catch(e){return{status:text}}
}catch(e){
try{await fetch(this.API,{method:'POST',mode:'no-cors',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(payload)});return{status:'sent'}}
catch(e2){throw e2}
}
},

drawPandits(){
var g=document.getElementById('panditGrid');if(!g)return;
var self=this;
g.innerHTML=Object.values(this.pandits).map(function(p){
return'<div class="pandit-card '+(self.S.pandit===p.id?'picked':'')+'" onclick="V.pickPandit(\''+p.id+'\')">' +
'<div class="pandit-top"><div class="pandit-av">üôè</div><div><div class="pandit-nm">'+p.name+'</div><div class="pandit-tl">'+p.title+'</div></div></div>' +
'<div class="pandit-det"><span>üìû '+p.phone+'</span><span>üìç '+p.address+'</span>'+(p.website?'<span>üåê '+p.website+'</span>':'')+'</div></div>'
}).join('');
},

pickPandit(id){this.S.pandit=id;this.drawPandits();this.saveState();this.toast('Selected',this.pandits[id].name,'ok')},

_uniquePoojas(){return[...new Set(this.S.master.map(function(x){return(x.pooja||'').trim()}))].filter(Boolean)},
_esc(s){return(s||'').replace(/'/g,"\\'").replace(/"/g,'&quot;')},

drawPoojaList(filter){
var all=this._uniquePoojas();
var self=this;
if(filter){var q=filter.toLowerCase();all=all.filter(function(n){return n.toLowerCase().includes(q)})}
var g=document.getElementById('poojaList');if(!g)return;
if(!all.length){g.innerHTML='<p style="color:var(--gray-500);text-align:center;padding:2rem;">'+(filter?'No match':'No poojas')+'</p>';return}
g.innerHTML=all.map(function(name){
var cnt=self.S.master.filter(function(x){return x.pooja===name}).length;
var sel=self.S.selPoojas.some(function(p){return p.name===name});
var idx=self.S.selPoojas.findIndex(function(p){return p.name===name});
var orderNum=sel?(idx+1):'';
return'<div class="pooja-row '+(sel?'picked':'')+'" onclick="V.togPooja(\''+self._esc(name)+'\')">' +
'<div class="pooja-tick"></div>' +
'<div class="pooja-body"><div class="pooja-nm">'+(sel?'<span class="badge badge-bhagwa" style="margin-right:0.3rem;">'+orderNum+'</span>':'')+name+'</div><div class="pooja-ct">'+cnt+' items</div></div>' +
(sel?'<div class="pooja-arrows"><button class="arr-btn" onclick="event.stopPropagation();V.moveP('+idx+',-1)">‚ñ≤</button><button class="arr-btn" onclick="event.stopPropagation();V.moveP('+idx+',1)">‚ñº</button></div>':'') +
'</div>';
}).join('');
},

filterPoojas(){this.drawPoojaList((document.getElementById('poojaSearch')||{}).value||'')},

togPooja(name){
var i=this.S.selPoojas.findIndex(function(p){return p.name===name});
if(i>-1)this.S.selPoojas.splice(i,1);else this.S.selPoojas.push({name:name,order:this.S.selPoojas.length});
this.drawPoojaList((document.getElementById('poojaSearch')||{}).value||'');this.saveState();
},

moveP(i,dir){
var j=i+dir;if(j<0||j>=this.S.selPoojas.length)return;
var temp=this.S.selPoojas[i];this.S.selPoojas[i]=this.S.selPoojas[j];this.S.selPoojas[j]=temp;
this.drawPoojaList((document.getElementById('poojaSearch')||{}).value||'');this.saveState();
},

selAll(){this.S.selPoojas=this._uniquePoojas().map(function(name,i){return{name:name,order:i}});this.drawPoojaList();this.saveState();this.toast('All Selected',this.S.selPoojas.length+' poojas','ok')},
selNone(){this.S.selPoojas=[];this.drawPoojaList();this.saveState()},

stepPooja(){
var y=document.getElementById('inpYajman').value.trim();
if(!y){this.toast('Required','Enter yajman name','warn');document.getElementById('inpYajman').focus();return}
this.S.yajman=y;this.S.phone=document.getElementById('inpPhone').value.trim();
this.S.date=document.getElementById('inpDate').value;this.S.address=(document.getElementById('inpAddress')||{}).value||'';
this.saveState();this.go('pgPooja');
},

stepMats(){
if(!this.S.selPoojas.length){this.toast('Required','Select at least one pooja','warn');return}
this.buildMats();this.drawMats();this.go('pgMats');
},

stepPreview(){
this.S.editData={
yajman:this.S.yajman||'',phone:this.S.phone||'',date:this.S.date||'',
address:this.S.address||'',poojas:this.S.selPoojas.map(function(p){return p.name}).join(', '),
remark:''
};
var self=this;
this.go('pgPreview');setTimeout(function(){self.buildPreview()},300);
},

buildMats(){
var existing=new Map();this.S.mats.forEach(function(m){existing.set(m.pooja+'||'+m.name,m)});
var newMats=[];
var self=this;
this.S.selPoojas.forEach(function(p){
var items=self.S.master.filter(function(d){return d.pooja===p.name});
items.forEach(function(item){var key=p.name+'||'+item.samagri;if(existing.has(key))newMats.push(existing.get(key));else newMats.push({pooja:p.name,name:item.samagri,qty:'',unit:'',on:true,custom:false})});
self.S.mats.filter(function(m){return m.pooja===p.name&&m.custom}).forEach(function(cm){if(!newMats.some(function(n){return n.pooja===cm.pooja&&n.name===cm.name}))newMats.push(cm)});
});
this.S.mats=newMats;
},

drawMats(filter){
var c=document.getElementById('matSections');if(!c)return;
var fq=(filter||'').toLowerCase();
var self=this;
c.innerHTML=this.S.selPoojas.map(function(p){
var items=self.S.mats.filter(function(m){return m.pooja===p.name});
var totalCount=items.length;var onCount=items.filter(function(m){return m.on}).length;
if(fq)items=items.filter(function(m){return m.name.toLowerCase().includes(fq)});
var sk=p.name.replace(/\s/g,'_');var collapsed=self.S.collapsedSections[sk];
return'<div class="card mat-section">' +
'<div class="mat-head" onclick="V.toggleSection(\''+sk+'\')" style="cursor:pointer;">' +
'<div class="mat-head-title"><span>'+(collapsed?'‚ñ∂':'‚ñº')+'</span><span>üïâÔ∏è '+p.name+'</span><span class="mat-head-count">'+onCount+'/'+totalCount+'</span></div>' +
'<div style="display:flex;gap:0.3rem;" onclick="event.stopPropagation();"><button class="btn btn-xs btn-s" onclick="V.togAllMats(\''+self._esc(p.name)+'\')">Toggle</button></div>' +
'</div>' +
(collapsed?'':(
'<div class="mat-grid">' +
items.map(function(m){
var gi=self.S.mats.indexOf(m);if(gi===-1)return'';
return'<div class="mat-row'+(!m.on?' mat-off':'')+(m.custom?' mat-custom':'')+'">' +
'<input type="checkbox" class="mat-chk" '+(m.on?'checked':'')+' onchange="V.S.mats['+gi+'].on=this.checked;V.drawMats(\''+(fq||'')+'\');V.saveState()">' +
'<div class="mat-nm" title="'+m.name+(m.custom?' (Custom)':'')+'">'+m.name+(m.custom?' ‚≠ê':'')+'</div>' +
'<input class="mat-qty" placeholder="Qty" value="'+(m.qty||'')+'" oninput="V.S.mats['+gi+'].qty=this.value;V.saveState()">' +
'<select class="mat-unit" onchange="V.S.mats['+gi+'].unit=this.value;V.saveState()">' +
'<option value="">Unit</option>' +
'<option'+(m.unit==='‡§ó‡•ç‡§∞‡§æ‡§Æ'?' selected':'')+'>‡§ó‡•ç‡§∞‡§æ‡§Æ</option>' +
'<option'+(m.unit==='‡§ï‡§ø‡§ó‡•ç‡§∞‡§æ'?' selected':'')+'>‡§ï‡§ø‡§ó‡•ç‡§∞‡§æ</option>' +
'<option'+(m.unit==='‡§®‡§ó'?' selected':'')+'>‡§®‡§ó</option>' +
'<option'+(m.unit==='‡§™‡•à‡§ï‡•á‡§ü'?' selected':'')+'>‡§™‡•à‡§ï‡•á‡§ü</option>' +
'<option'+(m.unit==='‡§ú‡•ã‡§°‡§º‡§æ'?' selected':'')+'>‡§ú‡•ã‡§°‡§º‡§æ</option>' +
'<option'+(m.unit==='‡§∞‡•Å‡§™‡§Ø‡•á'?' selected':'')+'>‡§∞‡•Å‡§™‡§Ø‡•á</option>' +
'<option'+(m.unit==='‡§≤‡•Ä‡§ü‡§∞'?' selected':'')+'>‡§≤‡•Ä‡§ü‡§∞</option>' +
'<option'+(m.unit==='‡§≤‡§ö‡•ç‡§õ‡§æ'?' selected':'')+'>‡§≤‡§ö‡•ç‡§õ‡§æ</option>' +
'<option'+(m.unit==='‡§Æ‡•Ä‡§ü‡§∞'?' selected':'')+'>‡§Æ‡•Ä‡§ü‡§∞</option>' +
'<option'+(m.unit==='‡§¨‡§£‡•ç‡§°‡§≤'?' selected':'')+'>‡§¨‡§£‡•ç‡§°‡§≤</option>' +
'<option'+(m.unit==='‡§õ‡•ã‡§ü‡•Ä ‡§∂‡•Ä‡§∂‡•Ä'?' selected':'')+'>‡§õ‡•ã‡§ü‡•Ä ‡§∂‡•Ä‡§∂‡•Ä</option>' +
'<option'+(m.unit==='‡§¨‡§°‡§º‡•Ä ‡§∂‡•Ä‡§∂‡•Ä'?' selected':'')+'>‡§¨‡§°‡§º‡•Ä ‡§∂‡•Ä‡§∂‡•Ä</option>' +
'</select>' +
(m.custom?'<button class="mat-del-btn" onclick="V.removeCustomItem('+gi+')">üóëÔ∏è</button>':'<div></div>') +
'</div>';
}).join('') +
'</div>' +
'<div class="add-item-row">' +
'<input class="add-item-input" id="addInput_'+sk+'" placeholder="‚ûï ‡§®‡§à ‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä ‡§ú‡•ã‡§°‡§º‡•á‡§Ç..." onkeydown="if(event.key===\'Enter\')V.addCustomItem(\''+self._esc(p.name)+'\')">' +
'<button class="btn btn-sm btn-p" onclick="V.addCustomItem(\''+self._esc(p.name)+'\')">Add</button>' +
'</div>'
)) +
'</div>';
}).join('');
},

toggleSection(key){this.S.collapsedSections[key]=!this.S.collapsedSections[key];this.drawMats((document.getElementById('matSearchGlobal')||{}).value||'');this.saveState()},

expandAllSections(expand){
var self=this;
this.S.selPoojas.forEach(function(p){self.S.collapsedSections[p.name.replace(/\s/g,'_')]=!expand});
this.drawMats((document.getElementById('matSearchGlobal')||{}).value||'');this.saveState();
},

filterMats(){this.drawMats((document.getElementById('matSearchGlobal')||{}).value||'')},

async addCustomItem(poojaName){
var sk=poojaName.replace(/\s/g,'_');var input=document.getElementById('addInput_'+sk);
if(!input)return;var val=input.value.trim();
if(!val){this.toast('Required','Enter item name','warn');return}
if(this.S.mats.some(function(m){return m.pooja===poojaName&&m.name===val})){this.toast('Duplicate','Already exists','warn');return}
this.S.mats.push({pooja:poojaName,name:val,qty:'',unit:'',on:true,custom:true});
input.value='';this.drawMats((document.getElementById('matSearchGlobal')||{}).value||'');this.saveState();
this.toast('Added','"'+val+'" added','ok');
try{await this.apiPost({action:'add',pooja:poojaName,samagri:val});this.S.master.push({pooja:poojaName,samagri:val});this.logActivity('‚ûï','Added "'+val+'" to '+poojaName)}
catch(e){this.toast('Warning','Local only','warn')}
},

removeCustomItem(gi){
var m=this.S.mats[gi];if(!m||!m.custom)return;
this.S.mats.splice(gi,1);this.drawMats((document.getElementById('matSearchGlobal')||{}).value||'');
this.saveState();this.toast('Removed','Item removed','ok');
},

togAllMats(poojaName){
var items=this.S.mats.filter(function(m){return m.pooja===poojaName});var allOn=items.every(function(m){return m.on});
items.forEach(function(m){m.on=!allOn});this.drawMats((document.getElementById('matSearchGlobal')||{}).value||'');this.saveState();
},

_getAllPairs(){
var included=this.S.mats.filter(function(m){return m.on});
var allItems=[];
var self=this;
this.S.selPoojas.forEach(function(sp){
included.filter(function(m){return m.pooja===sp.name}).forEach(function(m){allItems.push(m)});
});
var pairs=[];
for(var i=0;i<allItems.length;i+=2){pairs.push([allItems[i],allItems[i+1]||null])}
return pairs;
},

_tableRowsHTML(pairs){
var self=this;
return pairs.map(function(p){
var c1c=self.CFG.showChk?'<td class="chk-cell"><span class="chk-box"></span></td>':'';
var c1r=self.CFG.showRmk?'<td class="rmk-cell"></td>':'';
var c2c=self.CFG.showChk?'<td class="chk-cell">'+(p[1]?'<span class="chk-box"></span>':'')+'</td>':'';
var c2r=self.CFG.showRmk?'<td class="rmk-cell"></td>':'';
return'<tr>'+c1c+
'<td>'+(p[0]?p[0].name:'')+'</td>'+
'<td>'+(p[0]?((p[0].qty||'')+' '+(p[0].unit||'')).trim():'')+'</td>'+
c1r+c2c+
'<td>'+(p[1]?p[1].name:'')+'</td>'+
'<td>'+(p[1]?((p[1].qty||'')+' '+(p[1].unit||'')).trim():'')+'</td>'+
c2r+'</tr>';
}).join('');
},

_tableHeadHTML(){
var chkTH=this.CFG.showChk?'<th class="chk-cell">‚òê</th>':'';
var rmkTH=this.CFG.showRmk?'<th class="rmk-cell">‡§ü‡§ø‡§™‡•ç‡§™‡§£‡•Ä</th>':'';
return'<thead><tr>'+chkTH+'<th>‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä</th><th>‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ</th>'+rmkTH+chkTH+'<th>‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä</th><th>‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ</th>'+rmkTH+'</tr></thead>';
},

_buildTableHTML(pairs){
return'<table class="pdf-tbl">'+this._tableHeadHTML()+'<tbody>'+this._tableRowsHTML(pairs)+'</tbody></table>';
},

_paginate(){
var allPairs=this._getAllPairs();
if(!allPairs.length)return[];
var pages=[];var idx=0;var isFirst=true;
while(idx<allPairs.length){
var maxRows=isFirst?this.CFG.firstRows:this.CFG.nextRows;
var chunk=allPairs.slice(idx,idx+maxRows);
pages.push({isFirst:isFirst,pairs:chunk});idx+=maxRows;isFirst=false;
}
return pages;
},

_headerHTML(editable){
if(!this.CFG.showHdr)return'';
var p=this.pandits[this.S.pandit]||this.pandits.yugal;var ed=this.S.editData||{};
var yF,dF,phF,pjF,adF;
if(editable){
yF='<input type="text" class="editable-inline" data-field="yajman" value="'+(ed.yajman||'')+'">';
dF='<input type="text" class="editable-inline" data-field="date" value="'+(ed.date||'')+'">';
phF='<input type="text" class="editable-inline" data-field="phone" value="'+(ed.phone||'')+'">';
pjF='<input type="text" class="editable-inline" data-field="poojas" value="'+(ed.poojas||'')+'" style="width:95%;">';
adF='<input type="text" class="editable-inline" data-field="address" value="'+(ed.address||p.address||'')+'" style="width:90%;">';
}else{
yF=ed.yajman||this.S.yajman||'';dF=ed.date||this.S.date||'';phF=ed.phone||this.S.phone||'';
pjF=ed.poojas||this.S.selPoojas.map(function(x){return x.name}).join(', ');adF=ed.address||this.S.address||p.address||'';
}
return'<div class="pdf-hdr"><div class="pdf-swastik">Âçê</div><div class="pdf-hdr-center"><h1>‡•• ‡§∂‡•ç‡§∞‡•Ä ‡§ó‡§£‡•á‡§∂‡§æ‡§Ø ‡§®‡§Æ‡§É ‡••</h1><h2>‡§™‡•Ç‡§ú‡§æ ‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä ‡§∏‡•Ç‡§ö‡•Ä</h2></div><div class="pdf-swastik">Âçê</div></div>' +
'<div class="pdf-divider"></div>' +
'<div class="pdf-info"><div><b>‡§Ø‡§ú‡§Æ‡§æ‡§®:</b> '+yF+'</div><div><b>‡§§‡§æ‡§∞‡•Ä‡§ñ:</b> '+dF+'</div><div><b>‡§™‡§Ç‡§°‡§ø‡§§:</b> '+p.name+'</div><div><b>‡§´‡•ã‡§®:</b> '+phF+'</div><div class="full"><b>‡§™‡•Ç‡§ú‡§æ:</b>&nbsp;'+pjF+'</div><div class="full"><b>‡§™‡§§‡§æ:</b>&nbsp;'+adF+'</div></div>' +
'<div class="pdf-swastika-line">Âçê Âçê Âçê Âçê Âçê Âçê Âçê Âçê Âçê Âçê Âçê Âçê Âçê Âçê Âçê Âçê Âçê Âçê Âçê Âçê</div>';
},

_footerHTML(){
if(!this.CFG.showFtr)return'';
var p=this.pandits[this.S.pandit]||this.pandits.yugal;
return'<div class="pdf-ftr"><div><strong>‡§™‡§Ç‡§°‡§ø‡§§:</strong> '+p.name+' | <strong>‡§´‡•ã‡§®:</strong> '+p.phone+'</div><div><strong>‡§™‡§§‡§æ:</strong> '+p.address+'</div>'+(p.website?'<div><strong>‡§µ‡•á‡§¨‡§∏‡§æ‡§á‡§ü:</strong> '+p.website+'</div>':'')+'</div>';
},

_remarkHTML(editable){
var val=(this.S.editData&&this.S.editData.remark)?this.S.editData.remark:'';
if(editable){
return'<div class="pdf-remark-section"><div class="pdf-remark-title">üìù ‡§µ‡§ø‡§∂‡•á‡§∑ ‡§ü‡§ø‡§™‡•ç‡§™‡§£‡•Ä / Special Remarks:</div><textarea class="remark-box" placeholder="‡§Ø‡§π‡§æ‡§Å ‡§µ‡§ø‡§∂‡•á‡§∑ ‡§ü‡§ø‡§™‡•ç‡§™‡§£‡•Ä ‡§≤‡§ø‡§ñ‡•á‡§Ç..." oninput="V.S.editData.remark=this.value">'+val+'</textarea></div>';
}else{
return'<div class="pdf-remark-section"><div class="pdf-remark-title">üìù ‡§µ‡§ø‡§∂‡•á‡§∑ ‡§ü‡§ø‡§™‡•ç‡§™‡§£‡•Ä / Special Remarks:</div><div style="min-height:60px;padding:8px;font-size:13px;white-space:pre-wrap;border:1.5px dashed #999;">'+val+'</div></div>';
}
},

buildPreview(){
this.load('Building preview...');
var tc=this._themeClass();
var self=this;
try{
var pages=this._paginate();var wrap=document.getElementById('previewWrap');
if(!pages.length){wrap.innerHTML='<p style="color:#666;text-align:center;padding:2rem;">No materials selected.</p>';this.unload();return}
var total=pages.length;
wrap.innerHTML=pages.map(function(pg,pi){
var content='';
if(pg.isFirst)content+=self._headerHTML(true);
content+=self._buildTableHTML(pg.pairs);
if(pi===total-1)content+=self._remarkHTML(true);
content+=self._footerHTML();
return'<div class="preview-page"><div class="preview-page-num">Page '+(pi+1)+' / '+total+'</div><div class="pdfpage'+tc+'" style="font-size:'+self.CFG.fontSize+'px;">'+content+'</div></div>';
}).join('');
wrap.querySelectorAll('.editable-inline').forEach(function(inp){
inp.addEventListener('input',function(e){if(e.target.dataset.field)self.S.editData[e.target.dataset.field]=e.target.value});
});
this.calcPreviewScale();this.unload();this.toast('Preview Ready',total+' page(s)','ok');
}catch(e){this.unload();this.toast('Error','Preview failed: '+e.message,'err')}
},

// =====================================================
// üî• OPTIMIZED RENDER - ONE PAGE AT A TIME (NO CRASH) üî•
// =====================================================

_createRenderPage(pg,pi,total){
var tc=this._themeClass();
var div=document.createElement('div');
div.className='pdfpage render-mode'+tc;
div.style.fontSize=this.CFG.fontSize+'px';
var content='';
if(pg.isFirst)content+=this._headerHTML(false);
content+=this._buildTableHTML(pg.pairs);
if(pi===total-1)content+=this._remarkHTML(false);
if(this.CFG.showFtr)content+='<div style="position:absolute;bottom:25px;left:30px;right:30px;">'+this._footerHTML()+'</div>';
div.innerHTML=content;
return div;
},

_syncEditData(){
var self=this;
document.querySelectorAll('.editable-inline').forEach(function(inp){
if(inp.dataset.field)self.S.editData[inp.dataset.field]=inp.value;
});
var rb=document.querySelector('.remark-box');
if(rb)this.S.editData.remark=rb.value||'';
},

// =====================================================
// üî• FORCE DOWNLOAD - NO SHARE SHEET üî•
// =====================================================

_forceDownload(blob,filename){
try{
    var url=URL.createObjectURL(blob);
    var a=document.createElement('a');
    a.href=url;
    a.download=filename;
    a.style.cssText='position:fixed;top:0;left:0;opacity:0;pointer-events:none;z-index:99999;';
    document.body.appendChild(a);
    setTimeout(function(){
        a.click();
        setTimeout(function(){
            if(a.parentNode)document.body.removeChild(a);
            URL.revokeObjectURL(url);
        },5000);
    },200);
    return true;
}catch(e){return false}
},

_downloadWithFallback(blob,filename){
var self=this;
var ok=this._forceDownload(blob,filename);
if(!ok){
    try{
        var url=URL.createObjectURL(blob);
        window.open(url,'_blank');
        self.toast('Opened','Long press to save','warn');
        setTimeout(function(){URL.revokeObjectURL(url)},60000);
    }catch(e){
        self.toast('Error','Download failed','err');
    }
}
},

// =====================================================
// üî• PDF DOWNLOAD - OPTIMIZED FOR PHONE üî•
// =====================================================

async dlPDF(){
    this.load('Preparing PDF...');
    var self=this;
    try{
        this._syncEditData();
        var allPages=this._paginate();
        if(!allPages.length){this.unload();this.toast('Error','No pages','warn');return}

        var zone=document.getElementById('renderZone');
        var jsPDFLib=window.jspdf;
        var pdf=new jsPDFLib.jsPDF('p','mm','a4');
        var total=allPages.length;

        for(var i=0;i<total;i++){
            self.load('Rendering page '+(i+1)+'/'+total+'...');

            // Ek page banao
            zone.innerHTML='';
            var pageDiv=self._createRenderPage(allPages[i],i,total);
            zone.appendChild(pageDiv);

            // Thoda wait karo render hone do
            await new Promise(function(r){setTimeout(r,300)});

            // Canvas banao - LOW SCALE for phone
            var canvas=await html2canvas(pageDiv,{
                scale:2,
                useCORS:true,
                backgroundColor:'#ffffff',
                logging:false,
                allowTaint:true
            });

            if(i>0)pdf.addPage();
            pdf.addImage(canvas.toDataURL('image/jpeg',0.85),'JPEG',0,0,210,297);

            // Memory cleanup
            canvas=null;
            zone.innerHTML='';
            await new Promise(function(r){setTimeout(r,100)});
        }

        var name=(this.S.editData.yajman||this.S.yajman||'Pooja')+'_Samagri.pdf';
        var blob=pdf.output('blob');
        pdf=null;
        zone.innerHTML='';

        self.unload();
        self._downloadWithFallback(blob,name);
        self.toast('PDF Downloaded',name,'ok');
        self.logActivity('üìÑ','PDF: '+name);

    }catch(e){
        document.getElementById('renderZone').innerHTML='';
        self.unload();
        self.toast('Error','PDF failed: '+e.message,'err');
    }
},

// =====================================================
// üî• IMAGES ZIP - OPTIMIZED FOR PHONE üî•
// =====================================================

async dlImages(){
    this.load('Preparing images...');
    var self=this;
    try{
        this._syncEditData();
        var allPages=this._paginate();
        if(!allPages.length){this.unload();return}

        var zone=document.getElementById('renderZone');
        var zip=new JSZip();
        var fn=(this.S.editData.yajman||'Pooja')+'_Samagri';
        var folder=zip.folder(fn);
        var total=allPages.length;

        for(var i=0;i<total;i++){
            self.load('Rendering image '+(i+1)+'/'+total+'...');

            zone.innerHTML='';
            var pageDiv=self._createRenderPage(allPages[i],i,total);
            zone.appendChild(pageDiv);

            await new Promise(function(r){setTimeout(r,300)});

            var canvas=await html2canvas(pageDiv,{
                scale:2,
                useCORS:true,
                backgroundColor:'#ffffff',
                logging:false,
                allowTaint:true
            });

            var imgBlob=await new Promise(function(r){canvas.toBlob(r,'image/png')});
            folder.file('Page_'+(i+1)+'.png',imgBlob);

            canvas=null;
            imgBlob=null;
            zone.innerHTML='';
            await new Promise(function(r){setTimeout(r,100)});
        }

        self.load('Creating ZIP...');
        var zipBlob=await zip.generateAsync({type:'blob'});
        zip=null;
        zone.innerHTML='';

        self.unload();
        self._downloadWithFallback(zipBlob,fn+'.zip');
        self.toast('ZIP Downloaded',fn+'.zip','ok');
        self.logActivity('üñºÔ∏è','Images: '+fn);

    }catch(e){
        document.getElementById('renderZone').innerHTML='';
        self.unload();
        self.toast('Error',e.message,'err');
    }
},

// =====================================================
// üî• SHARE - ONLY THIS USES SHARE SHEET üî•
// =====================================================

async share(){
    this.load('Preparing...');
    var self=this;
    try{
        this._syncEditData();
        var allPages=this._paginate();
        if(!allPages.length){this.unload();return}

        var zone=document.getElementById('renderZone');
        var jsPDFLib=window.jspdf;
        var pdf=new jsPDFLib.jsPDF('p','mm','a4');
        var total=allPages.length;

        for(var i=0;i<total;i++){
            self.load('Preparing '+(i+1)+'/'+total+'...');
            zone.innerHTML='';
            var pageDiv=self._createRenderPage(allPages[i],i,total);
            zone.appendChild(pageDiv);
            await new Promise(function(r){setTimeout(r,300)});
            var canvas=await html2canvas(pageDiv,{scale:2,useCORS:true,backgroundColor:'#ffffff',logging:false,allowTaint:true});
            if(i>0)pdf.addPage();
            pdf.addImage(canvas.toDataURL('image/jpeg',0.85),'JPEG',0,0,210,297);
            canvas=null;
            zone.innerHTML='';
            await new Promise(function(r){setTimeout(r,100)});
        }

        var blob=pdf.output('blob');
        var fileName=(this.S.editData.yajman||'Pooja')+'_Samagri.pdf';
        pdf=null;
        zone.innerHTML='';
        self.unload();

        if(navigator.share&&navigator.canShare){
            try{
                var file=new File([blob],fileName,{type:'application/pdf'});
                if(navigator.canShare({files:[file]})){
                    await navigator.share({files:[file],title:'‡§™‡•Ç‡§ú‡§æ ‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä ‡§∏‡•Ç‡§ö‡•Ä',text:(self.S.editData.yajman||self.S.yajman)+' ‡§ï‡•Ä ‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä ‡§∏‡•Ç‡§ö‡•Ä'});
                    self.logActivity('üì§','Shared: '+fileName);
                    return;
                }
            }catch(e){if(e.name==='AbortError')return}
        }
        self._downloadWithFallback(blob,fileName);
        self.toast('Downloaded','Share not available','warn');

    }catch(e){
        document.getElementById('renderZone').innerHTML='';
        self.unload();
        if(e.name!=='AbortError')self.toast('Error',e.message,'err');
    }
},

// =====================================================
// üî• BACKUP EXPORT üî•
// =====================================================

exportAllData(){
    try{
        var data={
            exportDate:new Date().toISOString(),
            version:'ShubhArambh_v2',
            master:this.S.master,
            templates:this.S.templates,
            settings:this.CFG,
            state:{pandit:this.S.pandit,activities:this.S.activities}
        };
        var blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
        var name='ShubhArambh_Backup_'+new Date().toISOString().split('T')[0]+'.json';
        this._downloadWithFallback(blob,name);
        this.toast('Backup','Downloaded','ok');
        this.logActivity('üíæ','Backup exported');
    }catch(e){this.toast('Error',e.message,'err')}
},

// =====================================================
// CLOUD & LIBRARY FUNCTIONS
// =====================================================

async saveCloud(){
var name=this.S.yajman||'Unnamed';
if(!name||name==='Unnamed'){this.toast('Required','Set yajman name','warn');return}
this.load('Saving...');
try{
await this.apiPost({action:'saveTemplate',id:Date.now().toString(),name:name,date:this.S.date||new Date().toLocaleDateString('hi-IN'),poojas:this.S.selPoojas.map(function(p){return p.name}).join(', '),samagri:this.S.mats.filter(function(m){return m.on}),meta:{yajman:name,date:this.S.date,phone:this.S.phone}});
this.unload();this.toast('Saved','Template saved','ok');this.logActivity('üíæ','Saved: '+name);await this.fetchTemplates();
}catch(e){this.unload();this.toast('Error',e.message,'err')}
},

drawLib(){
var g=document.getElementById('tplGrid');if(!g)return;
var self=this;
if(!this.S.templates.length){g.innerHTML='<p style="color:var(--gray-500);text-align:center;padding:2rem;grid-column:1/-1;">No templates yet</p>';return}
g.innerHTML=this.S.templates.slice().reverse().map(function(t){
return'<div class="tpl-card"><div class="tpl-name">'+t.name+'</div><div class="tpl-meta"><span>üìÖ '+self._fmtDate(t.date)+'</span><span>üïâÔ∏è '+(t.poojasArr?t.poojasArr.length:0)+' poojas</span></div><div class="tpl-actions"><button class="btn btn-sm btn-p" onclick="V.loadTpl(\''+t.id+'\')">Open</button><button class="btn btn-sm btn-s" onclick="V.cloneTpl(\''+t.id+'\')">Clone</button><button class="btn btn-sm btn-d" onclick="V.delTpl(\''+t.id+'\')">Delete</button></div></div>'
}).join('');
},

filterLib(){
var q=((document.getElementById('libSearch')||{}).value||'').toLowerCase();
var self=this;
var filtered=this.S.templates.filter(function(t){return t.name.toLowerCase().includes(q)||(t.poojas||'').toLowerCase().includes(q)});
var g=document.getElementById('tplGrid');
if(!filtered.length){g.innerHTML='<p style="color:var(--gray-500);text-align:center;padding:2rem;grid-column:1/-1;">No match</p>';return}
g.innerHTML=filtered.slice().reverse().map(function(t){
return'<div class="tpl-card"><div class="tpl-name">'+t.name+'</div><div class="tpl-meta"><span>üìÖ '+self._fmtDate(t.date)+'</span></div><div class="tpl-actions"><button class="btn btn-sm btn-p" onclick="V.loadTpl(\''+t.id+'\')">Open</button><button class="btn btn-sm btn-s" onclick="V.cloneTpl(\''+t.id+'\')">Clone</button><button class="btn btn-sm btn-d" onclick="V.delTpl(\''+t.id+'\')">Delete</button></div></div>'
}).join('');
},

loadTpl(id){
var t=this.S.templates.find(function(x){return x.id.toString()===id.toString()});
if(!t){this.toast('Error','Not found','err');return}
this.S.yajman=t.name;this.S.date=t.date;
this.S.selPoojas=(t.poojasArr||[]).map(function(n,i){return{name:n,order:i}});
this.S.mats=Array.isArray(t.samagri)?t.samagri:[];
document.getElementById('inpYajman').value=t.name;document.getElementById('inpDate').value=t.date||'';
this.drawPoojaList();if(this.S.mats.length)this.drawMats();else{this.buildMats();this.drawMats()}
this.go('pgMats');this.saveState();this.toast('Loaded',t.name,'ok');this.logActivity('üìÇ','Opened: '+t.name);
},

async cloneTpl(id){
var t=this.S.templates.find(function(x){return x.id.toString()===id.toString()});if(!t)return;
var nn=prompt('New name:',t.name+' (Copy)');if(!nn)return;
this.load('Cloning...');
try{await this.apiPost({action:'saveTemplate',id:Date.now().toString(),name:nn,date:new Date().toLocaleDateString('hi-IN'),poojas:t.poojas,samagri:t.samagri,meta:{yajman:nn}});this.unload();this.toast('Cloned',nn,'ok');this.logActivity('üìã','Cloned: '+nn);await this.fetchTemplates()}
catch(e){this.unload();this.toast('Error',e.message,'err')}
},

async delTpl(id){
if(!await this.confirm('Delete this template?','üóëÔ∏è'))return;
this.load('Deleting...');
try{await this.apiPost({action:'deleteTemplate',id:id});this.unload();this.toast('Deleted','','ok');this.logActivity('üóëÔ∏è','Template deleted');await this.fetchTemplates()}
catch(e){this.unload();this.toast('Error',e.message,'err')}
},

// =====================================================
// DATABASE FUNCTIONS
// =====================================================

drawDB(filter){
var b=document.getElementById('dbBody');if(!b)return;
var data=this.S.master;
var self=this;
if(filter){var q=filter.toLowerCase();data=data.filter(function(r){return(r.pooja||'').toLowerCase().includes(q)||(r.samagri||'').toLowerCase().includes(q)})}
if(!data.length){b.innerHTML='<tr><td colspan="4" style="text-align:center;padding:2rem;color:#999;">'+(filter?'No results':'No data')+'</td></tr>';return}
b.innerHTML=data.map(function(r,i){var gi=self.S.master.indexOf(r);return'<tr><td>'+(i+1)+'</td><td><strong>'+(r.pooja||'')+'</strong></td><td>'+(r.samagri||'')+'</td><td><div class="db-acts"><button class="db-btn db-btn-e" onclick="V.dbEdit('+gi+')">Edit</button><button class="db-btn db-btn-d" onclick="V.dbDel('+gi+')">Del</button></div></td></tr>'}).join('');
},

filterDB(){this.drawDB((document.getElementById('dbSearch')||{}).value||'')},

syncDBStats(){
var up=[...new Set(this.S.master.map(function(x){return(x.pooja||'').trim()}))].filter(Boolean);
var eP=document.getElementById('dbStP'),eS=document.getElementById('dbStS');
if(eP)eP.textContent=up.length;if(eS)eS.textContent=this.S.master.length;
},

fillExistingSel(){
var up=[...new Set(this.S.master.map(function(x){return(x.pooja||'').trim()}))].filter(Boolean);
var sel=document.getElementById('mAddSel');if(!sel)return;
sel.innerHTML='<option value="">‚Äî or select existing ‚Äî</option>'+up.map(function(p){return'<option value="'+p+'">'+p+'</option>'}).join('');
},

pickExisting(){var v=document.getElementById('mAddSel').value;if(v)document.getElementById('mAddPooja').value=v},

async dbAdd(){
var pooja=document.getElementById('mAddPooja').value.trim();
var txt=document.getElementById('mAddItems').value.trim();
if(!pooja){this.toast('Required','Enter pooja name','warn');return}
if(!txt){this.toast('Required','Enter items','warn');return}
var items=txt.split('\n').map(function(x){return x.trim()}).filter(Boolean);
if(!items.length){this.toast('Required','Enter at least one item','warn');return}
this.modal('mAdd',0);this.load('Adding '+items.length+' items...');
var ok=0,fail=0;
for(var idx=0;idx<items.length;idx++){
document.getElementById('loaderTxt').textContent='Adding '+(idx+1)+'/'+items.length;
try{await this.apiPost({action:'add',pooja:pooja,samagri:items[idx]});ok++;if(idx<items.length-1)await new Promise(function(r){setTimeout(r,300)})}catch(e){fail++}
}
document.getElementById('mAddPooja').value='';document.getElementById('mAddItems').value='';document.getElementById('mAddSel').value='';
await new Promise(function(r){setTimeout(r,800)});this.unload();
this.toast(fail>0?'Partial':'Added',ok+' added','ok');
this.logActivity('‚ûï','Added '+ok+' items to '+pooja);await this.fetchMaster();
},

dbEdit(i){
var r=this.S.master[i];if(!r)return;
document.getElementById('mEditPooja').value=r.pooja||'';
document.getElementById('mEditSamagri').value=r.samagri||'';
document.getElementById('mEditIdx').value=i;this.modal('mEdit',1);
},

async dbUpdate(){
var i=parseInt(document.getElementById('mEditIdx').value);
var ns=document.getElementById('mEditSamagri').value.trim();
if(!ns){this.toast('Required','Cannot be empty','warn');return}
if(i<0||i>=this.S.master.length)return;
var old=this.S.master[i];this.modal('mEdit',0);this.load('Updating...');
try{
await this.apiPost({action:'delete',pooja:old.pooja,samagri:old.samagri});
await new Promise(function(r){setTimeout(r,400)});
await this.apiPost({action:'add',pooja:old.pooja,samagri:ns});
await new Promise(function(r){setTimeout(r,800)});
this.unload();this.toast('Updated','Done','ok');
this.logActivity('‚úèÔ∏è','Updated: '+ns);await this.fetchMaster();
}catch(e){this.unload();this.toast('Error',e.message,'err')}
},

async dbDel(i){
if(i<0||i>=this.S.master.length)return;
var r=this.S.master[i];
if(!await this.confirm('Delete "'+r.samagri+'"?','üóëÔ∏è'))return;
this.load('Deleting...');
try{
await this.apiPost({action:'deleteItem',pooja:r.pooja,samagri:r.samagri});
await new Promise(function(r){setTimeout(r,800)});
this.unload();this.toast('Deleted',r.samagri,'ok');
this.logActivity('üóëÔ∏è','Deleted: '+r.samagri);await this.fetchMaster();
}catch(e){this.unload();this.toast('Error',e.message,'err')}
},

syncStats(){
var up=this._uniquePoojas();
var eY=document.getElementById('stYaj'),eP=document.getElementById('stPooja'),eI=document.getElementById('stItems'),eC=document.getElementById('stCloud');
if(eY)eY.textContent=this.S.templates.length;if(eP)eP.textContent=up.length;
if(eI)eI.textContent=this.S.master.length;if(eC)eC.textContent=this.S.templates.length;
},

/* === YAJMAN MANAGEMENT === */
renderYajmans(){
var el=document.getElementById('yajList');if(!el)return;
var list=this.S.yajmans||[];
var q=(document.getElementById('yajSearch')||{}).value||'';
if(q){q=q.toLowerCase();list=list.filter(function(y){return(y.name||'').toLowerCase().includes(q)||(y.phone||'').includes(q)})}
if(!list.length){el.innerHTML='<div style="text-align:center;padding:2rem;color:#999"><div style="font-size:2rem;margin-bottom:0.5rem">üë•</div><p>No yajmans yet</p></div>';return}
var h='';var self=this;
list.forEach(function(y){h+='<div class="card" style="margin:0;padding:1rem"><div style="display:flex;justify-content:space-between;align-items:start;gap:1rem"><div style="flex:1"><div style="font-weight:700;color:white;font-size:1rem;margin-bottom:0.25rem">'+self._esc(y.name||'')+'</div><div style="font-size:0.8rem;color:#999">üìû '+(y.phone||'-')+' | üìç '+(y.address||'-')+'</div></div><div style="display:flex;gap:0.4rem"><button class="btn btn-xs btn-s" onclick="V.editYajman(\''+y.id+'\')">‚úèÔ∏è</button><button class="btn btn-xs btn-d" onclick="V.deleteYajman(\''+y.id+'\')">üóëÔ∏è</button></div></div></div>'});
el.innerHTML=h;
},

showAddYajman(){
var b='<div class="fg"><label class="fl">Name</label><input class="fi" id="yajName"></div>'+
'<div class="fg"><label class="fl">Phone</label><input class="fi" id="yajPhone" type="tel"></div>'+
'<div class="fg"><label class="fl">Address</label><input class="fi" id="yajAddr"></div>';
this.modal('mYajman',1);
document.querySelector('#mYajman .modal-title').textContent='‚ûï Add Yajman';
document.querySelector('#mYajman .modal-body').innerHTML=b;
document.querySelector('#mYajman .modal-foot').innerHTML='<button class="btn btn-s" onclick="V.modal(\'mYajman\',0)">Cancel</button><button class="btn btn-p" onclick="V.saveYajman()">Save</button>';
setTimeout(function(){var e=document.getElementById('yajName');if(e)e.focus()},300);
},

saveYajman(){
var n=(document.getElementById('yajName')||{}).value||'';
if(!n){this.toast('Required','Enter name','warn');return}
var y={id:Date.now().toString(),name:n,phone:(document.getElementById('yajPhone')||{}).value||'',address:(document.getElementById('yajAddr')||{}).value||''};
if(!this.S.yajmans)this.S.yajmans=[];
this.S.yajmans.push(y);
this.saveState();
this.modal('mYajman',0);
this.renderYajmans();
this.toast('Added',n,'ok');
},

editYajman(id){
var y=null;
for(var i=0;i<(this.S.yajmans||[]).length;i++){if(this.S.yajmans[i].id===id){y=this.S.yajmans[i];break}}
if(!y)return;
var b='<div class="fg"><label class="fl">Name</label><input class="fi" id="yajName" value="'+this._esc(y.name||'')+'"></div>'+
'<div class="fg"><label class="fl">Phone</label><input class="fi" id="yajPhone" type="tel" value="'+this._esc(y.phone||'')+'"></div>'+
'<div class="fg"><label class="fl">Address</label><input class="fi" id="yajAddr" value="'+this._esc(y.address||'')+'"></div>'+
'<input type="hidden" id="yajEditId" value="'+id+'">';
this.modal('mYajman',1);
document.querySelector('#mYajman .modal-title').textContent='‚úèÔ∏è Edit Yajman';
document.querySelector('#mYajman .modal-body').innerHTML=b;
document.querySelector('#mYajman .modal-foot').innerHTML='<button class="btn btn-s" onclick="V.modal(\'mYajman\',0)">Cancel</button><button class="btn btn-p" onclick="V.updateYajman()">Update</button>';
},

updateYajman(){
var id=(document.getElementById('yajEditId')||{}).value;
var y=null;
for(var i=0;i<(this.S.yajmans||[]).length;i++){if(this.S.yajmans[i].id===id){y=this.S.yajmans[i];break}}
if(!y)return;
y.name=(document.getElementById('yajName')||{}).value||'';
y.phone=(document.getElementById('yajPhone')||{}).value||'';
y.address=(document.getElementById('yajAddr')||{}).value||'';
this.saveState();
this.modal('mYajman',0);
this.renderYajmans();
this.toast('Updated',y.name,'ok');
},

deleteYajman(id){
var self=this;
this.confirm('Delete yajman?','‚ö†Ô∏è').then(function(yes){
if(!yes)return;
if(!self.S.yajmans)return;
self.S.yajmans=self.S.yajmans.filter(function(y){return y.id!==id});
self.saveState();
self.renderYajmans();
self.toast('Deleted','','ok');
});
},
/* === END YAJMAN MANAGEMENT === */

_fmtDate(d){
if(!d)return'-';
try{var dt=new Date(d);if(isNaN(dt.getTime()))return d;return String(dt.getDate()).padStart(2,'0')+'/'+String(dt.getMonth()+1).padStart(2,'0')+'/'+dt.getFullYear()}catch(e){return d}
}
};

if(document.readyState==='loading')document.addEventListener('DOMContentLoaded',function(){V.init()});
else V.init();
setInterval(function(){try{V.saveState()}catch(e){}},30000);
</script>
</body>
</html>
